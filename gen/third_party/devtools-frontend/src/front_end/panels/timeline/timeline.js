import*as e from"../../core/sdk/sdk.js";import*as t from"../../core/common/common.js";import*as i from"../../core/i18n/i18n.js";import*as n from"../../core/platform/platform.js";import*as a from"../../models/timeline_model/timeline_model.js";import*as r from"../../ui/legacy/components/perf_ui/perf_ui.js";import*as s from"../../ui/legacy/legacy.js";import*as o from"../../models/bindings/bindings.js";import*as l from"../../ui/legacy/components/utils/utils.js";import*as d from"../../core/host/host.js";import*as c from"../../core/root/root.js";import*as h from"../../models/extensions/extensions.js";import*as m from"../mobile_throttling/mobile_throttling.js";import*as u from"../../models/text_utils/text_utils.js";import*as p from"../coverage/coverage.js";import*as g from"../../ui/legacy/components/data_grid/data_grid.js";import*as v from"../layer_viewer/layer_viewer.js";import*as f from"../../ui/legacy/theme_support/theme_support.js";import*as T from"./components/components.js";class w{x;y;width;height;color;outlineColor;constructor([e,t,i,n]){this.x=e,this.y=t,this.width=i,this.height=n,this.color={r:238,g:111,b:99,a:.4},this.outlineColor={r:238,g:111,b:99,a:.7}}}let S;class y{static instance(e={forceNew:null}){const{forceNew:t}=e;return S&&!t||(S=new y),S}linkify(t,i){const n=document.createElement("span"),a=t,{x:r,y:s,width:o,height:l}=a;return n.textContent=`Location: [${r},${s}], Size: [${o}x${l}]`,n.addEventListener("mouseover",(()=>e.OverlayModel.OverlayModel.highlightRect(a))),n.addEventListener("mouseleave",(()=>e.OverlayModel.OverlayModel.clearHighlight())),n}}var b=Object.freeze({__proto__:null,CLSRect:w,Linkifier:y});const C=new CSSStyleSheet;C.replaceSync(".children,.content,.header{min-height:initial;line-height:initial}.children li::before{display:none}.content{margin-bottom:4px}.content .stack-preview-container{margin-left:8px}.content .node-list{margin-left:10px}.tree-outline li{white-space:normal}\n/*# sourceURL=invalidationsTree.css */\n");const k=new CSSStyleSheet;k.replaceSync(".image-preview-container{background:0 0;text-align:center;border-spacing:0}.image-preview-container img{margin:6px 0;max-width:100px;max-height:100px;background-image:var(--image-file-checker);user-select:text;vertical-align:top;-webkit-user-drag:auto}.image-container{padding:0}.image-container>div{min-height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer}.image-preview-container .row{line-height:1.2;vertical-align:baseline}.image-preview-container .title{padding-right:.5em;text-align:right;color:var(--color-text-secondary);white-space:nowrap}.image-preview-container .description{white-space:nowrap;text-align:left;color:var(--color-text-primary)}.image-preview-container .description-link{max-width:20em}.image-preview-container .source-link{white-space:normal;word-break:break-all;color:var(--color-link);cursor:pointer}\n/*# sourceURL=imagePreview.css */\n");const P=new CSSStyleSheet;P.replaceSync('.content{margin-left:5px}.history-dropdown-button{width:160px;height:26px;text-align:left;display:flex;border:1px solid transparent}.history-dropdown-button[disabled]{opacity:50%;border:1px solid transparent}.history-dropdown-button>.content{padding-right:5px;overflow:hidden;text-overflow:ellipsis;flex:1 1;min-width:35px}.history-dropdown-button:focus-visible::before{content:"";position:absolute;top:2px;left:0;right:0;bottom:2px;border-radius:2px;background:var(--divider-line)}@media (forced-colors:active){.history-dropdown-button[disabled]{opacity:100%}.history-dropdown-button[disabled] [is=ui-icon].icon-mask{background-color:GrayText}}\n/*# sourceURL=historyToolbarButton.css */\n');const M=new CSSStyleSheet;M.replaceSync('.timeline-toolbar-container{display:flex;flex:none}.timeline-toolbar-container>.toolbar{background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border)}.timeline-main-toolbar{flex:1 1 auto}.timeline-settings-pane{flex:none;background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border)}#timeline-overview-panel{flex:none;position:relative;border-bottom:1px solid var(--color-details-hairline)}#timeline-overview-grid{background-color:var(--color-background)}#timeline-overview-grid .timeline-grid-header{height:12px}#timeline-overview-grid .resources-dividers-label-bar{pointer-events:auto;height:12px}#timeline-overview-grid .resources-divider-label{top:1px}.timeline-details-split{flex:auto}.timeline.panel .status-pane-container{z-index:1000;display:flex;align-items:center;pointer-events:none}.timeline.panel .status-pane-container.tinted{background-color:var(--color-background-elevation-2);pointer-events:auto}#timeline-overview-panel .overview-strip{margin-top:2px;justify-content:center}#timeline-overview-panel .overview-strip .timeline-overview-strip-title{color:var(--color-text-secondary);font-size:10px;font-weight:700;z-index:100;background-color:var(--color-background-opacity-80);padding:0 4px;position:absolute;top:-2px;right:0}#timeline-overview-cpu-activity{flex-basis:20px}#timeline-overview-network{flex-basis:8px}#timeline-overview-filmstrip{flex-basis:30px}#timeline-overview-memory{flex-basis:20px}#timeline-overview-cpu-activity::before,#timeline-overview-network::before{content:"";position:absolute;left:0;right:0;bottom:0;border-bottom:1px solid var(--divider-line);z-index:-200}.overview-strip .background{z-index:-10}#timeline-overview-responsiveness{flex-basis:5px;margin-top:0!important}#timeline-overview-input{flex-basis:6px}#timeline-overview-pane{flex:auto;position:relative;overflow:hidden}#timeline-overview-container{display:flex;flex-direction:column;flex:none;position:relative;overflow:hidden}#timeline-overview-container canvas{width:100%;height:100%}.popover ul{margin:0;padding:0;list-style-type:none}.memory-graph-label{position:absolute;right:0;bottom:0;font-size:9px;color:var(--color-text-secondary);white-space:nowrap;padding:0 4px;background-color:var(--color-background-opacity-80)}#memory-graphs-canvas-container{overflow:hidden;flex:auto;position:relative}#memory-counters-graph{flex:auto}#memory-graphs-canvas-container .memory-counter-marker{position:absolute;border-radius:3px;width:5px;height:5px;margin-left:-3px;margin-top:-2px}#memory-graphs-container .timeline-memory-header{flex:0 0 26px;background-color:var(--color-background-elevation-1);border-bottom:1px solid var(--color-details-hairline);justify-content:space-between}#memory-graphs-container .timeline-memory-header::after{content:"";background-image:var(--image-file-toolbarResizerVertical);background-repeat:no-repeat;background-position:right center,center;flex:20px 0 0;margin:0 4px}.timeline-memory-toolbar{flex-shrink:1}.memory-counter-value{margin:8px}#counter-values-bar{flex:0 0 20px;border-top:solid 1px var(--color-details-hairline);width:100%;overflow:hidden;line-height:18px}#timeline-overview-coverage{flex-basis:20px}.timeline-overview-coverage-label{position:absolute;right:0;bottom:0;font-size:9px;color:var(--color-text-secondary);white-space:nowrap;padding:0 4px;background-color:var(--color-background-opacity-80)}.timeline-details{vertical-align:top}.timeline-details-view{color:var(--color-text-secondary);overflow:hidden}.timeline-details-view-body{flex:auto;overflow:auto;position:relative;background-color:var(--color-background-elevation-1);user-select:text}.timeline-details-view-block{flex:none;display:flex;background-color:var(--color-background);flex-direction:column;padding-bottom:5px;border-bottom:var(--legacy-divider-border)}.timeline-details-view-row{padding-left:10px;line-height:20px}.timeline-details-view-block .timeline-details-stack-values{flex-direction:column!important}.timeline-details-chip-title{font-size:13px;padding:8px;display:flex;align-items:center}.timeline-details-view-row-title:not(:empty){color:var(--color-text-secondary);overflow:hidden;padding-right:10px;display:inline-block}.timeline-details-warning{--override-details-warning-background-color:rgb(250 209 209 / 48%);background-color:var(--override-details-warning-background-color)}.-theme-with-dark-background .timeline-details-warning,:host-context(.-theme-with-dark-background) .timeline-details-warning{--override-details-warning-background-color:rgb(87 10 10 / 48%)}.timeline-details-warning .timeline-details-view-row-title{color:var(--color-red)}.timeline-details-view-row-value{display:inline-block;user-select:text;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}.timeline-details-warning .timeline-details-view-row-value{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.timeline-details-view-row-value .stack-preview-container{line-height:11px}.timeline-details-view-pie-chart-wrapper{margin:4px 0}.timeline-details-view-pie-chart{margin-top:5px}.timeline-details-view-row-stack-trace{padding:4px 0;line-height:inherit}.timeline-flamechart{overflow:hidden}.timeline-flamechart-resizer{flex:8px 0 0;background-color:var(--color-background-elevation-1);border:1px var(--color-details-hairline);border-style:solid none;display:flex;flex-direction:row;align-items:flex-end;justify-content:center}.timeline-network-resizer-disabled>.timeline-flamechart-resizer{display:none}.timeline-flamechart-resizer::after{content:"...";font-size:14px;margin-bottom:-1px}.timeline-layers-view-properties table{width:100%;border-collapse:collapse}.timeline-layers-view-properties td{border:1px solid var(--color-details-hairline);line-height:22px}.timeline-filmstrip-preview>img{margin-top:5px;max-width:500px;max-height:300px;cursor:pointer;border:1px solid var(--color-details-hairline)}.timeline-tree-view{display:flex;overflow:hidden}.timeline-tree-view .toolbar{background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border)}.timeline-tree-view .data-grid{border:none;flex:auto}.timeline-tree-view .data-grid .data-container{overflow-y:scroll}.timeline-tree-view .data-grid.data-grid-fits-viewport .corner{display:table-cell}.timeline-tree-view .data-grid table.data{background:var(--color-background)}.timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:var(--color-background-hover-overlay)}.timeline-tree-view .data-grid td.numeric-column{text-align:right;position:relative}.timeline-tree-view .data-grid div.background-percent-bar{float:right}.timeline-tree-view .data-grid span.percent-column{color:var(--color-text-secondary);width:45px;display:inline-block}.timeline-tree-view .data-grid tr.selected span{color:inherit}.timeline-tree-view .data-grid .name-container{display:flex;align-items:center;padding-left:2px}.timeline-tree-view .data-grid .name-container .activity-icon{width:12px;height:12px;border:1px solid var(--divider-line);margin:3px 0}.timeline-tree-view .data-grid .name-container .activity-icon-container{margin-right:3px;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;width:18px;height:18px;overflow:hidden}.timeline-tree-view .data-grid .name-container .activity-warning::after{content:"[deopt]";margin:0 4px;line-height:12px;font-size:10px;color:var(--color-text-disabled)}.timeline-tree-view .data-grid tr.selected .name-container .activity-warning::after{color:var(--color-text-secondary-selected)}.timeline-tree-view .data-grid .name-container .activity-link{flex:auto;text-align:right;overflow:hidden;text-overflow:ellipsis;margin-left:5px}.timeline-tree-view .data-grid .background-bar-container{position:absolute;left:3px;right:0}.timeline-tree-view .data-grid .background-bar{--override-background-bar-background-color:hsl(43deg 84% 64% / 20%);--override-background-bar-border-color:hsl(43deg 84% 64%);float:right;height:18px;background-color:var(--override-background-bar-background-color);border-bottom:1px solid var(--override-background-bar-border-color)}.timeline-tree-view .data-grid .selected .background-bar{background-color:var(--color-background-opacity-50);border-bottom:1px solid var(--color-background-opacity-80)}.-theme-with-dark-background .timeline-tree-view .data-grid .background-bar,:host-context(.-theme-with-dark-background) .timeline-tree-view .data-grid .background-bar{--override-background-bar-background-color:rgb(169 126 15 / 20%);--override-background-bar-border-color:rgb(169 126 15)}.timeline-tree-view .timeline-details-view-body .full-widget-dimmed-banner{background-color:inherit}.timeline-details .filter-input-field{width:120px}.timeline-tree-view .data-grid thead{height:21px}.timeline-stack-view-header{height:27px;background-color:var(--color-background-elevation-1);padding:6px 10px;color:var(--color-text-secondary);white-space:nowrap;border-bottom:var(--legacy-divider-border)}.timeline-landing-page{position:absolute;background-color:var(--color-background);justify-content:center;align-items:center;overflow:auto;font-size:13px;color:var(--color-text-secondary)}@media (forced-colors:active){.timeline-tree-view .data-grid .name-container .activity-icon{forced-color-adjust:none}.timeline-tree-view .data-grid tr.selected .name-container .activity-link .devtools-link,.timeline-tree-view .data-grid tr.selected div.background-percent-bar span,.timeline-tree-view .data-grid tr.selected span.percent-column{color:HighlightText}.timeline-tree-view .data-grid .background-bar,.timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:transparent}.timeline-tree-view .data-grid tr.selected .background-bar{background-color:transparent;border-bottom-color:HighlightText}}.timeline-additional-metrics{display:flex;flex:0 0 27px;background-color:var(--color-background-elevation-1);border-top:var(--legacy-divider-border);overflow:hidden;z-index:100}.timeline-details-view-row-stack-trace div{white-space:nowrap;text-overflow:ellipsis;line-height:12px}.timeline-details-view-body>div{overflow-y:hidden;overflow-x:auto}.timeline-landing-page>div{max-width:450px;margin:10px}.timeline-details-chip-title>div{width:12px;height:12px;border:1px solid var(--color-details-hairline);display:inline-block;margin-right:4px;content:" "}.timeline-paint-profiler-log-split>div:last-child{background-color:var(--color-background-elevation-1);z-index:0}.timeline-layers-view-properties>div:last-child,.timeline-layers-view>div:last-child{background-color:var(--color-background-elevation-1)}.timeline.panel .status-pane-container>div{pointer-events:auto}.timeline-landing-page>div>p{flex:none;white-space:pre-line}.timeline-tree-view .data-grid .name-container div{flex:none}.status-pane-container>.small-dialog{width:100%;height:100%}.timeline-concurrency-input{width:50px}.timeline-concurrency-hidden{visibility:hidden}\n/*# sourceURL=timelinePanel.css */\n');const x=new CSSStyleSheet;x.replaceSync(".timeline-status-dialog{display:flex;flex-direction:column;padding:16px 16px 12px;align-self:center;background-color:var(--color-background);box-shadow:var(--drop-shadow)}.status-dialog-line{margin:2px;height:14px;min-height:auto;display:flex;align-items:baseline}.status-dialog-line .label{display:inline-block;width:80px;text-align:right;color:var(--color-text-primary);margin-right:10px}.timeline-status-dialog .progress .indicator-container{display:inline-block;width:200px;height:8px;background-color:var(--color-background-elevation-2)}.timeline-status-dialog .progress .indicator{background-color:var(--color-primary-variant);height:100%;width:0;margin:0}.timeline-status-dialog .stop-button{margin-top:8px;height:100%;align-self:flex-end}.timeline-status-dialog .stop-button button{min-width:80px}.timeline-status-dialog.small-dialog{width:inherit;justify-content:center}.small-dialog>.stop-button{align-self:center;margin-top:20px;height:initial}@media (forced-colors:active){.timeline-status-dialog{border:1px solid canvastext}.timeline-status-dialog .progress .indicator-container{border:1px solid ButtonText;background-color:ButtonFace}.timeline-status-dialog .progress .indicator{forced-color-adjust:none;background-color:ButtonText}}\n/*# sourceURL=timelineStatusDialog.css */\n");const I={malformedTimelineDataUnknownJson:"Malformed timeline data: Unknown JSON format",malformedTimelineInputWrongJson:"Malformed timeline input, wrong JSON brackets balance",malformedTimelineDataS:"Malformed timeline data: {PH1}",legacyTimelineFormatIsNot:"Legacy Timeline format is not supported.",malformedCpuProfileFormat:"Malformed CPU profile format"},R=i.i18n.registerUIStrings("panels/timeline/TimelineLoader.ts",I),E=i.i18n.getLocalizedString.bind(void 0,R);class L{client;backingStorage;tracingModel;canceledCallback;state;buffer;firstRawChunk;firstChunk;loadedBytes;totalSize;jsonTokenizer;constructor(t){this.client=t,this.backingStorage=new o.TempFile.TempFileBackingStorage,this.tracingModel=new e.TracingModel.TracingModel(this.backingStorage),this.canceledCallback=null,this.state=D.Initial,this.buffer="",this.firstRawChunk=!0,this.firstChunk=!0,this.loadedBytes=0,this.jsonTokenizer=new u.TextUtils.BalancedJSONTokenizer(this.writeBalancedJSON.bind(this),!0)}static loadFromFile(e,t){const i=new L(t),n=new o.FileUtils.ChunkedFileReader(e,F);return i.canceledCallback=n.cancel.bind(n),i.totalSize=e.size,n.read(i).then((e=>{!e&&n.error()&&i.reportErrorAndCancelLoading(n.error().message)})),i}static loadFromEvents(e,t){const i=new L(t);return window.setTimeout((async()=>{t.loadingStarted();for(let n=0;n<e.length;n+=5e3){const a=e.slice(n,n+5e3);i.tracingModel.addEvents(a),t.loadingProgress((n+a.length)/e.length),await new Promise((e=>window.setTimeout(e)))}i.close()})),i}static loadFromURL(e,i){const n=new L(i),a=t.Settings.Settings.instance().moduleSetting("network.enable-unc-loading").get();return d.ResourceLoader.loadAsStream(e,null,n,void 0,a),n}cancel(){this.tracingModel=null,this.backingStorage.reset(),this.client&&(this.client.loadingComplete(null),this.client=null),this.canceledCallback&&this.canceledCallback()}async write(e){if(!this.client)return Promise.resolve();if(this.loadedBytes+=e.length,this.firstRawChunk)await this.client.loadingStarted(),await new Promise((e=>requestAnimationFrame((()=>requestAnimationFrame(e)))));else{let e;this.totalSize&&(e=this.loadedBytes/this.totalSize,e=e>1?e-Math.floor(e):e),await this.client.loadingProgress(e)}if(this.firstRawChunk=!1,this.state===D.Initial)if(e.startsWith('{"nodes":['))this.state=D.LoadingCPUProfileFormat;else if("{"===e[0])this.state=D.LookingForEvents;else{if("["!==e[0])return this.reportErrorAndCancelLoading(E(I.malformedTimelineDataUnknownJson)),Promise.resolve();this.state=D.ReadingEvents}if(this.state===D.LoadingCPUProfileFormat)return this.buffer+=e,Promise.resolve();if(this.state===D.LookingForEvents){const t='"traceEvents":',i=this.buffer.length-t.length;this.buffer+=e;const n=this.buffer.indexOf(t,i);if(-1===n)return Promise.resolve();e=this.buffer.slice(n+t.length),this.state=D.ReadingEvents}return this.state!==D.ReadingEvents||this.jsonTokenizer.write(e)||(this.state=D.SkippingTail,this.firstChunk&&this.reportErrorAndCancelLoading(E(I.malformedTimelineInputWrongJson))),Promise.resolve()}writeBalancedJSON(e){let t,i=e+"]";if(!this.firstChunk){const e=i.indexOf(",");-1!==e&&(i=i.slice(e+1)),i="["+i}try{t=JSON.parse(i)}catch(e){return void this.reportErrorAndCancelLoading(E(I.malformedTimelineDataS,{PH1:e.toString()}))}if(this.firstChunk&&(this.firstChunk=!1,this.looksLikeAppVersion(t[0])))this.reportErrorAndCancelLoading(E(I.legacyTimelineFormatIsNot));else try{this.tracingModel.addEvents(t)}catch(e){this.reportErrorAndCancelLoading(E(I.malformedTimelineDataS,{PH1:e.toString()}))}}reportErrorAndCancelLoading(e){e&&t.Console.Console.instance().error(e),this.cancel()}looksLikeAppVersion(e){return"string"==typeof e&&-1!==e.indexOf("Chrome")}async close(){this.client&&(this.client.processingStarted(),window.setTimeout((()=>this.finalizeTrace()),0))}finalizeTrace(){this.state===D.LoadingCPUProfileFormat&&(this.parseCPUProfileFormat(this.buffer),this.buffer=""),this.tracingModel.tracingComplete(),this.client.loadingComplete(this.tracingModel)}parseCPUProfileFormat(e){let t;try{const i=JSON.parse(e);t=a.TimelineJSProfile.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(i,1,!0)}catch(e){return void this.reportErrorAndCancelLoading(E(I.malformedCpuProfileFormat))}this.tracingModel.addEvents(t)}}const F=5e6;var D;!function(e){e.Initial="Initial",e.LookingForEvents="LookingForEvents",e.ReadingEvents="ReadingEvents",e.SkippingTail="SkippingTail",e.LoadingCPUProfileFormat="LoadingCPUProfileFormat"}(D||(D={}));var U=Object.freeze({__proto__:null,TimelineLoader:L,TransferChunkLengthBytes:F,get State(){return D}});class H{provider;performanceModel;completionCallback;completionPromise;timeOffset;constructor(e,t){this.provider=e,this.performanceModel=t,this.completionPromise=new Promise((e=>{this.completionCallback=e})),this.timeOffset=0}loadingStarted(){}processingStarted(){}loadingProgress(e){}loadingComplete(e){e&&(this.performanceModel.addExtensionEvents(this.provider.longDisplayName(),e,this.timeOffset),this.completionCallback())}complete(e,t){e?(this.timeOffset=t,L.loadFromURL(e,this)):this.completionCallback()}start(){this.provider.start(this)}stop(){return this.provider.stop(),this.completionPromise}}var W=Object.freeze({__proto__:null,ExtensionTracingSession:H});const V={cpuProfileForATargetIsNot:"CPU profile for a target is not available.",tracingNotSupported:"Performance trace recording not supported for this type of target"},B=i.i18n.registerUIStrings("panels/timeline/TimelineController.ts",V),N=i.i18n.getLocalizedString.bind(void 0,B);class A{target;tracingManager;performanceModel;client;tracingModel;extensionSessions;extensionTraceProviders;tracingCompleteCallback;profiling;cpuProfiles;constructor(t,i){this.target=t,this.tracingManager=t.model(e.TracingManager.TracingManager),this.performanceModel=new gi,this.performanceModel.setMainTarget(t),this.client=i;const n=new o.TempFile.TempFileBackingStorage;this.tracingModel=new e.TracingModel.TracingModel(n),this.extensionSessions=[],e.TargetManager.TargetManager.instance().observeModels(e.CPUProfilerModel.CPUProfilerModel,this)}dispose(){e.TargetManager.TargetManager.instance().unobserveModels(e.CPUProfilerModel.CPUProfilerModel,this)}mainTarget(){return this.target}async startRecording(t,i){function n(e){return"disabled-by-default-"+e}this.extensionTraceProviders=h.ExtensionServer.ExtensionServer.instance().traceProviders().slice();const r=[c.Runtime.experiments.isEnabled("timelineShowAllEvents")?"*":"-*",a.TimelineModel.TimelineModelImpl.Category.Console,a.TimelineModel.TimelineModelImpl.Category.UserTiming,"devtools.timeline",n("devtools.timeline"),n("devtools.timeline.frame"),n("devtools.timeline.stack"),n("v8.compile"),n("v8.cpu_profiler.hires"),a.TimelineModel.TimelineModelImpl.Category.LatencyInfo,a.TimelineModel.TimelineModelImpl.Category.Loading,n("lighthouse"),"v8.execute","v8"];c.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats")&&t.enableJSSampling&&r.push(n("v8.runtime_stats_sampling")),!c.Runtime.Runtime.queryParam("timelineTracingJSProfileDisabled")&&t.enableJSSampling&&r.push(n("v8.cpu_profiler")),c.Runtime.experiments.isEnabled("timelineInvalidationTracking")&&r.push(n("devtools.timeline.invalidationTracking")),t.capturePictures&&r.push(n("devtools.timeline.layers"),n("devtools.timeline.picture"),n("blink.graphics_context_annotations")),t.captureFilmStrip&&r.push(n("devtools.screenshot")),this.extensionSessions=i.map((e=>new H(e,this.performanceModel))),this.extensionSessions.forEach((e=>e.start())),this.performanceModel.setRecordStartTime(Date.now());const s=await this.startRecordingWithCategories(r.join(","),t.enableJSSampling);return s.getError()&&(await this.waitForTracingToStop(!1),await e.TargetManager.TargetManager.instance().resumeAllTargets()),s}async stopRecording(){return this.tracingManager&&this.tracingManager.stop(),this.client.loadingStarted(),await this.waitForTracingToStop(!0),this.allSourcesFinished(),this.performanceModel}async waitForTracingToStop(e){const t=[];this.tracingManager&&e&&t.push(new Promise((e=>{this.tracingCompleteCallback=e}))),t.push(this.stopProfilingOnAllModels());const i=this.extensionSessions.map((e=>e.stop()));i.length&&t.push(Promise.race([Promise.all(i),new Promise((e=>window.setTimeout(e,5e3)))])),await Promise.all(t)}modelAdded(e){this.profiling&&e.startRecording()}modelRemoved(e){}async startProfilingOnAllModels(){this.profiling=!0;const t=e.TargetManager.TargetManager.instance().models(e.CPUProfilerModel.CPUProfilerModel);await Promise.all(t.map((e=>e.startRecording())))}addCpuProfile(e,i){i?(this.cpuProfiles||(this.cpuProfiles=new Map),this.cpuProfiles.set(e,i)):t.Console.Console.instance().warn(N(V.cpuProfileForATargetIsNot))}async stopProfilingOnAllModels(){const t=this.profiling?e.TargetManager.TargetManager.instance().models(e.CPUProfilerModel.CPUProfilerModel):[];this.profiling=!1;const i=[];for(const e of t){const t=e.target().id(),n=e.stopRecording().then(this.addCpuProfile.bind(this,t));i.push(n)}await Promise.all(i)}async startRecordingWithCategories(t,i){if(!this.tracingManager)throw new Error(V.tracingNotSupported);return await e.TargetManager.TargetManager.instance().suspendAllTargets("performance-timeline"),i&&c.Runtime.Runtime.queryParam("timelineTracingJSProfileDisabled")&&await this.startProfilingOnAllModels(),this.tracingManager.start(this,t,"")}traceEventsCollected(e){this.tracingModel.addEvents(e)}tracingComplete(){this.tracingCompleteCallback&&(this.tracingCompleteCallback(void 0),this.tracingCompleteCallback=null)}allSourcesFinished(){this.client.processingStarted(),window.setTimeout((()=>this.finalizeTrace()),0)}async finalizeTrace(){this.injectCpuProfileEvents(),await e.TargetManager.TargetManager.instance().resumeAllTargets(),this.tracingModel.tracingComplete(),this.client.loadingComplete(this.tracingModel)}injectCpuProfileEvent(t,i,n){if(!n)return;const r={cat:e.TracingModel.DevToolsMetadataEventCategory,ph:e.TracingModel.Phase.Instant,ts:1e3*this.tracingModel.maximumRecordTime(),pid:t,tid:i,name:a.TimelineModel.RecordType.CpuProfile,args:{data:{cpuProfile:n}}};this.tracingModel.addEvents([r])}buildTargetToProcessIdMap(){const t=a.TimelineModel.TimelineModelImpl.DevToolsMetadataEvent,i=this.tracingModel.devToolsMetadataEvents(),r=i.find((e=>e.name===t.TracingStartedInBrowser));if(!r)return null;const s=new n.MapUtilities.Multimap,o=new Map,l=r.args.data.frames;for(const e of l)o.set(e.frame,e.processId);for(const e of i){const i=e.args.data;switch(e.name){case t.FrameCommittedInBrowser:i.processId?o.set(i.frame,i.processId):s.set(i.processPseudoId,i.frame);break;case t.ProcessReadyInBrowser:for(const e of s.get(i.processPseudoId)||[])o.set(e,i.processId)}}const d=l.find((e=>!e.parent)).processId,c=this.tracingModel.getProcessById(d);if(c){const t=e.TargetManager.TargetManager.instance().mainTarget();t&&o.set(t.id(),c.id())}return o}injectCpuProfileEvents(){if(!this.cpuProfiles)return;const t=a.TimelineModel.TimelineModelImpl.DevToolsMetadataEvent,i=this.tracingModel.devToolsMetadataEvents(),n=this.buildTargetToProcessIdMap();if(n)for(const[e,t]of this.cpuProfiles){const i=n.get(e);if(!i)continue;const r=this.tracingModel.getProcessById(i),s=r&&r.threadByName(a.TimelineModel.TimelineModelImpl.RendererMainThreadName);s&&this.injectCpuProfileEvent(i,s.id(),t)}else{const n=i.filter((e=>e.name===t.TracingStartedInPage)),r=n[n.length-1];if(r){const e=r.thread.process().id();if(this.tracingManager){const t=this.cpuProfiles.get(this.tracingManager.target().id());this.injectCpuProfileEvent(e,r.thread.id(),t)}}else{let t=0;for(const i of this.cpuProfiles){const n=e.TargetManager.TargetManager.instance().targetById(i[0]),r=n&&n.name();this.tracingModel.addEvents(a.TimelineJSProfile.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(i[1],++t,1===t,r))}}}const r=i.filter((e=>e.name===t.TracingSessionIdForWorker));for(const e of r){const t=e.args.data.workerId,i=this.cpuProfiles.get(t);this.injectCpuProfileEvent(e.thread.process().id(),e.args.data.workerThreadId,i)}this.cpuProfiles=null}tracingBufferUsage(e){this.client.recordingProgress(e)}eventsRetrievalProgress(e){this.client.loadingProgress(e)}}var z=Object.freeze({__proto__:null,TimelineController:A});const O={net:"NET",cpu:"CPU",heap:"HEAP",sSDash:"{PH1} – {PH2}",coverage:"COVERAGE"},G=i.i18n.registerUIStrings("panels/timeline/TimelineEventOverview.ts",O),_=i.i18n.getLocalizedString.bind(void 0,G);class j extends r.TimelineOverviewPane.TimelineOverviewBase{model;constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),this.model=null,t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}setModel(e){this.model=e}renderBar(e,t,i,n,a){const r=e,s=t-e,o=this.context();o.fillStyle=a,o.fillRect(r,i,s,n)}}class q extends j{constructor(){super("input",null)}update(){if(super.update(),!this.model)return;const e=this.height(),t=ii.eventDispatchDesciptors(),i=new Map;let r=-1;for(const e of t){for(const t of e.eventTypes)i.set(t,e);r=Math.max(r,e.priority)}const s=2*window.devicePixelRatio,o=this.model.timelineModel().minimumRecordTime(),l=this.model.timelineModel().maximumRecordTime()-o,d=this.width(),c=d/l;for(let t=0;t<=r;++t)for(const r of this.model.timelineModel().tracks())for(let l=0;l<r.events.length;++l){const h=r.events[l];if(h.name!==a.TimelineModel.RecordType.EventDispatch)continue;const m=i.get(h.args.data.type);if(!m||m.priority!==t)continue;if(void 0===h.endTime)continue;const u=n.NumberUtilities.clamp(Math.floor((h.startTime-o)*c),0,d),p=n.NumberUtilities.clamp(Math.ceil((h.endTime-o)*c),0,d),g=Math.max(p-u,s);this.renderBar(u,u+g,0,e,m.color)}}}class J extends j{constructor(){super("network",_(O.net))}update(){if(super.update(),!this.model)return;const e=this.model.timelineModel(),t=this.height()/2,i=e.minimumRecordTime(),n=e.maximumRecordTime()-i,a=this.width(),r=a/n,s=new Path2D,o=new Path2D,l=new Set(["VeryHigh","High","Medium"]);for(const n of e.networkRequests()){const e=l.has(n.priority)?s:o,d=Math.max(Math.floor((n.startTime-i)*r),0),c=Math.min(Math.ceil((n.endTime-i)*r+1),a);e.rect(d,0,c-d,t-1)}const d=this.context();d.save(),d.fillStyle="hsl(214, 60%, 60%)",d.fill(s),d.translate(0,t),d.fillStyle="hsl(214, 80%, 80%)",d.fill(o),d.restore()}}const X=new WeakMap;class $ extends j{backgroundCanvas;constructor(){super("cpu-activity",_(O.cpu)),this.backgroundCanvas=this.element.createChild("canvas","fill background")}resetCanvas(){super.resetCanvas(),this.backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this.backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}update(){if(super.update(),!this.model)return;const e=this.model.timelineModel(),t=4*window.devicePixelRatio,i=this.width(),n=this.height(),r=n,s=e.minimumRecordTime(),o=e.maximumRecordTime()-s,l=t/(i/o),d=ii.categories(),c=ii.getTimelineMainEventCategories(),h=c.indexOf("other");console.assert(0===c.indexOf("idle"));for(let e=1;e<c.length;++e)X.set(d[c[e]],e);const m=this.backgroundCanvas.getContext("2d");if(!m)throw new Error("Could not find 2d canvas");for(const t of e.tracks())t.type===a.TimelineModel.TrackType.MainThread&&t.forMainFrame?u(this.context(),t.events):u(m,t.events);function u(e,m){const u=new Z(s,l,(function(e){let i=r;for(let a=1;a<c.length;++a){const r=(e[a]||0)/l*n;i-=r,v[a].bezierCurveTo(p,f[a],p,i,p+t/2,i),f[a]=i}p+=t}));let p=0;const g=[],v=[],f=[];for(let e=0;e<c.length;++e)v[e]=new Path2D,v[e].moveTo(0,n),f[e]=n;a.TimelineModel.TimelineModelImpl.forEachEvent(m,(function(e){const t=g.length?g[g.length-1]:0;u.appendInterval(e.startTime,t),g.push(X.get(ii.eventStyle(e).category)||h)}),(function(e){const t=g.pop();void 0!==e.endTime&&t&&u.appendInterval(e.endTime,t)})),u.appendInterval(s+o+l,0);for(let t=c.length-1;t>0;--t)v[t].lineTo(i,n),e.fillStyle=d[c[t]].color,e.fill(v[t])}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let a=.5;a<i+n;a+=t)e.moveTo(a,0),e.lineTo(a-n,n);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(m)}}class K extends j{constructor(){super("responsiveness",null)}update(){if(super.update(),!this.model)return;const e=this.height(),t=this.model.timelineModel().minimumRecordTime(),i=this.model.timelineModel().maximumRecordTime()-t,n=this.width()/i,r=this.model.frames(),s=this.context(),o=new Path2D,l=new Path2D;for(let e=0;e<r.length;++e){const t=r[e];t.hasWarnings()&&d(t.startTime,t.duration)}for(const e of this.model.timelineModel().tracks()){const t=e.events;for(let e=0;e<t.length;++e){if(!a.TimelineModel.TimelineData.forEvent(t[e]).warning)continue;const i=t[e].duration;void 0!==i&&d(t[e].startTime,i)}}function d(i,a){const r=Math.round(n*(i-t)),s=Math.round(n*a);o.rect(r,0,s,e),l.moveTo(r+s,0),l.lineTo(r+s,e)}s.fillStyle="hsl(0, 80%, 90%)",s.strokeStyle="red",s.lineWidth=2*window.devicePixelRatio,s.fill(o),s.stroke(l)}}class Y extends j{frameToImagePromise;lastFrame;lastElement;drawGeneration;emptyImage;imageWidth;constructor(){super("filmstrip",null),this.frameToImagePromise=new Map,this.lastFrame=null,this.lastElement=null,this.reset()}update(){super.update();const e=this.model?this.model.filmStripModel().frames():[];if(!e.length)return;const t=Symbol("drawGeneration");this.drawGeneration=t,this.imageByFrame(e[0]).then((e=>{if(this.drawGeneration!==t)return;if(!e||!e.naturalWidth||!e.naturalHeight)return;const i=this.height()-2*Y.Padding,n=Math.ceil(i*e.naturalWidth/e.naturalHeight),a=Math.min(200/e.naturalWidth,1);this.emptyImage=new Image(e.naturalWidth*a,e.naturalHeight*a),this.drawFrames(n,i)}))}async imageByFrame(e){let t=this.frameToImagePromise.get(e);if(!t){const i=await e.imageDataPromise();t=s.UIUtils.loadImageFromData(i),this.frameToImagePromise.set(e,t)}return t}drawFrames(e,t){if(!e||!this.model)return;const i=this.model.filmStripModel();if(!i.frames().length)return;const n=Y.Padding,a=this.width(),r=i.zeroTime(),s=i.spanTime()/a,o=this.context(),l=this.drawGeneration;o.beginPath();for(let l=n;l<a;l+=e+2*n){const n=r+(l+e/2)*s,a=i.frameByTimestamp(n);a&&(o.rect(l-.5,.5,e+1,t+1),this.imageByFrame(a).then(d.bind(this,l)))}function d(i,n){this.drawGeneration===l&&n&&o.drawImage(n,i,1,e,t)}o.strokeStyle="#ddd",o.stroke()}async overviewInfoPromise(e){if(!this.model||!this.model.filmStripModel().frames().length)return null;const t=this.calculator();if(!t)return null;const i=t.positionToTime(e),n=this.model.filmStripModel().frameByTimestamp(i);if(n===this.lastFrame)return this.lastElement;const a=n?this.imageByFrame(n):Promise.resolve(this.emptyImage),r=await a,s=document.createElement("div");return s.classList.add("frame"),r&&s.createChild("div","thumbnail").appendChild(r),this.lastFrame=n,this.lastElement=s,s}reset(){this.lastFrame=null,this.lastElement=null,this.frameToImagePromise=new Map,this.imageWidth=0}static Padding=2}class Q extends j{heapSizeLabel;constructor(){super("memory",_(O.heap)),this.heapSizeLabel=this.element.createChild("div","memory-graph-label")}resetHeapSizeLabels(){this.heapSizeLabel.textContent=""}update(){super.update();const e=window.devicePixelRatio;if(!this.model)return void this.resetHeapSizeLabels();const t=this.model.timelineModel().tracks().filter((e=>e.type===a.TimelineModel.TrackType.MainThread&&e.forMainFrame)).map((e=>e.events)),i=3*e;let r=0,s=1e11;const o=this.model.timelineModel().minimumRecordTime(),l=this.model.timelineModel().maximumRecordTime();function d(e){return e.name===a.TimelineModel.RecordType.UpdateCounters}for(let e=0;e<t.length;e++)t[e]=t[e].filter(d);function c(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(r=Math.max(r,t.jsHeapSizeUsed),s=Math.min(s,t.jsHeapSizeUsed))}for(let e=0;e<t.length;e++)t[e].forEach(c);s=Math.min(s,r);const h=this.width(),m=this.height()-i,u=h/(l-o),p=(m-1)/Math.max(r-s,1),g=new Array(h);function v(e){const t=e.args.data;if(!t||!t.jsHeapSizeUsed)return;const i=Math.round((e.startTime-o)*u),n=Math.round((t.jsHeapSizeUsed-s)*p);g[i]=Math.max(g[i]||0,n)}for(let e=0;e<t.length;e++)t[e].forEach(v);const f=this.context(),T=m+i+1;f.translate(.5,.5),f.beginPath(),f.moveTo(-1,T);let w=0,S=!0,y=0;for(let e=0;e<g.length;e++){if(void 0===g[e])continue;S&&(S=!1,w=g[e],f.lineTo(-1,m-w));const t=g[e];Math.abs(t-w)>2&&Math.abs(e-y)>1&&f.lineTo(e,m-w),w=t,f.lineTo(e,m-w),y=e}f.lineTo(h+1,m-w),f.lineTo(h+1,T),f.closePath(),f.fillStyle="hsla(220, 90%, 70%, 0.2)",f.fill(),f.lineWidth=1,f.strokeStyle="hsl(220, 90%, 70%)",f.stroke(),this.heapSizeLabel.textContent=_(O.sSDash,{PH1:n.NumberUtilities.bytesToString(s),PH2:n.NumberUtilities.bytesToString(r)})}}class Z{lastTime;quantDuration;callback;counters;remainder;constructor(e,t,i){this.lastTime=e,this.quantDuration=t,this.callback=i,this.counters=[],this.remainder=t}appendInterval(e,t){let i=e-this.lastTime;if(i<=this.remainder)return this.counters[t]=(this.counters[t]||0)+i,this.remainder-=i,void(this.lastTime=e);for(this.counters[t]=(this.counters[t]||0)+this.remainder,this.callback(this.counters),i-=this.remainder;i>=this.quantDuration;){const e=[];e[t]=this.quantDuration,this.callback(e),i-=this.quantDuration}this.counters=[],this.counters[t]=i,this.lastTime=e,this.remainder=this.quantDuration-i}}class ee extends j{heapSizeLabel;coverageModel;constructor(){super("coverage",_(O.coverage)),this.heapSizeLabel=this.element.createChild("div","timeline-overview-coverage-label")}resetHeapSizeLabels(){this.heapSizeLabel.textContent=""}setModel(e){if(super.setModel(e),e){const t=e.mainTarget();t&&(this.coverageModel=t.model(p.CoverageModel.CoverageModel))}}update(){super.update();const e=window.devicePixelRatio;if(!this.coverageModel)return;let t=0,i=0;const n=new Map,a=new Map;for(const e of this.coverageModel.entries())for(const r of e.entries()){t+=r.getSize();for(const[e,t]of r.usedByTimestamp()){i+=t;let s=a.get(e);void 0===s&&(s=new Set,a.set(e,s)),s.add(r);const o=n.get(e);void 0===o?n.set(e,t):n.set(e,o+t)}}const r=new Set,s=new Map;let o=0,l=0;const d=Array.from(a.entries()).sort(((e,t)=>e[0]-t[0]));for(const[e,t]of d){for(const e of t.values())r.has(e)||(r.add(e),o+=e.getSize());l+=n.get(e)||0,s.set(e,l/o)}const c=t?Math.round(100*i/t):0,h=3*e;if(!this.model)return;const m=this.model.timelineModel().minimumRecordTime()/1e3,u=this.model.timelineModel().maximumRecordTime()/1e3,p=this.width(),g=this.height()-h,v=p/(u-m),f=g-1;let T=0;const w=this.context(),S=g+h+1;w.translate(.5,.5),w.beginPath(),w.moveTo(-1,S),w.lineTo(-1,g-T);let y=null;for(const e of this.coverageModel.getCoverageUpdateTimes()){const t=s.get(e)||y;if(y=t,!t)continue;if(e>u)break;const i=(e-m)*v;T=t*f,w.lineTo(i,g-T)}const b="hsl(220, 90%, 70%)";w.lineTo(p+1,g-T),w.lineTo(p+1,S),w.closePath(),w.fillStyle="hsla(220, 90%, 70%, 0.2)",w.fill(),w.lineWidth=1,w.strokeStyle=b,w.stroke(),y=null;for(const e of this.coverageModel.getCoverageUpdateTimes()){const t=s.get(e)||y;if(y=t,!t)continue;w.beginPath();const i=(e-m)*v,n=g-t*f;w.arc(i,n,2,0,2*Math.PI,!1),w.closePath(),w.stroke(),w.fillStyle=s.has(e)?b:"hsl(0, 100%, 100%)",w.fill()}this.heapSizeLabel.textContent=`${c}% used`}}var te=Object.freeze({__proto__:null,TimelineEventOverview:j,TimelineEventOverviewInput:q,TimelineEventOverviewNetwork:J,TimelineEventOverviewCPUActivity:$,TimelineEventOverviewResponsiveness:K,TimelineFilmStripOverview:Y,TimelineEventOverviewMemory:Q,Quantizer:Z,TimelineEventOverviewCoverage:ee});class ie extends a.TimelineModelFilter.TimelineModelFilter{minimumRecordDuration;constructor(){super(),this.minimumRecordDuration=0}setMinimumRecordDuration(e){this.minimumRecordDuration=e}accept(e){return(e.endTime?e.endTime-e.startTime:0)>=this.minimumRecordDuration}}class ne extends a.TimelineModelFilter.TimelineModelFilter{constructor(){super()}accept(e){return!ii.eventStyle(e).category.hidden}}class ae extends a.TimelineModelFilter.TimelineModelFilter{regExpInternal;constructor(e){super(),this.setRegExp(e||null)}setRegExp(e){this.regExpInternal=e}regExp(){return this.regExpInternal}accept(e){return!this.regExpInternal||ii.testContentMatching(e,this.regExpInternal)}}var re=Object.freeze({__proto__:null,IsLong:ie,Category:ne,TimelineRegExp:ae});const se={performance:"Performance",filter:"Filter",selfTime:"Self Time",totalTime:"Total Time",activity:"Activity",selectItemForDetails:"Select item for details.",notOptimizedS:"Not optimized: {PH1}",fms:"{PH1} ms",percentPlaceholder:"{PH1} %",chromeExtensionsOverhead:"[`Chrome` extensions overhead]",vRuntime:"[`V8` Runtime]",unattributed:"[unattributed]",javascript:"JavaScript",page:"Page",noGrouping:"No Grouping",groupByActivity:"Group by Activity",groupByCategory:"Group by Category",groupByDomain:"Group by Domain",groupByFrame:"Group by Frame",groupBySubdomain:"Group by Subdomain",groupByUrl:"Group by URL",groupBy:"Group by",filterCallTree:"Filter call tree",filterBottomup:"Filter bottom-up",heaviestStack:"Heaviest stack",showHeaviestStack:"Show Heaviest stack",hideHeaviestStack:"Hide Heaviest stack",heaviestStackShown:"Heaviest stack sidebar shown",heaviestStackHidden:"Heaviest stack sidebar hidden",timelineStack:"Timeline Stack"},oe=i.i18n.registerUIStrings("panels/timeline/TimelineTreeView.ts",se),le=i.i18n.getLocalizedString.bind(void 0,oe);class de extends s.Widget.VBox{modelInternal;track;tree;searchResults;linkifier;dataGrid;lastHoveredProfileNode;textFilterInternal;taskFilter;startTime;endTime;splitWidget;detailsView;searchableView;currentThreadSetting;lastSelectedNodeInternal;textFilterUI;root;currentResult;constructor(){super(),this.modelInternal=null,this.track=null,this.tree=null,this.element.classList.add("timeline-tree-view"),this.searchResults=[]}static eventNameForSorting(e){if(e.name===a.TimelineModel.RecordType.JSFrame){const t=e.args.data;return t.functionName+"@"+(t.scriptId||t.url||"")}return e.name+":@"+a.TimelineProfileTree.eventURL(e)}setSearchableView(e){this.searchableView=e}setModel(e,t){this.modelInternal=e,this.track=t,this.refreshTree()}getToolbarInputAccessiblePlaceHolder(){return""}model(){return this.modelInternal}init(){this.linkifier=new l.Linkifier.Linkifier,this.taskFilter=new a.TimelineModelFilter.ExclusiveNameFilter([a.TimelineModel.RecordType.Task]),this.textFilterInternal=new ae,this.currentThreadSetting=t.Settings.Settings.instance().createSetting("timelineTreeCurrentThread",0),this.currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this.splitWidget=new s.SplitWidget.SplitWidget(!0,!0,"timelineTreeViewDetailsSplitWidget");const i=new s.Widget.VBox,n=new s.Toolbar.Toolbar("",i.element);n.makeWrappable(!0),this.populateToolbar(n),this.dataGrid=new g.SortableDataGrid.SortableDataGrid({displayName:le(se.performance),columns:e,refreshCallback:void 0,editCallback:void 0,deleteCallback:void 0}),this.dataGrid.addEventListener(g.DataGrid.Events.SortingChanged,this.sortingChanged,this),this.dataGrid.element.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.dataGrid.setResizeMethod(g.DataGrid.ResizeMethod.Last),this.dataGrid.setRowContextMenuCallback(this.onContextMenu.bind(this)),this.dataGrid.asWidget().show(i.element),this.dataGrid.addEventListener(g.DataGrid.Events.SelectedNode,this.updateDetailsForSelection,this),this.detailsView=new s.Widget.VBox,this.detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this.splitWidget.setMainWidget(i),this.splitWidget.setSidebarWidget(this.detailsView),this.splitWidget.hideSidebar(),this.splitWidget.show(this.element),this.splitWidget.addEventListener(s.SplitWidget.Events.ShowModeChanged,this.onShowModeChanged,this),this.lastSelectedNodeInternal}lastSelectedNode(){return this.lastSelectedNodeInternal}updateContents(e){this.setRange(e.startTime(),e.endTime())}setRange(e,t){this.startTime=e,this.endTime=t,this.refreshTree()}filters(){return[this.taskFilter,this.textFilterInternal,...this.modelInternal?this.modelInternal.filters():[]]}filtersWithoutTextFilter(){return[this.taskFilter,...this.modelInternal?this.modelInternal.filters():[]]}textFilter(){return this.textFilterInternal}exposePercentages(){return!1}populateToolbar(e){const t=new s.Toolbar.ToolbarInput(le(se.filter),this.getToolbarInputAccessiblePlaceHolder());t.addEventListener(s.Toolbar.ToolbarInput.Event.TextChanged,(()=>{const e=t.value();this.textFilterInternal.setRegExp(e?n.StringUtilities.createPlainTextSearchRegex(e,"i"):null),this.refreshTree()}),this),this.textFilterUI=t,e.appendToolbarItem(t)}modelEvents(){return this.track?this.track.syncEvents():[]}onHover(e){}appendContextMenuItems(e,t){}linkifyLocation(e){if(!this.modelInternal)return null;const t=this.modelInternal.timelineModel().targetByEvent(e);if(!t)return null;const i=a.TimelineProfileTree.eventStackFrame(e);return i?this.linkifier.maybeLinkifyConsoleCallFrame(t,i,{showColumnNumber:!0,inlineFrameIndex:0}):null}selectProfileNode(e,t){const i=[];let n=e;for(;n;n=n.parent)i.push(n);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t&&t.dataGrid&&t.expand()}const a=this.dataGridNodeForTreeNode(e);a&&a.dataGrid&&(a.reveal(),a.select(t))}refreshTree(){if(this.linkifier.reset(),this.dataGrid.rootNode().removeChildren(),!this.modelInternal)return void this.updateDetailsForSelection();this.root=this.buildTree();const e=this.root.children();let t=0,i=0;const n=this.root.totalTime-this.root.selfTime;for(const n of e.values())t=Math.max(t,n.selfTime),i=Math.max(i,n.totalTime);for(const a of e.values()){const e=new he(a,n,t,i,this);this.dataGrid.insertChild(e)}this.sortingChanged(),this.updateDetailsForSelection(),this.searchableView&&this.searchableView.refreshSearch();const a=this.dataGrid.rootNode();a.children.length>0&&a.children[0].select(!0)}buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,t){return new a.TimelineProfileTree.TopDownRootNode(this.modelEvents(),this.filters(),this.startTime,this.endTime,e,t)}populateColumns(e){e.push({id:"self",title:le(se.selfTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:le(se.totalTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:le(se.activity),disclosure:!0,sortable:!0})}sortingChanged(){const e=this.dataGrid.sortColumnId();if(!e)return;let t;switch(e){case"startTime":t=function(e,t){const i=t,n=e.profileNode.event,a=i.profileNode.event;return n.startTime-a.startTime};break;case"self":t=i.bind(null,"selfTime");break;case"total":t=i.bind(null,"totalTime");break;case"activity":t=function(e,t){const i=t,n=e.profileNode.event,a=i.profileNode.event,r=de.eventNameForSorting(n),s=de.eventNameForSorting(a);return r.localeCompare(s)};break;default:return void console.assert(!1,"Unknown sort field: "+e)}function i(e,t,i){const n=i;return t.profileNode[e]-n.profileNode[e]}this.dataGrid.sortNodes(t,!this.dataGrid.isSortOrderAscending())}onShowModeChanged(){this.splitWidget.showMode()!==s.SplitWidget.ShowMode.OnlyMain&&(this.lastSelectedNodeInternal=void 0,this.updateDetailsForSelection())}updateDetailsForSelection(){const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;if(e===this.lastSelectedNodeInternal)return;if(this.lastSelectedNodeInternal=e,this.splitWidget.showMode()===s.SplitWidget.ShowMode.OnlyMain)return;if(this.detailsView.detachChildWidgets(),this.detailsView.element.removeChildren(),e&&this.showDetailsForNode(e))return;const t=this.detailsView.element.createChild("div","full-widget-dimmed-banner");s.UIUtils.createTextChild(t,le(se.selectItemForDetails))}showDetailsForNode(e){return!1}onMouseMove(e){const t=e.target&&e.target instanceof Node?this.dataGrid.dataGridNodeFromNode(e.target):null,i=t&&t._profileNode;i!==this.lastHoveredProfileNode&&(this.lastHoveredProfileNode=i,this.onHover(i))}onContextMenu(e,t){const i=t;i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement);const n=i.profileNode;n&&this.appendContextMenuItems(e,n)}dataGridNodeForTreeNode(e){return me.get(e)||null}searchCanceled(){this.searchResults=[],this.currentResult=0}performSearch(e,t,i){if(this.searchResults=[],this.currentResult=0,!this.root)return;const n=e.toSearchRegex();this.searchResults=this.root.searchTree((e=>ii.testContentMatching(e,n.regex))),this.searchableView.updateSearchMatchesCount(this.searchResults.length)}jumpToNextSearchResult(){this.searchResults.length&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=n.NumberUtilities.mod(this.currentResult+1,this.searchResults.length))}jumpToPreviousSearchResult(){this.searchResults.length&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=n.NumberUtilities.mod(this.currentResult-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}class ce extends g.SortableDataGrid.SortableDataGridNode{populated;profileNode;treeView;grandTotalTime;maxSelfTime;maxTotalTime;linkElement;constructor(e,t,i,n,a){super(null,!1),this.populated=!1,this.profileNode=e,this.treeView=a,this.grandTotalTime=t,this.maxSelfTime=i,this.maxTotalTime=n,this.linkElement=null}createCell(e){return"activity"===e?this.createNameCell(e):this.createValueCell(e)||super.createCell(e)}createNameCell(e){const t=this.createTD(e),i=t.createChild("div","name-container"),n=i.createChild("div","activity-icon-container"),a=n.createChild("div","activity-icon"),r=i.createChild("div","activity-name"),o=this.profileNode.event;if(this.profileNode.isGroupNode()){const e=this.treeView.displayInfoForGroupNode(this.profileNode);r.textContent=e.name,a.style.backgroundColor=e.color,e.icon&&n.insertBefore(e.icon,a)}else if(o){const e=o.args.data,t=e&&e.deoptReason;t&&(i.createChild("div","activity-warning").title=le(se.notOptimizedS,{PH1:t})),r.textContent=ii.eventTitle(o),this.linkElement=this.treeView.linkifyLocation(o),this.linkElement&&i.createChild("div","activity-link").appendChild(this.linkElement);const n=ii.eventStyle(o).category;s.ARIAUtils.setAccessibleName(a,n.title),a.style.backgroundColor=n.color}return t}createValueCell(e){if("self"!==e&&"total"!==e&&"startTime"!==e)return null;let t,i,n,a=!1;switch(e){case"startTime":{n=this.profileNode.event;const e=this.treeView.model();if(!e)throw new Error("Unable to find model for tree view");t=(n?n.startTime:0)-e.timelineModel().minimumRecordTime()}break;case"self":t=this.profileNode.selfTime,i=this.maxSelfTime,a=!0;break;case"total":t=this.profileNode.totalTime,i=this.maxTotalTime,a=!0;break;default:return null}const r=this.createTD(e);r.className="numeric-column",r.setAttribute("title",le(se.fms,{PH1:t.toFixed(4)}));const s=r.createChild("div");return s.createChild("span").textContent=le(se.fms,{PH1:t.toFixed(1)}),a&&this.treeView.exposePercentages()&&(s.createChild("span","percent-column").textContent=le(se.percentPlaceholder,{PH1:(t/this.grandTotalTime*100).toFixed(1)})),i&&(s.classList.add("background-percent-bar"),r.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*t/i).toFixed(1)+"%"),r}}class he extends ce{constructor(e,t,i,n,a){super(e,t,i,n,a),this.setHasChildren(this.profileNode.hasChildren()),me.set(e,this)}populate(){if(!this.populated&&(this.populated=!0,this.profileNode.children))for(const e of this.profileNode.children().values()){const t=new he(e,this.grandTotalTime,this.maxSelfTime,this.maxTotalTime,this.treeView);this.insertChildOrdered(t)}}static gridNodeSymbol=Symbol("treeGridNode")}const me=new WeakMap;class ue extends de{groupBySetting;stackView;productByURLCache;colorByURLCache;executionContextNamesByOrigin;constructor(){super(),this.groupBySetting=t.Settings.Settings.instance().createSetting("timelineTreeGroupBy",ue.GroupBy.None),this.groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this.stackView=new ve(this),this.stackView.addEventListener(ve.Events.SelectionChanged,this.onStackViewSelectionChanged,this),this.productByURLCache=new Map,this.colorByURLCache=new Map,this.executionContextNamesByOrigin=new Map}setModel(e,t){super.setModel(e,t)}updateContents(e){this.updateExtensionResolver(),super.updateContents(e);const t=this.dataGrid.rootNode();t.children.length&&t.children[0].select(!0)}updateExtensionResolver(){this.executionContextNamesByOrigin=new Map;for(const t of e.TargetManager.TargetManager.instance().models(e.RuntimeModel.RuntimeModel))for(const e of t.executionContexts())this.executionContextNamesByOrigin.set(e.origin,e.name)}beautifyDomainName(e){return ue.isExtensionInternalURL(e)?e=le(se.chromeExtensionsOverhead):ue.isV8NativeURL(e)?e=le(se.vRuntime):e.startsWith("chrome-extension")&&(e=this.executionContextNamesByOrigin.get(e)||e),e}displayInfoForGroupNode(e){const t=ii.categories(),i=e.id?ii.eventColor(e.event):t.other.color,n=le(se.unattributed),r="symbol"==typeof e.id?void 0:e.id;switch(this.groupBySetting.get()){case ue.GroupBy.Category:{const e=r?t[r]||t.other:{title:n,color:n};return{name:e.title,color:e.color,icon:void 0}}case ue.GroupBy.Domain:case ue.GroupBy.Subdomain:return{name:(r?this.beautifyDomainName(r):void 0)||n,color:i,icon:void 0};case ue.GroupBy.EventName:if(!e.event)throw new Error("Unable to find event for group by operation");return{name:e.event.name===a.TimelineModel.RecordType.JSFrame?le(se.javascript):ii.eventTitle(e.event),color:e.event.name===a.TimelineModel.RecordType.JSFrame?ii.eventStyle(e.event).category.color:i,icon:void 0};case ue.GroupBy.URL:break;case ue.GroupBy.Frame:{if(!this.modelInternal)throw new Error("Unable to find model for group by frame operation");const e=r?this.modelInternal.timelineModel().pageFrameById(r):void 0;return{name:e?ii.displayNameForFrame(e,80):le(se.page),color:i,icon:void 0}}default:console.assert(!1,"Unexpected grouping type")}return{name:r||n,color:i,icon:void 0}}populateToolbar(e){super.populateToolbar(e);const t=ue.GroupBy,i=[{label:le(se.noGrouping),value:t.None},{label:le(se.groupByActivity),value:t.EventName},{label:le(se.groupByCategory),value:t.Category},{label:le(se.groupByDomain),value:t.Domain},{label:le(se.groupByFrame),value:t.Frame},{label:le(se.groupBySubdomain),value:t.Subdomain},{label:le(se.groupByUrl),value:t.URL}];e.appendToolbarItem(new s.Toolbar.ToolbarSettingComboBox(i,this.groupBySetting,le(se.groupBy))),e.appendSpacer(),e.appendToolbarItem(this.splitWidget.createShowHideSidebarButton(le(se.showHeaviestStack),le(se.hideHeaviestStack),le(se.heaviestStackShown),le(se.heaviestStackHidden)))}buildHeaviestStack(e){console.assert(Boolean(e.parent),"Attempt to build stack for tree root");let t=[];for(let i=e;i&&i.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i&&i.children()&&i.children().size;){const e=Array.from(i.children().values());i=e.reduce(((e,t)=>e.totalTime>t.totalTime?e:t)),t.push(i)}return t}exposePercentages(){return!0}onStackViewSelectionChanged(){const e=this.stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}showDetailsForNode(e){const t=this.buildHeaviestStack(e);return this.stackView.setStack(t,e),this.stackView.show(this.detailsView.element),!0}groupingFunction(e){const t=ue.GroupBy;switch(e){case t.None:return null;case t.EventName:return e=>ii.eventStyle(e).title;case t.Category:return e=>ii.eventStyle(e).category.name;case t.Subdomain:return this.domainByEvent.bind(this,!1);case t.Domain:return this.domainByEvent.bind(this,!0);case t.URL:return e=>a.TimelineProfileTree.eventURL(e)||"";case t.Frame:return e=>a.TimelineModel.TimelineData.forEvent(e).frameId||"";default:return console.assert(!1,`Unexpected aggregation setting: ${e}`),null}}domainByEvent(e,i){const n=a.TimelineProfileTree.eventURL(i);if(!n)return"";if(ue.isExtensionInternalURL(n))return ue.extensionInternalPrefix;if(ue.isV8NativeURL(n))return ue.v8NativePrefix;const r=t.ParsedURL.ParsedURL.fromString(n);if(!r)return"";if("chrome-extension"===r.scheme)return r.scheme+"://"+r.host;if(!e)return r.host;if(/^[.0-9]+$/.test(r.host))return r.host;const s=/([^.]*\.)?[^.]*$/.exec(r.host);return s&&s[0]||""}appendContextMenuItems(e,t){if(this.groupBySetting.get()!==ue.GroupBy.Frame)return;if(!t.isGroupNode())return;if(!this.modelInternal)return;const i=this.modelInternal.timelineModel().pageFrameById(t.id);i&&i.ownerNode&&e.appendApplicableItems(i.ownerNode)}static isExtensionInternalURL(e){return e.startsWith(ue.extensionInternalPrefix)}static isV8NativeURL(e){return e.startsWith(ue.v8NativePrefix)}static extensionInternalPrefix="extensions::";static v8NativePrefix="native "}!function(e){let t;!function(e){e.None="None",e.EventName="EventName",e.Category="Category",e.Domain="Domain",e.Subdomain="Subdomain",e.URL="URL",e.Frame="Frame"}(t=e.GroupBy||(e.GroupBy={}))}(ue||(ue={}));class pe extends ue{constructor(){super(),this.dataGrid.markColumnAsSortedBy("total",g.DataGrid.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return le(se.filterCallTree)}buildTree(){const e=this.groupBySetting.get();return this.buildTopDownTree(!1,this.groupingFunction(e))}}class ge extends ue{constructor(){super(),this.dataGrid.markColumnAsSortedBy("self",g.DataGrid.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return le(se.filterBottomup)}buildTree(){return new a.TimelineProfileTree.BottomUpRootNode(this.modelEvents(),this.textFilter(),this.filtersWithoutTextFilter(),this.startTime,this.endTime,this.groupingFunction(this.groupBySetting.get()))}}class ve extends(t.ObjectWrapper.eventMixin(s.Widget.VBox)){treeView;dataGrid;constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=le(se.heaviestStack),this.treeView=e;const t=[{id:"total",title:le(se.totalTime),fixedWidth:!0,width:"110px"},{id:"activity",title:le(se.activity)}];this.dataGrid=new g.ViewportDataGrid.ViewportDataGrid({displayName:le(se.timelineStack),columns:t,deleteCallback:void 0,editCallback:void 0,refreshCallback:void 0}),this.dataGrid.setResizeMethod(g.DataGrid.ResizeMethod.Last),this.dataGrid.addEventListener(g.DataGrid.Events.SelectedNode,this.onSelectionChanged,this),this.dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this.dataGrid.rootNode();i.removeChildren();let n=null;const a=Math.max.apply(Math,e.map((e=>e.totalTime)));for(const r of e){const e=new ce(r,a,a,a,this.treeView);i.appendChild(e),r===t&&(n=e)}n&&n.revealAndSelect()}selectedTreeNode(){const e=this.dataGrid.selectedNode;return e&&e.profileNode}onSelectionChanged(){this.dispatchEventToListeners(ve.Events.SelectionChanged)}}!function(e){let t;!function(e){e.SelectionChanged="SelectionChanged"}(t=e.Events||(e.Events={}))}(ve||(ve={}));var fe=Object.freeze({__proto__:null,TimelineTreeView:de,GridNode:ce,TreeGridNode:he,get AggregatedTimelineTreeView(){return ue},CallTreeTimelineTreeView:pe,BottomUpTimelineTreeView:ge,get TimelineStackView(){return ve}});const Te={filterEventLog:"Filter event log",startTime:"Start Time",durationFilter:"Duration filter",Dms:"{PH1} ms",all:"All"},we=i.i18n.registerUIStrings("panels/timeline/EventsTimelineTreeView.ts",Te),Se=i.i18n.getLocalizedString.bind(void 0,we);class ye extends de{filtersControl;delegate;currentTree;constructor(e){super(),this.filtersControl=new be,this.filtersControl.addEventListener("FilterChanged",this.onFilterChanged,this),this.init(),this.delegate=e,this.dataGrid.markColumnAsSortedBy("startTime",g.DataGrid.Order.Ascending),this.splitWidget.showBoth()}filters(){return[...super.filters(),...this.filtersControl.filters()]}updateContents(e){if(super.updateContents(e),e.type()===Vt.Type.TraceEvent){const t=e.object();this.selectEvent(t,!0)}}getToolbarInputAccessiblePlaceHolder(){return Se(Te.filterEventLog)}buildTree(){return this.currentTree=this.buildTopDownTree(!0,null),this.currentTree}onFilterChanged(){const e=this.lastSelectedNode(),t=e&&e.event;this.refreshTree(),t&&this.selectEvent(t,!1)}findNodeWithEvent(e){const t=[this.currentTree.children().values()];for(;t.length;){const{done:i,value:n}=t[t.length-1].next();if(i)t.pop();else{if(n.event===e)return n;t.push(n.children().values())}}return null}selectEvent(e,t){const i=this.findNodeWithEvent(e);if(i&&(this.selectProfileNode(i,!1),t)){const e=this.dataGridNodeForTreeNode(i);e&&e.expand()}}populateColumns(e){e.push({id:"startTime",title:Se(Te.startTime),width:"80px",fixedWidth:!0,sortable:!0}),super.populateColumns(e),e.filter((e=>e.fixedWidth)).forEach((e=>{e.width="80px"}))}populateToolbar(e){super.populateToolbar(e),this.filtersControl.populateToolbar(e)}showDetailsForNode(e){const t=e.event;if(!t)return!1;const i=this.model();return!!i&&(ii.buildTraceEventDetails(t,i.timelineModel(),this.linkifier,!1).then((e=>this.detailsView.element.appendChild(e))),!0)}onHover(e){this.delegate.highlightEvent(e&&e.event)}}class be extends t.ObjectWrapper.ObjectWrapper{categoryFilter;durationFilter;filtersInternal;constructor(){super(),this.categoryFilter=new ne,this.durationFilter=new ie,this.filtersInternal=[this.categoryFilter,this.durationFilter]}filters(){return this.filtersInternal}populateToolbar(e){const t=new s.Toolbar.ToolbarComboBox(function(){const e=t.selectedOption().value,i=parseInt(e,10);this.durationFilter.setMinimumRecordDuration(i),this.notifyFiltersChanged()}.bind(this),Se(Te.durationFilter));for(const e of be.durationFilterPresetsMs)t.addOption(t.createOption(e?`≥ ${Se(Te.Dms,{PH1:e})}`:Se(Te.all),String(e)));e.appendToolbarItem(t);const i=new Map,n=ii.categories();for(const t in n){const r=n[t];if(!r.visible)continue;const o=new s.Toolbar.ToolbarCheckbox(r.title,void 0,a.bind(this,t));o.setChecked(!0),o.inputElement.style.backgroundColor=r.color,i.set(r.name,o),e.appendToolbarItem(o)}function a(e){const t=ii.categories(),n=i.get(e);t[e].hidden=!n||!n.checked(),this.notifyFiltersChanged()}}notifyFiltersChanged(){this.dispatchEventToListeners("FilterChanged")}static durationFilterPresetsMs=[0,1,15]}var Ce=Object.freeze({__proto__:null,EventsTimelineTreeView:ye,Filters:be});class ke extends s.SplitWidget.SplitWidget{model;showPaintProfilerCallback;rightSplitWidget;layerViewHost;layers3DView;frameLayerTree;updateWhenVisible;constructor(e,t){super(!0,!1,"timelineLayersView"),this.model=e,this.showPaintProfilerCallback=t,this.element.classList.add("timeline-layers-view"),this.rightSplitWidget=new s.SplitWidget.SplitWidget(!0,!0,"timelineLayersViewDetails"),this.rightSplitWidget.element.classList.add("timeline-layers-view-properties"),this.setMainWidget(this.rightSplitWidget);const i=new s.Widget.VBox;this.setSidebarWidget(i),this.layerViewHost=new v.LayerViewHost.LayerViewHost;const n=new v.LayerTreeOutline.LayerTreeOutline(this.layerViewHost);i.element.appendChild(n.element),this.layers3DView=new v.Layers3DView.Layers3DView(this.layerViewHost),this.layers3DView.addEventListener(v.Layers3DView.Events.PaintProfilerRequested,this.onPaintProfilerRequested,this),this.rightSplitWidget.setMainWidget(this.layers3DView);const a=new v.LayerDetailsView.LayerDetailsView(this.layerViewHost);this.rightSplitWidget.setSidebarWidget(a),a.addEventListener(v.LayerDetailsView.Events.PaintProfilerRequested,this.onPaintProfilerRequested,this)}showLayerTree(e){this.frameLayerTree=e,this.isShowing()?this.update():this.updateWhenVisible=!0}wasShown(){this.updateWhenVisible&&(this.updateWhenVisible=!1,this.update())}async onPaintProfilerRequested(e){const t=e.data,i=await this.layers3DView.snapshotForSelection(t);i&&this.showPaintProfilerCallback(i.snapshot)}update(){this.frameLayerTree&&this.frameLayerTree.layerTreePromise().then((e=>this.layerViewHost.setLayerTree(e)))}}var Pe=Object.freeze({__proto__:null,TimelineLayersView:ke});const Me=new CSSStyleSheet;Me.replaceSync(".paint-profiler-image-view{overflow:hidden}.paint-profiler-image-view .paint-profiler-image-container{transform-origin:0 0}.paint-profiler-image-view .paint-profiler-image-container div{border-color:var(--color-details-hairline);border-style:solid;z-index:100;position:absolute;top:0;left:0}.paint-profiler-image-view img{border:solid 1px var(--color-background-inverted)}\n/*# sourceURL=timelinePaintProfiler.css */\n");class xe extends s.SplitWidget.SplitWidget{frameModel;logAndImageSplitWidget;imageView;paintProfilerView;logTreeView;needsUpdateWhenVisible;pendingSnapshot;event;paintProfilerModel;lastLoadedSnapshot;constructor(e){super(!1,!1),this.element.classList.add("timeline-paint-profiler-view"),this.setSidebarSize(60),this.setResizable(!1),this.frameModel=e,this.logAndImageSplitWidget=new s.SplitWidget.SplitWidget(!0,!1),this.logAndImageSplitWidget.element.classList.add("timeline-paint-profiler-log-split"),this.setMainWidget(this.logAndImageSplitWidget),this.imageView=new Ie,this.logAndImageSplitWidget.setMainWidget(this.imageView),this.paintProfilerView=new v.PaintProfilerView.PaintProfilerView(this.imageView.showImage.bind(this.imageView)),this.paintProfilerView.addEventListener(v.PaintProfilerView.Events.WindowChanged,this.onWindowChanged,this),this.setSidebarWidget(this.paintProfilerView),this.logTreeView=new v.PaintProfilerView.PaintProfilerCommandLogView,this.logAndImageSplitWidget.setSidebarWidget(this.logTreeView),this.needsUpdateWhenVisible=!1,this.pendingSnapshot=null,this.event=null,this.paintProfilerModel=null,this.lastLoadedSnapshot=null}wasShown(){super.wasShown(),this.needsUpdateWhenVisible&&(this.needsUpdateWhenVisible=!1,this.update())}setSnapshot(e){this.releaseSnapshot(),this.pendingSnapshot=e,this.event=null,this.updateWhenVisible()}setEvent(e,t){return this.releaseSnapshot(),this.paintProfilerModel=e,this.pendingSnapshot=null,this.event=t,this.updateWhenVisible(),this.event.name===a.TimelineModel.RecordType.Paint?Boolean(a.TimelineModel.TimelineData.forEvent(t).picture):this.event.name===a.TimelineModel.RecordType.RasterTask&&this.frameModel.hasRasterTile(this.event)}updateWhenVisible(){this.isShowing()?this.update():this.needsUpdateWhenVisible=!0}update(){let e;if(this.logTreeView.setCommandLog([]),this.paintProfilerView.setSnapshotAndLog(null,[],null),this.pendingSnapshot)e=Promise.resolve({rect:null,snapshot:this.pendingSnapshot});else if(this.event&&this.event.name===a.TimelineModel.RecordType.Paint){e=a.TimelineModel.TimelineData.forEvent(this.event).picture.objectPromise().then((e=>this.paintProfilerModel.loadSnapshot(e.skp64))).then((e=>e&&{rect:null,snapshot:e}))}else{if(!this.event||this.event.name!==a.TimelineModel.RecordType.RasterTask)return void console.assert(!1,"Unexpected event type or no snapshot");e=this.frameModel.rasterTilePromise(this.event)}function t(e,t,i){this.logTreeView.setCommandLog(i||[]),this.paintProfilerView.setSnapshotAndLog(e,i||[],t)}e.then((e=>{if(this.releaseSnapshot(),!e)return void this.imageView.showImage();const i=e.snapshot;this.lastLoadedSnapshot=i,this.imageView.setMask(e.rect),i.commandLog().then((n=>t.call(this,i,e.rect,n||[])))}))}releaseSnapshot(){this.lastLoadedSnapshot&&(this.lastLoadedSnapshot.release(),this.lastLoadedSnapshot=null)}onWindowChanged(){this.logTreeView.updateWindow(this.paintProfilerView.selectionWindow())}}class Ie extends s.Widget.Widget{imageContainer;imageElement;maskElement;transformController;maskRectangle;constructor(){super(!0),this.contentElement.classList.add("fill","paint-profiler-image-view"),this.imageContainer=this.contentElement.createChild("div","paint-profiler-image-container"),this.imageElement=this.imageContainer.createChild("img"),this.maskElement=this.imageContainer.createChild("div"),this.imageElement.addEventListener("load",this.updateImagePosition.bind(this),!1),this.transformController=new v.TransformController.TransformController(this.contentElement,!0),this.transformController.addEventListener(v.TransformController.Events.TransformChanged,this.updateImagePosition,this)}onResize(){this.imageElement.src&&this.updateImagePosition()}updateImagePosition(){const e=this.imageElement.naturalWidth,t=this.imageElement.naturalHeight,i=this.contentElement.clientWidth,n=this.contentElement.clientHeight,a=.1*i,r=.1*n,o=(i-a)/e,l=(n-r)/t,d=Math.min(o,l);if(this.maskRectangle){const i=this.maskElement.style;i.width=e+"px",i.height=t+"px",i.borderLeftWidth=this.maskRectangle.x+"px",i.borderTopWidth=this.maskRectangle.y+"px",i.borderRightWidth=e-this.maskRectangle.x-this.maskRectangle.width+"px",i.borderBottomWidth=t-this.maskRectangle.y-this.maskRectangle.height+"px"}this.transformController.setScaleConstraints(.5,10/d);let c=(new WebKitCSSMatrix).scale(this.transformController.scale(),this.transformController.scale()).translate(i/2,n/2).scale(d,d).translate(-e/2,-t/2);const h=s.Geometry.boundsForTransformedPoints(c,[0,0,0,e,t,0]);this.transformController.clampOffsets(a-h.maxX,i-a-h.minX,r-h.maxY,n-r-h.minY),c=(new WebKitCSSMatrix).translate(this.transformController.offsetX(),this.transformController.offsetY()).multiply(c),this.imageContainer.style.webkitTransform=c.toString()}showImage(e){this.imageContainer.classList.toggle("hidden",!e),e&&(this.imageElement.src=e)}setMask(e){this.maskRectangle=e,this.maskElement.classList.toggle("hidden",!e)}wasShown(){super.wasShown(),this.registerCSSFiles([Me])}}var Re=Object.freeze({__proto__:null,TimelinePaintProfilerView:xe,TimelinePaintImageView:Ie});const Ee={summary:"Summary",bottomup:"Bottom-Up",callTree:"Call Tree",eventLog:"Event Log",estimated:"estimated",totalBlockingTimeSmss:"Total blocking time: {PH1}ms{PH2}",learnMore:"Learn more",layers:"Layers",paintProfiler:"Paint Profiler",rangeSS:"Range:  {PH1} – {PH2}"},Le=i.i18n.registerUIStrings("panels/timeline/TimelineDetailsView.ts",Ee),Fe=i.i18n.getLocalizedString.bind(void 0,Le);class De extends s.Widget.VBox{detailsLinkifier;tabbedPane;defaultDetailsWidget;defaultDetailsContentElement;rangeDetailViews;additionalMetricsToolbar;model;track;lazyPaintProfilerView;lazyLayersView;preferredTabId;selection;constructor(e){super(),this.element.classList.add("timeline-details"),this.detailsLinkifier=new l.Linkifier.Linkifier,this.tabbedPane=new s.TabbedPane.TabbedPane,this.tabbedPane.show(this.element),this.defaultDetailsWidget=new s.Widget.VBox,this.defaultDetailsWidget.element.classList.add("timeline-details-view"),this.defaultDetailsContentElement=this.defaultDetailsWidget.element.createChild("div","timeline-details-view-body vbox"),this.appendTab(Ue.Details,Fe(Ee.summary),this.defaultDetailsWidget),this.setPreferredTab(Ue.Details),this.rangeDetailViews=new Map;const t=new ge;this.appendTab(Ue.BottomUp,Fe(Ee.bottomup),t),this.rangeDetailViews.set(Ue.BottomUp,t);const i=new pe;this.appendTab(Ue.CallTree,Fe(Ee.callTree),i),this.rangeDetailViews.set(Ue.CallTree,i);const n=new ye(e);this.appendTab(Ue.EventLog,Fe(Ee.eventLog),n),this.rangeDetailViews.set(Ue.EventLog,n),this.additionalMetricsToolbar=new s.Toolbar.Toolbar("timeline-additional-metrics"),this.element.appendChild(this.additionalMetricsToolbar.element),this.tabbedPane.addEventListener(s.TabbedPane.Events.TabSelected,this.tabSelected,this)}setModel(e,t){this.model!==e&&(this.model&&this.model.removeEventListener(ui.WindowChanged,this.onWindowChanged,this),this.model=e,this.model&&this.model.addEventListener(ui.WindowChanged,this.onWindowChanged,this)),this.track=t,this.tabbedPane.closeTabs([Ue.PaintProfiler,Ue.LayerViewer],!1);for(const i of this.rangeDetailViews.values())i.setModel(e,t);if(this.lazyPaintProfilerView=null,this.lazyLayersView=null,this.setSelection(null),this.additionalMetricsToolbar.removeToolbarItems(),e&&e.timelineModel()){const{estimated:t,time:i}=e.timelineModel().totalBlockingTime(),n=t?` (${Fe(Ee.estimated)})`:"",a=Fe(Ee.totalBlockingTimeSmss,{PH1:i.toFixed(2),PH2:n}),r=document.createElement("span"),o=s.XLink.XLink.create("https://web.dev/tbt/",Fe(Ee.learnMore));o.style.marginRight="2px",r.appendChild(o),this.additionalMetricsToolbar.appendText(a),this.additionalMetricsToolbar.appendToolbarItem(new s.Toolbar.ToolbarItem(r))}}setContent(e){const t=this.tabbedPane.otherTabs(Ue.Details);for(let e=0;e<t.length;++e)this.rangeDetailViews.has(t[e])||this.tabbedPane.closeTab(t[e]);this.defaultDetailsContentElement.removeChildren(),this.defaultDetailsContentElement.appendChild(e)}updateContents(){const e=this.rangeDetailViews.get(this.tabbedPane.selectedTabId||"");if(e){const t=this.model.window();e.updateContents(this.selection||Vt.fromRange(t.left,t.right))}}appendTab(e,t,i,n){this.tabbedPane.appendTab(e,t,i,void 0,void 0,n),this.preferredTabId!==this.tabbedPane.selectedTabId&&this.tabbedPane.selectTab(e)}headerElement(){return this.tabbedPane.headerElement()}setPreferredTab(e){this.preferredTabId=e}onWindowChanged(){this.selection||this.updateContentsFromWindow()}updateContentsFromWindow(){if(!this.model)return void this.setContent(s.Fragment.html`<div>`);const e=this.model.window();this.updateSelectedRangeStats(e.left,e.right),this.updateContents()}setSelection(e){if(this.detailsLinkifier.reset(),this.selection=e,this.selection){switch(this.selection.type()){case Vt.Type.TraceEvent:{const e=this.selection.object();ii.buildTraceEventDetails(e,this.model.timelineModel(),this.detailsLinkifier,!0).then((t=>this.appendDetailsTabsForTraceEventAndShowDetails(e,t)));break}case Vt.Type.Frame:{const e=this.selection.object(),t=this.model.filmStripModelFrame(e);if(this.setContent(ii.generateDetailsContentForFrame(e,t)),e.layerTree){const t=this.layersView();t.showLayerTree(e.layerTree),this.tabbedPane.hasTab(Ue.LayerViewer)||this.appendTab(Ue.LayerViewer,Fe(Ee.layers),t)}break}case Vt.Type.NetworkRequest:{const e=this.selection.object();ii.buildNetworkRequestDetails(e,this.model.timelineModel(),this.detailsLinkifier).then(this.setContent.bind(this));break}case Vt.Type.Range:this.updateSelectedRangeStats(this.selection.startTime(),this.selection.endTime())}this.updateContents()}else this.updateContentsFromWindow()}tabSelected(e){e.data.isUserGesture&&(this.setPreferredTab(e.data.tabId),this.updateContents())}layersView(){return this.lazyLayersView||(this.lazyLayersView=new ke(this.model.timelineModel(),this.showSnapshotInPaintProfiler.bind(this))),this.lazyLayersView}paintProfilerView(){return this.lazyPaintProfilerView||(this.lazyPaintProfilerView=new xe(this.model.frameModel())),this.lazyPaintProfilerView}showSnapshotInPaintProfiler(e){const t=this.paintProfilerView();t.setSnapshot(e),this.tabbedPane.hasTab(Ue.PaintProfiler)||this.appendTab(Ue.PaintProfiler,Fe(Ee.paintProfiler),t,!0),this.tabbedPane.selectTab(Ue.PaintProfiler,!0)}appendDetailsTabsForTraceEventAndShowDetails(e,t){this.setContent(t),e.name!==a.TimelineModel.RecordType.Paint&&e.name!==a.TimelineModel.RecordType.RasterTask||this.showEventInPaintProfiler(e)}showEventInPaintProfiler(t){const i=e.TargetManager.TargetManager.instance().models(e.PaintProfiler.PaintProfilerModel)[0];if(!i)return;const n=this.paintProfilerView();n.setEvent(i,t)&&(this.tabbedPane.hasTab(Ue.PaintProfiler)||this.appendTab(Ue.PaintProfiler,Fe(Ee.paintProfiler),n))}updateSelectedRangeStats(e,t){if(!this.model||!this.track)return;const n=ii.statsForTimeRange(this.track.syncEvents(),e,t),a=e-this.model.timelineModel().minimumRecordTime(),r=t-this.model.timelineModel().minimumRecordTime(),s=new ci(null,null);s.addSection(Fe(Ee.rangeSS,{PH1:i.TimeUtilities.millisToString(a),PH2:i.TimeUtilities.millisToString(r)}));const o=ii.generatePieChart(n);s.appendElementRow("",o),this.setContent(s.fragment)}}var Ue;!function(e){e.Details="Details",e.EventLog="EventLog",e.CallTree="CallTree",e.BottomUp="BottomUp",e.PaintProfiler="PaintProfiler",e.LayerViewer="LayerViewer"}(Ue||(Ue={}));var He=Object.freeze({__proto__:null,TimelineDetailsView:De,get Tab(){return Ue}});const We=new CSSStyleSheet;We.replaceSync(".timeline-flamechart-popover{overflow:hidden}.timeline-flamechart-popover span{margin-right:5px}.timeline-flamechart-popover span.timeline-info-network-time{color:var(--color-primary)}.timeline-flamechart-popover span.timeline-info-time{color:var(--color-accent-green)}.timeline-flamechart-popover span.timeline-info-warning{color:var(--color-accent-red)}.timeline-flamechart-popover span.timeline-info-warning *{color:inherit}\n/*# sourceURL=timelineFlamechartPopover.css */\n");const Ve={onIgnoreList:"On ignore list",animation:"Animation",userInteractions:"Interactions",timings:"Timings",console:"Console",mainS:"Main — {PH1}",main:"Main",frameS:"Frame — {PH1}",subframe:"Subframe",raster:"Raster",rasterizerThreadS:"Rasterizer Thread {PH1}",gpu:"GPU",thread:"Thread",experience:"Experience",frames:"Frames",sSelfS:"{PH1} (self {PH2})",occurrencesS:"Occurrences: {PH1}",idleFrame:"Idle Frame",droppedFrame:"Dropped Frame",partiallyPresentedFrame:"Partially Presented Frame",frame:"Frame",longFrame:"Long frame",threadS:"Thread {PH1}"},Be=i.i18n.registerUIStrings("panels/timeline/TimelineFlameChartDataProvider.ts",Ve),Ne=i.i18n.getLocalizedString.bind(void 0,Be);class Ae extends t.ObjectWrapper.ObjectWrapper{font;droppedFramePatternCanvas;partialFramePatternCanvas;timelineDataInternal;currentLevel;performanceModel;model;minimumBoundaryInternal;maximumBoundary;timeSpan;consoleColorGenerator;extensionColorGenerator;headerLevel1;headerLevel2;staticHeader;framesHeader;collapsibleTimingsHeader;timingsHeader;screenshotsHeader;animationsHeader;userInteractionsHeader;experienceHeader;flowEventIndexById;entryData;entryTypeByLevel;markers;asyncColorByInteractionPhase;screenshotImageCache;extensionInfo;entryIndexToTitle;asyncColorByCategory;lastInitiatorEntry;entryParent;frameGroup;lastSelection;colorForEvent;constructor(){super(),this.reset(),this.font="11px "+d.Platform.fontFamily(),this.droppedFramePatternCanvas=document.createElement("canvas"),this.partialFramePatternCanvas=document.createElement("canvas"),this.preparePatternCanvas(),this.timelineDataInternal=null,this.currentLevel=0,this.performanceModel=null,this.model=null,this.minimumBoundaryInternal=0,this.maximumBoundary=0,this.timeSpan=0,this.consoleColorGenerator=new t.Color.Generator({min:30,max:55,count:void 0},{min:70,max:100,count:6},50,.7),this.extensionColorGenerator=new t.Color.Generator({min:210,max:300,count:void 0},{min:70,max:100,count:6},70,.7),this.headerLevel1=this.buildGroupStyle({shareHeaderLine:!1}),this.headerLevel2=this.buildGroupStyle({padding:2,nestingLevel:1,collapsible:!1}),this.staticHeader=this.buildGroupStyle({collapsible:!1}),this.framesHeader=this.buildGroupStyle({useFirstLineForOverview:!0}),this.collapsibleTimingsHeader=this.buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!0}),this.timingsHeader=this.buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!1}),this.screenshotsHeader=this.buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),this.animationsHeader=this.buildGroupStyle({useFirstLineForOverview:!1}),this.userInteractionsHeader=this.buildGroupStyle({shareHeaderLine:!1,useFirstLineForOverview:!0,collapsible:!1}),this.experienceHeader=this.buildGroupStyle({collapsible:!1}),f.ThemeSupport.instance().addEventListener(f.ThemeChangeEvent.eventName,(()=>{const e=[this.headerLevel1,this.headerLevel2,this.staticHeader,this.framesHeader,this.collapsibleTimingsHeader,this.timingsHeader,this.screenshotsHeader,this.animationsHeader,this.userInteractionsHeader,this.experienceHeader];for(const t of e)t.color=f.ThemeSupport.instance().getComputedValue("--color-text-primary"),t.backgroundColor=f.ThemeSupport.instance().getComputedValue("--color-background")})),this.flowEventIndexById=new Map}buildGroupStyle(e){const t={padding:4,height:17,collapsible:!0,color:f.ThemeSupport.instance().getComputedValue("--color-text-primary"),backgroundColor:f.ThemeSupport.instance().getComputedValue("--color-background"),font:this.font,nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}setModel(e){this.reset(),this.performanceModel=e,this.model=e&&e.timelineModel()}groupTrack(e){return e.track||null}navStartTimes(){return this.model?this.model.navStartTimes():new Map}entryTitle(t){const i=je,n=this.entryType(t);if(n===i.Event){const i=this.entryData[t];return i.phase===e.TracingModel.Phase.AsyncStepInto||i.phase===e.TracingModel.Phase.AsyncStepPast?i.name+":"+i.args.step:Oe.get(i)?Ne(Ve.onIgnoreList):this.performanceModel&&this.performanceModel.timelineModel().isMarkerEvent(i)?ii.markerShortTitle(i):ii.eventTitle(i)}if(n===i.ExtensionEvent){return this.entryData[t].name}if(n===i.Screenshot)return"";let a=this.entryIndexToTitle[t];return a||(a=`Unexpected entryIndex ${t}`,console.error(a)),a}textColor(e){const t=this.entryData[e];return t&&Oe.get(t)?"#888":rt.textColor}entryFont(e){return this.font}reset(){this.currentLevel=0,this.timelineDataInternal=null,this.entryData=[],this.entryParent=[],this.entryTypeByLevel=[],this.entryIndexToTitle=[],this.markers=[],this.asyncColorByCategory=new Map,this.asyncColorByInteractionPhase=new Map,this.extensionInfo=[],this.screenshotImageCache=new Map}maxStackDepth(){return this.currentLevel}timelineData(){return this.timelineDataInternal?this.timelineDataInternal:(this.timelineDataInternal=new r.FlameChart.TimelineData([],[],[],[]),this.model?(this.flowEventIndexById.clear(),this.minimumBoundaryInternal=this.model.minimumRecordTime(),this.timeSpan=this.model.isEmpty()?1e3:this.model.maximumRecordTime()-this.minimumBoundaryInternal,this.currentLevel=0,this.model.isGenericTrace()?this.processGenericTrace():this.processInspectorTrace(),this.timelineDataInternal):this.timelineDataInternal)}processGenericTrace(){const e=this.buildGroupStyle({shareHeaderLine:!1}),t=this.buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),i=je.Event,r=new n.MapUtilities.Multimap;if(this.model){for(const e of this.model.tracks())null!==e.thread?r.set(e.thread.process(),e):console.error("Failed to process track");for(const n of r.keysArray()){if(r.size>1){const t=`${n.name()} ${n.id()}`;this.appendHeader(t,e,!1)}for(const e of r.get(n)){const n=this.appendSyncEvents(e,e.events,e.name,t,i,!0);!this.timelineDataInternal||this.timelineDataInternal.selectedGroup&&e.name!==a.TimelineModel.TimelineModelImpl.BrowserMainThreadName||(this.timelineDataInternal.selectedGroup=n)}}}}processInspectorTrace(){this.appendFrames(),this.appendInteractionRecords();const e=je.Event,t=e=>{switch(e.type){case a.TimelineModel.TrackType.Animation:return 0;case a.TimelineModel.TrackType.Timings:return 1;case a.TimelineModel.TrackType.UserInteractions:return 2;case a.TimelineModel.TrackType.Console:return 3;case a.TimelineModel.TrackType.Experience:return 4;case a.TimelineModel.TrackType.MainThread:return e.forMainFrame?5:6;case a.TimelineModel.TrackType.Worker:return 7;case a.TimelineModel.TrackType.Raster:return 8;case a.TimelineModel.TrackType.GPU:return 9;case a.TimelineModel.TrackType.Other:return 10;default:return-1}};if(!this.model)return;const i=this.model.tracks().slice();i.sort(((e,i)=>t(e)-t(i)));let n=0;for(const t of i)switch(t.type){case a.TimelineModel.TrackType.UserInteractions:this.appendAsyncEventsGroup(t,Ne(Ve.userInteractions),t.asyncEvents,this.userInteractionsHeader,e,!1);break;case a.TimelineModel.TrackType.Animation:this.appendAsyncEventsGroup(t,Ne(Ve.animation),t.asyncEvents,this.animationsHeader,e,!1);break;case a.TimelineModel.TrackType.Timings:{const i=t.asyncEvents.length>0?this.collapsibleTimingsHeader:this.timingsHeader;this.appendHeader(Ne(Ve.timings),i,!0).track=t,this.appendPageMetrics(),this.copyPerfMarkEvents(t),this.appendSyncEvents(t,t.events,null,null,e,!0),this.appendAsyncEventsGroup(t,null,t.asyncEvents,null,e,!0);break}case a.TimelineModel.TrackType.Console:this.appendAsyncEventsGroup(t,Ne(Ve.console),t.asyncEvents,this.headerLevel1,e,!0);break;case a.TimelineModel.TrackType.MainThread:if(t.forMainFrame){const i=this.appendSyncEvents(t,t.events,t.url?Ne(Ve.mainS,{PH1:t.url}):Ne(Ve.main),this.headerLevel1,e,!0);i&&this.timelineDataInternal&&(this.timelineDataInternal.selectedGroup=i)}else this.appendSyncEvents(t,t.events,t.url?Ne(Ve.frameS,{PH1:t.url}):Ne(Ve.subframe),this.headerLevel1,e,!0);break;case a.TimelineModel.TrackType.Worker:this.appendSyncEvents(t,t.events,t.name,this.headerLevel1,e,!0);break;case a.TimelineModel.TrackType.Raster:n||this.appendHeader(Ne(Ve.raster),this.headerLevel1,!1),++n,this.appendSyncEvents(t,t.events,Ne(Ve.rasterizerThreadS,{PH1:n}),this.headerLevel2,e,!0);break;case a.TimelineModel.TrackType.GPU:this.appendSyncEvents(t,t.events,Ne(Ve.gpu),this.headerLevel1,e,!0);break;case a.TimelineModel.TrackType.Other:this.appendSyncEvents(t,t.events,t.name||Ne(Ve.thread),this.headerLevel1,e,!0),this.appendAsyncEventsGroup(t,t.name,t.asyncEvents,this.headerLevel1,e,!0);break;case a.TimelineModel.TrackType.Experience:this.appendSyncEvents(t,t.events,Ne(Ve.experience),this.experienceHeader,e,!0)}this.timelineDataInternal&&this.timelineDataInternal.selectedGroup&&(this.timelineDataInternal.selectedGroup.expanded=!0);for(let e=0;e<this.extensionInfo.length;e++)this.innerAppendExtensionEvents(e);this.markers.sort(((e,t)=>e.startTime()-t.startTime())),this.timelineDataInternal&&(this.timelineDataInternal.markers=this.markers),this.flowEventIndexById.clear()}minimumBoundary(){return this.minimumBoundaryInternal}totalTime(){return this.timeSpan}search(t,i,n){const a=[],r=je;this.timelineData();for(let e=0;e<this.entryData.length;++e){if(this.entryType(e)!==r.Event)continue;const s=this.entryData[e];s.startTime>i||((s.endTime||s.startTime)<t||n.accept(s)&&a.push(e))}return a.sort(((t,i)=>e.TracingModel.Event.compareStartTime(this.entryData[t],this.entryData[i]))),a}appendSyncEvents(t,i,n,r,s,o){if(!i.length)return null;if(!this.performanceModel||!this.model)return null;const l=s===je.ExtensionEvent,d=[],h=!l&&c.Runtime.experiments.isEnabled("ignoreListJSFramesOnTimeline");let m=0,u=null;t&&t.type===a.TimelineModel.TrackType.MainThread&&(u=this.appendHeader(n,r,o),u.track=t);for(let s=0;s<i.length;++s){const c=i[s];if(this.performanceModel){const e=this.performanceModel.timelineModel().isInteractiveTimeEvent(c),i=this.performanceModel.timelineModel().isLayoutShiftEvent(c),n=e||i;if(t&&t.type===a.TimelineModel.TrackType.MainThread&&n)continue}if(this.performanceModel&&this.performanceModel.timelineModel().isLayoutShiftEvent(c))for(const e of this.performanceModel.frames()){void 0===c.endTime&&c.setEndTime(c.startTime);const t=c.startTime>=e.startTime,i=c.endTime&&c.endTime<=e.endTime;t&&i&&(c.startTime=e.startTime,c.setEndTime(e.endTime))}if(!l&&this.performanceModel.timelineModel().isMarkerEvent(c)&&this.markers.push(new st(c.startTime,c.startTime-this.model.minimumRecordTime(),ii.markerStyleForEvent(c))),!e.TracingModel.TracingModel.isFlowPhase(c.phase)){if(!c.endTime&&c.phase!==e.TracingModel.Phase.Instant)continue;if(e.TracingModel.TracingModel.isAsyncPhase(c.phase))continue;if(!l&&!this.performanceModel.isVisible(c))continue}for(;d.length&&d[d.length-1].endTime<=c.startTime;)d.pop();if(Oe.set(c,!1),h&&this.isIgnoreListedEvent(c)){const e=d[d.length-1];if(e&&Oe.get(e))continue;Oe.set(c,!0)}!u&&n&&(u=this.appendHeader(n,r,o),o&&(u.track=t));const p=this.currentLevel+d.length,g=this.appendEvent(c,p);d.length&&(this.entryParent[g]=d[d.length-1]),!l&&this.performanceModel.timelineModel().isMarkerEvent(c)&&(this.timelineDataInternal.entryTotalTimes[this.entryData.length]=void 0),m=Math.max(m,d.length+1),c.endTime&&d.push(c)}return this.entryTypeByLevel.length=this.currentLevel+m,this.entryTypeByLevel.fill(s,this.currentLevel),this.currentLevel+=m,u}isIgnoreListedEvent(e){if(e.name!==a.TimelineModel.RecordType.JSFrame)return!1;const t=e.args.data.url;return t&&this.isIgnoreListedURL(t)}isIgnoreListedURL(e){return o.IgnoreListManager.IgnoreListManager.instance().isUserIgnoreListedURL(e)}appendAsyncEventsGroup(e,t,i,n,a,r){if(!i.length)return null;const s=[];let o=null;for(let a=0;a<i.length;++a){const l=i[a];if(!this.performanceModel||!this.performanceModel.isVisible(l))continue;!o&&t&&(o=this.appendHeader(t,n,r),r&&(o.track=e));const d=l.startTime;let c;for(c=0;c<s.length&&s[c]>d;++c);this.appendAsyncEvent(l,this.currentLevel+c),s[c]=l.endTime}return this.entryTypeByLevel.length=this.currentLevel+s.length,this.entryTypeByLevel.fill(a,this.currentLevel),this.currentLevel+=s.length,o}appendInteractionRecords(){if(!this.performanceModel)return;const e=this.performanceModel.interactionRecords();if(e.length){for(const t of e){const e=this.entryData.length;this.entryData.push(t.data),this.entryIndexToTitle[e]=t.data,this.timelineDataInternal&&(this.timelineDataInternal.entryLevels[e]=this.currentLevel,this.timelineDataInternal.entryTotalTimes[e]=t.end-t.begin,this.timelineDataInternal.entryStartTimes[e]=t.begin)}this.entryTypeByLevel[this.currentLevel++]=je.InteractionRecord}}appendPageMetrics(){if(this.entryTypeByLevel[this.currentLevel]=je.Event,!this.performanceModel||!this.model)return;const t=[],i=[],n=[],a=this.performanceModel.timelineModel();for(const e of this.model.tracks())for(const r of e.events)a.isLayoutShiftEvent(r)&&n.push(r),a.isMarkerEvent(r)&&(a.isLCPCandidateEvent(r)||a.isLCPInvalidateEvent(r)?i.push(r):t.push(r));if(i.length>0){const e=new Map;for(const t of i){const i=t.args.data.navigationId,n=e.get(i);(!n||n.args.data.candidateIndex<t.args.data.candidateIndex)&&e.set(i,t)}const n=Array.from(e.values()).filter((e=>a.isLCPCandidateEvent(e)));t.push(...n)}if(n.length&&mi(n),t.sort(e.TracingModel.Event.compareStartTime),this.timelineDataInternal){const e=this.timelineDataInternal.entryTotalTimes;for(const i of t)this.appendEvent(i,this.currentLevel),e[e.length-1]=Number.NaN}++this.currentLevel}copyPerfMarkEvents(t){if(this.entryTypeByLevel[this.currentLevel]=je.Event,!this.performanceModel||!this.model||!t)return;const i=this.performanceModel.timelineModel(),n=["workerStart","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","navigationStart","unloadEventStart","unloadEventEnd","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","domLoading","domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"];for(const r of this.model.tracks())if(r.type===a.TimelineModel.TrackType.MainThread)for(const a of r.events)if(i.isUserTimingEvent(a)){if(n.includes(a.name))continue;if(e.TracingModel.TracingModel.isAsyncPhase(a.phase))continue;a.setEndTime(a.startTime),t.events.push(a)}++this.currentLevel}appendFrames(){if(!this.performanceModel||!this.timelineDataInternal||!this.model)return;const e=this.performanceModel.filmStripModel().frames(),t=Boolean(e.length);this.framesHeader.collapsible=t,this.appendHeader(Ne(Ve.frames),this.framesHeader,!1),this.frameGroup=this.timelineDataInternal.groups[this.timelineDataInternal.groups.length-1];const i=ii.markerStyleForFrame();this.entryTypeByLevel[this.currentLevel]=je.Frame;for(const e of this.performanceModel.frames())this.markers.push(new st(e.startTime,e.startTime-this.model.minimumRecordTime(),i)),this.appendFrame(e);if(++this.currentLevel,!t)return;let n;this.appendHeader("",this.screenshotsHeader,!1),this.entryTypeByLevel[this.currentLevel]=je.Screenshot;for(const t of e)this.entryData.push(t),this.timelineDataInternal.entryLevels.push(this.currentLevel),this.timelineDataInternal.entryStartTimes.push(t.timestamp),n&&this.timelineDataInternal.entryTotalTimes.push(t.timestamp-n),n=t.timestamp;e.length&&void 0!==n&&this.timelineDataInternal.entryTotalTimes.push(this.model.maximumRecordTime()-n),++this.currentLevel}entryType(e){return this.entryTypeByLevel[this.timelineDataInternal.entryLevels[e]]}prepareHighlightedEntryInfo(e){let t,n,a="",r="timeline-info-time";const l=this.entryType(e);if(l===je.Event){const r=this.entryData[e],s=r.duration,l=r.selfTime,d=1e-6;if("number"==typeof s&&(a=Math.abs(s-l)>d&&l>d?Ne(Ve.sSelfS,{PH1:i.TimeUtilities.millisToString(s,!0),PH2:i.TimeUtilities.millisToString(l,!0)}):i.TimeUtilities.millisToString(s,!0)),t=this.performanceModel&&this.performanceModel.timelineModel().isMarkerEvent(r)?ii.eventTitle(r):this.entryTitle(e),n=ii.eventWarning(r),this.model&&this.model.isLayoutShiftEvent(r)){a=Ne(Ve.occurrencesS,{PH1:1})}if(this.model&&this.model.isParseHTMLEvent(r)){const e=r.args.beginData.startLine,i=r.args.endData&&r.args.endData.endLine;t+=` - ${o.ResourceUtils.displayNameForURL(r.args.beginData.url)} [${-1!==i||i===e?`${e}...${i}`:e}]`}}else{if(l!==je.Frame)return null;{const s=this.entryData[e];a=i.TimeUtilities.preciseMillisToString(s.duration,1),s.idle?t=Ne(Ve.idleFrame):s.dropped?(t=s.isPartial?Ne(Ve.partiallyPresentedFrame):Ne(Ve.droppedFrame),r="timeline-info-warning"):t=Ne(Ve.frame),s.hasWarnings()&&(n=document.createElement("span"),n.textContent=Ne(Ve.longFrame))}}const d=document.createElement("div"),c=s.Utils.createShadowRootWithCoreStyles(d,{cssFile:[We],delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover");return c.createChild("span",r).textContent=a,c.createChild("span","timeline-info-title").textContent=t,n&&(n.classList.add("timeline-info-warning"),c.appendChild(n)),d}entryColor(i){function n(e,i,n){let a=e.get(i);if(a)return a;const r=t.Color.Color.parse(n(i));if(!r)throw new Error("Could not parse color from entry");return a=r.setAlpha(.7).asString(t.Color.Format.RGBA)||"",e.set(i,a),a}if(!this.performanceModel||!this.model)return"";const r=je,s=this.entryType(i);if(s===r.Event){const t=this.entryData[i];if(this.model.isGenericTrace())return this.genericTraceEventColor(t);if(this.performanceModel.timelineModel().isMarkerEvent(t))return ii.markerStyleForEvent(t).color;if(!e.TracingModel.TracingModel.isAsyncPhase(t.phase)&&this.colorForEvent)return this.colorForEvent(t);if(this.model.isEventTimingInteractionEvent(t))return this.consoleColorGenerator.colorForID(t.args.data.type+":"+t.args.data.interactionId);if(t.hasCategory(a.TimelineModel.TimelineModelImpl.Category.Console)||t.hasCategory(a.TimelineModel.TimelineModelImpl.Category.UserTiming))return this.consoleColorGenerator.colorForID(t.name);if(t.hasCategory(a.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const e=a.TimelineIRModel.TimelineIRModel.phaseForEvent(t)||a.TimelineIRModel.Phases.Uncategorized;return n(this.asyncColorByInteractionPhase,e,ii.interactionPhaseColor)}const r=ii.eventStyle(t).category;return n(this.asyncColorByCategory,r,(()=>r.color))}if(s===r.Frame)return"white";if(s===r.InteractionRecord)return"transparent";if(s===r.ExtensionEvent){const e=this.entryData[i];return this.extensionColorGenerator.colorForID(e.name)}return""}genericTraceEventColor(e){const t=e.categoriesString||e.name;return t?`hsl(${n.StringUtilities.hashCode(t)%300+30}, 40%, 70%)`:"#ccc"}preparePatternCanvas(){const e=17;this.droppedFramePatternCanvas.width=e,this.droppedFramePatternCanvas.height=e,this.partialFramePatternCanvas.width=e,this.partialFramePatternCanvas.height=e;const t=this.droppedFramePatternCanvas.getContext("2d");if(t){t.translate(8.5,8.5),t.rotate(.25*Math.PI),t.translate(-8.5,-8.5),t.fillStyle="rgb(255, 255, 255)";for(let e=-17;e<34;e+=3)t.fillRect(e,-17,1,51)}const i=this.partialFramePatternCanvas.getContext("2d");i&&(i.strokeStyle="rgb(255, 255, 255)",i.lineWidth=2,i.beginPath(),i.moveTo(17,0),i.lineTo(10,7),i.moveTo(8,9),i.lineTo(2,15),i.stroke())}drawFrame(e,t,n,a,r,s,o){const l=this.entryData[e];if(a+=1,s-=2,l.idle)t.fillStyle="white";else if(l.dropped)if(l.isPartial){t.fillStyle="#f0e442",t.fillRect(a,r,s,o);const e=t.createPattern(this.partialFramePatternCanvas,"repeat");t.fillStyle=e||t.fillStyle}else{t.fillStyle="#f08080",t.fillRect(a,r,s,o);const e=t.createPattern(this.droppedFramePatternCanvas,"repeat");t.fillStyle=e||t.fillStyle}else l.hasWarnings()?t.fillStyle="#fad1d1":t.fillStyle="#d7f0d1";t.fillRect(a,r,s,o);const d=i.TimeUtilities.preciseMillisToString(l.duration,1),c=t.measureText(d).width;c<=s&&(t.fillStyle=this.textColor(e),t.fillText(d,a+(s-c)/2,r+o-4))}async drawScreenshot(e,t,i,n,a,r){const o=this.entryData[e];if(!this.screenshotImageCache.has(o)){this.screenshotImageCache.set(o,null);const e=await o.imageDataPromise(),t=await s.UIUtils.loadImageFromData(e);return this.screenshotImageCache.set(o,t),void this.dispatchEventToListeners(_e.DataChanged)}const l=this.screenshotImageCache.get(o);if(!l)return;const d=i+1,c=n+1,h=r-2,m=h/l.naturalHeight,u=Math.floor(l.naturalWidth*m);t.save(),t.beginPath(),t.rect(i,n,a,r),t.clip(),t.drawImage(l,d,c,u,h),t.strokeStyle="#ccc",t.strokeRect(d-.5,c-.5,Math.min(a-1,u+1),h),t.restore()}decorateEntry(e,t,i,n,r,s,o,l,d){const c=this.entryData[e],h=this.entryType(e),m=je;if(h===m.Frame)return this.drawFrame(e,t,i,n,r,s,o),!0;if(h===m.Screenshot)return this.drawScreenshot(e,t,n,r,s,o),!0;if(h===m.InteractionRecord){const e=ii.interactionPhaseColor(c);return t.fillStyle=e,t.fillRect(n,r,s-1,2),t.fillRect(n,r-3,2,3),t.fillRect(n+s-3,r-3,2,3),!1}if(h===m.Event){const e=c;if(e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const i=a.TimelineModel.TimelineData.forEvent(e).timeWaitingForMainThread;if(i){t.fillStyle="hsla(0, 70%, 60%, 1)";const e=Math.floor(l-n+i*d);t.fillRect(n,r+o-3,e,2)}}a.TimelineModel.TimelineData.forEvent(e).warning&&function(e,i){const n=8;t.save(),t.beginPath(),t.rect(e,r,i,o),t.clip(),t.beginPath(),t.fillStyle="red",t.moveTo(e+i-n,r),t.lineTo(e+i,r),t.lineTo(e+i,r+n),t.fill(),t.restore()}(n,s-1.5)}return!1}forceDecoration(e){const t=je,i=this.entryType(e);if(i===t.Frame)return!0;if(i===t.Screenshot)return!0;if(i===t.Event){const t=this.entryData[e];return Boolean(a.TimelineModel.TimelineData.forEvent(t).warning)}return!1}appendExtensionEvents(e){this.extensionInfo.push(e),this.timelineDataInternal&&this.innerAppendExtensionEvents(this.extensionInfo.length-1)}innerAppendExtensionEvents(e){const t=this.extensionInfo[e],i=je.ExtensionEvent,n=[...t.model.sortedProcesses().map((e=>e.sortedThreads()))].flat();if(!n.length)return;const a=!(1!==n.length||n[0].events().length&&n[0].asyncEvents().length);a||this.appendHeader(t.title,this.headerLevel1,!1);const r=a?this.headerLevel2:this.headerLevel1;let s=0;for(const e of n){const n=a?t.title:e.name()||Ne(Ve.threadS,{PH1:++s});this.appendAsyncEventsGroup(null,n,e.asyncEvents(),r,i,!1),this.appendSyncEvents(null,e.events(),n,r,i,!1)}}appendHeader(e,t,i){const n={startLevel:this.currentLevel,name:e,style:t,selectable:i};return this.timelineDataInternal.groups.push(n),n}appendEvent(e,t){const i=this.entryData.length;this.entryData.push(e);const n=this.timelineDataInternal;return n.entryLevels[i]=t,n.entryTotalTimes[i]=e.duration||ze,n.entryStartTimes[i]=e.startTime,Ge.set(e,i),i}appendAsyncEvent(t,i){const n=t.steps,a=n.length>1&&n[1].phase===e.TracingModel.Phase.AsyncStepPast?1:0;for(let e=0;e<n.length-1;++e){const t=this.entryData.length;this.entryData.push(n[e+a]);const r=n[e].startTime,s=this.timelineDataInternal;s.entryLevels[t]=i,s.entryTotalTimes[t]=n[e+1].startTime-r,s.entryStartTimes[t]=r}}appendFrame(e){const t=this.entryData.length;this.entryData.push(e),this.entryIndexToTitle[t]=i.TimeUtilities.millisToString(e.duration,!0),this.timelineDataInternal&&(this.timelineDataInternal.entryLevels[t]=this.currentLevel,this.timelineDataInternal.entryTotalTimes[t]=e.duration,this.timelineDataInternal.entryStartTimes[t]=e.startTime)}createSelection(e){const t=this.entryType(e);let i=null;return t===je.Event?i=Vt.fromTraceEvent(this.entryData[e]):t===je.Frame&&(i=Vt.fromFrame(this.entryData[e])),i&&(this.lastSelection=new at(i,e)),i}formatValue(e,t){return i.TimeUtilities.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||e.type()===Vt.Type.Range)return-1;if(this.lastSelection&&this.lastSelection.timelineSelection.object()===e.object())return this.lastSelection.entryIndex;const t=this.entryData.indexOf(e.object());return-1!==t&&(this.lastSelection=new at(e,t)),t}buildFlowForInitiator(e){if(this.lastInitiatorEntry===e)return!1;this.lastInitiatorEntry=e;let t=this.eventByIndex(e);const i=this.timelineDataInternal;if(!i)return!1;for(i.flowStartTimes=[],i.flowStartLevels=[],i.flowEndTimes=[],i.flowEndLevels=[];t;){let e;for(;t&&(e=a.TimelineModel.TimelineData.forEvent(t).initiator(),!e);t=this.eventParent(t));if(!e||!t)break;const n=Ge.get(t),r=Ge.get(e);i.flowStartTimes.push(e.endTime||e.startTime),i.flowStartLevels.push(i.entryLevels[r]),i.flowEndTimes.push(t.startTime),i.flowEndLevels.push(i.entryLevels[n]),t=e}return!0}eventParent(e){const t=Ge.get(e);return void 0===t?null:this.entryParent[t]||null}eventByIndex(e){return e>=0&&this.entryType(e)===je.Event?this.entryData[e]:null}entryDataByIndex(e){return this.entryData[e]}setEventColorMapping(e){this.colorForEvent=e}}const ze=.001,Oe=new WeakMap,Ge=new WeakMap;var _e,je;(_e||(_e={})).DataChanged="DataChanged",function(e){e.Frame="Frame",e.Event="Event",e.InteractionRecord="InteractionRecord",e.ExtensionEvent="ExtensionEvent",e.Screenshot="Screenshot"}(je||(je={}));var qe=Object.freeze({__proto__:null,TimelineFlameChartDataProvider:Ae,InstantEventVisibleDurationMs:ze,get Events(){return _e},get EntryType(){return je}});const Je={network:"Network"},Xe=i.i18n.registerUIStrings("panels/timeline/TimelineFlameChartNetworkDataProvider.ts",Je),$e=i.i18n.getLocalizedString.bind(void 0,Xe);class Ke{font;style;group;minimumBoundaryInternal;maximumBoundary;timeSpan;requests;maxLevel;model;timelineDataInternal;startTime;endTime;lastSelection;priorityToValue;constructor(){this.font="11px "+d.Platform.fontFamily(),this.setModel(null),this.style={padding:4,height:17,collapsible:!0,color:f.ThemeSupport.instance().getComputedValue("--color-text-primary"),font:this.font,backgroundColor:f.ThemeSupport.instance().getComputedValue("--color-background"),nestingLevel:0,useFirstLineForOverview:!1,useDecoratorsForOverview:!0,shareHeaderLine:!1},this.group={startLevel:0,name:$e(Je.network),expanded:!1,style:this.style},this.minimumBoundaryInternal=0,this.maximumBoundary=0,this.timeSpan=0,this.requests=[],this.maxLevel=0,f.ThemeSupport.instance().addEventListener(f.ThemeChangeEvent.eventName,(()=>{this.style.color=f.ThemeSupport.instance().getComputedValue("--color-text-primary"),this.style.backgroundColor=f.ThemeSupport.instance().getComputedValue("--color-background")}))}setModel(e){this.model=e&&e.timelineModel(),this.timelineDataInternal=null}isEmpty(){return this.timelineData(),!this.requests.length}maxStackDepth(){return this.maxLevel}timelineData(){return this.timelineDataInternal||(this.requests=[],this.timelineDataInternal=new r.FlameChart.TimelineData([],[],[],[]),this.model&&this.appendTimelineData()),this.timelineDataInternal}minimumBoundary(){return this.minimumBoundaryInternal}totalTime(){return this.timeSpan}setWindowTimes(e,t){this.startTime=e,this.endTime=t,this.updateTimelineData()}createSelection(e){if(-1===e)return null;const t=this.requests[e];return this.lastSelection=new at(Vt.fromNetworkRequest(t),e),this.lastSelection.timelineSelection}entryIndexForSelection(e){if(!e)return-1;if(this.lastSelection&&this.lastSelection.timelineSelection.object()===e.object())return this.lastSelection.entryIndex;if(e.type()!==Vt.Type.NetworkRequest)return-1;const t=e.object(),i=this.requests.indexOf(t);return-1!==i&&(this.lastSelection=new at(Vt.fromNetworkRequest(t),i)),i}entryColor(e){const t=this.requests[e],i=ii.networkRequestCategory(t);return ii.networkCategoryColor(i)}textColor(e){return rt.textColor}entryTitle(e){const i=this.requests[e],n=new t.ParsedURL.ParsedURL(i.url||"");return n.isValid?`${n.displayName} (${n.host})`:i.url||null}entryFont(e){return this.font}decorateEntry(e,t,i,a,r,o,l,d,c){const h=this.requests[e];if(!h.timing)return!1;const m=h.timing,u=h.beginTime(),p=e=>Math.floor(d+(e-u)*c),g=h.getStartTime(),v=h.endTime,{sendStartTime:T,headersEndTime:w}=h.getSendReceiveTiming(),S=Math.max(p(T),d),y=Math.max(p(w),S),b=Math.max(p(h.finishTime||v),y+2),C=p(g),k=Math.max(p(v),b);if(t.fillStyle="hsla(0, 100%, 100%, 0.8)",t.fillRect(S+.5,r+.5,y-S-.5,l-2),t.fillStyle=f.ThemeSupport.instance().getComputedValue("--color-background"),t.fillRect(a,r-.5,S-a,l),t.fillRect(b,r-.5,a+o-b,l),!h.cached()&&m.pushStart){const i=p(1e3*m.pushStart),a=m.pushEnd?p(1e3*m.pushEnd):C,s=n.NumberUtilities.clamp(a-i-2,0,4),o=1;if(t.save(),t.beginPath(),t.moveTo(i+s,r+l/2),t.lineTo(i,r+o),t.lineTo(a-s,r+o),t.lineTo(a,r+l/2),t.lineTo(a-s,r+l-o),t.lineTo(i,r+l-o),t.closePath(),m.pushEnd)t.fillStyle=this.entryColor(e);else{const n=t.createLinearGradient(i,0,a,0);n.addColorStop(0,this.entryColor(e)),n.addColorStop(1,"white"),t.fillStyle=n}t.globalAlpha=.3,t.fill(),t.restore()}function P(e,i,n){t.moveTo(e,n-3),t.lineTo(e,n+3),t.moveTo(e,n),t.lineTo(i,n)}t.beginPath(),t.lineWidth=1,t.strokeStyle="#ccc";const M=Math.floor(r+l/2)+.5,x=k-.5;if(P(C+.5,S,M),P(x,b,M),t.stroke(),"string"==typeof h.priority){const e=this.colorForPriority(h.priority);e&&(t.fillStyle=e,t.fillRect(S+.5,r+.5,3.5,3.5))}const I=Math.max(S,0),R=b-I;if(R>=20&&(i=this.entryTitle(e)||"",h.fromServiceWorker&&(i="⚙ "+i),i)){const e=4,n=l-5,a=s.UIUtils.trimTextEnd(t,i,R-2*e);t.fillStyle="#333",t.fillText(a,I+e,r+n)}return!0}forceDecoration(e){return!0}prepareHighlightedEntryInfo(e){const t=this.requests[e];if(!t.url)return null;const a=document.createElement("div"),o=s.Utils.createShadowRootWithCoreStyles(a,{cssFile:[We],delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover"),l=t.getStartTime(),d=t.endTime-l;if(l&&isFinite(d)&&(o.createChild("span","timeline-info-network-time").textContent=i.TimeUtilities.millisToString(d,!0)),"string"==typeof t.priority){const e=o.createChild("span");e.textContent=r.NetworkPriorities.uiLabelForNetworkPriority(t.priority),e.style.color=this.colorForPriority(t.priority)||"black"}return o.createChild("span").textContent=n.StringUtilities.trimMiddle(t.url,80),a}colorForPriority(e){this.priorityToValue||(this.priorityToValue=new Map([["VeryLow",1],["Low",2],["Medium",3],["High",4],["VeryHigh",5]]));const t=this.priorityToValue.get(e);return t?`hsla(214, 80%, 50%, ${t/5})`:null}appendTimelineData(){this.model&&(this.minimumBoundaryInternal=this.model.minimumRecordTime(),this.maximumBoundary=this.model.maximumRecordTime(),this.timeSpan=this.model.isEmpty()?1e3:this.maximumBoundary-this.minimumBoundaryInternal,this.model.networkRequests().forEach(this.appendEntry.bind(this)),this.updateTimelineData())}updateTimelineData(){if(!this.timelineDataInternal)return;const e=[];let t=0;for(let i=0;i<this.requests.length;++i){const n=this.requests[i],a=n.beginTime(),r=this.startTime;if(a<this.endTime&&n.endTime>r){for(;e.length&&e[e.length-1]<=a;)e.pop();this.timelineDataInternal.entryLevels[i]=e.length,e.push(n.endTime),t=Math.max(t,e.length)}else this.timelineDataInternal.entryLevels[i]=-1}for(let e=0;e<this.requests.length;++e)-1===this.timelineDataInternal.entryLevels[e]&&(this.timelineDataInternal.entryLevels[e]=t);this.timelineDataInternal=new r.FlameChart.TimelineData(this.timelineDataInternal.entryLevels,this.timelineDataInternal.entryTotalTimes,this.timelineDataInternal.entryStartTimes,[this.group]),this.maxLevel=t}appendEntry(e){this.requests.push(e),this.timelineDataInternal.entryStartTimes.push(e.beginTime()),this.timelineDataInternal.entryTotalTimes.push(e.endTime-e.beginTime()),this.timelineDataInternal.entryLevels.push(this.requests.length-1)}preferredHeight(){return this.style.height*(this.group.expanded?n.NumberUtilities.clamp(this.maxLevel+1,4,8.5):1)}isExpanded(){return this.group&&Boolean(this.group.expanded)}formatValue(e,t){return i.TimeUtilities.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}navStartTimes(){return this.model?this.model.navStartTimes():new Map}}var Ye=Object.freeze({__proto__:null,TimelineFlameChartNetworkDataProvider:Ke});class Qe extends s.Widget.VBox{delegate;webVitalsTimeline;chartViewport;constructor(e){super(!0,!0),this.delegate=e,this.element.style.height="120px",this.element.style.flex="0 auto",this.webVitalsTimeline=new T.WebVitalsTimeline.WebVitalsTimeline,this.chartViewport=new r.ChartViewport.ChartViewport(this),this.chartViewport.show(this.contentElement),this.chartViewport.alwaysShowVerticalScroll(),this.chartViewport.setContentHeight(114),this.chartViewport.viewportElement.appendChild(this.webVitalsTimeline)}windowChanged(e,t,i){this.delegate.windowChanged(e,t,i)}updateRangeSelection(e,t){this.delegate.updateRangeSelection(e,t)}setSize(e,t){this.webVitalsTimeline.setSize(e,t)}update(){this.webVitalsTimeline.render()}}const Ze={sAtS:"{PH1} at {PH2}"},et=i.i18n.registerUIStrings("panels/timeline/TimelineFlameChartView.ts",Ze),tt=i.i18n.getLocalizedString.bind(void 0,et);class it extends s.SplitWidget.SplitWidget{webVitals;model;constructor(e,t,i,n,a,r){super(e,t,i,n,a,r)}setWebVitals(e){this.webVitals=e,this.webVitals.setMinimumSize(0,120)}setWindowTimes(e,t,i){if(!this.webVitals)return;const n=e-(this.model?this.model.timelineModel().minimumRecordTime():0);this.webVitals.chartViewport.setWindowTimes(e,t,i),this.webVitals.webVitalsTimeline.data={startTime:n,duration:t-e,fcps:void 0,lcps:void 0,layoutShifts:void 0,longTasks:void 0,mainFrameNavigations:void 0,maxDuration:void 0}}setModelAndUpdateBoundaries(t){if(this.model=t,!this.webVitals||!t)return;const i=t.window().left,n=t.window().right,a=t.timelineModel(),r=a.tracks().reduce(((e,t)=>e.concat(t.events)),[]),s=t.timelineModel().minimumRecordTime(),o=e=>r.filter(e).map((e=>e.startTime-s)),l=r.filter((e=>a.isLCPCandidateEvent(e)||a.isLCPInvalidateEvent(e))),d=new Map;for(const e of l){const t=e.args.data.navigationId,i=d.get(t);(!i||i.args.data.candidateIndex<e.args.data.candidateIndex)&&d.set(t,e)}const c=Array.from(d.values()).filter((e=>a.isLCPCandidateEvent(e))),h=r.filter((t=>e.TracingModel.TracingModel.isCompletePhase(t.phase)&&a.isLongRunningTask(t))).map((e=>({start:e.startTime-s,duration:e.duration||0})));this.webVitals.chartViewport.setBoundaries(i,n-i),this.webVitals.chartViewport.setWindowTimes(i,n);const m=i-(this.model?this.model.timelineModel().minimumRecordTime():0);this.webVitals.webVitalsTimeline.data={startTime:m,duration:n-i,maxDuration:a.maximumRecordTime(),fcps:r.filter((e=>a.isFCPEvent(e))).map((e=>({timestamp:e.startTime-s,e:e}))),lcps:c.map((e=>e.startTime)).map((e=>({timestamp:e-s}))),layoutShifts:o((e=>a.isLayoutShiftEvent(e))).map((e=>({timestamp:e}))),longTasks:h,mainFrameNavigations:o((e=>a.isMainFrameNavigationStartEvent(e)))}}}class nt extends s.Widget.VBox{delegate;model;searchResults;eventListeners;showMemoryGraphSetting;showWebVitalsSetting;networkSplitWidget;mainDataProvider;mainFlameChart;networkFlameChartGroupExpansionSetting;networkDataProvider;networkFlameChart;networkPane;splitResizer;webVitals;mainSplitWidget;chartSplitWidget;countersView;detailsSplitWidget;detailsView;onMainEntrySelected;onNetworkEntrySelected;nextExtensionIndex;boundRefresh;selectedTrack;groupBySetting;searchableView;urlToColorCache;needsResizeToPreferredHeights;selectedSearchResult;searchRegex;constructor(e){super(),this.element.classList.add("timeline-flamechart"),this.delegate=e,this.model=null,this.eventListeners=[],this.showMemoryGraphSetting=t.Settings.Settings.instance().createSetting("timelineShowMemory",!1),this.showWebVitalsSetting=t.Settings.Settings.instance().createSetting("timelineWebVitals",!1),this.networkSplitWidget=new s.SplitWidget.SplitWidget(!1,!1,"timelineFlamechartMainView",150),this.networkSplitWidget.sidebarElement().style.zIndex="120";const i=t.Settings.Settings.instance().createSetting("timelineFlamechartMainViewGroupExpansion",{});this.mainDataProvider=new Ae,this.mainDataProvider.addEventListener(_e.DataChanged,(()=>this.mainFlameChart.scheduleUpdate())),this.mainFlameChart=new r.FlameChart.FlameChart(this.mainDataProvider,this,i),this.mainFlameChart.alwaysShowVerticalScroll(),this.mainFlameChart.enableRuler(!1),this.networkFlameChartGroupExpansionSetting=t.Settings.Settings.instance().createSetting("timelineFlamechartNetworkViewGroupExpansion",{}),this.networkDataProvider=new Ke,this.networkFlameChart=new r.FlameChart.FlameChart(this.networkDataProvider,this,this.networkFlameChartGroupExpansionSetting),this.networkFlameChart.alwaysShowVerticalScroll(),this.networkFlameChart.disableRangeSelection(),this.networkPane=new s.Widget.VBox,this.networkPane.setMinimumSize(23,23),this.networkFlameChart.show(this.networkPane.element),this.splitResizer=this.networkPane.element.createChild("div","timeline-flamechart-resizer"),this.networkSplitWidget.hideDefaultResizer(!0),this.networkSplitWidget.installResizer(this.splitResizer),this.webVitals=new Qe(this),this.mainSplitWidget=new it(!1,!1,"timelineFlamechartMainAndVitalsView",void 0,120),this.mainSplitWidget.setWebVitals(this.webVitals),this.mainSplitWidget.setMainWidget(this.mainFlameChart),this.mainSplitWidget.setSidebarWidget(this.webVitals),this.toggleWebVitalsLane(),this.networkSplitWidget.setMainWidget(this.mainSplitWidget),this.networkSplitWidget.setSidebarWidget(this.networkPane),this.chartSplitWidget=new s.SplitWidget.SplitWidget(!1,!0,"timelineCountersSplitViewState"),this.countersView=new Si(this.delegate),this.chartSplitWidget.setMainWidget(this.networkSplitWidget),this.chartSplitWidget.setSidebarWidget(this.countersView),this.chartSplitWidget.hideDefaultResizer(),this.chartSplitWidget.installResizer(this.countersView.resizerElement()),this.updateCountersGraphToggle(),this.detailsSplitWidget=new s.SplitWidget.SplitWidget(!1,!0,"timelinePanelDetailsSplitViewState"),this.detailsSplitWidget.element.classList.add("timeline-details-split"),this.detailsView=new De(e),this.detailsSplitWidget.installResizer(this.detailsView.headerElement()),this.detailsSplitWidget.setMainWidget(this.chartSplitWidget),this.detailsSplitWidget.setSidebarWidget(this.detailsView),this.detailsSplitWidget.show(this.element),this.onMainEntrySelected=this.onEntrySelected.bind(this,this.mainDataProvider),this.onNetworkEntrySelected=this.onEntrySelected.bind(this,this.networkDataProvider),this.mainFlameChart.addEventListener(r.FlameChart.Events.EntrySelected,this.onMainEntrySelected,this),this.mainFlameChart.addEventListener(r.FlameChart.Events.EntryInvoked,this.onMainEntrySelected,this),this.networkFlameChart.addEventListener(r.FlameChart.Events.EntrySelected,this.onNetworkEntrySelected,this),this.networkFlameChart.addEventListener(r.FlameChart.Events.EntryInvoked,this.onNetworkEntrySelected,this),this.mainFlameChart.addEventListener(r.FlameChart.Events.EntryHighlighted,this.onEntryHighlighted,this),this.nextExtensionIndex=0,this.boundRefresh=this.refresh.bind(this),this.selectedTrack=null,this.mainDataProvider.setEventColorMapping(ii.eventColor),this.groupBySetting=t.Settings.Settings.instance().createSetting("timelineTreeGroupBy",ue.GroupBy.None),this.groupBySetting.addChangeListener(this.updateColorMapper,this),this.updateColorMapper()}toggleWebVitalsLane(){this.showWebVitalsSetting.get()?(this.mainSplitWidget.showBoth(),this.mainSplitWidget.setSidebarSize(120),this.mainSplitWidget.setResizable(!1),this.mainSplitWidget.hideDefaultResizer(!0)):this.mainSplitWidget.hideSidebar()}updateColorMapper(){this.urlToColorCache=new Map,this.model&&(this.mainDataProvider.setEventColorMapping(ii.eventColor),this.mainFlameChart.update())}onWindowChanged(e){const{window:t,animate:i}=e.data;this.mainFlameChart.setWindowTimes(t.left,t.right,i),this.networkFlameChart.setWindowTimes(t.left,t.right,i),this.networkDataProvider.setWindowTimes(t.left,t.right),this.mainSplitWidget.setWindowTimes(t.left,t.right,Boolean(i)),this.updateSearchResults(!1,!1)}windowChanged(e,t,i){this.model&&this.model.setWindow({left:e,right:t},i)}updateRangeSelection(e,t){this.delegate.select(Vt.fromRange(e,t))}updateSelectedGroup(e,t){if(e!==this.mainFlameChart)return;const i=t?this.mainDataProvider.groupTrack(t):null;this.selectedTrack=i,this.updateTrack()}setModel(e){if(e!==this.model){if(t.EventTarget.removeEventListeners(this.eventListeners),this.model=e,this.selectedTrack=null,this.mainDataProvider.setModel(this.model),this.networkDataProvider.setModel(this.model),this.model){this.eventListeners=[this.model.addEventListener(ui.WindowChanged,this.onWindowChanged,this),this.model.addEventListener(ui.ExtensionDataAdded,this.appendExtensionData,this)];const t=this.model.window();this.mainFlameChart.setWindowTimes(t.left,t.right),this.networkFlameChart.setWindowTimes(t.left,t.right),this.networkDataProvider.setWindowTimes(t.left,t.right),this.mainSplitWidget.setModelAndUpdateBoundaries(e),this.updateSearchResults(!1,!1)}this.updateColorMapper(),this.updateTrack(),this.nextExtensionIndex=0,this.appendExtensionData(),this.refresh()}}updateTrack(){this.countersView.setModel(this.model,this.selectedTrack),this.detailsView.setModel(this.model,this.selectedTrack)}refresh(){this.networkDataProvider.isEmpty()?(this.mainFlameChart.enableRuler(!0),this.networkSplitWidget.hideSidebar()):(this.mainFlameChart.enableRuler(!1),this.networkSplitWidget.showBoth(),this.resizeToPreferredHeights()),this.mainFlameChart.reset(),this.networkFlameChart.reset(),this.updateSearchResults(!1,!1)}appendExtensionData(){if(!this.model)return;const e=this.model.extensionInfo();for(;this.nextExtensionIndex<e.length;)this.mainDataProvider.appendExtensionEvents(e[this.nextExtensionIndex++]);this.mainFlameChart.scheduleUpdate()}onEntryHighlighted(t){e.OverlayModel.OverlayModel.hideDOMNodeHighlight();const i=t.data,n=this.mainDataProvider.eventByIndex(i);if(!n)return;const r=this.model&&this.model.timelineModel().targetByEvent(n);if(!r)return;const s=a.TimelineModel.TimelineData.forEvent(n).backendNodeIds;if(s)for(let t=0;t<s.length;++t)new e.DOMModel.DeferredDOMNode(r,s[t]).highlight()}highlightEvent(e){const t=e?this.mainDataProvider.entryIndexForSelection(Vt.fromTraceEvent(e)):-1;t>=0?this.mainFlameChart.highlightEntry(t):this.mainFlameChart.hideHighlight()}willHide(){this.networkFlameChartGroupExpansionSetting.removeChangeListener(this.resizeToPreferredHeights,this),this.showMemoryGraphSetting.removeChangeListener(this.updateCountersGraphToggle,this),o.IgnoreListManager.IgnoreListManager.instance().removeChangeListener(this.boundRefresh)}wasShown(){this.networkFlameChartGroupExpansionSetting.addChangeListener(this.resizeToPreferredHeights,this),this.showMemoryGraphSetting.addChangeListener(this.updateCountersGraphToggle,this),o.IgnoreListManager.IgnoreListManager.instance().addChangeListener(this.boundRefresh),this.needsResizeToPreferredHeights&&this.resizeToPreferredHeights(),this.mainFlameChart.scheduleUpdate(),this.networkFlameChart.scheduleUpdate()}updateCountersGraphToggle(){this.showMemoryGraphSetting.get()?this.chartSplitWidget.showBoth():this.chartSplitWidget.hideSidebar()}setSelection(e){let t=this.mainDataProvider.entryIndexForSelection(e);this.mainFlameChart.setSelectedEntry(t),t=this.networkDataProvider.entryIndexForSelection(e),this.networkFlameChart.setSelectedEntry(t),this.detailsView&&this.detailsView.setSelection(e)}onEntrySelected(e,t){const i=t.data;c.Runtime.experiments.isEnabled("timelineEventInitiators")&&e===this.mainDataProvider&&this.mainDataProvider.buildFlowForInitiator(i)&&this.mainFlameChart.scheduleUpdate(),this.delegate.select(e.createSelection(i))}resizeToPreferredHeights(){this.isShowing()?(this.needsResizeToPreferredHeights=!1,this.networkPane.element.classList.toggle("timeline-network-resizer-disabled",!this.networkDataProvider.isExpanded()),this.networkSplitWidget.setSidebarSize(this.networkDataProvider.preferredHeight()+this.splitResizer.clientHeight+r.FlameChart.HeaderHeight+2)):this.needsResizeToPreferredHeights=!0}setSearchableView(e){this.searchableView=e}jumpToNextSearchResult(){if(!this.searchResults||!this.searchResults.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):-1;this.selectSearchResult(n.NumberUtilities.mod(e+1,this.searchResults.length))}jumpToPreviousSearchResult(){if(!this.searchResults||!this.searchResults.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):0;this.selectSearchResult(n.NumberUtilities.mod(e-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}selectSearchResult(e){this.searchableView.updateCurrentMatchIndex(e),this.searchResults&&(this.selectedSearchResult=this.searchResults[e],this.delegate.select(this.mainDataProvider.createSelection(this.selectedSearchResult)))}updateSearchResults(e,t){const i=this.selectedSearchResult;if(delete this.selectedSearchResult,this.searchResults=[],!this.searchRegex||!this.model)return;const n=new ae(this.searchRegex),a=this.model.window();if(this.searchResults=this.mainDataProvider.search(a.left,a.right,n),this.searchableView.updateSearchMatchesCount(this.searchResults.length),!e||!this.searchResults.length)return;let r=this.searchResults.indexOf(i);-1===r&&(r=t?this.searchResults.length-1:0),this.selectSearchResult(r)}searchCanceled(){void 0!==this.selectedSearchResult&&this.delegate.select(null),delete this.searchResults,delete this.selectedSearchResult,delete this.searchRegex}performSearch(e,t,i){this.searchRegex=e.toSearchRegex().regex,this.updateSearchResults(t,i)}}class at{timelineSelection;entryIndex;constructor(e,t){this.timelineSelection=e,this.entryIndex=t}}const rt={textColor:"#333"};class st{startTimeInternal;startOffset;style;constructor(e,t,i){this.startTimeInternal=e,this.startOffset=t,this.style=i}startTime(){return this.startTimeInternal}color(){return this.style.color}title(){if(this.style.lowPriority)return null;const e=i.TimeUtilities.millisToString(this.startOffset);return tt(Ze.sAtS,{PH1:this.style.title,PH2:e})}draw(e,t,i,n){this.style.lowPriority&&n<4||(e.save(),this.style.tall&&(e.strokeStyle=this.style.color,e.lineWidth=this.style.lineWidth,e.translate(this.style.lineWidth<1||1&this.style.lineWidth?.5:0,.5),e.beginPath(),e.moveTo(t,0),e.setLineDash(this.style.dashStyle),e.lineTo(t,e.canvas.height),e.stroke()),e.restore())}}var ot;!function(e){e.URL="URL"}(ot||(ot={}));var lt=Object.freeze({__proto__:null,TimelineFlameChartView:nt,Selection:at,FlameChartStyle:rt,TimelineFlameChartMarker:st,get ColorBy(){return ot}});const dt=new CSSStyleSheet;dt.replaceSync(".drop-down{padding:1px;box-shadow:var(--drop-shadow);background:var(--color-background)}.preview-item{border-color:transparent;border-style:solid;border-width:1px 5px;padding:2px 0;margin:2px 1px}.preview-item.selected{border-color:var(--legacy-selection-bg-color)}.preview-item canvas{width:100%;height:100%}.text-details{font-size:11px;padding:3px}.text-details span{flex:1 0;padding-left:8px;padding-right:8px}.text-details .name{font-weight:700}.text-details span.time{color:var(--color-text-secondary);text-align:right}.screenshot-thumb{display:flex;border:1px solid var(--color-background-elevation-2);margin:2px 4px}.screenshot-thumb img{margin:auto;max-width:100%;max-height:100%}\n/*# sourceURL=timelineHistoryManager.css */\n");const ct={currentSessionSS:"Current Session: {PH1}. {PH2}",noRecordings:"(no recordings)",sAgo:"({PH1} ago)",moments:"moments",sM:"{PH1} m",sH:"{PH1} h",sD:"{PH1} #{PH2}",selectTimelineSession:"Select Timeline Session"},ht=i.i18n.registerUIStrings("panels/timeline/TimelineHistoryManager.ts",ct),mt=i.i18n.getLocalizedString.bind(void 0,ht);class ut{recordings;action;nextNumberByDomain;buttonInternal;allOverviews;totalHeight;enabled;lastActiveModel;constructor(){this.recordings=[],this.action=s.ActionRegistry.ActionRegistry.instance().action("timeline.show-history"),this.nextNumberByDomain=new Map,this.buttonInternal=new Tt(this.action),s.ARIAUtils.markAsMenuButton(this.buttonInternal.element),this.clear(),this.allOverviews=[{constructor:K,height:3},{constructor:$,height:20},{constructor:J,height:8}],this.totalHeight=this.allOverviews.reduce(((e,t)=>e+t.height),0),this.enabled=!0,this.lastActiveModel=null}addRecording(e){this.lastActiveModel=e,this.recordings.unshift(e),this.buildPreview(e);const t=this.title(e);this.buttonInternal.setText(t);const i=this.action.title();if(s.ARIAUtils.setAccessibleName(this.buttonInternal.element,mt(ct.currentSessionSS,{PH1:t,PH2:i})),this.updateState(),this.recordings.length<=pt)return;const n=this.recordings.reduce(((e,t)=>a(e)<a(t)?e:t));function a(e){const t=ut.dataForModel(e);if(!t)throw new Error("Unable to find data for model");return t.lastUsed}this.recordings.splice(this.recordings.indexOf(n),1),n.dispose()}setEnabled(e){this.enabled=e,this.updateState()}button(){return this.buttonInternal}clear(){this.recordings.forEach((e=>e.dispose())),this.recordings=[],this.lastActiveModel=null,this.updateState(),this.buttonInternal.setText(mt(ct.noRecordings)),this.nextNumberByDomain.clear()}async showHistoryDropDown(){if(this.recordings.length<2||!this.enabled)return null;const e=await ft.show(this.recordings,this.lastActiveModel,this.buttonInternal.element);if(!e)return null;return this.recordings.indexOf(e)<0?(console.assert(!1,"selected recording not found"),null):(this.setCurrentModel(e),e)}cancelIfShowing(){ft.cancelIfShowing()}navigate(e){if(!this.enabled||!this.lastActiveModel)return null;const t=this.recordings.indexOf(this.lastActiveModel);if(t<0)return null;const i=n.NumberUtilities.clamp(t+e,0,this.recordings.length-1),a=this.recordings[i];return this.setCurrentModel(a),a}setCurrentModel(e){const t=ut.dataForModel(e);if(!t)throw new Error("Unable to find data for model");t.lastUsed=Date.now(),this.lastActiveModel=e;const i=this.title(e),n=this.action.title();this.buttonInternal.setText(i),s.ARIAUtils.setAccessibleName(this.buttonInternal.element,mt(ct.currentSessionSS,{PH1:i,PH2:n}))}updateState(){this.action.setEnabled(this.recordings.length>1&&this.enabled)}static previewElement(e){const t=ut.dataForModel(e);if(!t)throw new Error("Unable to find data for model");const i=e.recordStartTime();return t.time.textContent=i?mt(ct.sAgo,{PH1:ut.coarseAge(i)}):"",t.preview}static coarseAge(e){const t=Math.round((Date.now()-e)/1e3);if(t<50)return mt(ct.moments);const i=Math.round(t/60);if(i<50)return mt(ct.sM,{PH1:i});const n=Math.round(i/60);return mt(ct.sH,{PH1:n})}title(e){const t=ut.dataForModel(e);if(!t)throw new Error("Unable to find data for model");return t.title}buildPreview(e){const i=t.ParsedURL.ParsedURL.fromString(e.timelineModel().pageURL()),n=i?i.host:"",a=this.nextNumberByDomain.get(n)||1,r=mt(ct.sD,{PH1:n,PH2:a});this.nextNumberByDomain.set(n,a+1);const s=document.createElement("span"),o=document.createElement("div");o.classList.add("preview-item"),o.classList.add("vbox");const l={preview:o,title:r,time:s,lastUsed:Date.now()};vt.set(e,l),o.appendChild(this.buildTextDetails(e,r,s));const d=o.createChild("div","hbox");return d.appendChild(this.buildScreenshotThumbnail(e)),d.appendChild(this.buildOverview(e)),l.preview}buildTextDetails(e,t,n){const a=document.createElement("div");a.classList.add("text-details"),a.classList.add("hbox");const r=a.createChild("span","name");r.textContent=t,s.ARIAUtils.setAccessibleName(r,t);const o=e.tracingModel(),l=i.TimeUtilities.millisToString(o.maximumRecordTime()-o.minimumRecordTime(),!1),d=a.createChild("span","time");return d.appendChild(document.createTextNode(l)),d.appendChild(n),a}buildScreenshotThumbnail(e){const t=document.createElement("div");t.classList.add("screenshot-thumb");t.style.width=1.5*this.totalHeight+"px",t.style.height=this.totalHeight+"px";const i=e.filmStripModel().frames(),n=i[i.length-1];return n?(n.imageDataPromise().then((e=>s.UIUtils.loadImageFromData(e))).then((e=>e&&t.appendChild(e))),t):t}buildOverview(e){const t=document.createElement("div");t.style.width=gt+"px",t.style.height=this.totalHeight+"px";const i=t.createChild("canvas");i.width=window.devicePixelRatio*gt,i.height=window.devicePixelRatio*this.totalHeight;const n=i.getContext("2d");let a=0;for(const t of this.allOverviews){const i=new t.constructor;i.setCanvasSize(gt,t.height),i.setModel(e),i.update();const r=i.context(),s=r.getImageData(0,0,r.canvas.width,r.canvas.height);n&&n.putImageData(s,0,a),a+=t.height*window.devicePixelRatio}return t}static dataForModel(e){return vt.get(e)||null}}const pt=5,gt=450,vt=new WeakMap;class ft{glassPane;listControl;focusRestorer;selectionDone;constructor(e){this.glassPane=new s.GlassPane.GlassPane,this.glassPane.setSizeBehavior("MeasureContent"),this.glassPane.setOutsideClickCallback((()=>this.close(null))),this.glassPane.setPointerEventsBehavior("BlockedByGlassPane"),this.glassPane.setAnchorBehavior("PreferBottom"),this.glassPane.element.addEventListener("blur",(()=>this.close(null)));const t=s.Utils.createShadowRootWithCoreStyles(this.glassPane.contentElement,{cssFile:[dt],delegatesFocus:void 0}).createChild("div","drop-down"),i=new s.ListModel.ListModel;this.listControl=new s.ListControl.ListControl(i,this,s.ListControl.ListMode.NonViewport),this.listControl.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),i.replaceAll(e),s.ARIAUtils.markAsMenu(this.listControl.element),s.ARIAUtils.setAccessibleName(this.listControl.element,mt(ct.selectTimelineSession)),t.appendChild(this.listControl.element),t.addEventListener("keydown",this.onKeyDown.bind(this),!1),t.addEventListener("click",this.onClick.bind(this),!1),this.focusRestorer=new s.UIUtils.ElementFocusRestorer(this.listControl.element),this.selectionDone=null}static show(e,t,i){if(ft.instance)return Promise.resolve(null);return new ft(e).show(i,t)}static cancelIfShowing(){ft.instance&&ft.instance.close(null)}show(e,t){return ft.instance=this,this.glassPane.setContentAnchorBox(e.boxInWindow()),this.glassPane.show(this.glassPane.contentElement.ownerDocument),this.listControl.element.focus(),this.listControl.selectItem(t),new Promise((e=>{this.selectionDone=e}))}onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("preview-item"),i=t&&this.listControl.itemForNode(t);i&&this.listControl.selectItem(i)}onClick(e){e.target.enclosingNodeOrSelfWithClass("preview-item")&&this.close(this.listControl.selectedItem())}onKeyDown(e){switch(e.key){case"Tab":case"Escape":this.close(null);break;case"Enter":this.close(this.listControl.selectedItem());break;default:return}e.consume(!0)}close(e){this.selectionDone&&this.selectionDone(e),this.focusRestorer.restore(),this.glassPane.hide(),ft.instance=null}createElementForItem(e){const t=ut.previewElement(e);return s.ARIAUtils.markAsMenuItem(t),t.classList.remove("selected"),t}heightForItem(e){return console.assert(!1,"Should not be called"),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,n){i&&i.classList.remove("selected"),n&&n.classList.add("selected")}updateSelectedItemARIA(e,t){return!1}static instance=null}class Tt extends s.Toolbar.ToolbarItem{contentElement;constructor(e){const t=document.createElement("button");t.classList.add("history-dropdown-button"),super(t),this.contentElement=this.element.createChild("span","content");const i=s.Icon.Icon.create("smallicon-triangle-down");this.element.appendChild(i),this.element.addEventListener("click",(()=>{e.execute()}),!1),this.setEnabled(e.enabled()),e.addEventListener("Enabled",(e=>this.setEnabled(e.data))),this.setTitle(e.title())}setText(e){this.contentElement.textContent=e}}var wt=Object.freeze({__proto__:null,TimelineHistoryManager:ut,maxRecordings:pt,previewWidth:gt,DropDown:ft,ToolbarButton:Tt});const St={frameStart:"Frame Start",drawFrame:"Draw Frame",layout:"Layout",rasterizing:"Rasterizing",drawing:"Drawing",painting:"Painting",system:"System",idle:"Idle"},yt=i.i18n.registerUIStrings("panels/timeline/UIDevtoolsUtils.ts",St),bt=i.i18n.getLocalizedString.bind(void 0,yt);let Ct=null,kt=null;class Pt{static isUiDevTools(){return"true"===c.Runtime.Runtime.queryParam("uiDevTools")}static categorizeEvents(){if(Ct)return Ct;const e=Mt,t=Pt.categories(),i=t.drawing,n=t.rasterizing,a=t.layout,r=t.painting,s=t.other,o={};return o[e.ViewPaint]=new ni("View::Paint",r),o[e.ViewOnPaint]=new ni("View::OnPaint",r),o[e.ViewPaintChildren]=new ni("View::PaintChildren",r),o[e.ViewOnPaintBackground]=new ni("View::OnPaintBackground",r),o[e.ViewOnPaintBorder]=new ni("View::OnPaintBorder",r),o[e.LayerPaintContentsToDisplayList]=new ni("Layer::PaintContentsToDisplayList",r),o[e.ViewLayout]=new ni("View::Layout",a),o[e.ViewLayoutBoundsChanged]=new ni("View::Layout(bounds_changed)",a),o[e.RasterTask]=new ni("RasterTask",n),o[e.RasterizerTaskImplRunOnWorkerThread]=new ni("RasterizerTaskImpl::RunOnWorkerThread",n),o[e.DirectRendererDrawFrame]=new ni("DirectRenderer::DrawFrame",i),o[e.BeginFrame]=new ni(bt(St.frameStart),i,!0),o[e.DrawFrame]=new ni(bt(St.drawFrame),i,!0),o[e.NeedsBeginFrameChanged]=new ni("NeedsBeginFrameChanged",i,!0),o[e.ThreadControllerImplRunTask]=new ni("ThreadControllerImpl::RunTask",s),Ct=o,o}static categories(){return kt||(kt={layout:new di("layout",bt(St.layout),!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),rasterizing:new di("rasterizing",bt(St.rasterizing),!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),drawing:new di("drawing",bt(St.drawing),!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new di("painting",bt(St.painting),!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),other:new di("other",bt(St.system),!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new di("idle",bt(St.idle),!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")},kt)}static getMainCategoriesList(){return["idle","drawing","painting","rasterizing","layout","other"]}}var Mt;!function(e){e.ViewPaint="View::Paint",e.ViewOnPaint="View::OnPaint",e.ViewPaintChildren="View::PaintChildren",e.ViewOnPaintBackground="View::OnPaintBackground",e.ViewOnPaintBorder="View::OnPaintBorder",e.ViewLayout="View::Layout",e.ViewLayoutBoundsChanged="View::Layout(bounds_changed)",e.LayerPaintContentsToDisplayList="Layer::PaintContentsToDisplayList",e.DirectRendererDrawFrame="DirectRenderer::DrawFrame",e.RasterTask="RasterTask",e.RasterizerTaskImplRunOnWorkerThread="RasterizerTaskImpl::RunOnWorkerThread",e.BeginFrame="BeginFrame",e.DrawFrame="DrawFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.ThreadControllerImplRunTask="ThreadControllerImpl::RunTask"}(Mt||(Mt={}));var xt=Object.freeze({__proto__:null,UIDevtoolsUtils:Pt,get RecordType(){return Mt}});class It extends A{constructor(e,t){super(e,t),ii.setEventStylesMap(Pt.categorizeEvents()),ii.setCategories(Pt.categories()),ii.setTimelineMainEventCategories(Pt.getMainCategoriesList())}}var Rt=Object.freeze({__proto__:null,UIDevtoolsController:It});const Et={dropTimelineFileOrUrlHere:"Drop timeline file or URL here",disableJavascriptSamples:"Disable JavaScript samples",enableAdvancedPaint:"Enable advanced paint instrumentation (slow)",screenshots:"Screenshots",coverage:"Coverage",memory:"Memory",webVitals:"Web Vitals",clear:"Clear",loadProfile:"Load profile…",saveProfile:"Save profile…",captureScreenshots:"Capture screenshots",showMemoryTimeline:"Show memory timeline",showWebVitals:"Show Web Vitals",recordCoverageWithPerformance:"Record coverage with performance trace",captureSettings:"Capture settings",disablesJavascriptSampling:"Disables JavaScript sampling, reduces overhead when running against mobile devices",capturesAdvancedPaint:"Captures advanced paint instrumentation, introduces significant performance overhead",network:"Network:",cpu:"CPU:",networkConditions:"Network conditions",failedToSaveTimelineSSS:"Failed to save timeline: {PH1} ({PH2}, {PH3})",CpuThrottlingIsEnabled:"- CPU throttling is enabled",NetworkThrottlingIsEnabled:"- Network throttling is enabled",HardwareConcurrencyIsEnabled:"- Hardware concurrency override is enabled",SignificantOverheadDueToPaint:"- Significant overhead due to paint instrumentation",JavascriptSamplingIsDisabled:"- JavaScript sampling is disabled",stoppingTimeline:"Stopping timeline…",received:"Received",close:"Close",recordingFailed:"Recording failed",profiling:"Profiling…",bufferUsage:"Buffer usage",learnmore:"Learn more",wasd:"WASD",clickTheRecordButtonSOrHitSTo:"Click the record button {PH1} or hit {PH2} to start a new recording.",clickTheReloadButtonSOrHitSTo:"Click the reload button {PH1} or hit {PH2} to record the page load.",afterRecordingSelectAnAreaOf:"After recording, select an area of interest in the overview by dragging. Then, zoom and pan the timeline with the mousewheel or {PH1} keys. {PH2}",loadingProfile:"Loading profile…",processingProfile:"Processing profile…",initializingProfiler:"Initializing profiler…",status:"Status",time:"Time",description:"Description",stop:"Stop",ssec:"{PH1} sec"},Lt=i.i18n.registerUIStrings("panels/timeline/TimelinePanel.ts",Et),Ft=i.i18n.getLocalizedString.bind(void 0,Lt);let Dt;class Ut extends s.Panel.Panel{dropTarget;recordingOptionUIControls;state;recordingPageReload;millisecondsToRecordAfterLoadEvent;toggleRecordAction;recordReloadAction;historyManager;performanceModel;viewModeSetting;disableCaptureJSProfileSetting;captureLayersAndPicturesSetting;showScreenshotsSetting;startCoverage;showMemorySetting;showWebVitalsSetting;panelToolbar;panelRightToolbar;timelinePane;overviewPane;overviewControls;statusPaneContainer;flameChart;searchableViewInternal;showSettingsPaneButton;showSettingsPaneSetting;settingsPane;controller;clearButton;loadButton;saveButton;statusPane;landingPage;loader;showScreenshotsToolbarCheckbox;showMemoryToolbarCheckbox;showWebVitalsToolbarCheckbox;startCoverageCheckbox;networkThrottlingSelect;cpuThrottlingSelect;fileSelectorElement;selection;constructor(){super("timeline"),this.element.addEventListener("contextmenu",this.contextMenu.bind(this),!1),this.dropTarget=new s.DropTarget.DropTarget(this.element,[s.DropTarget.Type.File,s.DropTarget.Type.URI],Ft(Et.dropTimelineFileOrUrlHere),this.handleDrop.bind(this)),this.recordingOptionUIControls=[],this.state=Ht.Idle,this.recordingPageReload=!1,this.millisecondsToRecordAfterLoadEvent=5e3,this.toggleRecordAction=s.ActionRegistry.ActionRegistry.instance().action("timeline.toggle-recording"),this.recordReloadAction=s.ActionRegistry.ActionRegistry.instance().action("timeline.record-reload"),this.historyManager=new ut,this.performanceModel=null,this.viewModeSetting=t.Settings.Settings.instance().createSetting("timelineViewMode",Wt.FlameChart),this.disableCaptureJSProfileSetting=t.Settings.Settings.instance().createSetting("timelineDisableJSSampling",!1),this.disableCaptureJSProfileSetting.setTitle(Ft(Et.disableJavascriptSamples)),this.captureLayersAndPicturesSetting=t.Settings.Settings.instance().createSetting("timelineCaptureLayersAndPictures",!1),this.captureLayersAndPicturesSetting.setTitle(Ft(Et.enableAdvancedPaint)),this.showScreenshotsSetting=t.Settings.Settings.instance().createSetting("timelineShowScreenshots",!0),this.showScreenshotsSetting.setTitle(Ft(Et.screenshots)),this.showScreenshotsSetting.addChangeListener(this.updateOverviewControls,this),this.startCoverage=t.Settings.Settings.instance().createSetting("timelineStartCoverage",!1),this.startCoverage.setTitle(Ft(Et.coverage)),c.Runtime.experiments.isEnabled("recordCoverageWithPerformanceTracing")||this.startCoverage.set(!1),this.showMemorySetting=t.Settings.Settings.instance().createSetting("timelineShowMemory",!1),this.showMemorySetting.setTitle(Ft(Et.memory)),this.showMemorySetting.addChangeListener(this.onModeChanged,this),this.showWebVitalsSetting=t.Settings.Settings.instance().createSetting("timelineWebVitals",!1),this.showWebVitalsSetting.setTitle(Ft(Et.webVitals)),this.showWebVitalsSetting.addChangeListener(this.onWebVitalsChanged,this);const i=this.element.createChild("div","timeline-toolbar-container");this.panelToolbar=new s.Toolbar.Toolbar("timeline-main-toolbar",i),this.panelToolbar.makeWrappable(!0),this.panelRightToolbar=new s.Toolbar.Toolbar("",i),this.createSettingsPane(),this.updateShowSettingsToolbarButton(),this.timelinePane=new s.Widget.VBox,this.timelinePane.show(this.element);const n=this.timelinePane.element.createChild("div","hbox");n.id="timeline-overview-panel",this.overviewPane=new r.TimelineOverviewPane.TimelineOverviewPane("timeline"),this.overviewPane.addEventListener(r.TimelineOverviewPane.Events.WindowChanged,this.onOverviewWindowChanged.bind(this)),this.overviewPane.show(n),this.overviewControls=[],this.statusPaneContainer=this.timelinePane.element.createChild("div","status-pane-container fill"),this.createFileSelector(),e.TargetManager.TargetManager.instance().addModelListener(e.ResourceTreeModel.ResourceTreeModel,e.ResourceTreeModel.Events.Load,this.loadEventFired,this),this.flameChart=new nt(this),this.searchableViewInternal=new s.SearchableView.SearchableView(this.flameChart,null),this.searchableViewInternal.setMinimumSize(0,100),this.searchableViewInternal.element.classList.add("searchable-view"),this.searchableViewInternal.show(this.timelinePane.element),this.flameChart.show(this.searchableViewInternal.element),this.flameChart.setSearchableView(this.searchableViewInternal),this.searchableViewInternal.hideWidget(),this.onModeChanged(),this.onWebVitalsChanged(),this.populateToolbar(),this.showLandingPage(),this.updateTimelineControls(),h.ExtensionServer.ExtensionServer.instance().addEventListener(h.ExtensionServer.Events.TraceProviderAdded,this.appendExtensionsToToolbar,this),e.TargetManager.TargetManager.instance().addEventListener(e.TargetManager.Events.SuspendStateChanged,this.onSuspendStateChanged,this)}static instance(e={forceNew:null}){const{forceNew:t}=e;return Dt&&!t||(Dt=new Ut),Dt}searchableView(){return this.searchableViewInternal}wasShown(){super.wasShown(),s.Context.Context.instance().setFlavor(Ut,this),this.registerCSSFiles([M]),d.userMetrics.panelLoaded("timeline","DevTools.Launch.Timeline")}willHide(){s.Context.Context.instance().setFlavor(Ut,null),this.historyManager.cancelIfShowing()}loadFromEvents(e){this.state===Ht.Idle&&(this.prepareToLoadTimeline(),this.loader=L.loadFromEvents(e,this))}onOverviewWindowChanged(e){if(!this.performanceModel)return;const t=e.data.startTime,i=e.data.endTime;this.performanceModel.setWindow({left:t,right:i},!0)}onModelWindowChanged(e){const t=e.data.window;this.overviewPane.setWindowTimes(t.left,t.right)}setState(e){this.state=e,this.updateTimelineControls()}createSettingCheckbox(e,t){const i=new s.Toolbar.ToolbarSettingCheckbox(e,t);return this.recordingOptionUIControls.push(i),i}populateToolbar(){this.panelToolbar.appendToolbarItem(s.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),this.panelToolbar.appendToolbarItem(s.Toolbar.Toolbar.createActionButton(this.recordReloadAction)),this.clearButton=new s.Toolbar.ToolbarButton(Ft(Et.clear),"largeicon-clear"),this.clearButton.addEventListener(s.Toolbar.ToolbarButton.Events.Click,(()=>this.onClearButton())),this.panelToolbar.appendToolbarItem(this.clearButton),this.loadButton=new s.Toolbar.ToolbarButton(Ft(Et.loadProfile),"largeicon-load"),this.loadButton.addEventListener(s.Toolbar.ToolbarButton.Events.Click,(()=>{d.userMetrics.actionTaken(d.UserMetrics.Action.PerfPanelTraceImported),this.selectFileToLoad()})),this.saveButton=new s.Toolbar.ToolbarButton(Ft(Et.saveProfile),"largeicon-download"),this.saveButton.addEventListener(s.Toolbar.ToolbarButton.Events.Click,(e=>{d.userMetrics.actionTaken(d.UserMetrics.Action.PerfPanelTraceExported),this.saveToFile()})),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.loadButton),this.panelToolbar.appendToolbarItem(this.saveButton),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.historyManager.button()),this.panelToolbar.registerCSSFiles([P]),this.panelToolbar.appendSeparator(),this.panelToolbar.appendSeparator(),this.showScreenshotsToolbarCheckbox=this.createSettingCheckbox(this.showScreenshotsSetting,Ft(Et.captureScreenshots)),this.panelToolbar.appendToolbarItem(this.showScreenshotsToolbarCheckbox),this.showMemoryToolbarCheckbox=this.createSettingCheckbox(this.showMemorySetting,Ft(Et.showMemoryTimeline)),this.panelToolbar.appendToolbarItem(this.showMemoryToolbarCheckbox),this.showWebVitalsToolbarCheckbox=this.createSettingCheckbox(this.showWebVitalsSetting,Ft(Et.showWebVitals)),this.panelToolbar.appendToolbarItem(this.showWebVitalsToolbarCheckbox),c.Runtime.experiments.isEnabled("recordCoverageWithPerformanceTracing")&&(this.startCoverageCheckbox=this.createSettingCheckbox(this.startCoverage,Ft(Et.recordCoverageWithPerformance)),this.panelToolbar.appendToolbarItem(this.startCoverageCheckbox)),this.panelToolbar.appendToolbarItem(s.Toolbar.Toolbar.createActionButtonForId("components.collect-garbage")),this.panelRightToolbar.appendSeparator(),this.panelRightToolbar.appendToolbarItem(this.showSettingsPaneButton)}createSettingsPane(){this.showSettingsPaneSetting=t.Settings.Settings.instance().createSetting("timelineShowSettingsToolbar",!1),this.showSettingsPaneButton=new s.Toolbar.ToolbarSettingToggle(this.showSettingsPaneSetting,"largeicon-settings-gear",Ft(Et.captureSettings)),e.NetworkManager.MultitargetNetworkManager.instance().addEventListener(e.NetworkManager.MultitargetNetworkManager.Events.ConditionsChanged,this.updateShowSettingsToolbarButton,this),e.CPUThrottlingManager.CPUThrottlingManager.instance().addEventListener(e.CPUThrottlingManager.Events.RateChanged,this.updateShowSettingsToolbarButton,this),e.CPUThrottlingManager.CPUThrottlingManager.instance().addEventListener(e.CPUThrottlingManager.Events.HardwareConcurrencyChanged,this.updateShowSettingsToolbarButton,this),this.disableCaptureJSProfileSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.captureLayersAndPicturesSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.settingsPane=new s.Widget.HBox,this.settingsPane.element.classList.add("timeline-settings-pane"),this.settingsPane.show(this.element);const i=new s.Toolbar.Toolbar("",this.settingsPane.element);i.element.classList.add("flex-auto"),i.makeVertical(),i.appendToolbarItem(this.createSettingCheckbox(this.disableCaptureJSProfileSetting,Ft(Et.disablesJavascriptSampling))),i.appendToolbarItem(this.createSettingCheckbox(this.captureLayersAndPicturesSetting,Ft(Et.capturesAdvancedPaint)));const n=new s.Widget.VBox;n.element.classList.add("flex-auto"),n.show(this.settingsPane.element);const a=new s.Toolbar.Toolbar("",n.element);a.appendText(Ft(Et.cpu)),this.cpuThrottlingSelect=m.ThrottlingManager.throttlingManager().createCPUThrottlingSelector(),a.appendToolbarItem(this.cpuThrottlingSelect);const r=new s.Toolbar.Toolbar("",n.element);r.appendText(Ft(Et.network)),this.networkThrottlingSelect=this.createNetworkConditionsSelect(),r.appendToolbarItem(this.networkThrottlingSelect);const o=new s.Widget.VBox;o.element.classList.add("flex-auto"),o.show(this.settingsPane.element);const{toggle:l,input:d,reset:c,warning:h}=m.ThrottlingManager.throttlingManager().createHardwareConcurrencySelector(),u=new s.Toolbar.Toolbar("",o.element);u.registerCSSFiles([M]),d.element.classList.add("timeline-concurrency-input"),u.appendToolbarItem(l),u.appendToolbarItem(d),u.appendToolbarItem(c),u.appendToolbarItem(h),this.showSettingsPaneSetting.addChangeListener(this.updateSettingsPaneVisibility.bind(this)),this.updateSettingsPaneVisibility()}appendExtensionsToToolbar(e){const t=e.data,i=Ut.settingForTraceProvider(t),n=this.createSettingCheckbox(i,t.longDisplayName());this.panelToolbar.appendToolbarItem(n)}static settingForTraceProvider(e){let i=Gt.get(e);if(!i){const n=e.persistentIdentifier();i=t.Settings.Settings.instance().createSetting(n,!1),i.setTitle(e.shortDisplayName()),Gt.set(e,i)}return i}createNetworkConditionsSelect(){const e=new s.Toolbar.ToolbarComboBox(null,Ft(Et.networkConditions));return e.setMaxWidth(140),m.ThrottlingManager.throttlingManager().decorateSelectWithNetworkThrottling(e.selectElement()),e}prepareToLoadTimeline(){console.assert(this.state===Ht.Idle),this.setState(Ht.Loading),this.performanceModel&&(this.performanceModel.dispose(),this.performanceModel=null)}createFileSelector(){this.fileSelectorElement&&this.fileSelectorElement.remove(),this.fileSelectorElement=s.UIUtils.createFileSelectorElement(this.loadFromFile.bind(this)),this.timelinePane.element.appendChild(this.fileSelectorElement)}contextMenu(e){const t=new s.ContextMenu.ContextMenu(e);t.appendItemsAtLocation("timelineMenu"),t.show()}async saveToFile(){if(this.state!==Ht.Idle)return;const e=this.performanceModel;if(!e)return;const i=new Date,a="Profile-"+n.DateUtilities.toISO8601Compact(i)+".json",r=new o.FileUtils.FileOutputStream;if(!await r.open(a))return;const s=await e.save(r);s&&t.Console.Console.instance().error(Ft(Et.failedToSaveTimelineSSS,{PH1:s.message,PH2:s.name,PH3:s.code}))}async showHistory(){const e=await this.historyManager.showHistoryDropDown();e&&e!==this.performanceModel&&this.setModel(e)}navigateHistory(e){const t=this.historyManager.navigate(e);return t&&t!==this.performanceModel&&this.setModel(t),!0}selectFileToLoad(){this.fileSelectorElement&&this.fileSelectorElement.click()}loadFromFile(e){this.state===Ht.Idle&&(this.prepareToLoadTimeline(),this.loader=L.loadFromFile(e,this),this.createFileSelector())}loadFromURL(e){this.state===Ht.Idle&&(this.prepareToLoadTimeline(),this.loader=L.loadFromURL(e,this))}updateOverviewControls(){this.overviewControls=[],this.overviewControls.push(new K),c.Runtime.experiments.isEnabled("inputEventsOnTimelineOverview")&&this.overviewControls.push(new q),this.overviewControls.push(new $),this.overviewControls.push(new J),this.showScreenshotsSetting.get()&&this.performanceModel&&this.performanceModel.filmStripModel().frames().length&&this.overviewControls.push(new Y),this.showMemorySetting.get()&&this.overviewControls.push(new Q),this.startCoverage.get()&&this.overviewControls.push(new ee);for(const e of this.overviewControls)e.setModel(this.performanceModel);this.overviewPane.setOverviewControls(this.overviewControls)}onModeChanged(){this.updateOverviewControls(),this.doResize(),this.select(null)}onWebVitalsChanged(){this.flameChart.toggleWebVitalsLane()}updateSettingsPaneVisibility(){this.showSettingsPaneSetting.get()?this.settingsPane.showWidget():this.settingsPane.hideWidget()}updateShowSettingsToolbarButton(){const t=[];if(1!==e.CPUThrottlingManager.CPUThrottlingManager.instance().cpuThrottlingRate()&&t.push(Ft(Et.CpuThrottlingIsEnabled)),m.ThrottlingManager.throttlingManager().hardwareConcurrencyOverrideEnabled&&t.push(Ft(Et.HardwareConcurrencyIsEnabled)),e.NetworkManager.MultitargetNetworkManager.instance().isThrottling()&&t.push(Ft(Et.NetworkThrottlingIsEnabled)),this.captureLayersAndPicturesSetting.get()&&t.push(Ft(Et.SignificantOverheadDueToPaint)),this.disableCaptureJSProfileSetting.get()&&t.push(Ft(Et.JavascriptSamplingIsDisabled)),this.showSettingsPaneButton.setDefaultWithRedColor(t.length>0),this.showSettingsPaneButton.setToggleWithRedColor(t.length>0),t.length){const e=document.createElement("div");t.forEach((t=>{e.createChild("div").textContent=t})),this.showSettingsPaneButton.setTitle(e.textContent||"")}else this.showSettingsPaneButton.setTitle(Ft(Et.captureSettings))}setUIControlsEnabled(e){this.recordingOptionUIControls.forEach((t=>t.setEnabled(e)))}async getCoverageViewWidget(){const e=s.ViewManager.ViewManager.instance().view("coverage");return await e.widget()}async startRecording(){console.assert(!this.statusPane,"Status pane is already opened."),this.setState(Ht.StartPending);const t={enableJSSampling:!this.disableCaptureJSProfileSetting.get(),capturePictures:this.captureLayersAndPicturesSetting.get(),captureFilmStrip:this.showScreenshotsSetting.get(),startCoverage:this.startCoverage.get()};t.startCoverage&&await s.ViewManager.ViewManager.instance().showView("coverage").then((()=>this.getCoverageViewWidget())).then((e=>e.ensureRecordingStarted())),this.showRecordingStarted();const i=h.ExtensionServer.ExtensionServer.instance().traceProviders().filter((e=>Ut.settingForTraceProvider(e).get())),n=e.TargetManager.TargetManager.instance().mainTarget();Pt.isUiDevTools()?this.controller=new It(n,this):this.controller=new A(n,this),this.setUIControlsEnabled(!1),this.hideLandingPage();try{const e=await this.controller.startRecording(t,i);if(e.getError())throw new Error(e.getError());this.recordingStarted()}catch(e){this.recordingFailed(e.message)}}async stopRecording(){if(this.statusPane&&(this.statusPane.finish(),this.statusPane.updateStatus(Ft(Et.stoppingTimeline)),this.statusPane.updateProgressBar(Ft(Et.received),0)),this.setState(Ht.StopPending),this.startCoverage.get()&&await s.ViewManager.ViewManager.instance().showView("coverage").then((()=>this.getCoverageViewWidget())).then((e=>e.stopRecording())),this.controller){const e=await this.controller.stopRecording();this.performanceModel=e,this.setUIControlsEnabled(!0),this.controller.dispose(),this.controller=null}}recordingFailed(e){this.statusPane&&this.statusPane.remove(),this.statusPane=new Bt({description:e,buttonText:Ft(Et.close),buttonDisabled:!1,showProgress:void 0,showTimer:void 0},(()=>this.loadingComplete(null))),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Ft(Et.recordingFailed)),this.setState(Ht.RecordingFailed),this.performanceModel=null,this.setUIControlsEnabled(!0),this.controller&&(this.controller.dispose(),this.controller=null)}onSuspendStateChanged(){this.updateTimelineControls()}updateTimelineControls(){const e=Ht;this.toggleRecordAction.setToggled(this.state===e.Recording),this.toggleRecordAction.setEnabled(this.state===e.Recording||this.state===e.Idle),this.recordReloadAction.setEnabled(this.state===e.Idle),this.historyManager.setEnabled(this.state===e.Idle),this.clearButton.setEnabled(this.state===e.Idle),this.panelToolbar.setEnabled(this.state!==e.Loading),this.panelRightToolbar.setEnabled(this.state!==e.Loading),this.dropTarget.setEnabled(this.state===e.Idle),this.loadButton.setEnabled(this.state===e.Idle),this.saveButton.setEnabled(this.state===e.Idle&&Boolean(this.performanceModel))}toggleRecording(){this.state===Ht.Idle?(this.recordingPageReload=!1,this.startRecording(),d.userMetrics.actionTaken(d.UserMetrics.Action.TimelineStarted)):this.state===Ht.Recording&&this.stopRecording()}recordReload(){this.state===Ht.Idle&&(this.recordingPageReload=!0,this.startRecording(),d.userMetrics.actionTaken(d.UserMetrics.Action.TimelinePageReloadStarted))}onClearButton(){this.historyManager.clear(),this.clear()}clear(){this.showLandingPage(),this.reset()}reset(){r.LineLevelProfile.Performance.instance().reset(),this.setModel(null)}applyFilters(e){e.timelineModel().isGenericTrace()||c.Runtime.experiments.isEnabled("timelineShowAllEvents")||e.setFilters([ii.visibleEventsFilter()])}setModel(e){if(this.performanceModel&&this.performanceModel.removeEventListener(ui.WindowChanged,this.onModelWindowChanged,this),this.performanceModel=e,e?(this.searchableViewInternal.showWidget(),this.applyFilters(e)):this.searchableViewInternal.hideWidget(),this.flameChart.setModel(e),this.updateOverviewControls(),this.overviewPane.reset(),e&&this.performanceModel){this.performanceModel.addEventListener(ui.WindowChanged,this.onModelWindowChanged,this),this.overviewPane.setNavStartTimes(e.timelineModel().navStartTimes()),this.overviewPane.setBounds(e.timelineModel().minimumRecordTime(),e.timelineModel().maximumRecordTime()),r.LineLevelProfile.Performance.instance().reset();for(const t of e.timelineModel().cpuProfiles())r.LineLevelProfile.Performance.instance().appendCPUProfile(t);this.setMarkers(e.timelineModel()),this.flameChart.setSelection(null),this.overviewPane.setWindowTimes(e.window().left,e.window().right)}for(const t of this.overviewControls)t.setModel(e);this.flameChart&&this.flameChart.resizeToPreferredHeights(),this.updateTimelineControls()}recordingStarted(){if(this.recordingPageReload&&this.controller){const t=this.controller.mainTarget().model(e.ResourceTreeModel.ResourceTreeModel);t&&t.reloadPage()}this.reset(),this.setState(Ht.Recording),this.showRecordingStarted(),this.statusPane&&(this.statusPane.enableAndFocusButton(),this.statusPane.updateStatus(Ft(Et.profiling)),this.statusPane.updateProgressBar(Ft(Et.bufferUsage),0),this.statusPane.startTimer()),this.hideLandingPage()}recordingProgress(e){this.statusPane&&this.statusPane.updateProgressBar(Ft(Et.bufferUsage),100*e)}showLandingPage(){if(this.landingPage)return void this.landingPage.show(this.statusPaneContainer);function e(e,t){const i=document.createElement(e);return i.textContent=t,i}const t=s.XLink.XLink.create("https://developer.chrome.com/docs/devtools/evaluate-performance/",Ft(Et.learnmore)),n=e("b",s.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.toggle-recording")[0].title()),a=e("b",s.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.record-reload")[0].title()),r=e("b",Ft(Et.wasd));this.landingPage=new s.Widget.VBox,this.landingPage.contentElement.classList.add("timeline-landing-page","fill");const o=this.landingPage.contentElement.createChild("div"),l=s.UIUtils.createInlineButton(s.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),d=s.UIUtils.createInlineButton(s.Toolbar.Toolbar.createActionButtonForId("timeline.record-reload"));o.createChild("p").appendChild(i.i18n.getFormatLocalizedString(Lt,Et.clickTheRecordButtonSOrHitSTo,{PH1:l,PH2:n})),o.createChild("p").appendChild(i.i18n.getFormatLocalizedString(Lt,Et.clickTheReloadButtonSOrHitSTo,{PH1:d,PH2:a})),o.createChild("p").appendChild(i.i18n.getFormatLocalizedString(Lt,Et.afterRecordingSelectAnAreaOf,{PH1:r,PH2:t})),this.landingPage.show(this.statusPaneContainer)}hideLandingPage(){this.landingPage.detach()}loadingStarted(){this.hideLandingPage(),this.statusPane&&this.statusPane.remove(),this.statusPane=new Bt({showProgress:!0,showTimer:void 0,buttonDisabled:void 0,buttonText:void 0,description:void 0},(()=>this.cancelLoading())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Ft(Et.loadingProfile)),this.loader||this.statusPane.finish(),this.loadingProgress(0)}loadingProgress(e){"number"==typeof e&&this.statusPane&&this.statusPane.updateProgressBar(Ft(Et.received),100*e)}processingStarted(){this.statusPane&&this.statusPane.updateStatus(Ft(Et.processingProfile))}loadingComplete(e){delete this.loader,this.setState(Ht.Idle),this.statusPane&&this.statusPane.remove(),this.statusPane=null,e?(this.performanceModel||(this.performanceModel=new gi),this.performanceModel.setTracingModel(e),this.setModel(this.performanceModel),this.historyManager.addRecording(this.performanceModel),this.startCoverage.get()&&s.ViewManager.ViewManager.instance().showView("coverage").then((()=>this.getCoverageViewWidget())).then((e=>e.processBacklog())).then((()=>this.updateOverviewControls()))):this.clear()}showRecordingStarted(){this.statusPane||(this.statusPane=new Bt({showTimer:!0,showProgress:!0,buttonDisabled:!0,description:void 0,buttonText:void 0},(()=>this.stopRecording())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Ft(Et.initializingProfiler)))}cancelLoading(){this.loader&&this.loader.cancel()}setMarkers(e){const t=new Map,i=a.TimelineModel.RecordType,n=e.minimumRecordTime();for(const a of e.timeMarkerEvents())a.name!==i.TimeStamp&&a.name!==i.ConsoleTime&&t.set(a.startTime,ii.createEventDivider(a,n));for(const i of e.navStartTimes().values())t.set(i.startTime,ii.createEventDivider(i,n));this.overviewPane.setMarkers(t)}async loadEventFired(e){if(this.state!==Ht.Recording||!this.recordingPageReload||!this.controller||this.controller.mainTarget()!==e.data.resourceTreeModel.target())return;const t=this.controller;await new Promise((e=>window.setTimeout(e,this.millisecondsToRecordAfterLoadEvent))),t===this.controller&&this.state===Ht.Recording&&this.stopRecording()}frameForSelection(e){switch(e.type()){case Vt.Type.Frame:return e.object();case Vt.Type.Range:return null;case Vt.Type.TraceEvent:return this.performanceModel?this.performanceModel.frameModel().getFramesWithinWindow(e.endTimeInternal,e.endTimeInternal)[0]:null;default:return console.assert(!1,"Should never be reached"),null}}jumpToFrame(e){const t=this.selection&&this.frameForSelection(this.selection);if(!t||!this.performanceModel)return;const i=this.performanceModel.frames();let a=i.indexOf(t);console.assert(a>=0,"Can't find current frame in the frame list"),a=n.NumberUtilities.clamp(a+e,0,i.length-1);const r=i[a];return this.revealTimeRange(r.startTime,r.endTime),this.select(Vt.fromFrame(r)),!0}select(e){this.selection=e,this.flameChart.setSelection(e)}selectEntryAtTime(t,i){if(t){for(let a=n.ArrayUtilities.upperBound(t,i,((e,t)=>e-t.startTime))-1;a>=0;--a){const n=t[a],r=n.endTime||n.startTime;if(e.TracingModel.TracingModel.isTopLevelEvent(n)&&r<i)break;if(this.performanceModel&&this.performanceModel.isVisible(n)&&r>=i)return void this.select(Vt.fromTraceEvent(n))}this.select(null)}}highlightEvent(e){this.flameChart.highlightEvent(e)}revealTimeRange(e,t){if(!this.performanceModel)return;const i=this.performanceModel.window();let n=0;i.right<t?n=t-i.right:i.left>e&&(n=e-i.left),this.performanceModel.setWindow({left:i.left+n,right:i.right+n},!0)}handleDrop(e){const i=e.items;if(!i.length)return;const n=i[0];if(d.userMetrics.actionTaken(d.UserMetrics.Action.PerfPanelTraceImported),"string"===n.kind){const i=e.getData("text/uri-list");new t.ParsedURL.ParsedURL(i).isValid&&this.loadFromURL(i)}else if("file"===n.kind){const e=i[0].getAsFile();if(!e)return;this.loadFromFile(e)}}}var Ht,Wt;!function(e){e.Idle="Idle",e.StartPending="StartPending",e.Recording="Recording",e.StopPending="StopPending",e.Loading="Loading",e.RecordingFailed="RecordingFailed"}(Ht||(Ht={})),function(e){e.FlameChart="FlameChart",e.BottomUp="BottomUp",e.CallTree="CallTree",e.EventLog="EventLog"}(Wt||(Wt={}));class Vt{typeInternal;startTimeInternal;endTimeInternal;objectInternal;constructor(e,t,i,n){this.typeInternal=e,this.startTimeInternal=t,this.endTimeInternal=i,this.objectInternal=n||null}static fromFrame(e){return new Vt(Vt.Type.Frame,e.startTime,e.endTime,e)}static fromNetworkRequest(e){return new Vt(Vt.Type.NetworkRequest,e.startTime,e.endTime||e.startTime,e)}static fromTraceEvent(e){return new Vt(Vt.Type.TraceEvent,e.startTime,e.endTime||e.startTime+1,e)}static fromRange(e,t){return new Vt(Vt.Type.Range,e,t)}type(){return this.typeInternal}object(){return this.objectInternal}startTime(){return this.startTimeInternal}endTime(){return this.endTimeInternal}}!function(e){let t;!function(e){e.Frame="Frame",e.NetworkRequest="NetworkRequest",e.TraceEvent="TraceEvent",e.Range="Range"}(t=e.Type||(e.Type={}))}(Vt||(Vt={}));class Bt extends s.Widget.VBox{status;time;progressLabel;progressBar;description;button;startTime;timeUpdateTimer;constructor(e,t){super(!0),this.contentElement.classList.add("timeline-status-dialog");const i=this.contentElement.createChild("div","status-dialog-line status");if(i.createChild("div","label").textContent=Ft(Et.status),this.status=i.createChild("div","content"),s.ARIAUtils.markAsStatus(this.status),e.showTimer){const e=this.contentElement.createChild("div","status-dialog-line time");e.createChild("div","label").textContent=Ft(Et.time),this.time=e.createChild("div","content")}if(e.showProgress){const e=this.contentElement.createChild("div","status-dialog-line progress");this.progressLabel=e.createChild("div","label"),this.progressBar=e.createChild("div","indicator-container").createChild("div","indicator"),s.ARIAUtils.markAsProgressBar(this.progressBar)}if("string"==typeof e.description){const t=this.contentElement.createChild("div","status-dialog-line description");t.createChild("div","label").textContent=Ft(Et.description),this.description=t.createChild("div","content"),this.description.innerText=e.description}const n=e.buttonText||Ft(Et.stop);this.button=s.UIUtils.createTextButton(n,t,"",!0),this.button.disabled=!1==!e.buttonDisabled,this.contentElement.createChild("div","stop-button").appendChild(this.button)}finish(){this.stopTimer(),this.button.disabled=!0}remove(){this.element.parentNode.classList.remove("tinted"),this.arrangeDialog(this.element.parentNode),this.stopTimer(),this.element.remove()}showPane(e){this.arrangeDialog(e),this.show(e),e.classList.add("tinted")}enableAndFocusButton(){this.button.disabled=!1,this.button.focus()}updateStatus(e){this.status.textContent=e}updateProgressBar(e,t){this.progressLabel.textContent=e,this.progressBar.style.width=t.toFixed(1)+"%",s.ARIAUtils.setValueNow(this.progressBar,t),this.updateTimer()}startTimer(){this.startTime=Date.now(),this.timeUpdateTimer=window.setInterval(this.updateTimer.bind(this,!1),1e3),this.updateTimer()}stopTimer(){this.timeUpdateTimer&&(clearInterval(this.timeUpdateTimer),this.updateTimer(!0),delete this.timeUpdateTimer)}updateTimer(e){if(this.arrangeDialog(this.element.parentNode),!this.timeUpdateTimer)return;const t=(Date.now()-this.startTime)/1e3;this.time.textContent=Ft(Et.ssec,{PH1:t.toFixed(e?1:0)})}arrangeDialog(e){const t=e.clientWidth<325;this.element.classList.toggle("small-dialog",t),this.contentElement.classList.toggle("small-dialog",t)}wasShown(){super.wasShown(),this.registerCSSFiles([x])}}let Nt,At;class zt{static instance(e={forceNew:null}){const{forceNew:t}=e;return Nt&&!t||(Nt=new zt),Nt}handleQueryParam(e){s.ViewManager.ViewManager.instance().showView("timeline").then((()=>{Ut.instance().loadFromURL(window.decodeURIComponent(e))}))}}class Ot{static instance(e={forceNew:null}){const{forceNew:t}=e;return At&&!t||(At=new Ot),At}handleAction(e,t){const i=s.Context.Context.instance().flavor(Ut);switch(console.assert(i&&i instanceof Ut),t){case"timeline.toggle-recording":return i.toggleRecording(),!0;case"timeline.record-reload":return i.recordReload(),!0;case"timeline.save-to-file":return i.saveToFile(),!0;case"timeline.load-from-file":return i.selectFileToLoad(),!0;case"timeline.jump-to-previous-frame":return i.jumpToFrame(-1),!0;case"timeline.jump-to-next-frame":return i.jumpToFrame(1),!0;case"timeline.show-history":return i.showHistory(),!0;case"timeline.previous-recording":return i.navigateHistory(1),!0;case"timeline.next-recording":return i.navigateHistory(-1),!0}return!1}}const Gt=new WeakMap;var _t=Object.freeze({__proto__:null,TimelinePanel:Ut,get State(){return Ht},get ViewMode(){return Wt},rowHeight:18,headerHeight:20,get TimelineSelection(){return Vt},StatusPane:Bt,LoadTimelineHandler:zt,ActionDelegate:Ot});const jt={sAndS:"{PH1} and {PH2}",sAndSOther:"{PH1}, {PH2}, and 1 other",task:"Task",other:"Other",animation:"Animation",event:"Event",requestMainThreadFrame:"Request Main Thread Frame",frameStart:"Frame Start",frameStartMainThread:"Frame Start (main thread)",drawFrame:"Draw Frame",hitTest:"Hit Test",scheduleStyleRecalculation:"Schedule Style Recalculation",recalculateStyle:"Recalculate Style",invalidateLayout:"Invalidate Layout",layout:"Layout",paintSetup:"Paint Setup",paintImage:"Paint Image",prePaint:"Pre-Paint",updateLayer:"Update Layer",updateLayerTree:"Update Layer Tree",paint:"Paint",rasterizePaint:"Rasterize Paint",scroll:"Scroll",compositeLayers:"Composite Layers",computeIntersections:"Compute Intersections",parseHtml:"Parse HTML",parseStylesheet:"Parse Stylesheet",installTimer:"Install Timer",removeTimer:"Remove Timer",timerFired:"Timer Fired",xhrReadyStateChange:"`XHR` Ready State Change",xhrLoad:"`XHR` Load",compileScript:"Compile Script",cacheScript:"Cache Script Code",compileCode:"Compile Code",optimizeCode:"Optimize Code",evaluateScript:"Evaluate Script",compileModule:"Compile Module",cacheModule:"Cache Module Code",evaluateModule:"Evaluate Module",streamingCompileTask:"Streaming Compile Task",waitingForNetwork:"Waiting for Network",parseAndCompile:"Parse and Compile",streamingWasmResponse:"Streaming Wasm Response",compiledWasmModule:"Compiled Wasm Module",cachedWasmModule:"Cached Wasm Module",wasmModuleCacheHit:"Wasm Module Cache Hit",wasmModuleCacheInvalid:"Wasm Module Cache Invalid",frameStartedLoading:"Frame Started Loading",onloadEvent:"Onload Event",domcontentloadedEvent:"DOMContentLoaded Event",firstPaint:"First Paint",firstContentfulPaint:"First Contentful Paint",largestContentfulPaint:"Largest Contentful Paint",timestamp:"Timestamp",consoleTime:"Console Time",userTiming:"User Timing",willSendRequest:"Will Send Request",sendRequest:"Send Request",receiveResponse:"Receive Response",finishLoading:"Finish Loading",receiveData:"Receive Data",runMicrotasks:"Run Microtasks",functionCall:"Function Call",gcEvent:"GC Event",majorGc:"Major GC",minorGc:"Minor GC",jsFrame:"JS Frame",requestAnimationFrame:"Request Animation Frame",cancelAnimationFrame:"Cancel Animation Frame",animationFrameFired:"Animation Frame Fired",requestIdleCallback:"Request Idle Callback",cancelIdleCallback:"Cancel Idle Callback",fireIdleCallback:"Fire Idle Callback",createWebsocket:"Create WebSocket",sendWebsocketHandshake:"Send WebSocket Handshake",receiveWebsocketHandshake:"Receive WebSocket Handshake",destroyWebsocket:"Destroy WebSocket",embedderCallback:"Embedder Callback",imageDecode:"Image Decode",imageResize:"Image Resize",gpu:"GPU",inputLatency:"Input Latency",domGc:"DOM GC",encrypt:"Encrypt",encryptReply:"Encrypt Reply",decrypt:"Decrypt",decryptReply:"Decrypt Reply",digest:"Digest",digestReply:"Digest Reply",sign:"Sign",signReply:"Sign Reply",verify:"Verify",verifyReply:"Verify Reply",asyncTask:"Async Task",layoutShift:"Layout Shift",eventTiming:"Event Timing",keyCharacter:"Key — Character",keyDown:"Key Down",keyUp:"Key Up",click:"Click",contextMenu:"Context Menu",mouseDown:"Mouse Down",mouseMove:"Mouse Move",mouseUp:"Mouse Up",mouseWheel:"Mouse Wheel",scrollBegin:"Scroll Begin",scrollEnd:"Scroll End",scrollUpdate:"Scroll Update",flingStart:"Fling Start",flingHalt:"Fling Halt",tap:"Tap",tapHalt:"Tap Halt",tapBegin:"Tap Begin",tapDown:"Tap Down",touchCancel:"Touch Cancel",touchEnd:"Touch End",touchMove:"Touch Move",touchStart:"Touch Start",pinchBegin:"Pinch Begin",pinchEnd:"Pinch End",pinchUpdate:"Pinch Update",compile:"Compile",parse:"Parse",interactionEvent:"Interaction type:{PH1} id:{PH2}",sS:"{PH1}: {PH2}",response:"Response",fling:"Fling",drag:"Drag",uncategorized:"Uncategorized",sCollected:"{PH1} collected",sSs:"{PH1} [{PH2}…{PH3}]",sSSquareBrackets:"{PH1} [{PH2}…]",learnMore:"Learn more",compilationCacheStatus:"Compilation cache status",compilationCacheSize:"Compilation cache size",scriptLoadedFromCache:"script loaded from cache",failedToLoadScriptFromCache:"failed to load script from cache",scriptNotEligible:"script not eligible",totalTime:"Total Time",selfTime:"Self Time",collected:"Collected",function:"Function",timerId:"Timer ID",timeout:"Timeout",repeats:"Repeats",callbackId:"Callback ID",resource:"Resource",requestMethod:"Request Method",statusCode:"Status Code",mimeTypeCaps:"MIME Type",priority:"Priority",encodedData:"Encoded Data",sBytes:"{n, plural, =1 {# Byte} other {# Bytes}}",decodedBody:"Decoded Body",module:"Module",script:"Script",streamed:"Streamed",eagerCompile:"Compiling all functions eagerly",url:"Url",producedCacheSize:"Produced Cache Size",consumedCacheSize:"Consumed Cache Size",location:"Location",sSCurlyBrackets:"({PH1}, {PH2})",dimensions:"Dimensions",sSDimensions:"{PH1} × {PH2}",layerRoot:"Layer Root",ownerElement:"Owner Element",imageUrl:"Image URL",stylesheetUrl:"Stylesheet URL",elementsAffected:"Elements Affected",nodesThatNeedLayout:"Nodes That Need Layout",sOfS:"{PH1} of {PH2}",layoutRoot:"Layout root",message:"Message",websocketProtocol:"WebSocket Protocol",callbackFunction:"Callback Function",state:"State",range:"Range",allottedTime:"Allotted Time",invokedByTimeout:"Invoked by Timeout",type:"Type",size:"Size",details:"Details",cumulativeLayoutShifts:"Cumulative Layout Shifts",evolvedClsLink:"evolved",sCLSInformation:"{PH1} can result in poor user experiences. It has recently {PH2}.",warning:"Warning",score:"Score",cumulativeScore:"Cumulative Score",currentClusterScore:"Current Cluster Score",currentClusterId:"Current Cluster ID",hadRecentInput:"Had recent input",yes:"Yes",no:"No",movedFrom:"Moved from",movedTo:"Moved to",timeWaitingForMainThread:"Time Waiting for Main Thread",relatedNode:"Related Node",preview:"Preview",aggregatedTime:"Aggregated Time",networkRequest:"Network request",loadFromCache:"load from cache",networkTransfer:"network transfer",SSSResourceLoading:" ({PH1} {PH2} + {PH3} resource loading)",duration:"Duration",mimeType:"Mime Type",FromMemoryCache:" (from memory cache)",FromCache:" (from cache)",FromPush:" (from push)",FromServiceWorker:" (from `service worker`)",initiator:"Initiator",timerInstalled:"Timer Installed",animationFrameRequested:"Animation Frame Requested",idleCallbackRequested:"Idle Callback Requested",recalculationForced:"Recalculation Forced",firstLayoutInvalidation:"First Layout Invalidation",layoutForced:"Layout Forced",callStacks:"Call Stacks",stackTrace:"Stack Trace",invalidations:"Invalidations",pendingFor:"Pending for",reveal:"Reveal",firstInvalidated:"First Invalidated",styleInvalidations:"Style Invalidations",layoutInvalidations:"Layout Invalidations",otherInvalidations:"Other Invalidations",paintProfiler:"Paint Profiler",sAtS:"{PH1} at {PH2}",loading:"Loading",experience:"Experience",scripting:"Scripting",rendering:"Rendering",painting:"Painting",async:"Async",system:"System",idle:"Idle",sSelf:"{PH1} (self)",sChildren:"{PH1} (children)",timeSpentInRendering:"Time spent in rendering",frame:"Frame",cpuTime:"CPU time",layerTree:"Layer tree",show:"Show",sAtSParentheses:"{PH1} (at {PH2})",emptyPlaceholder:"{PH1}",jank:"jank",sLongFrameTimesAreAnIndicationOf:"{PH1}. Long frame times are an indication of {PH2}",forcedReflow:"Forced reflow",sIsALikelyPerformanceBottleneck:"{PH1} is a likely performance bottleneck.",idleCallbackExecutionExtended:"Idle callback execution extended beyond deadline by {PH1}",handlerTookS:"Handler took {PH1}",recurringHandlerTookS:"Recurring handler took {PH1}",longTask:"Long task",sTookS:"{PH1} took {PH2}.",notOptimized:"Not optimized",emptyPlaceholderColon:": {PH1}",unknownCause:"Unknown cause",sForS:"{PH1} for {PH2}",sSDot:"{PH1}. {PH2}",unknown:"unknown",stackTraceColon:"Stack trace:",nodes:"Nodes:",node:"Node:",changedIdToSs:'(changed id to "{PH1}"{PH2})',changedClassToSs:'(changed class to "{PH1}"{PH2})',changedAttributeToSs:'(changed attribute to "{PH1}"{PH2})',changedPesudoToSs:'(changed pseudo to "{PH1}"{PH2})',changedSs:'(changed "{PH1}"{PH2})',sSAndSOthers:"{PH1}, {PH2}, and {PH3} others",UnknownNode:"[ unknown node ]"},qt=i.i18n.registerUIStrings("panels/timeline/TimelineUIUtils.ts",jt),Jt=i.i18n.getLocalizedString.bind(void 0,qt);let Xt,$t,Kt,Yt,Qt,Zt,ei;const ti=new WeakMap;class ii{static initEventStyles(){if(Xt)return Xt;const e=a.TimelineModel.RecordType,t=ii.categories(),i=t.rendering,n=t.scripting,r=t.loading,s=t.experience,o=t.painting,l=t.other,d=t.idle,c={};return c[e.Task]=new ni(Jt(jt.task),l),c[e.Program]=new ni(Jt(jt.other),l),c[e.Animation]=new ni(Jt(jt.animation),i),c[e.EventDispatch]=new ni(Jt(jt.event),n),c[e.RequestMainThreadFrame]=new ni(Jt(jt.requestMainThreadFrame),i,!0),c[e.BeginFrame]=new ni(Jt(jt.frameStart),i,!0),c[e.BeginMainThreadFrame]=new ni(Jt(jt.frameStartMainThread),i,!0),c[e.DrawFrame]=new ni(Jt(jt.drawFrame),i,!0),c[e.HitTest]=new ni(Jt(jt.hitTest),i),c[e.ScheduleStyleRecalculation]=new ni(Jt(jt.scheduleStyleRecalculation),i),c[e.RecalculateStyles]=new ni(Jt(jt.recalculateStyle),i),c[e.UpdateLayoutTree]=new ni(Jt(jt.recalculateStyle),i),c[e.InvalidateLayout]=new ni(Jt(jt.invalidateLayout),i,!0),c[e.Layout]=new ni(Jt(jt.layout),i),c[e.PaintSetup]=new ni(Jt(jt.paintSetup),o),c[e.PaintImage]=new ni(Jt(jt.paintImage),o,!0),c[e.UpdateLayer]=new ni(Jt(jt.updateLayer),o,!0),c[e.UpdateLayerTree]=new ni(Jt(jt.updateLayerTree),i),c[e.Paint]=new ni(Jt(jt.paint),o),c[e.PrePaint]=new ni(Jt(jt.prePaint),i),c[e.RasterTask]=new ni(Jt(jt.rasterizePaint),o),c[e.ScrollLayer]=new ni(Jt(jt.scroll),i),c[e.CompositeLayers]=new ni(Jt(jt.compositeLayers),o),c[e.ComputeIntersections]=new ni(Jt(jt.computeIntersections),i),c[e.ParseHTML]=new ni(Jt(jt.parseHtml),r),c[e.ParseAuthorStyleSheet]=new ni(Jt(jt.parseStylesheet),r),c[e.TimerInstall]=new ni(Jt(jt.installTimer),n),c[e.TimerRemove]=new ni(Jt(jt.removeTimer),n),c[e.TimerFire]=new ni(Jt(jt.timerFired),n),c[e.XHRReadyStateChange]=new ni(Jt(jt.xhrReadyStateChange),n),c[e.XHRLoad]=new ni(Jt(jt.xhrLoad),n),c[e.CompileScript]=new ni(Jt(jt.compileScript),n),c[e.CacheScript]=new ni(Jt(jt.cacheScript),n),c[e.CompileCode]=new ni(Jt(jt.compileCode),n),c[e.OptimizeCode]=new ni(Jt(jt.optimizeCode),n),c[e.EvaluateScript]=new ni(Jt(jt.evaluateScript),n),c[e.CompileModule]=new ni(Jt(jt.compileModule),n),c[e.CacheModule]=new ni(Jt(jt.cacheModule),n),c[e.EvaluateModule]=new ni(Jt(jt.evaluateModule),n),c[e.StreamingCompileScript]=new ni(Jt(jt.streamingCompileTask),l),c[e.StreamingCompileScriptWaiting]=new ni(Jt(jt.waitingForNetwork),d),c[e.StreamingCompileScriptParsing]=new ni(Jt(jt.parseAndCompile),n),c[e.WasmStreamFromResponseCallback]=new ni(Jt(jt.streamingWasmResponse),n),c[e.WasmCompiledModule]=new ni(Jt(jt.compiledWasmModule),n),c[e.WasmCachedModule]=new ni(Jt(jt.cachedWasmModule),n),c[e.WasmModuleCacheHit]=new ni(Jt(jt.wasmModuleCacheHit),n),c[e.WasmModuleCacheInvalid]=new ni(Jt(jt.wasmModuleCacheInvalid),n),c[e.FrameStartedLoading]=new ni(Jt(jt.frameStartedLoading),r,!0),c[e.MarkLoad]=new ni(Jt(jt.onloadEvent),n,!0),c[e.MarkDOMContent]=new ni(Jt(jt.domcontentloadedEvent),n,!0),c[e.MarkFirstPaint]=new ni(Jt(jt.firstPaint),o,!0),c[e.MarkFCP]=new ni(Jt(jt.firstContentfulPaint),i,!0),c[e.MarkLCPCandidate]=new ni(Jt(jt.largestContentfulPaint),i,!0),c[e.TimeStamp]=new ni(Jt(jt.timestamp),n),c[e.ConsoleTime]=new ni(Jt(jt.consoleTime),n),c[e.UserTiming]=new ni(Jt(jt.userTiming),n),c[e.ResourceWillSendRequest]=new ni(Jt(jt.willSendRequest),r),c[e.ResourceSendRequest]=new ni(Jt(jt.sendRequest),r),c[e.ResourceReceiveResponse]=new ni(Jt(jt.receiveResponse),r),c[e.ResourceFinish]=new ni(Jt(jt.finishLoading),r),c[e.ResourceReceivedData]=new ni(Jt(jt.receiveData),r),c[e.RunMicrotasks]=new ni(Jt(jt.runMicrotasks),n),c[e.FunctionCall]=new ni(Jt(jt.functionCall),n),c[e.GCEvent]=new ni(Jt(jt.gcEvent),n),c[e.MajorGC]=new ni(Jt(jt.majorGc),n),c[e.MinorGC]=new ni(Jt(jt.minorGc),n),c[e.JSFrame]=new ni(Jt(jt.jsFrame),n),c[e.RequestAnimationFrame]=new ni(Jt(jt.requestAnimationFrame),n),c[e.CancelAnimationFrame]=new ni(Jt(jt.cancelAnimationFrame),n),c[e.FireAnimationFrame]=new ni(Jt(jt.animationFrameFired),n),c[e.RequestIdleCallback]=new ni(Jt(jt.requestIdleCallback),n),c[e.CancelIdleCallback]=new ni(Jt(jt.cancelIdleCallback),n),c[e.FireIdleCallback]=new ni(Jt(jt.fireIdleCallback),n),c[e.WebSocketCreate]=new ni(Jt(jt.createWebsocket),n),c[e.WebSocketSendHandshakeRequest]=new ni(Jt(jt.sendWebsocketHandshake),n),c[e.WebSocketReceiveHandshakeResponse]=new ni(Jt(jt.receiveWebsocketHandshake),n),c[e.WebSocketDestroy]=new ni(Jt(jt.destroyWebsocket),n),c[e.EmbedderCallback]=new ni(Jt(jt.embedderCallback),n),c[e.DecodeImage]=new ni(Jt(jt.imageDecode),o),c[e.ResizeImage]=new ni(Jt(jt.imageResize),o),c[e.GPUTask]=new ni(Jt(jt.gpu),t.gpu),c[e.LatencyInfo]=new ni(Jt(jt.inputLatency),n),c[e.GCCollectGarbage]=new ni(Jt(jt.domGc),n),c[e.CryptoDoEncrypt]=new ni(Jt(jt.encrypt),n),c[e.CryptoDoEncryptReply]=new ni(Jt(jt.encryptReply),n),c[e.CryptoDoDecrypt]=new ni(Jt(jt.decrypt),n),c[e.CryptoDoDecryptReply]=new ni(Jt(jt.decryptReply),n),c[e.CryptoDoDigest]=new ni(Jt(jt.digest),n),c[e.CryptoDoDigestReply]=new ni(Jt(jt.digestReply),n),c[e.CryptoDoSign]=new ni(Jt(jt.sign),n),c[e.CryptoDoSignReply]=new ni(Jt(jt.signReply),n),c[e.CryptoDoVerify]=new ni(Jt(jt.verify),n),c[e.CryptoDoVerifyReply]=new ni(Jt(jt.verifyReply),n),c[e.AsyncTask]=new ni(Jt(jt.asyncTask),t.async),c[e.LayoutShift]=new ni(Jt(jt.layoutShift),s),c[e.EventTiming]=new ni(jt.eventTiming,s),Xt=c,c}static setEventStylesMap(e){Xt=e}static inputEventDisplayName(e){if(!$t){const e=a.TimelineIRModel.InputEvents;$t=new Map([[e.Char,Jt(jt.keyCharacter)],[e.KeyDown,Jt(jt.keyDown)],[e.KeyDownRaw,Jt(jt.keyDown)],[e.KeyUp,Jt(jt.keyUp)],[e.Click,Jt(jt.click)],[e.ContextMenu,Jt(jt.contextMenu)],[e.MouseDown,Jt(jt.mouseDown)],[e.MouseMove,Jt(jt.mouseMove)],[e.MouseUp,Jt(jt.mouseUp)],[e.MouseWheel,Jt(jt.mouseWheel)],[e.ScrollBegin,Jt(jt.scrollBegin)],[e.ScrollEnd,Jt(jt.scrollEnd)],[e.ScrollUpdate,Jt(jt.scrollUpdate)],[e.FlingStart,Jt(jt.flingStart)],[e.FlingCancel,Jt(jt.flingHalt)],[e.Tap,Jt(jt.tap)],[e.TapCancel,Jt(jt.tapHalt)],[e.ShowPress,Jt(jt.tapBegin)],[e.TapDown,Jt(jt.tapDown)],[e.TouchCancel,Jt(jt.touchCancel)],[e.TouchEnd,Jt(jt.touchEnd)],[e.TouchMove,Jt(jt.touchMove)],[e.TouchStart,Jt(jt.touchStart)],[e.PinchBegin,Jt(jt.pinchBegin)],[e.PinchEnd,Jt(jt.pinchEnd)],[e.PinchUpdate,Jt(jt.pinchUpdate)]])}return $t.get(e)||null}static frameDisplayName(e){if(!a.TimelineJSProfile.TimelineJSProfileProcessor.isNativeRuntimeFrame(e))return s.UIUtils.beautifyFunctionName(e.functionName);const t=a.TimelineJSProfile.TimelineJSProfileProcessor.nativeGroup(e.functionName),i=a.TimelineJSProfile.TimelineJSProfileProcessor.NativeGroups;switch(t){case i.Compile:return Jt(jt.compile);case i.Parse:return Jt(jt.parse)}return e.functionName}static testContentMatching(e,t){const i=[ii.eventStyle(e).title],n=a.TimelineModel.TimelineData.forEvent(e).url;return n&&i.push(n),function e(t,n){if(!n)return;for(const a in t){const r=t[a],s=typeof r;"string"===s?i.push(r):"number"===s?i.push(String(r)):"object"===s&&e(r,n-1)}}(e.args,2),t.test(i.join("|"))}static eventURL(e){const t=e.args.data||e.args.beginData,i=t&&t.url;if(i)return i;const n=t&&t.stackTrace,r=n&&n.length&&n[0]||a.TimelineModel.TimelineData.forEvent(e).topFrame();return r&&r.url||null}static eventStyle(e){const t=ii.initEventStyles();if(e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.Console)||e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.UserTiming))return new ni(e.name,ii.categories().scripting);if(e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const t="InputLatency::",i=e.name.startsWith(t)?e.name.substr(t.length):e.name,n=ii.inputEventDisplayName(i);return new ni(n||i,ii.categories().scripting)}let i=t[e.name];return i||(i=new ni(e.name,ii.categories().other,!0),t[e.name]=i),i}static eventColor(e){if(e.name===a.TimelineModel.RecordType.JSFrame){const t=e.args.data;if(ii.isUserFrame(t))return ii.colorForId(t.url)}const i=ii.eventStyle(e).category.color;if(e.name===a.TimelineModel.RecordType.StreamingCompileScriptWaiting){const e=t.Color.Color.parse(ii.categories().scripting.color);if(!e)throw new Error("Unable to parse color from TimelineUIUtils.categories().scripting.color");return e.setAlpha(.3).asString(null)}return i}static eventColorByProduct(e,i,a){const r=ii.eventURL(a)||n.DevToolsPath.EmptyUrlString;let s=i.get(r);if(s)return s;const o="#f2ecdc",l=t.ParsedURL.ParsedURL.fromString(r);if(!l)return o;const d=l.host;return e.rootFrames().some((e=>new t.ParsedURL.ParsedURL(e.url).host===d))&&(s=o),s||(s=o),i.set(r,s),s}static eventTitle(e){const t=a.TimelineModel.RecordType,i=e.args.data;if(e.name===t.JSFrame)return ii.frameDisplayName(i);if("EventTiming"===e.name&&e.args.data&&e.args.data.interactionId)return Jt(jt.interactionEvent,{PH1:e.args.data.type,PH2:e.args.data.interactionId});const n=ii.eventStyle(e).title;return e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.Console)?n:e.name===t.TimeStamp?Jt(jt.sS,{PH1:n,PH2:i.message}):e.name===t.Animation&&i&&i.name?Jt(jt.sS,{PH1:n,PH2:i.name}):e.name===t.EventDispatch&&i&&i.type?Jt(jt.sS,{PH1:n,PH2:i.type}):n}static interactionPhaseStyles(){let e=Kt;return e||(e=new Map([[a.TimelineIRModel.Phases.Idle,{color:"white",label:"Idle"}],[a.TimelineIRModel.Phases.Response,{color:"hsl(43, 83%, 64%)",label:Jt(jt.response)}],[a.TimelineIRModel.Phases.Scroll,{color:"hsl(256, 67%, 70%)",label:Jt(jt.scroll)}],[a.TimelineIRModel.Phases.Fling,{color:"hsl(256, 67%, 70%)",label:Jt(jt.fling)}],[a.TimelineIRModel.Phases.Drag,{color:"hsl(256, 67%, 70%)",label:Jt(jt.drag)}],[a.TimelineIRModel.Phases.Animation,{color:"hsl(256, 67%, 70%)",label:Jt(jt.animation)}],[a.TimelineIRModel.Phases.Uncategorized,{color:"hsl(0, 0%, 87%)",label:Jt(jt.uncategorized)}]]),Kt=e),e}static interactionPhaseColor(e){const t=ii.interactionPhaseStyles().get(e);if(!t)throw new Error(`Unknown phase ${e}`);return t.color}static interactionPhaseLabel(e){const t=ii.interactionPhaseStyles().get(e);if(!t)throw new Error(`Unknown phase ${e}`);return t.label}static isUserFrame(e){return"0"!==e.scriptId&&!(e.url&&e.url.startsWith("native "))}static networkRequestCategory(e){const t=ai;switch(e.mimeType){case"text/html":return t.HTML;case"application/javascript":case"application/x-javascript":case"text/javascript":return t.Script;case"text/css":return t.Style;case"audio/ogg":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/webp":case"image/x-icon":case"font/opentype":case"font/woff2":case"application/font-woff":return t.Media;default:return t.Other}}static networkCategoryColor(e){const t=ai;switch(e){case t.HTML:return"hsl(214, 67%, 66%)";case t.Script:return"hsl(43, 83%, 64%)";case t.Style:return"hsl(256, 67%, 70%)";case t.Media:return"hsl(109, 33%, 55%)";default:return"hsl(0, 0%, 70%)"}}static async buildDetailsTextForTraceEvent(e){const t=a.TimelineModel.RecordType;let i;const r=e.args.data;switch(e.name){case t.GCEvent:case t.MajorGC:case t.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;i=Jt(jt.sCollected,{PH1:n.NumberUtilities.bytesToString(t)});break}case t.FunctionCall:r&&r.url&&void 0!==r.lineNumber&&void 0!==r.columnNumber&&(i=r.url+":"+(r.lineNumber+1)+":"+(r.columnNumber+1));break;case t.JSFrame:i=ii.frameDisplayName(r);break;case t.EventDispatch:i=r?r.type:null;break;case t.Paint:{const e=ii.quadWidth(r.clip),t=ii.quadHeight(r.clip);e&&t&&(i=Jt(jt.sSDimensions,{PH1:e,PH2:t}));break}case t.ParseHTML:{const t=e.args.beginData.startLine,n=e.args.endData&&e.args.endData.endLine,a=o.ResourceUtils.displayNameForURL(e.args.beginData.url);i=n>=0?Jt(jt.sSs,{PH1:a,PH2:t+1,PH3:n+1}):Jt(jt.sSSquareBrackets,{PH1:a,PH2:t+1});break}case t.CompileModule:case t.CacheModule:i=o.ResourceUtils.displayNameForURL(e.args.fileName);break;case t.CompileScript:case t.CacheScript:case t.EvaluateScript:{const e=r&&r.url;e&&(i=o.ResourceUtils.displayNameForURL(e)+":"+(r.lineNumber+1));break}case t.WasmCompiledModule:case t.WasmModuleCacheHit:{const t=e.args.url;t&&(i=o.ResourceUtils.displayNameForURL(t));break}case t.StreamingCompileScript:case t.XHRReadyStateChange:case t.XHRLoad:{const e=r.url;e&&(i=o.ResourceUtils.displayNameForURL(e));break}case t.TimeStamp:i=r.message;break;case t.WebSocketCreate:case t.WebSocketSendHandshakeRequest:case t.WebSocketReceiveHandshakeResponse:case t.WebSocketDestroy:case t.ResourceWillSendRequest:case t.ResourceSendRequest:case t.ResourceReceivedData:case t.ResourceReceiveResponse:case t.ResourceFinish:case t.PaintImage:case t.DecodeImage:case t.ResizeImage:case t.DecodeLazyPixelRef:{const t=a.TimelineModel.TimelineData.forEvent(e).url;t&&(i=o.ResourceUtils.displayNameForURL(t));break}case t.EmbedderCallback:i=r.callbackName;break;case t.Animation:i=r&&r.name;break;case t.AsyncTask:i=r?r.name:null;break;default:i=e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.Console)?null:await async function(){const t=a.TimelineModel.TimelineData.forEvent(e).topFrame();if(!t)return null;return t.url+":"+(t.lineNumber+1)+":"+(t.columnNumber+1)}()}return i}static async buildDetailsNodeForTraceEvent(e,t,i){const n=a.TimelineModel.RecordType;let r,o=null;const d=e.args.data;switch(e.name){case n.GCEvent:case n.MajorGC:case n.MinorGC:case n.EventDispatch:case n.Paint:case n.Animation:case n.EmbedderCallback:case n.ParseHTML:case n.WasmStreamFromResponseCallback:case n.WasmCompiledModule:case n.WasmModuleCacheHit:case n.WasmCachedModule:case n.WasmModuleCacheInvalid:case n.WebSocketCreate:case n.WebSocketSendHandshakeRequest:case n.WebSocketReceiveHandshakeResponse:case n.WebSocketDestroy:r=await ii.buildDetailsTextForTraceEvent(e);break;case n.PaintImage:case n.DecodeImage:case n.ResizeImage:case n.DecodeLazyPixelRef:case n.XHRReadyStateChange:case n.XHRLoad:case n.ResourceWillSendRequest:case n.ResourceSendRequest:case n.ResourceReceivedData:case n.ResourceReceiveResponse:case n.ResourceFinish:{const t=a.TimelineModel.TimelineData.forEvent(e).url;if(t){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};o=l.Linkifier.Linkifier.linkifyURL(t,e)}break}case n.FunctionCall:case n.JSFrame:{o=document.createElement("span"),s.UIUtils.createTextChild(o,ii.frameDisplayName(d));const e=c(d.scriptId,d.url,d.lineNumber,d.columnNumber);e&&(s.UIUtils.createTextChild(o," @ "),o.appendChild(e));break}case n.CompileModule:case n.CacheModule:o=c(null,e.args.fileName,0,0);break;case n.CompileScript:case n.CacheScript:case n.EvaluateScript:{const e=d.url;e&&(o=c(null,e,d.lineNumber,0));break}case n.StreamingCompileScript:{const e=d.url;e&&(o=c(null,e,0,0));break}default:e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.Console)?r=null:o=function(){const n=a.TimelineModel.TimelineData.forEvent(e).topFrame();return n?i.maybeLinkifyConsoleCallFrame(t,n,{className:"timeline-details",tabStop:!0,inlineFrameIndex:0,showColumnNumber:!0}):null}()}return!o&&r&&(o=document.createTextNode(r)),o;function c(e,n,a,r){const s={columnNumber:r,showColumnNumber:!0,inlineFrameIndex:0,className:"timeline-details",tabStop:!0};return i.linkifyScriptLocation(t,e,n,a,s)}}static buildDetailsNodeForPerformanceEvent(e){let t="https://web.dev/user-centric-performance-metrics/",i="page performance metrics";const n=a.TimelineModel.RecordType;switch(e.name){case n.MarkLCPCandidate:t="https://web.dev/lcp/",i="largest contentful paint";break;case n.MarkFCP:t="https://web.dev/first-contentful-paint/",i="first contentful paint"}return s.Fragment.html`<div>${s.XLink.XLink.create(t,Jt(jt.learnMore))} about ${i}.</div>`}static buildConsumeCacheDetails(e,t){"consumedCacheSize"in e?(t.appendTextRow(Jt(jt.compilationCacheStatus),Jt(jt.scriptLoadedFromCache)),t.appendTextRow(Jt(jt.compilationCacheSize),n.NumberUtilities.bytesToString(e.consumedCacheSize))):e&&"cacheRejected"in e&&e.cacheRejected?t.appendTextRow(Jt(jt.compilationCacheStatus),Jt(jt.failedToLoadScriptFromCache)):t.appendTextRow(Jt(jt.compilationCacheStatus),Jt(jt.scriptNotEligible))}static async buildTraceEventDetails(o,d,c,h){const m=d.targetByEvent(o);let u=null;if(m){const t=m;if(void 0===o[oi]){let e=null;const i=a.TimelineModel.TimelineData.forEvent(o).url;i?e=await l.ImagePreview.ImagePreview.build(t,i,!1,{imageAltText:l.ImagePreview.ImagePreview.defaultAltTextForImageURL(i),precomputedFeatures:void 0}):a.TimelineModel.TimelineData.forEvent(o).picture&&(e=await ii.buildPicturePreviewContent(o,t)),o[oi]=e}const i=new Set,n=a.TimelineModel.TimelineData.forEvent(o);if(n.backendNodeIds)for(let e=0;e<n.backendNodeIds.length;++e)i.add(n.backendNodeIds[e]);const r=a.TimelineModel.InvalidationTracker.invalidationEventsFor(o);if(r&&ii.collectInvalidationNodeIds(i,r),i.size){const n=t.model(e.DOMModel.DOMModel);n&&(u=await n.pushNodesByBackendIdsToFrontend(i))}}const p=a.TimelineModel.RecordType;let g;o.name===p.LayoutShift&&(h=!1);const v=new ci(d.targetByEvent(o),c),f=d.isMarkerEvent(o)?ii.markerStyleForEvent(o).color:ii.eventStyle(o).category.color;v.addSection(ii.eventTitle(o),f);const T=o.args.data,S=a.TimelineModel.TimelineData.forEvent(o),y=S.initiator();let b=null;if(S.warning&&v.appendWarningRow(o),o.name===p.JSFrame&&T.deoptReason&&v.appendWarningRow(o,a.TimelineModel.TimelineModelImpl.WarningType.V8Deopt),h&&!Number.isNaN(o.duration||0)&&(v.appendTextRow(Jt(jt.totalTime),i.TimeUtilities.millisToString(o.duration||0,!0)),v.appendTextRow(Jt(jt.selfTime),i.TimeUtilities.millisToString(o.selfTime,!0))),d.isGenericTrace()){for(const e in o.args)try{v.appendTextRow(e,JSON.stringify(o.args[e]))}catch(t){v.appendTextRow(e,`<${typeof o.args[e]}>`)}return v.fragment}switch(o.name){case p.GCEvent:case p.MajorGC:case p.MinorGC:{const e=o.args.usedHeapSizeBefore-o.args.usedHeapSizeAfter;v.appendTextRow(Jt(jt.collected),n.NumberUtilities.bytesToString(e));break}case p.JSFrame:case p.FunctionCall:{const e=await ii.buildDetailsNodeForTraceEvent(o,d.targetByEvent(o),c);e&&v.appendElementRow(Jt(jt.function),e);break}case p.TimerFire:case p.TimerInstall:case p.TimerRemove:v.appendTextRow(Jt(jt.timerId),T.timerId),o.name===p.TimerInstall&&(v.appendTextRow(Jt(jt.timeout),i.TimeUtilities.millisToString(T.timeout)),v.appendTextRow(Jt(jt.repeats),!T.singleShot));break;case p.FireAnimationFrame:v.appendTextRow(Jt(jt.callbackId),T.id);break;case p.ResourceWillSendRequest:case p.ResourceSendRequest:case p.ResourceReceiveResponse:case p.ResourceReceivedData:case p.ResourceFinish:if(b=S.url,b){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};v.appendElementRow(Jt(jt.resource),l.Linkifier.Linkifier.linkifyURL(b,e))}if(T.requestMethod&&v.appendTextRow(Jt(jt.requestMethod),T.requestMethod),"number"==typeof T.statusCode&&v.appendTextRow(Jt(jt.statusCode),T.statusCode),T.mimeType&&v.appendTextRow(Jt(jt.mimeTypeCaps),T.mimeType),"priority"in T){const e=r.NetworkPriorities.uiLabelForNetworkPriority(T.priority);v.appendTextRow(Jt(jt.priority),e)}T.encodedDataLength&&v.appendTextRow(Jt(jt.encodedData),Jt(jt.sBytes,{n:T.encodedDataLength})),T.decodedBodyLength&&v.appendTextRow(Jt(jt.decodedBody),Jt(jt.sBytes,{n:T.decodedBodyLength}));break;case p.CompileModule:v.appendLocationRow(Jt(jt.module),o.args.fileName,0);break;case p.CompileScript:{b=T&&T.url,b&&v.appendLocationRow(Jt(jt.script),b,T.lineNumber,T.columnNumber);(T.eager??!1)&&v.appendTextRow(Jt(jt.eagerCompile),!0);const e=T.streamed;v.appendTextRow(Jt(jt.streamed),e+(e?"":`: ${T.notStreamedReason}`)),ii.buildConsumeCacheDetails(T,v);break}case p.CacheModule:b=T&&T.url,v.appendTextRow(Jt(jt.compilationCacheSize),n.NumberUtilities.bytesToString(T.producedCacheSize));break;case p.CacheScript:b=T&&T.url,b&&v.appendLocationRow(Jt(jt.script),b,T.lineNumber,T.columnNumber),v.appendTextRow(Jt(jt.compilationCacheSize),n.NumberUtilities.bytesToString(T.producedCacheSize));break;case p.EvaluateScript:b=T&&T.url,b&&v.appendLocationRow(Jt(jt.script),b,T.lineNumber,T.columnNumber);break;case p.WasmStreamFromResponseCallback:case p.WasmCompiledModule:case p.WasmCachedModule:case p.WasmModuleCacheHit:case p.WasmModuleCacheInvalid:if(T){b=o.args.url,b&&v.appendTextRow(Jt(jt.url),b);const e=o.args.producedCachedSize;e&&v.appendTextRow(Jt(jt.producedCacheSize),e);const t=o.args.consumedCachedSize;t&&v.appendTextRow(Jt(jt.consumedCacheSize),t)}break;case p.Paint:{const e=T.clip;v.appendTextRow(Jt(jt.location),Jt(jt.sSCurlyBrackets,{PH1:e[0],PH2:e[1]}));const t=ii.quadWidth(e),i=ii.quadHeight(e);v.appendTextRow(Jt(jt.dimensions),Jt(jt.sSDimensions,{PH1:t,PH2:i}))}case p.PaintSetup:case p.Rasterize:case p.ScrollLayer:g=Jt(jt.layerRoot);break;case p.PaintImage:case p.DecodeLazyPixelRef:case p.DecodeImage:case p.ResizeImage:case p.DrawLazyPixelRef:if(g=Jt(jt.ownerElement),b=S.url,b){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};v.appendElementRow(Jt(jt.imageUrl),l.Linkifier.Linkifier.linkifyURL(b,e))}break;case p.ParseAuthorStyleSheet:if(b=T.styleSheetUrl,b){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};v.appendElementRow(Jt(jt.stylesheetUrl),l.Linkifier.Linkifier.linkifyURL(b,e))}break;case p.UpdateLayoutTree:case p.RecalculateStyles:v.appendTextRow(Jt(jt.elementsAffected),o.args.elementCount);break;case p.Layout:{const e=o.args.beginData;v.appendTextRow(Jt(jt.nodesThatNeedLayout),Jt(jt.sOfS,{PH1:e.dirtyObjects,PH2:e.totalObjects})),g=Jt(jt.layoutRoot);break}case p.ConsoleTime:v.appendTextRow(Jt(jt.message),o.name);break;case p.WebSocketCreate:case p.WebSocketSendHandshakeRequest:case p.WebSocketReceiveHandshakeResponse:case p.WebSocketDestroy:{const e=y?y.args.data:T;void 0!==e.webSocketURL&&v.appendTextRow(i.i18n.lockedString("URL"),e.webSocketURL),void 0!==e.webSocketProtocol&&v.appendTextRow(Jt(jt.websocketProtocol),e.webSocketProtocol),void 0!==T.message&&v.appendTextRow(Jt(jt.message),T.message);break}case p.EmbedderCallback:v.appendTextRow(Jt(jt.callbackFunction),T.callbackName);break;case p.Animation:o.phase===e.TracingModel.Phase.NestableAsyncInstant&&v.appendTextRow(Jt(jt.state),T.state);break;case p.ParseHTML:{const e=o.args.beginData,t=e.startLine-1,i=o.args.endData?o.args.endData.endLine-1:void 0;b=e.url,b&&v.appendLocationRange(Jt(jt.range),b,t,i);break}case p.FireIdleCallback:v.appendTextRow(Jt(jt.allottedTime),i.TimeUtilities.millisToString(T.allottedMilliseconds)),v.appendTextRow(Jt(jt.invokedByTimeout),T.timedOut);case p.RequestIdleCallback:case p.CancelIdleCallback:v.appendTextRow(Jt(jt.callbackId),T.id);break;case p.EventDispatch:v.appendTextRow(Jt(jt.type),T.type);break;case p.MarkLCPCandidate:v.appendTextRow(Jt(jt.type),String(T.type)),v.appendTextRow(Jt(jt.size),String(T.size));case p.MarkFirstPaint:case p.MarkFCP:case p.MarkLoad:case p.MarkDOMContent:{let e=o.startTime-d.minimumRecordTime();const{navigationId:t}=o.args.data;if(t){const i=d.navStartTimes().get(t);i&&(e=o.startTime-i.startTime)}v.appendTextRow(Jt(jt.timestamp),i.TimeUtilities.preciseMillisToString(e,1)),v.appendElementRow(Jt(jt.details),ii.buildDetailsNodeForPerformanceEvent(o));break}case p.LayoutShift:{const e=document.createElement("span"),n=s.XLink.XLink.create("https://web.dev/cls/",Jt(jt.cumulativeLayoutShifts)),a=s.XLink.XLink.create("https://web.dev/evolving-cls/",Jt(jt.evolvedClsLink));e.appendChild(i.i18n.getFormatLocalizedString(qt,jt.sCLSInformation,{PH1:n,PH2:a})),v.appendElementRow(Jt(jt.warning),e,!0),v.appendTextRow(Jt(jt.score),T.score.toPrecision(4)),v.appendTextRow(Jt(jt.cumulativeScore),T.cumulative_score.toPrecision(4)),"_current_cluster_id"in T&&v.appendTextRow(Jt(jt.currentClusterId),T._current_cluster_id),"_current_cluster_score"in T&&v.appendTextRow(Jt(jt.currentClusterScore),T._current_cluster_score.toPrecision(4)),v.appendTextRow(Jt(jt.hadRecentInput),T.had_recent_input?Jt(jt.yes):Jt(jt.no));for(const e of T.impacted_nodes){const i=new w(e.old_rect),n=new w(e.new_rect),a=await t.Linkifier.Linkifier.linkify(i),r=await t.Linkifier.Linkifier.linkify(n);v.appendElementRow(Jt(jt.movedFrom),a),v.appendElementRow(Jt(jt.movedTo),r)}break}default:{const e=await ii.buildDetailsNodeForTraceEvent(o,d.targetByEvent(o),c);e&&v.appendElementRow(Jt(jt.details),e);break}}S.timeWaitingForMainThread&&v.appendTextRow(Jt(jt.timeWaitingForMainThread),i.TimeUtilities.millisToString(S.timeWaitingForMainThread,!0));for(let e=0;e<S.backendNodeIds.length;++e){const i=u&&u.get(S.backendNodeIds[e]);if(i){const e=await t.Linkifier.Linkifier.linkify(i);v.appendElementRow(g||Jt(jt.relatedNode),e)}}o[oi]&&(v.addSection(Jt(jt.preview)),v.appendElementRow("",o[oi])),(y||S.stackTraceForSelfOrInitiator()||a.TimelineModel.InvalidationTracker.invalidationEventsFor(o))&&ii.generateCauses(o,d.targetByEvent(o),u,v);const C={};if(h&&ii.aggregatedStatsForTraceEvent(C,d,o)){v.addSection(Jt(jt.aggregatedTime));const e=ii.generatePieChart(C,ii.eventStyle(o).category,o.selfTime);v.appendElementRow("",e)}return v.fragment}static statsForTimeRange(t,i,r){if(!t.length)return{idle:r-i};!function(t){if(t[hi])return;const i={},n=[];let r=0;function s(e,t){let n=i[e];if(n||(n={time:[],value:[]},i[e]=n),n.time.length&&n.time[n.time.length-1]===t||r>t)return;const a=n.value.length>0?n.value[n.value.length-1]:0;n.value.push(a+t-r),n.time.push(t)}function o(e,t,i){e&&s(e,i),r=i,t&&s(t,i)}a.TimelineModel.TimelineModelImpl.forEachEvent(t,(function(e){const t=ii.eventStyle(e).category.name,i=n.length?n[n.length-1]:null;t!==i&&o(i||null,t,e.startTime),n.push(t)}),(function(e){const t=n.pop(),i=n.length?n[n.length-1]:null;t!==i&&o(t||null,i||null,e.endTime||0)}),void 0,void 0,void 0,function(){const t=ii.visibleEventsFilter();return i=>t.accept(i)||e.TracingModel.TracingModel.isTopLevelEvent(i)}());t[hi]=i}(t);const s=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(l(r),l(i)),o=Object.values(s).reduce(((e,t)=>e+t),0);return s.idle=Math.max(0,r-i-o),s;function l(e){const i={},a=t[hi];for(const t in a){const r=a[t],s=n.ArrayUtilities.upperBound(r.time,e,n.ArrayUtilities.DEFAULT_COMPARATOR);let o;if(0===s)o=0;else if(s===r.time.length)o=r.value[r.value.length-1];else{const t=r.time[s-1],i=r.time[s],n=r.value[s-1];o=n+(r.value[s]-n)*(e-t)/(i-t)}i[t]=o}return i}}static async buildNetworkRequestDetails(e,t,s){const o=t.targetByEvent(e.children[0]),d=new ci(o,s),c=ii.networkRequestCategory(e),h=ii.networkCategoryColor(c);if(d.addSection(Jt(jt.networkRequest),h),e.url){const t={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};d.appendElementRow(i.i18n.lockedString("URL"),l.Linkifier.Linkifier.linkifyURL(e.url,t))}const m=e.endTime-(e.getStartTime()||-1/0);if(isFinite(m)){let t=i.TimeUtilities.millisToString(m,!0);const n=(e.finishTime||e.getStartTime())-e.getStartTime(),a=e.endTime-(e.finishTime||0);if(isFinite(n)&&isFinite(a)){const r=i.TimeUtilities.millisToString(n,!0),s=i.TimeUtilities.millisToString(a,!0),o=e.cached()?Jt(jt.loadFromCache):Jt(jt.networkTransfer);t+=Jt(jt.SSSResourceLoading,{PH1:r,PH2:o,PH3:s})}d.appendTextRow(Jt(jt.duration),t)}if(e.requestMethod&&d.appendTextRow(Jt(jt.requestMethod),e.requestMethod),"string"==typeof e.priority){const t=r.NetworkPriorities.uiLabelForNetworkPriority(e.priority);d.appendTextRow(Jt(jt.priority),t)}e.mimeType&&d.appendTextRow(Jt(jt.mimeType),e.mimeType);let u="";e.memoryCached()?u+=Jt(jt.FromMemoryCache):e.cached()?u+=Jt(jt.FromCache):e.timing&&e.timing.pushStart&&(u+=Jt(jt.FromPush)),e.fromServiceWorker&&(u+=Jt(jt.FromServiceWorker)),!e.encodedDataLength&&u||(u=`${n.NumberUtilities.bytesToString(e.encodedDataLength)}${u}`),d.appendTextRow(Jt(jt.encodedData),u),e.decodedBodyLength&&d.appendTextRow(Jt(jt.decodedBody),n.NumberUtilities.bytesToString(e.decodedBodyLength));const p=Jt(jt.initiator),g=e.children[0],v=a.TimelineModel.TimelineData.forEvent(g).topFrame();if(v){const e=s.maybeLinkifyConsoleCallFrame(o,v,{tabStop:!0,inlineFrameIndex:0,showColumnNumber:!0});e&&d.appendElementRow(p,e)}else{const e=a.TimelineModel.TimelineData.forEvent(g).initiator();if(e){const t=a.TimelineModel.TimelineData.forEvent(e).url;if(t){const e=s.maybeLinkifyScriptLocation(o,null,t,0,{tabStop:!0,inlineFrameIndex:0});e&&d.appendElementRow(p,e)}}}if(!ti.get(e)&&e.url&&o){const t=await l.ImagePreview.ImagePreview.build(o,e.url,!1,{imageAltText:l.ImagePreview.ImagePreview.defaultAltTextForImageURL(e.url),precomputedFeatures:void 0});ti.set(e,t)}const f=ti.get(e);return f&&d.appendElementRow(Jt(jt.preview),f),d.fragment}static stackTraceFromCallFrames(e){return{callFrames:e}}static generateCauses(e,t,n,r){const o=a.TimelineModel.RecordType;let l,d;switch(e.name){case o.TimerFire:l=Jt(jt.timerInstalled);break;case o.FireAnimationFrame:l=Jt(jt.animationFrameRequested);break;case o.FireIdleCallback:l=Jt(jt.idleCallbackRequested);break;case o.UpdateLayoutTree:case o.RecalculateStyles:d=Jt(jt.recalculationForced);break;case o.Layout:l=Jt(jt.firstLayoutInvalidation),d=Jt(jt.layoutForced)}const c=a.TimelineModel.TimelineData.forEvent(e);c.stackTrace&&c.stackTrace.length&&(r.addSection(Jt(jt.callStacks)),r.appendStackTrace(d||Jt(jt.stackTrace),ii.stackTraceFromCallFrames(c.stackTrace)));const h=a.TimelineModel.TimelineData.forEvent(e).initiator();if(a.TimelineModel.InvalidationTracker.invalidationEventsFor(e)&&t)r.addSection(Jt(jt.invalidations)),ii.generateInvalidations(e,t,n,r);else if(h){const t=e.startTime-h.startTime;r.appendTextRow(Jt(jt.pendingFor),i.TimeUtilities.preciseMillisToString(t,1));const n=document.createElement("span");n.classList.add("devtools-link"),s.ARIAUtils.markAsLink(n),n.tabIndex=0,n.textContent=Jt(jt.reveal),n.addEventListener("click",(()=>{Ut.instance().select(Vt.fromTraceEvent(h))})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&(Ut.instance().select(Vt.fromTraceEvent(h)),e.consume(!0))})),r.appendElementRow(Jt(jt.initiator),n);const o=a.TimelineModel.TimelineData.forEvent(h).stackTrace;o&&r.appendStackTrace(l||Jt(jt.firstInvalidated),ii.stackTraceFromCallFrames(o))}}static generateInvalidations(e,t,i,n){const r=a.TimelineModel.InvalidationTracker.invalidationEventsFor(e);if(!r)return;const s={};for(const e of r)s[e.type]||(s[e.type]=[]),s[e.type].push(e);Object.keys(s).forEach((function(e){ii.generateInvalidationsForType(e,t,s[e],i,n)}))}static generateInvalidationsForType(e,t,i,n,r){let o;switch(e){case a.TimelineModel.RecordType.StyleRecalcInvalidationTracking:o=Jt(jt.styleInvalidations);break;case a.TimelineModel.RecordType.LayoutInvalidationTracking:o=Jt(jt.layoutInvalidations);break;default:o=Jt(jt.otherInvalidations)}const l=new s.TreeOutline.TreeOutlineInShadow;l.registerCSSFiles([C]),l.element.classList.add("invalidations-tree");const d=function(e){const t=new Map;for(let i=0;i<e.length;i++){const n=e[i];let a="";n.cause.reason&&(a+=n.cause.reason+"."),n.cause.stackTrace&&n.cause.stackTrace.forEach((function(e){a+=e.functionName+".",a+=e.scriptId+".",a+=e.url+".",a+=e.lineNumber+".",a+=e.columnNumber+"."}));const r=t.get(a);r?r.push(n):t.set(a,[n])}return[...t.values()]}(i);d.forEach((function(e){const i=new si(t,n,r,e);l.appendChild(i)})),r.appendElementRow(o,l.element,!1,!0)}static collectInvalidationNodeIds(e,t){n.SetUtilities.addAll(e,t.map((e=>e.nodeId)).filter((e=>e)))}static aggregatedStatsForTraceEvent(t,i,a){const r=i.inspectedTargetEvents();const s=n.ArrayUtilities.binaryIndexOf(r,a.startTime,(function(e,t){return e-t.startTime}));if(s<0)return!1;let o=!1;const l=a.endTime;if(l)for(let e=s;e<r.length;e++){const i=r[e];if(i.startTime>=l)break;if(!i.selfTime)continue;if(i.thread!==a.thread)continue;e>s&&(o=!0);const n=ii.eventStyle(i).category.name;t[n]=(t[n]||0)+i.selfTime}if(e.TracingModel.TracingModel.isAsyncPhase(a.phase)){if(a.endTime){let e=0;for(const i in t)e+=t[i];t.idle=Math.max(0,a.endTime-a.startTime-e)}return!1}return o}static async buildPicturePreviewContent(e,t){const i=await new a.TimelineFrameModel.LayerPaintEvent(e,t).snapshotPromise();if(!i)return null;const n=i.snapshot.replay();i.snapshot.release();const r=await n;if(!r)return null;const o=document.createElement("div"),d=o.attachShadow({mode:"open"});d.adoptedStyleSheets=[k];const c=d.createChild("div");c.classList.add("image-preview-container","vbox","link");const h=c.createChild("img");h.src=r,h.alt=l.ImagePreview.ImagePreview.defaultAltTextForImageURL(r);return c.createChild("a").textContent=Jt(jt.paintProfiler),s.ARIAUtils.markAsLink(c),c.tabIndex=0,c.addEventListener("click",(()=>Ut.instance().select(Vt.fromTraceEvent(e))),!1),c.addEventListener("keydown",(t=>{"Enter"===t.key&&(Ut.instance().select(Vt.fromTraceEvent(e)),t.consume(!0))})),o}static createEventDivider(e,t){const n=document.createElement("div");n.classList.add("resources-event-divider");const a=i.TimeUtilities.millisToString(e.startTime-t);s.Tooltip.Tooltip.install(n,Jt(jt.sAtS,{PH1:ii.eventTitle(e),PH2:a}));const r=ii.markerStyleForEvent(e);return r.tall&&(n.style.backgroundColor=r.color),n}static visibleTypes(){const e=ii.initEventStyles(),t=[];for(const i in e)e[i].hidden||t.push(i);return t}static visibleEventsFilter(){return new a.TimelineModelFilter.TimelineVisibleEventsFilter(ii.visibleTypes())}static categories(){return Yt||(Yt={loading:new di("loading",Jt(jt.loading),!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),experience:new di("experience",Jt(jt.experience),!1,"hsl(5, 80%, 74%)","hsl(5, 80%, 66%)"),scripting:new di("scripting",Jt(jt.scripting),!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),rendering:new di("rendering",Jt(jt.rendering),!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new di("painting",Jt(jt.painting),!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),gpu:new di("gpu",Jt(jt.gpu),!1,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),async:new di("async",Jt(jt.async),!1,"hsl(0, 100%, 50%)","hsl(0, 100%, 40%)"),other:new di("other",Jt(jt.system),!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new di("idle",Jt(jt.idle),!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")},Yt)}static setCategories(e){Yt=e}static getTimelineMainEventCategories(){return Qt||(Qt=["idle","loading","painting","rendering","scripting","other"],Qt)}static setTimelineMainEventCategories(e){Qt=e}static generatePieChart(e,t,n){let a=0;for(const t in e)a+=e[t];const s=document.createElement("div");s.classList.add("timeline-details-view-pie-chart-wrapper"),s.classList.add("hbox");const o=new r.PieChart.PieChart,l=[];function d(e,t,i,n){i&&l.push({value:i,color:n,title:t})}if(t){n&&d(t.name,Jt(jt.sSelf,{PH1:t.title}),n,t.color);const i=e[t.name]-(n||0);i>0&&d(t.name,Jt(jt.sChildren,{PH1:t.title}),i,t.childColor)}for(const i in ii.categories()){const n=ii.categories()[i];n!==t&&d(n.name,n.title,e[n.name],n.childColor)}o.data={chartName:Jt(jt.timeSpentInRendering),size:110,formatter:e=>i.TimeUtilities.preciseMillisToString(e),showLegend:!0,total:a,slices:l};return s.createChild("div","vbox").appendChild(o),s}static generateDetailsContentForFrame(e,t){const n=new ci(null,null);n.addSection(Jt(jt.frame));const a=ii.frameDuration(e);if(n.appendElementRow(Jt(jt.duration),a,e.hasWarnings()),n.appendTextRow(Jt(jt.cpuTime),i.TimeUtilities.millisToString(e.cpuTime,!0)),t){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview"),t.imageDataPromise().then((e=>s.UIUtils.loadImageFromData(e))).then((t=>t&&e.appendChild(t))),n.appendElementRow("",e),e.addEventListener("click",function(e){new r.FilmStripView.Dialog(e,0)}.bind(null,t),!1)}return e.layerTree&&n.appendElementRow(Jt(jt.layerTree),l.Linkifier.Linkifier.linkifyRevealable(e.layerTree,Jt(jt.show))),n.fragment}static frameDuration(e){const t=Jt(jt.sAtSParentheses,{PH1:i.TimeUtilities.millisToString(e.endTime-e.startTime,!0),PH2:i.TimeUtilities.millisToString(e.startTimeOffset,!0)});if(!e.hasWarnings())return i.i18n.getFormatLocalizedString(qt,jt.emptyPlaceholder,{PH1:t});const n=s.XLink.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/",Jt(jt.jank));return i.i18n.getFormatLocalizedString(qt,jt.sLongFrameTimesAreAnIndicationOf,{PH1:t,PH2:n})}static createFillStyle(e,t,i,n,a,r){const s=e.createLinearGradient(0,0,t,i);return s.addColorStop(0,n),s.addColorStop(.25,a),s.addColorStop(.75,a),s.addColorStop(1,r),s}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(Zt)return Zt;const e="hsl(40,100%,80%)",t="hsl(40,100%,50%)";return Zt=[new li(1,e,["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new li(1,e,["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new li(2,"hsl(90,100%,40%)",["wheel"]),new li(3,t,["click","mousedown","mouseup"]),new li(3,t,["touchstart","touchend","touchmove","touchcancel"]),new li(3,t,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new li(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],Zt}static markerShortTitle(e){const t=a.TimelineModel.RecordType;switch(e.name){case t.MarkDOMContent:return i.i18n.lockedString("DCL");case t.MarkLoad:return i.i18n.lockedString("L");case t.MarkFirstPaint:return i.i18n.lockedString("FP");case t.MarkFCP:return i.i18n.lockedString("FCP");case t.MarkLCPCandidate:return i.i18n.lockedString("LCP")}return null}static markerStyleForEvent(e){const t=[6,4],i=ii.eventTitle(e),n=a.TimelineModel.RecordType;if(e.name!==n.NavigationStart&&(e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.Console)||e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.UserTiming)))return{title:i,dashStyle:t,lineWidth:.5,color:e.hasCategory(a.TimelineModel.TimelineModelImpl.Category.UserTiming)?"purple":"orange",tall:!1,lowPriority:!1};let r=!1,s="grey";switch(e.name){case n.NavigationStart:s="#FF9800",r=!0;break;case n.FrameStartedLoading:s="green",r=!0;break;case n.MarkDOMContent:s="#0867CB",r=!0;break;case n.MarkLoad:s="#B31412",r=!0;break;case n.MarkFirstPaint:s="#228847",r=!0;break;case n.MarkFCP:s="#1A6937",r=!0;break;case n.MarkLCPCandidate:s="#1A3422",r=!0;break;case n.TimeStamp:s="orange"}return{title:i,dashStyle:t,lineWidth:.5,color:s,tall:r,lowPriority:!1}}static markerStyleForFrame(){return{title:Jt(jt.frame),color:"rgba(100, 100, 100, 0.4)",lineWidth:3,dashStyle:[3],tall:!0,lowPriority:!0}}static colorForId(e){return ei||(ei=new t.Color.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:3},85),ei.setColorForID("","#f2ecdc")),ei.colorForID(e)}static eventWarning(e,t){const n=a.TimelineModel.TimelineData.forEvent(e),r=t||n.warning;if(!r)return null;const o=a.TimelineModel.TimelineModelImpl.WarningType,l=document.createElement("span"),d=e.args.data;switch(r){case o.ForcedStyle:case o.ForcedLayout:{const e=s.XLink.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid-forced-synchronous-layouts",Jt(jt.forcedReflow));l.appendChild(i.i18n.getFormatLocalizedString(qt,jt.sIsALikelyPerformanceBottleneck,{PH1:e}));break}case o.IdleDeadlineExceeded:{const t=i.TimeUtilities.millisToString((e.duration||0)-d.allottedMilliseconds,!0);l.textContent=Jt(jt.idleCallbackExecutionExtended,{PH1:t});break}case o.LongHandler:l.textContent=Jt(jt.handlerTookS,{PH1:i.TimeUtilities.millisToString(e.duration||0,!0)});break;case o.LongRecurringHandler:l.textContent=Jt(jt.recurringHandlerTookS,{PH1:i.TimeUtilities.millisToString(e.duration||0,!0)});break;case o.LongTask:{const t=s.XLink.XLink.create("https://web.dev/rail/#goals-and-guidelines",Jt(jt.longTask));l.appendChild(i.i18n.getFormatLocalizedString(qt,jt.sTookS,{PH1:t,PH2:i.TimeUtilities.millisToString(e.duration||0,!0)}));break}case o.V8Deopt:l.appendChild(s.XLink.XLink.create("https://github.com/GoogleChrome/devtools-docs/issues/53",Jt(jt.notOptimized))),s.UIUtils.createTextChild(l,Jt(jt.emptyPlaceholderColon,{PH1:d.deoptReason}));break;default:console.assert(!1,"Unhandled TimelineModel.WarningType")}return l}static displayNameForFrame(e,t){return t||(t=30),e.url.startsWith("about:")?`"${n.StringUtilities.trimMiddle(e.name,t)}"`:e.url.trimEnd(t)}}class ni{title;category;hidden;constructor(e,t,i=!1){this.title=e,this.category=t,this.hidden=i}}var ai;!function(e){e.HTML="HTML",e.Script="Script",e.Style="Style",e.Media="Media",e.Other="Other"}(ai||(ai={}));const ri=Symbol("aggregatedStats");class si extends s.TreeOutline.TreeElement{toggleOnClick;relatedNodesMap;contentHelper;invalidations;constructor(e,t,i,n){super("",!0),this.listItemElement.classList.add("header"),this.selectable=!1,this.toggleOnClick=!0,this.relatedNodesMap=t,this.contentHelper=i,this.invalidations=n,this.title=this.createTitle(e)}createTitle(e){const t=this.invalidations[0],n=t.cause.reason||Jt(jt.unknownCause),a=t.cause.stackTrace&&t.cause.stackTrace[0],r=this.getTruncatedNodesElement(this.invalidations);if(null===r)return i.i18n.getFormatLocalizedString(qt,jt.emptyPlaceholder,{PH1:n});const s=i.i18n.getFormatLocalizedString(qt,jt.sForS,{PH1:n,PH2:r});if(a&&this.contentHelper.linkifier()){const t=document.createElement("span");t.classList.add("monospace");const n=i.i18n.getFormatLocalizedString(qt,jt.sSDot,{PH1:s,PH2:t});t.createChild("span").textContent=ii.frameDisplayName(a);const r=this.contentHelper.linkifier();if(r){const i=r.maybeLinkifyConsoleCallFrame(e,a,{showColumnNumber:!0,inlineFrameIndex:0});i&&(i.textContent&&"​"!==i.textContent||(i.textContent=Jt(jt.unknown)),t.createChild("span").textContent=" @ ",t.createChild("span").appendChild(i))}return n}return s}async onpopulate(){const e=document.createElement("div");e.classList.add("content");const t=this.invalidations[0];if(t.cause.stackTrace){const i=e.createChild("div");s.UIUtils.createTextChild(i,Jt(jt.stackTraceColon)),this.contentHelper.createChildStackTraceElement(i,ii.stackTraceFromCallFrames(t.cause.stackTrace))}s.UIUtils.createTextChild(e,1!==this.invalidations.length?Jt(jt.nodes):Jt(jt.node));const i=e.createChild("div","node-list");let n=!0;for(let e=0;e<this.invalidations.length;e++){const t=this.invalidations[e],a=this.createInvalidationNode(t,!0);if(a){n||s.UIUtils.createTextChild(i,", "),n=!1,i.appendChild(a);const e=t.extraData?", "+t.extraData:"";t.changedId?s.UIUtils.createTextChild(i,Jt(jt.changedIdToSs,{PH1:t.changedId,PH2:e})):t.changedClass?s.UIUtils.createTextChild(i,Jt(jt.changedClassToSs,{PH1:t.changedClass,PH2:e})):t.changedAttribute?s.UIUtils.createTextChild(i,Jt(jt.changedAttributeToSs,{PH1:t.changedAttribute,PH2:e})):t.changedPseudo?s.UIUtils.createTextChild(i,Jt(jt.changedPesudoToSs,{PH1:t.changedPseudo,PH2:e})):t.selectorPart&&s.UIUtils.createTextChild(i,Jt(jt.changedSs,{PH1:t.selectorPart,extraData:e}))}}const a=new s.TreeOutline.TreeElement(e,!1);a.selectable=!1,this.appendChild(a)}getTruncatedNodesElement(e){const t=[],n={};for(let i=0;i<e.length;i++){const a=e[i],r=this.createInvalidationNode(a,!1);r.addEventListener("click",(e=>e.consume()),!1),r&&a.nodeId&&!n[a.nodeId]&&(t.push(r),n[a.nodeId]=!0)}if(1===t.length){const e=t[0];return e instanceof HTMLSpanElement?e:null}return 2===t.length?i.i18n.getFormatLocalizedString(qt,jt.sAndS,{PH1:t[0],PH2:t[1]}):3===t.length?i.i18n.getFormatLocalizedString(qt,jt.sAndSOther,{PH1:t[0],PH2:t[1]}):t.length>=4?i.i18n.getFormatLocalizedString(qt,jt.sSAndSOthers,{PH1:t[0],PH2:t[1],PH3:String(t.length-2)}):null}createInvalidationNode(e,i){const n=e.nodeId&&this.relatedNodesMap?this.relatedNodesMap.get(e.nodeId):null;if(n){const e=document.createElement("span");return t.Linkifier.Linkifier.linkify(n).then((t=>e.appendChild(t))),e}if(e.nodeName){const t=document.createElement("span");return t.textContent=e.nodeName,t}if(i){const e=document.createElement("span");return s.UIUtils.createTextChild(e,Jt(jt.UnknownNode))}throw new Error("Unable to create invalidation node")}}const oi=Symbol("previewElement");class li{priority;color;eventTypes;constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}class di{name;title;visible;childColor;color;hiddenInternal;constructor(e,t,i,n,a){this.name=e,this.title=t,this.visible=i,this.childColor=n,this.color=a,this.hidden=!1}get hidden(){return Boolean(this.hiddenInternal)}set hidden(e){this.hiddenInternal=e}}class ci{fragment;linkifierInternal;target;element;tableElement;constructor(e,t){this.fragment=document.createDocumentFragment(),this.linkifierInternal=t,this.target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this.tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),s.UIUtils.createTextChild(i,e)}this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this.linkifierInternal}appendTextRow(e,t){const i=this.tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t.toString()}appendElementRow(e,t,i,n){const a=this.tableElement.createChild("div","timeline-details-view-row");i&&a.classList.add("timeline-details-warning"),n&&a.classList.add("timeline-details-stack-values");a.createChild("div","timeline-details-view-row-title").textContent=e;const r=a.createChild("div","timeline-details-view-row-value");t instanceof Node?r.appendChild(t):s.UIUtils.createTextChild(r,t||"")}appendLocationRow(e,t,i,n){if(!this.linkifierInternal||!this.target)return;const a={tabStop:!0,columnNumber:n,showColumnNumber:!0,inlineFrameIndex:0},r=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,a);r&&this.appendElementRow(e,r)}appendLocationRange(e,t,i,a){if(!this.linkifierInternal||!this.target)return;const r=document.createElement("span"),o=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,{tabStop:!0,inlineFrameIndex:0});o&&(r.appendChild(o),s.UIUtils.createTextChild(r,n.StringUtilities.sprintf(" [%s…%s]",i+1,(a||0)+1||"")),this.appendElementRow(e,r))}appendStackTrace(e,t){if(!this.linkifierInternal||!this.target)return;const i=this.tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,this.createChildStackTraceElement(i,t)}createChildStackTraceElement(e,t){if(!this.linkifierInternal||!this.target)return;e.classList.add("timeline-details-stack-values");const i=e.createChild("div","timeline-details-view-row-value timeline-details-view-row-stack-trace"),n=l.JSPresentationUtils.buildStackTracePreviewContents(this.target,this.linkifierInternal,{stackTrace:t,tabStops:!0});i.appendChild(n.element)}appendWarningRow(e,t){const i=ii.eventWarning(e,t);i&&this.appendElementRow(Jt(jt.warning),i,!0)}}const hi=Symbol("categoryBreakdownCache");function mi(e){let t=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=0,a=0,r=new Set;for(const s of e)if(!s.args.data.had_recent_input&&void 0!==s.args.data.weighted_score_delta){if(s.startTime-t>5e3||s.startTime-i>1e3){t=s.startTime;for(const e of r)e.args.data._current_cluster_score=a,e.args.data._current_cluster_id=n;n+=1,a=0,r=new Set}i=s.startTime,a+=s.args.data.weighted_score_delta,r.add(s)}for(const e of r)e.args.data._current_cluster_score=a,e.args.data._current_cluster_id=n}var ui,pi=Object.freeze({__proto__:null,TimelineUIUtils:ii,TimelineRecordStyle:ni,get NetworkCategory(){return ai},aggregatedStatsKey:ri,InvalidationsGroupElement:si,previewElementSymbol:oi,EventDispatchTypeDescriptor:li,TimelineCategory:di,TimelineDetailsContentHelper:ci,categoryBreakdownCacheSymbol:hi,assignLayoutShiftsToClusters:mi});class gi extends t.ObjectWrapper.ObjectWrapper{mainTargetInternal;tracingModelInternal;filtersInternal;timelineModelInternal;frameModelInternal;filmStripModelInternal;irModel;windowInternal;extensionTracingModels;recordStartTimeInternal;constructor(){super(),this.mainTargetInternal=null,this.tracingModelInternal=null,this.filtersInternal=[],this.timelineModelInternal=new a.TimelineModel.TimelineModelImpl,this.frameModelInternal=new a.TimelineFrameModel.TimelineFrameModel((e=>ii.eventStyle(e).category.name)),this.filmStripModelInternal=null,this.irModel=new a.TimelineIRModel.TimelineIRModel,this.windowInternal={left:0,right:1/0},this.extensionTracingModels=[],this.recordStartTimeInternal=void 0}setMainTarget(e){this.mainTargetInternal=e}mainTarget(){return this.mainTargetInternal}setRecordStartTime(e){this.recordStartTimeInternal=e}recordStartTime(){return this.recordStartTimeInternal}setFilters(e){this.filtersInternal=e}filters(){return this.filtersInternal}isVisible(e){return this.filtersInternal.every((t=>t.accept(e)))}setTracingModel(e){this.tracingModelInternal=e,this.timelineModelInternal.setEvents(e);let t=null;for(const e of this.timelineModelInternal.tracks())e.type===a.TimelineModel.TrackType.Animation&&(t=e.asyncEvents);t&&this.irModel.populate([],t||[]);const i=this.timelineModelInternal.tracks().filter((e=>e.type===a.TimelineModel.TrackType.MainThread&&e.forMainFrame&&e.events.length)).map((e=>{const t=e.events[0];return{thread:t.thread,time:t.startTime}}));this.frameModelInternal.addTraceEvents(this.mainTargetInternal,this.timelineModelInternal.inspectedTargetEvents(),i);for(const e of this.extensionTracingModels)e.model.adjustTime(this.tracingModelInternal.minimumRecordTime()+e.timeOffset/1e3-this.recordStartTimeInternal);this.autoWindowTimes()}addExtensionEvents(e,t,i){this.extensionTracingModels.push({model:t,title:e,timeOffset:i}),this.tracingModelInternal&&(t.adjustTime(this.tracingModelInternal.minimumRecordTime()+i/1e3-this.recordStartTimeInternal),this.dispatchEventToListeners(ui.ExtensionDataAdded))}tracingModel(){if(!this.tracingModelInternal)throw"call setTracingModel before accessing PerformanceModel";return this.tracingModelInternal}timelineModel(){return this.timelineModelInternal}filmStripModel(){if(this.filmStripModelInternal)return this.filmStripModelInternal;if(!this.tracingModelInternal)throw"call setTracingModel before accessing PerformanceModel";return this.filmStripModelInternal=new e.FilmStripModel.FilmStripModel(this.tracingModelInternal),this.filmStripModelInternal}frames(){return this.frameModelInternal.getFrames()}frameModel(){return this.frameModelInternal}interactionRecords(){return this.irModel.interactionRecords()}extensionInfo(){return this.extensionTracingModels}dispose(){this.tracingModelInternal&&this.tracingModelInternal.dispose();for(const e of this.extensionTracingModels)e.model.dispose()}filmStripModelFrame(e){const t=e.idle?e.startTime:e.endTime,i=this.filmStripModelInternal.frameByTimestamp(t);return i&&i.timestamp-e.endTime<10?i:null}save(e){if(!this.tracingModelInternal)throw"call setTracingModel before accessing PerformanceModel";return this.tracingModelInternal.backingStorage().writeToStream(e)}setWindow(e,t){this.windowInternal=e,this.dispatchEventToListeners(ui.WindowChanged,{window:e,animate:t})}window(){return this.windowInternal}autoWindowTimes(){const e=this.timelineModelInternal;let t=[];for(const i of e.tracks())i.type===a.TimelineModel.TrackType.MainThread&&i.forMainFrame&&(t=i.tasks);if(!t.length)return void this.setWindow({left:e.minimumRecordTime(),right:e.maximumRecordTime()});function i(e,i){let n=e,a=(t[n].startTime+t[n].endTime)/2,r=0;const s=Math.sign(i-e);for(let o=e;o!==i;o+=s){const e=t[o],i=(e.startTime+e.endTime)/2;r<.1*Math.abs(a-i)&&(n=o,a=i,r=0),r+=e.duration}return n}const n=i(t.length-1,0),r=i(0,n);let s=t[r].startTime,o=t[n].endTime;const l=o-s;l<.1*(e.maximumRecordTime()-e.minimumRecordTime())?(s=e.minimumRecordTime(),o=e.maximumRecordTime()):(s=Math.max(s-.05*l,e.minimumRecordTime()),o=Math.min(o+.05*l,e.maximumRecordTime())),this.setWindow({left:s,right:o})}}!function(e){e.ExtensionDataAdded="ExtensionDataAdded",e.WindowChanged="WindowChanged"}(ui||(ui={}));var vi=Object.freeze({__proto__:null,PerformanceModel:gi,get Events(){return ui}});const fi={jsHeap:"JS Heap",documents:"Documents",nodes:"Nodes",listeners:"Listeners",gpuMemory:"GPU Memory",ss:"[{PH1} – {PH2}]"},Ti=i.i18n.registerUIStrings("panels/timeline/CountersGraph.ts",fi),wi=i.i18n.getLocalizedString.bind(void 0,Ti);class Si extends s.Widget.VBox{delegate;calculator;model;header;toolbar;graphsContainer;canvasContainer;canvas;timelineGrid;counters;counterUI;countersByName;gpuMemoryCounter;track;currentValuesBar;markerXPosition;constructor(e){super(),this.element.id="memory-graphs-container",this.delegate=e,this.calculator=new Ci,this.header=new s.Widget.HBox,this.header.element.classList.add("timeline-memory-header"),this.header.show(this.element),this.toolbar=new s.Toolbar.Toolbar("timeline-memory-toolbar"),this.header.element.appendChild(this.toolbar.element),this.graphsContainer=new s.Widget.VBox,this.graphsContainer.show(this.element);const t=new s.Widget.VBoxWithResizeCallback(this.resize.bind(this));t.show(this.graphsContainer.element),this.createCurrentValuesBar(),this.canvasContainer=t.element,this.canvasContainer.id="memory-graphs-canvas-container",this.canvas=document.createElement("canvas"),this.canvasContainer.appendChild(this.canvas),this.canvas.id="memory-counters-graph",this.canvasContainer.addEventListener("mouseover",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mouseleave",this.onMouseLeave.bind(this),!0),this.canvasContainer.addEventListener("click",this.onClick.bind(this),!0),this.timelineGrid=new r.TimelineGrid.TimelineGrid,this.canvasContainer.appendChild(this.timelineGrid.dividersElement),this.counters=[],this.counterUI=[],this.countersByName=new Map,this.countersByName.set("jsHeapSizeUsed",this.createCounter(wi(fi.jsHeap),"hsl(220, 90%, 43%)",n.NumberUtilities.bytesToString)),this.countersByName.set("documents",this.createCounter(wi(fi.documents),"hsl(0, 90%, 43%)")),this.countersByName.set("nodes",this.createCounter(wi(fi.nodes),"hsl(120, 90%, 43%)")),this.countersByName.set("jsEventListeners",this.createCounter(wi(fi.listeners),"hsl(38, 90%, 43%)")),this.gpuMemoryCounter=this.createCounter(wi(fi.gpuMemory),"hsl(300, 90%, 43%)",n.NumberUtilities.bytesToString),this.countersByName.set("gpuMemoryUsedKB",this.gpuMemoryCounter)}setModel(e,t){this.model!==e&&(this.model&&this.model.removeEventListener(ui.WindowChanged,this.onWindowChanged,this),this.model=e,this.model&&this.model.addEventListener(ui.WindowChanged,this.onWindowChanged,this)),this.calculator.setZeroTime(e?e.timelineModel().minimumRecordTime():0);for(let e=0;e<this.counters.length;++e)this.counters[e].reset(),this.counterUI[e].reset();if(this.scheduleRefresh(),this.track=t,!t)return;const i=t.syncEvents();for(let e=0;e<i.length;++e){const t=i[e];if(t.name!==a.TimelineModel.RecordType.UpdateCounters)continue;const n=t.args.data;if(!n)return;for(const e in n){const i=this.countersByName.get(e);i&&i.appendSample(t.startTime,n[e])}const r="gpuMemoryLimitKB";r in n&&this.gpuMemoryCounter.setLimit(n[r])}}createCurrentValuesBar(){this.currentValuesBar=this.graphsContainer.element.createChild("div"),this.currentValuesBar.id="counter-values-bar"}createCounter(e,t,i){const n=new yi;return this.counters.push(n),this.counterUI.push(new bi(this,e,t,n,i)),n}resizerElement(){return this.header.element}resize(){const e=this.canvas.parentElement;this.canvas.width=e.clientWidth*window.devicePixelRatio,this.canvas.height=e.clientHeight*window.devicePixelRatio,this.calculator.setDisplayWidth(this.canvas.width),this.refresh()}onWindowChanged(e){const t=e.data.window;this.calculator.setWindow(t.left,t.right),this.scheduleRefresh()}scheduleRefresh(){s.UIUtils.invokeOnceAfterBatchUpdate(this,this.refresh)}draw(){this.clear();for(const e of this.counters)e.calculateVisibleIndexes(this.calculator),e.calculateXValues(this.canvas.width);for(const e of this.counterUI)e.drawGraph(this.canvas)}onClick(e){const t=e.x-this.canvasContainer.totalOffsetLeft();let i,n=1/0;for(const e of this.counterUI){if(!e.counter.times.length)continue;const a=e.recordIndexAt(t),r=Math.abs(t*window.devicePixelRatio-e.counter.x[a]);r<n&&(n=r,i=e.counter.times[a])}void 0!==i&&this.track&&this.delegate.selectEntryAtTime(this.track.events.length?this.track.events:this.track.asyncEvents,i)}onMouseLeave(e){delete this.markerXPosition,this.clearCurrentValueAndMarker()}clearCurrentValueAndMarker(){for(let e=0;e<this.counterUI.length;e++)this.counterUI[e].clearCurrentValueAndMarker()}onMouseMove(e){const t=e.x-this.canvasContainer.totalOffsetLeft();this.markerXPosition=t,this.refreshCurrentValues()}refreshCurrentValues(){if(void 0!==this.markerXPosition)for(let e=0;e<this.counterUI.length;++e)this.counterUI[e].updateCurrentValue(this.markerXPosition)}refresh(){this.timelineGrid.updateDividers(this.calculator),this.draw(),this.refreshCurrentValues()}clear(){const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to get canvas context");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class yi{times;values;x;minimumIndex;maximumIndex;maxTime;minTime;limitValue;constructor(){this.times=[],this.values=[],this.x=[],this.minimumIndex=0,this.maximumIndex=0,this.maxTime=0,this.minTime=0}appendSample(e,t){this.values.length&&this.values[this.values.length-1]===t||(this.times.push(e),this.values.push(t))}reset(){this.times=[],this.values=[]}setLimit(e){this.limitValue=e}calculateBounds(){let e,t;for(let i=this.minimumIndex;i<=this.maximumIndex;i++){const n=this.values[i];(void 0===t||n<t)&&(t=n),(void 0===e||n>e)&&(e=n)}return t=t||0,e=e||1,this.limitValue&&(e>.5*this.limitValue&&(e=Math.max(e,this.limitValue)),t=Math.min(t,this.limitValue)),{min:t,max:e}}calculateVisibleIndexes(e){const t=e.minimumBoundary(),i=e.maximumBoundary();this.minimumIndex=n.NumberUtilities.clamp(n.ArrayUtilities.upperBound(this.times,t,n.ArrayUtilities.DEFAULT_COMPARATOR)-1,0,this.times.length-1),this.maximumIndex=n.NumberUtilities.clamp(n.ArrayUtilities.lowerBound(this.times,i,n.ArrayUtilities.DEFAULT_COMPARATOR),0,this.times.length-1),this.minTime=t,this.maxTime=i}calculateXValues(e){if(!this.values.length)return;const t=e/(this.maxTime-this.minTime);this.x=new Array(this.values.length);for(let e=this.minimumIndex+1;e<=this.maximumIndex;e++)this.x[e]=t*(this.times[e]-this.minTime)}}class bi{countersPane;counter;formatter;setting;filter;range;value;graphColor;limitColor;graphYValues;verticalPadding;currentValueLabel;marker;constructor(e,i,a,r,o){this.countersPane=e,this.counter=r,this.formatter=o||n.NumberUtilities.withThousandsSeparator,this.setting=t.Settings.Settings.instance().createSetting("timelineCountersGraph-"+i,!0),this.setting.setTitle(i),this.filter=new s.Toolbar.ToolbarSettingCheckbox(this.setting,i),this.filter.inputElement.classList.add("-theme-preserve-input");const l=t.Color.Color.parse(a);if(l){const e=l.setAlpha(.5).asString(t.Color.Format.RGBA),i=this.filter.element;e&&(i.style.backgroundColor=e),i.style.borderColor="transparent"}this.filter.inputElement.addEventListener("click",this.toggleCounterGraph.bind(this)),e.toolbar.appendToolbarItem(this.filter),this.range=this.filter.element.createChild("span","range"),this.value=e.currentValuesBar.createChild("span","memory-counter-value"),this.value.style.color=a,this.graphColor=a,l&&(this.limitColor=l.setAlpha(.3).asString(t.Color.Format.RGBA)),this.graphYValues=[],this.verticalPadding=10,this.currentValueLabel=i,this.marker=e.canvasContainer.createChild("div","memory-counter-marker"),this.marker.style.backgroundColor=a,this.clearCurrentValueAndMarker()}reset(){this.range.textContent=""}setRange(e,t){const i=this.formatter(e),n=this.formatter(t);this.range.textContent=wi(fi.ss,{PH1:i,PH2:n})}toggleCounterGraph(){this.value.classList.toggle("hidden",!this.filter.checked()),this.countersPane.refresh()}recordIndexAt(e){return n.ArrayUtilities.upperBound(this.counter.x,e*window.devicePixelRatio,n.ArrayUtilities.DEFAULT_COMPARATOR,this.counter.minimumIndex+1,this.counter.maximumIndex+1)-1}updateCurrentValue(e){if(!this.visible()||!this.counter.values.length||!this.counter.x)return;const t=this.recordIndexAt(e),i=n.NumberUtilities.withThousandsSeparator(this.counter.values[t]);this.value.textContent=`${this.currentValueLabel}: ${i}`;const a=this.graphYValues[t]/window.devicePixelRatio;this.marker.style.left=e+"px",this.marker.style.top=a+"px",this.marker.classList.remove("hidden")}clearCurrentValueAndMarker(){this.value.textContent="",this.marker.classList.add("hidden")}drawGraph(e){const t=e.getContext("2d");if(!t)throw new Error("Unable to get canvas context");const i=e.width,n=e.height-2*this.verticalPadding;if(n<=0)return void(this.graphYValues=[]);const a=this.verticalPadding,r=this.counter,s=r.values;if(!s.length)return;const o=r.calculateBounds(),l=o.min,d=o.max;if(this.setRange(l,d),!this.visible())return;const c=this.graphYValues,h=d-l,m=h?n/h:1;t.save(),t.lineWidth=window.devicePixelRatio,t.lineWidth%2&&t.translate(.5,.5),t.beginPath();let u=s[r.minimumIndex],p=Math.round(a+n-(u-l)*m);t.moveTo(0,p);let g=r.minimumIndex;for(;g<=r.maximumIndex;g++){const e=Math.round(r.x[g]);t.lineTo(e,p);const i=s[g];void 0!==i&&(u=i),p=Math.round(a+n-(u-l)*m),t.lineTo(e,p),c[g]=p}if(c.length=g,t.lineTo(i,p),t.strokeStyle=this.graphColor,t.stroke(),r.limitValue){const e=Math.round(a+n-(r.limitValue-l)*m);t.moveTo(0,e),t.lineTo(i,e),this.limitColor&&(t.strokeStyle=this.limitColor),t.stroke()}t.closePath(),t.restore()}visible(){return this.filter.checked()}}class Ci{minimumBoundaryInternal;maximumBoundaryInternal;workingArea;zeroTimeInternal;constructor(){this.minimumBoundaryInternal=0,this.maximumBoundaryInternal=0,this.workingArea=0,this.zeroTimeInternal=0}setZeroTime(e){this.zeroTimeInternal=e}computePosition(e){return(e-this.minimumBoundaryInternal)/this.boundarySpan()*this.workingArea}setWindow(e,t){this.minimumBoundaryInternal=e,this.maximumBoundaryInternal=t}setDisplayWidth(e){this.workingArea=e}formatValue(e,t){return i.TimeUtilities.preciseMillisToString(e-this.zeroTime(),t)}maximumBoundary(){return this.maximumBoundaryInternal}minimumBoundary(){return this.minimumBoundaryInternal}zeroTime(){return this.zeroTimeInternal}boundarySpan(){return this.maximumBoundaryInternal-this.minimumBoundaryInternal}}var ki=Object.freeze({__proto__:null,CountersGraph:Si,Counter:yi,CounterUI:bi,Calculator:Ci});export{b as CLSLinkifier,ki as CountersGraph,Ce as EventsTimelineTreeView,W as ExtensionTracingSession,vi as PerformanceModel,z as TimelineController,He as TimelineDetailsView,te as TimelineEventOverview,re as TimelineFilters,qe as TimelineFlameChartDataProvider,Ye as TimelineFlameChartNetworkDataProvider,lt as TimelineFlameChartView,wt as TimelineHistoryManager,Pe as TimelineLayersView,U as TimelineLoader,Re as TimelinePaintProfilerView,_t as TimelinePanel,fe as TimelineTreeView,pi as TimelineUIUtils,Rt as UIDevtoolsController,xt as UIDevtoolsUtils};
