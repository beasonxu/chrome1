import*as e from"../../core/common/common.js";import*as t from"../../core/root/root.js";import*as r from"../../core/sdk/sdk.js";import*as o from"../workspace/workspace.js";import*as s from"../../core/platform/platform.js";import{assertNotNullOrUndefined as i}from"../../core/platform/platform.js";import*as n from"../text_utils/text_utils.js";import*as a from"../../core/i18n/i18n.js";const c={unknownErrorLoadingFile:"Unknown error loading file"},u=a.i18n.registerUIStrings("models/bindings/ContentProviderBasedProject.ts",c),l=a.i18n.getLocalizedString.bind(void 0,u);class d extends o.Workspace.ProjectStore{#e;#t;#r;constructor(e,t,r,o,s){super(e,t,r,o),this.#e=new Map,this.#t=s,this.#r=new WeakMap,e.addProject(this)}async requestFileContent(e){const t=this.#e.get(e.url());try{const e=await t.requestContent(),r="wasmDisassemblyInfo"in e?e.wasmDisassemblyInfo:void 0;return{content:e.content,wasmDisassemblyInfo:r,isEncoded:e.isEncoded,error:"error"in e&&e.error||""}}catch(e){return{content:null,isEncoded:!1,error:e?String(e):l(c.unknownErrorLoadingFile)}}}isServiceProject(){return this.#t}async requestMetadata(e){const{metadata:t}=this.#r.get(e);return t}canSetFileContent(){return!1}async setFileContent(e,t,r){}fullDisplayName(e){let t=e.parentURL().replace(/^(?:https?|file)\:\/\//,"");try{t=decodeURI(t)}catch(e){}return t+"/"+e.displayName(!0)}mimeType(e){const{mimeType:t}=this.#r.get(e);return t}canRename(){return!1}rename(e,t,r){const o=e.url();this.performRename(o,t,function(t,s){if(t&&s){const t=o.split("/");t[t.length-1]=s;const r=t.join("/"),i=this.#e.get(o);this.#e.set(r,i),this.#e.delete(o),this.renameUISourceCode(e,s)}r(t,s)}.bind(this))}excludeFolder(e){}canExcludeFolder(e){return!1}async createFile(e,t,r,o){return null}canCreateFile(){return!1}deleteFile(e){}remove(){}performRename(e,t,r){r(!1)}searchInFileContent(e,t,r,o){return this.#e.get(e.url()).searchInContent(t,r,o)}async findFilesMatchingSearchRequest(e,t,r){const o=[];return r.setTotalWork(t.length),await Promise.all(t.map(async function(t){const s=this.#e.get(t);let i=!0;for(const t of e.queries().slice()){if(!(await s.searchInContent(t,!e.ignoreCase(),e.isRegex())).length){i=!1;break}}i&&o.push(t);r.incrementWorked(1)}.bind(this))),r.done(),o}indexContent(e){queueMicrotask(e.done.bind(e))}addUISourceCodeWithProvider(e,t,r,o){this.#e.set(e.url(),t),this.#r.set(e,{mimeType:o,metadata:r}),this.addUISourceCode(e)}addContentProvider(e,t,r){const o=this.createUISourceCode(e,t.contentType());return this.addUISourceCodeWithProvider(o,t,null,r),o}removeFile(e){this.#e.delete(e),this.removeUISourceCode(e)}reset(){this.#e.clear(),this.removeProject(),this.workspace().addProject(this)}dispose(){this.#e.clear(),this.removeProject()}}var h=Object.freeze({__proto__:null,ContentProviderBasedProject:d});let p;class g{#o;#s;#i;constructor(t){this.#o=t,r.TargetManager.TargetManager.instance().addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.GlobalObjectCleared,this.clearCacheIfNeeded.bind(this),this),e.Settings.Settings.instance().moduleSetting("skipStackFramesPattern").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("skipContentScripts").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("automaticallyIgnoreListKnownThirdPartyScripts").addChangeListener(this.patternChanged.bind(this)),this.#s=new Set,this.#i=new Map,r.TargetManager.TargetManager.instance().observeModels(r.DebuggerModel.DebuggerModel,this)}static instance(e={forceNew:null,debuggerWorkspaceBinding:null}){const{forceNew:t,debuggerWorkspaceBinding:r}=e;if(!p||t){if(!r)throw new Error(`Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);p=new g(r)}return p}addChangeListener(e){this.#s.add(e)}removeChangeListener(e){this.#s.delete(e)}modelAdded(e){this.setIgnoreListPatterns(e);const t=e.sourceMapManager();t.addEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),t.addEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}modelRemoved(e){this.clearCacheIfNeeded();const t=e.sourceMapManager();t.removeEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),t.removeEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}clearCacheIfNeeded(){this.#i.size>1024&&this.#i.clear()}getSkipStackFramesPatternSetting(){return e.Settings.Settings.instance().moduleSetting("skipStackFramesPattern")}setIgnoreListPatterns(e){const t=this.getSkipStackFramesPatternSetting().getAsArray(),r=[];for(const e of t)!e.disabled&&e.pattern&&r.push(e.pattern);return e.setBlackboxPatterns(r)}isUserOrSourceMapIgnoreListedUISourceCode(e){const t=e.project().type()===o.Workspace.projectTypes.ContentScripts;if(this.skipContentScripts&&t)return!0;const r=this.uiSourceCodeURL(e);return!!r&&this.isUserOrSourceMapIgnoreListedURL(r,e.isKnownThirdParty())}isUserOrSourceMapIgnoreListedURL(e,t){return!!this.isUserIgnoreListedURL(e)||!(!this.automaticallyIgnoreListKnownThirdPartyScripts||!t)}isUserIgnoreListedURL(e,t){if(this.#i.has(e))return Boolean(this.#i.get(e));if(t&&this.skipContentScripts)return!0;const r=this.getSkipStackFramesPatternSetting().asRegExp(),o=r&&r.test(e)||!1;return this.#i.set(e,o),o}sourceMapAttached(e){const t=e.data.client,r=e.data.sourceMap;this.updateScriptRanges(t,r)}sourceMapDetached(e){const t=e.data.client;this.updateScriptRanges(t,null)}async updateScriptRanges(e,t){let r=!1;if(g.instance().isUserIgnoreListedURL(e.sourceURL,e.isContentScript())||(r=t?.sourceURLs().some((e=>this.isUserOrSourceMapIgnoreListedURL(e,t.hasIgnoreListHint(e))))??!1),!r)return m.get(e)&&await e.setBlackboxedRanges([])&&m.delete(e),void await this.#o.updateLocations(e);if(!t)return;const o=t.findRanges((e=>this.isUserOrSourceMapIgnoreListedURL(e,t.hasIgnoreListHint(e))),{isStartMatching:!0}).flatMap((e=>[e.start,e.end]));!function(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;++r)if(e[r].lineNumber!==t[r].lineNumber||e[r].columnNumber!==t[r].columnNumber)return!1;return!0}(m.get(e)||[],o)&&await e.setBlackboxedRanges(o)&&m.set(e,o),this.#o.updateLocations(e)}uiSourceCodeURL(e){return e.project().type()===o.Workspace.projectTypes.Debugger?null:e.url()}canIgnoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);return!!t&&Boolean(this.urlToRegExpString(t))}ignoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);t&&this.ignoreListURL(t)}unIgnoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);t&&this.unIgnoreListURL(t)}get skipContentScripts(){return e.Settings.Settings.instance().moduleSetting("skipContentScripts").get()}get automaticallyIgnoreListKnownThirdPartyScripts(){return e.Settings.Settings.instance().moduleSetting("automaticallyIgnoreListKnownThirdPartyScripts").get()}ignoreListContentScripts(){e.Settings.Settings.instance().moduleSetting("skipContentScripts").set(!0)}unIgnoreListContentScripts(){e.Settings.Settings.instance().moduleSetting("skipContentScripts").set(!1)}ignoreListURL(e){const t=this.getSkipStackFramesPatternSetting().getAsArray(),r=this.urlToRegExpString(e);if(!r)return;let o=!1;for(let e=0;e<t.length;++e){const s=t[e];if(s.pattern===r){s.disabled=!1,o=!0;break}}o||t.push({pattern:r,disabled:void 0}),this.getSkipStackFramesPatternSetting().setAsArray(t)}unIgnoreListURL(e){let t=this.getSkipStackFramesPatternSetting().getAsArray();const r=g.instance().urlToRegExpString(e);if(r){t=t.filter((function(e){return e.pattern!==r}));for(let r=0;r<t.length;++r){const o=t[r];if(!o.disabled)try{new RegExp(o.pattern).test(e)&&(o.disabled=!0)}catch(e){}}this.getSkipStackFramesPatternSetting().setAsArray(t)}}async patternChanged(){this.#i.clear();const e=[];for(const t of r.TargetManager.TargetManager.instance().models(r.DebuggerModel.DebuggerModel)){e.push(this.setIgnoreListPatterns(t));const r=t.sourceMapManager();for(const o of t.scripts())e.push(this.updateScriptRanges(o,r.sourceMapForClient(o)))}await Promise.all(e);const t=Array.from(this.#s);for(const e of t)e();this.patternChangeFinishedForTests()}patternChangeFinishedForTests(){}urlToRegExpString(t){const r=new e.ParsedURL.ParsedURL(t);if(r.isAboutBlank()||r.isDataURL())return"";if(!r.isValid)return"^"+s.StringUtilities.escapeForRegExp(t)+"$";let o=r.lastPathComponent;if(o?o="/"+o:r.folderPathComponents&&(o=r.folderPathComponents+"/"),o||(o=r.host),!o)return"";const i=r.scheme;let n="";return i&&"http"!==i&&"https"!==i&&(n="^"+i+"://","chrome-extension"===i&&(n+=r.host+"\\b"),n+=".*"),n+s.StringUtilities.escapeForRegExp(o)+(t.endsWith(o)?"$":"\\b")}}const m=new WeakMap;var b=Object.freeze({__proto__:null,IgnoreListManager:g});const f=new WeakMap,S=new WeakMap;let M;class L extends e.ObjectWrapper.ObjectWrapper{constructor(){super()}static instance({forceNew:e}={forceNew:!1}){return M&&!e||(M=new L),M}}var C;!function(e){e.FrameAttributionAdded="FrameAttributionAdded",e.FrameAttributionRemoved="FrameAttributionRemoved"}(C||(C={}));class v{static resolveFrame(e,t){const o=v.targetForUISourceCode(e),s=o&&o.model(r.ResourceTreeModel.ResourceTreeModel);return s?s.frameForId(t):null}static setInitialFrameAttribution(e,t){if(!t)return;const r=v.resolveFrame(e,t);if(!r)return;const o=new Map;o.set(t,{frame:r,count:1}),f.set(e,o)}static cloneInitialFrameAttribution(e,t){const r=f.get(e);if(!r)return;const o=new Map;for(const e of r.keys()){const t=r.get(e);void 0!==t&&o.set(e,{frame:t.frame,count:t.count})}f.set(t,o)}static addFrameAttribution(e,t){const r=v.resolveFrame(e,t);if(!r)return;const o=f.get(e);if(!o)return;const s=o.get(t)||{frame:r,count:0};if(s.count+=1,o.set(t,s),1!==s.count)return;const i={uiSourceCode:e,frame:r};L.instance().dispatchEventToListeners(C.FrameAttributionAdded,i)}static removeFrameAttribution(e,t){const r=f.get(e);if(!r)return;const o=r.get(t);if(console.assert(Boolean(o),"Failed to remove frame attribution for url: "+e.url()),!o)return;if(o.count-=1,o.count>0)return;r.delete(t);const s={uiSourceCode:e,frame:o.frame};L.instance().dispatchEventToListeners(C.FrameAttributionRemoved,s)}static targetForUISourceCode(e){return S.get(e.project())||null}static setTargetForProject(e,t){S.set(e,t)}static getTargetForProject(e){return S.get(e)||null}static framesForUISourceCode(e){const t=v.targetForUISourceCode(e),o=t&&t.model(r.ResourceTreeModel.ResourceTreeModel),s=f.get(e);if(!o||!s)return[];return Array.from(s.keys()).map((e=>o.frameForId(e))).filter((e=>Boolean(e)))}}var I=Object.freeze({__proto__:null,NetworkProjectManager:L,get Events(){return C},NetworkProject:v});class w{#n;#a;#c;#o;#u;#l;#d;#h;#p;#g;#m;constructor(e,t,s){this.#n=e,this.#a=this.#n.sourceMapManager(),this.#c=t,this.#o=s;const i=e.target();this.#u=new d(t,"jsSourceMaps::"+i.id(),o.Workspace.projectTypes.Network,"",!1),this.#l=new d(t,"jsSourceMaps:extensions:"+i.id(),o.Workspace.projectTypes.ContentScripts,"",!1),v.setTargetForProject(this.#u,i),v.setTargetForProject(this.#l,i),this.#d=new Map,this.#h=new Map,this.#p=new Map,this.#g=new d(t,"jsSourceMaps:stub:"+i.id(),o.Workspace.projectTypes.Service,"",!0),this.#m=[this.#a.addEventListener(r.SourceMapManager.Events.SourceMapWillAttach,this.sourceMapWillAttach,this),this.#a.addEventListener(r.SourceMapManager.Events.SourceMapFailedToAttach,this.sourceMapFailedToAttach,this),this.#a.addEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#a.addEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this),this.#c.addEventListener(o.Workspace.Events.UISourceCodeAdded,(e=>{this.onUiSourceCodeAdded(e)}),this)]}onUiSourceCodeAdded(e){const t=e.data;if(t.contentType().isDocument())for(const e of this.#n.scriptsForSourceURL(t.url()))this.#o.updateLocations(e)}addStubUISourceCode(t){const r=this.#g.addContentProvider(e.ParsedURL.ParsedURL.concatenate(t.sourceURL,":sourcemap"),n.StaticContentProvider.StaticContentProvider.fromString(t.sourceURL,e.ResourceType.resourceTypes.Script,"\n\n\n\n\n// Please wait a bit.\n// Compiled script is not shown while source map is being loaded!"),"text/javascript");this.#p.set(t,r)}async removeStubUISourceCode(e){const t=this.#p.get(e);this.#p.delete(e),t&&this.#g.removeFile(t.url()),await this.#o.updateLocations(e)}static uiSourceCodeOrigin(e){const t=y.get(e);return t?t.getReferringSourceMaps().map((e=>e.compiledURL())):[]}getLocationRangesForSameSourceLocation(e){const t=e.debuggerModel,r=e.script();if(!r)return[];const o=this.#a.sourceMapForClient(r);if(!o)return[];const s=o.findEntry(e.lineNumber,e.columnNumber);if(!s||!s.sourceURL)return[];return o.findReverseRanges(s.sourceURL,s.sourceLineNumber,s.sourceColumnNumber).map((function(e){return{start:t.createRawLocation(r,e.startLine,e.startColumn),end:t.createRawLocation(r,e.endLine,e.endColumn)}}))}uiSourceCodeForURL(e,t){return t?this.#l.uiSourceCodeForURL(e):this.#u.uiSourceCodeForURL(e)}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=e.lineNumber-t.lineOffset;let s=e.columnNumber;r||(s-=t.columnOffset);const i=this.#p.get(t);if(i)return new o.UISourceCode.UILocation(i,r,s);const n=this.#a.sourceMapForClient(t);if(!n)return null;const a=n.findEntry(r,s);if(!a||!a.sourceURL)return null;const c=t.isContentScript()?this.#l.uiSourceCodeForURL(a.sourceURL):this.#u.uiSourceCodeForURL(a.sourceURL);return c?c.uiLocation(a.sourceLineNumber,a.sourceColumnNumber):null}uiLocationToRawLocations(e,t,r){const o=y.get(e);if(!o)return[];const s=[];for(const i of o.getReferringSourceMaps()){const o=i.sourceLineMapping(e.url(),t,r);if(o)for(const e of this.#a.clientsForSourceMap(i))s.push(this.#n.createRawLocation(e,o.lineNumber+e.lineOffset,o.lineNumber?o.columnNumber:o.columnNumber+e.columnOffset))}return s}async sourceMapWillAttach(e){const t=e.data.client;this.addStubUISourceCode(t),await this.#o.updateLocations(t)}async sourceMapFailedToAttach(e){const t=e.data.client;await this.removeStubUISourceCode(t)}async sourceMapAttached(e){const t=e.data.client,r=e.data.sourceMap;await this.removeStubUISourceCode(t),g.instance().isUserIgnoreListedURL(t.sourceURL,t.isContentScript())||await this.populateSourceMapSources(t,r),this.sourceMapAttachedForTest(r)}async sourceMapDetached(e){const t=e.data.client,r=e.data.sourceMap,o=t.isContentScript()?this.#h:this.#d;for(const e of r.sourceURLs()){const s=o.get(e);s&&(s.removeSourceMap(r,t.frameId),s.getUiSourceCode()||o.delete(e))}await this.#o.updateLocations(t)}sourceMapForScript(e){return this.#a.sourceMapForClient(e)}scriptsForUISourceCode(e){const t=y.get(e);if(!t)return[];const r=[];for(const e of t.getReferringSourceMaps())this.#a.clientsForSourceMap(e).forEach((e=>r.push(e)));return r}sourceMapAttachedForTest(e){}async populateSourceMapSources(e,t){const r=e.isContentScript()?this.#l:this.#u,o=e.isContentScript()?this.#h:this.#d;for(const s of t.sourceURLs()){let i=o.get(s);i||(i=new R(r,s),o.set(s,i)),i.addSourceMap(t,e.frameId)}await this.#o.updateLocations(e)}static uiLineHasMapping(e,t){const r=y.get(e);if(!r)return!0;for(const o of r.getReferringSourceMaps())if(o.sourceLineMapping(e.url(),t,0))return!0;return!1}dispose(){e.EventTarget.removeEventListeners(this.#m),this.#u.dispose(),this.#l.dispose(),this.#g.dispose()}}const y=new WeakMap;class R{#b;#f;referringSourceMaps;uiSourceCode;constructor(e,t){this.#b=e,this.#f=t,this.referringSourceMaps=[],this.uiSourceCode=null}recreateUISourceCodeIfNeeded(t,r){const s=this.referringSourceMaps[this.referringSourceMaps.length-1],i=this.#b.createUISourceCode(this.#f,e.ResourceType.resourceTypes.SourceMapScript);r&&i.markKnownThirdParty(),y.set(i,this);const n=s.sourceContentProvider(this.#f,e.ResourceType.resourceTypes.SourceMapScript),a=e.ResourceType.ResourceType.mimeFromURL(this.#f)||"text/javascript",c=s.embeddedContentByURL(this.#f),u="string"==typeof c?new o.UISourceCode.UISourceCodeMetadata(null,c.length):null;this.uiSourceCode?(v.cloneInitialFrameAttribution(this.uiSourceCode,i),this.#b.removeFile(this.uiSourceCode.url())):v.setInitialFrameAttribution(i,t),this.uiSourceCode=i,this.#b.addUISourceCodeWithProvider(this.uiSourceCode,n,u,a)}addSourceMap(e,t){this.uiSourceCode&&v.addFrameAttribution(this.uiSourceCode,t),this.referringSourceMaps.push(e),this.recreateUISourceCodeIfNeeded(t,e.hasIgnoreListHint(this.#f))}removeSourceMap(e,t){const r=this.uiSourceCode;v.removeFrameAttribution(r,t);const o=this.referringSourceMaps.lastIndexOf(e);-1!==o&&this.referringSourceMaps.splice(o,1),this.referringSourceMaps.length?this.recreateUISourceCodeIfNeeded(t,e.hasIgnoreListHint(this.#f)):(this.#b.removeFile(r.url()),this.uiSourceCode=null)}getReferringSourceMaps(){return this.referringSourceMaps}getUiSourceCode(){return this.uiSourceCode}}var k=Object.freeze({__proto__:null,CompilerScriptMapping:w});const T={errorInDebuggerLanguagePlugin:"Error in debugger language plugin: {PH1}",loadingDebugSymbolsForVia:"[{PH1}] Loading debug symbols for {PH2} (via {PH3})...",loadingDebugSymbolsFor:"[{PH1}] Loading debug symbols for {PH2}...",loadedDebugSymbolsForButDidnt:"[{PH1}] Loaded debug symbols for {PH2}, but didn't find any source files",loadedDebugSymbolsForFound:"[{PH1}] Loaded debug symbols for {PH2}, found {PH3} source file(s)",failedToLoadDebugSymbolsFor:"[{PH1}] Failed to load debug symbols for {PH2} ({PH3})",failedToLoadDebugSymbolsForFunction:'No debug information for function "{PH1}"',debugSymbolsIncomplete:"The debug information for function {PH1} is incomplete"},F=a.i18n.registerUIStrings("models/bindings/DebuggerLanguagePlugins.ts",T),U=a.i18n.getLocalizedString.bind(void 0,F);class P{typeInfo;members;typeMap;constructor(e,t,r){this.typeInfo=e,this.members=t,this.typeMap=r}static create(e){if(0===e.length)return null;const t=new Map;for(const r of e)t.set(r.typeId,new P(r,[],t));for(const r of t.values())r.members=r.typeInfo.members.map((({typeId:r})=>{const o=t.get(r);if(!o)throw new Error(`Incomplete type information for type ${e[0].typeNames[0]||"<anonymous>"}`);return o}));return t.get(e[0].typeId)||null}}function j(e){return`${e.sourceURL}@${e.hash}`}function E(e){const{script:t}=e;return{rawModuleId:j(t),codeOffset:e.location().columnNumber-(t.codeOffset()||0),inlineFrameIndex:e.inlineFrameIndex}}class D extends r.RemoteObject.RemoteObjectImpl{inspectableAddress;callFrame;constructor(e,t,r,o,s,i,n,a,c,u,l){super(e.debuggerModel.runtimeModel(),t,r,o,s,n,a,c,u,l),this.inspectableAddress=i,this.callFrame=e}get sourceType(){throw new Error("Not Implemented")}}async function N(e,t,o,s){const i=E(e);let n;try{n=await t.getTypeInfo(o,i)}catch(t){throw A.makeLocal(e,t.message)}if(!n)return new r.RemoteObject.LocalJSONObject(void 0);const{base:a,typeInfos:c}=n,u=P.create(c);if(!u)return new r.RemoteObject.LocalJSONObject(void 0);if(u.typeInfo.hasValue&&!u.typeInfo.canExpand&&a)return B(e,t,u,a,[],s);const l=await x.getInspectableAddress(e,t,a,[],s);return new x(e,t,u,a,[],s,l)}async function B(e,t,r,o,s,i){const n=E(e);let a=await t.getFormatter({base:o,field:s},n);a||(a={js:""});const c=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:a.js,objectGroup:i.objectGroup,includeCommandLineAPI:i.includeCommandLineAPI,silent:i.silent,returnByValue:i.returnByValue,generatePreview:i.generatePreview,throwOnSideEffect:i.throwOnSideEffect,timeout:i.timeout}),u=c.getError();if(u)throw new Error(u);const{result:l,exceptionDetails:d}=c;if(d)throw new A(e.debuggerModel.runtimeModel().createRemoteObject(l),d);const h=new O(e,r,t,l,null,i,void 0),p=await async function(e){const{tag:t,value:r,inspectableAddress:o,description:s}=await e.findProperties("tag","value","inspectableAddress","description");if(!t||!r)return null;const{className:i,symbol:n}=await t.findProperties("className","symbol");if(!i||!n)return null;const a=i.value;if("string"!=typeof a||void 0===n.objectId)return null;const c=s?.value;"string"==typeof c&&(r.description=c);return r.formatterTag={symbol:n.objectId,className:a},r.inspectableAddress=o?o.value:void 0,r}(h),g=p||h;return void 0===g.value&&"undefined"!==g.type&&(g.description=r.typeInfo.typeNames[0]),g}class O extends D{#S;#M;formatterTag;#L;constructor(e,t,r,o,s,i,n){super(e,o.objectId,o.type,o.subtype,o.value,n,o.unserializableValue,o.description,o.preview,o.customPreview,o.className),this.#S=r,this.#M=t,this.formatterTag=s,this.#L=i}get sourceType(){return this.#M}async findProperties(...e){const t={};for(const r of(await this.getOwnProperties(!1)).properties||[])e.indexOf(r.name)>=0&&r.value&&(t[r.name]=r.value);return t}async createRemoteObject(e){const t=await this.getEvalBaseFromObject(e);if(!t)return new O(this.callFrame,this.#M,this.#S,e,this.formatterTag,this.#L,void 0);const r=this.#M.typeMap.get(t.rootType.typeId);if(!r)throw new Error("Unknown typeId in eval base");if(t.rootType.hasValue&&!t.rootType.canExpand&&t)return B(this.callFrame,this.#S,r,t,[],this.#L);const o=await x.getInspectableAddress(this.callFrame,this.#S,t,[],this.#L);return new x(this.callFrame,this.#S,r,t,[],this.#L,o)}async getEvalBaseFromObject(e){const{objectId:t}=e;if(!e||!this.formatterTag)return null;const{className:r,symbol:o}=this.formatterTag;if(r!==e.className)return null;const s=await this.debuggerModel().target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function(sym) { return this[sym]; }",objectId:t,arguments:[{objectId:o}]}),{result:i}=s;if(!i||"undefined"===i.type)return null;const n=new O(this.callFrame,this.#M,this.#S,i,null,this.#L,void 0),{payload:a,rootType:c}=await n.findProperties("payload","rootType");if(void 0===a||void 0===c)return null;const u=await async function(e,t){if(void 0!==t.value)return t.value;const r=await e.debuggerModel.target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function() { return this; }",objectId:t.objectId,returnByValue:!0}),{result:o}=r;return o?o.value:void 0}(this.callFrame,a),{typeId:l}=await c.findProperties("typeId");if(void 0===u||void 0===l)return null;const d=this.#M.typeMap.get(l.value);return d?{payload:u,rootType:d.typeInfo}:null}}class A extends Error{exception;exceptionDetails;constructor(e,t){const{description:r}=t.exception||{};super(r||t.text),this.exception=e,this.exceptionDetails=t}static makeLocal(e,t){const r={type:"object",subtype:"error",description:t},o={text:"Uncaught",exceptionId:-1,columnNumber:0,lineNumber:0,exception:r},s=e.debuggerModel.runtimeModel().createRemoteObject(r);return new A(s,o)}}class x extends D{#C;#S;#M;#v;#I;#L;constructor(e,t,r,o,s,i,n){const a=r.typeInfo.typeNames[0]||"<anonymous>",c="object";super(e,void 0,c,void 0,null,n,void 0,a,void 0,void 0,a),this.#C=c,this.#S=t,this.#M=r,this.#v=o,this.#I=s,this.hasChildrenInternal=!0,this.#L=i}get type(){return this.#C}get sourceType(){return this.#M}async expandMember(e,t){const r=this.#I.concat(t);if(e.typeInfo.hasValue&&!e.typeInfo.canExpand&&this.#v)return B(this.callFrame,this.#S,e,this.#v,r,this.#L);const o=void 0!==this.inspectableAddress?this.inspectableAddress+t.offset:void 0;return new x(this.callFrame,this.#S,e,this.#v,r,this.#L,o)}static async getInspectableAddress(e,t,r,o,s){if(!r)return;const i=await t.getInspectableAddress({base:r,field:o});if(!i.js)return;const n=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:i.js,objectGroup:s.objectGroup,includeCommandLineAPI:s.includeCommandLineAPI,silent:s.silent,returnByValue:!0,generatePreview:s.generatePreview,throwOnSideEffect:s.throwOnSideEffect,timeout:s.timeout}),a=n.getError();if(a)throw new Error(a);const{result:c,exceptionDetails:u}=n;if(u)throw new A(e.debuggerModel.runtimeModel().createRemoteObject(c),u);const l=c.value;if(Number.isSafeInteger(l)&&!(l<0))return l;console.error(`Inspectable address is not a positive, safe integer: ${l}`)}async doGetProperties(e,t,o){const{typeInfo:s}=this.#M;if(t||!s.canExpand)return{properties:[],internalProperties:[]};if(s.members.length>0){if(s.arraySize>0){const{typeId:e}=this.#M.typeInfo.members[0],t=[],o=this.#M.members[0];for(let i=0;i<s.arraySize;++i){const s=`${i}`,n={name:s,typeId:e,offset:o.typeInfo.size*i};t.push(new r.RemoteObject.RemoteObjectProperty(s,await this.expandMember(o,n),!1,!1,!0,!1))}return{properties:t,internalProperties:[]}}const e=Promise.all(this.#M.members.map((async(e,t)=>{const o=this.#M.typeInfo.members[t],s=await this.expandMember(e,o),i=o.name||"";return new r.RemoteObject.RemoteObjectProperty(i,s,!1,!1,!0,!1)})));return{properties:await e,internalProperties:[]}}return{properties:[],internalProperties:[]}}}class W extends r.RemoteObject.LocalJSONObject{constructor(e){super(e)}get description(){return this.type}get type(){return"namespace"}}class H extends r.RemoteObject.RemoteObjectImpl{variables;#w;#S;stopId;constructor(e,t,r){super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null),this.variables=[],this.#w=e,this.#S=r,this.stopId=t}async doGetProperties(e,t,o){if(t)return{properties:[],internalProperties:[]};const s=[],i={};function n(e,t){return new r.RemoteObject.RemoteObjectProperty(e,t,!1,!1,!0,!1)}for(const e of this.variables){let t;try{const r=await this.#S.evaluate(e.name,E(this.#w),this.stopId);r&&(t=new z(this.#w,r,this.#S)),t||(t=await N(this.#w,this.#S,e.name,{generatePreview:!1,includeCommandLineAPI:!0,objectGroup:"backtrace",returnByValue:!1,silent:!1}))}catch(e){console.warn(e),t=new r.RemoteObject.LocalJSONObject(void 0)}if(e.nestedName&&e.nestedName.length>1){let r=i;for(let t=0;t<e.nestedName.length-1;t++){const o=e.nestedName[t];let s=r[o];s||(s=new W({}),r[o]=s),r=s.value}r[e.nestedName[e.nestedName.length-1]]=t}else s.push(n(e.name,t))}for(const e in i)s.push(n(e,i[e]));return{properties:s,internalProperties:[]}}}class _{#y;#R;#k;#T;#F;#U;#P;constructor(e,t,r,o,s,i){this.#y=e,this.#R=r,this.#k=o,this.#T=s,this.#F=new H(e,t,i),this.#U=null,this.#P=null}async getVariableValue(e){for(let t=0;t<this.#F.variables.length;++t){if(this.#F.variables[t].name!==e)continue;const r=await this.#F.getAllProperties(!1,!1);if(!r.properties)continue;const{value:o}=r.properties[t];if(o)return o}return null}callFrame(){return this.#y}type(){return this.#R}typeName(){return this.#k}name(){}startLocation(){return this.#U}endLocation(){return this.#P}object(){return this.#F}description(){return""}icon(){return this.#T}}class z extends r.RemoteObject.RemoteObject{extensionObject;plugin;callFrame;constructor(e,t,r){super(),this.extensionObject=t,this.plugin=r,this.callFrame=e}get linearMemoryAddress(){return this.extensionObject.linearMemoryAddress}get objectId(){return this.extensionObject.objectId}get type(){return"array"===this.extensionObject.type||"null"===this.extensionObject.type?"object":this.extensionObject.type}get subtype(){if("array"===this.extensionObject.type||"null"===this.extensionObject.type)return this.extensionObject.type}get value(){return this.extensionObject.value}unserializableValue(){}get description(){return this.extensionObject.description}set description(e){}get hasChildren(){return this.extensionObject.hasChildren}get preview(){}get className(){return this.extensionObject.className??null}arrayLength(){return 0}arrayBufferByteLength(){return 0}getOwnProperties(e,t){return this.getAllProperties(!1,e,t)}async getAllProperties(e,t,o){const{objectId:s}=this.extensionObject;if(s){i(this.plugin.getProperties);return{properties:(await this.plugin.getProperties(s)).map((e=>new r.RemoteObject.RemoteObjectProperty(e.name,new z(this.callFrame,e.value,this.plugin)))),internalProperties:null}}return{properties:null,internalProperties:null}}release(){const{objectId:e}=this.extensionObject;e&&(i(this.plugin.releaseObject),this.plugin.releaseObject(e))}debuggerModel(){return this.callFrame.debuggerModel}runtimeModel(){return this.callFrame.debuggerModel.runtimeModel()}}class V{#c;#o;#j;#E;#D;callFrameByStopId=new Map;stopIdByCallFrame=new Map;nextStopId=0n;constructor(e,t,o){this.#c=t,this.#o=o,this.#j=[],this.#E=new Map,e.observeModels(r.DebuggerModel.DebuggerModel,this),this.#D=new Map}async evaluateOnCallFrame(e,t){const{script:r}=e,{expression:o,returnByValue:s,throwOnSideEffect:i}=t,{plugin:n}=await this.rawModuleIdAndPluginForScript(r);if(!n)return null;const a=E(e);if(0===(await n.rawLocationToSourceLocation(a)).length)return null;if(s)return{error:"Cannot return by value"};if(i)return{error:"Cannot guarantee side-effect freedom"};try{const r=await n.evaluate(o,a,this.stopIdForCallFrame(e));if(!r){return{object:await N(e,n,o,t),exceptionDetails:void 0}}return{object:new z(e,r,n),exceptionDetails:void 0}}catch(t){if(t instanceof A){const{exception:e,exceptionDetails:r}=t;return{object:e,exceptionDetails:r}}const{exception:r,exceptionDetails:o}=A.makeLocal(e,t.message);return{object:r,exceptionDetails:o}}}stopIdForCallFrame(e){let t=this.stopIdByCallFrame.get(e);return void 0!==t||(t=this.nextStopId++,this.stopIdByCallFrame.set(e,t),this.callFrameByStopId.set(t,e)),t}callFrameForStopId(e){return this.callFrameByStopId.get(e)}expandCallFrames(e){return Promise.all(e.map((async e=>{const t=await this.getFunctionInfo(e.script,e.location());if(t){if("frames"in t&&t.frames.length)return t.frames.map((({name:t},r)=>e.createVirtualCallFrame(r,t)));if("missingSymbolFiles"in t&&t.missingSymbolFiles.length){const r=t.missingSymbolFiles,o=U(T.debugSymbolsIncomplete,{PH1:e.functionName});e.setMissingDebugInfoDetails({details:o,resources:r})}else e.setMissingDebugInfoDetails({resources:[],details:U(T.failedToLoadDebugSymbolsForFunction,{PH1:e.functionName})})}return e}))).then((e=>e.flat()))}modelAdded(e){this.#E.set(e,new G(e,this.#c)),e.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(r.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),e.setEvaluateOnCallFrameCallback(this.evaluateOnCallFrame.bind(this)),e.setExpandCallFramesCallback(this.expandCallFrames.bind(this))}modelRemoved(t){t.removeEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),t.removeEventListener(r.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),t.removeEventListener(r.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),t.setEvaluateOnCallFrameCallback(null),t.setExpandCallFramesCallback(null);const o=this.#E.get(t);o&&(o.dispose(),this.#E.delete(t)),this.#D.forEach(((r,o)=>{const s=r.scripts.filter((e=>e.debuggerModel!==t));0===s.length?(r.plugin.removeRawModule(o).catch((t=>{e.Console.Console.instance().error(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message}))})),this.#D.delete(o)):r.scripts=s}))}globalObjectCleared(e){const t=e.data;this.modelRemoved(t),this.modelAdded(t)}addPlugin(e){this.#j.push(e);for(const e of this.#E.keys())for(const t of e.scripts())this.hasPluginForScript(t)||this.parsedScriptSource({data:t})}removePlugin(e){this.#j=this.#j.filter((t=>t!==e));const t=new Set;this.#D.forEach(((r,o)=>{r.plugin===e&&(r.scripts.forEach((e=>t.add(e))),this.#D.delete(o))}));for(const e of t){this.#E.get(e.debuggerModel).removeScript(e),this.parsedScriptSource({data:e})}}hasPluginForScript(e){const t=j(e),r=this.#D.get(t);return void 0!==r&&r.scripts.includes(e)}async rawModuleIdAndPluginForScript(e){const t=j(e),r=this.#D.get(t);return r&&(await r.addRawModulePromise,r===this.#D.get(t))?{rawModuleId:t,plugin:r.plugin}:{rawModuleId:t,plugin:null}}uiSourceCodeForURL(e,t){const r=this.#E.get(e);return r?r.getProject().uiSourceCodeForURL(t):null}async rawLocationToUILocation(t){const r=t.script();if(!r)return null;const{rawModuleId:o,plugin:s}=await this.rawModuleIdAndPluginForScript(r);if(!s)return null;const i={rawModuleId:o,codeOffset:t.columnNumber-(r.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex};try{const e=await s.rawLocationToSourceLocation(i);for(const t of e){const e=this.uiSourceCodeForURL(r.debuggerModel,t.sourceFileURL);if(e)return e.uiLocation(t.lineNumber,t.columnNumber>=0?t.columnNumber:void 0)}}catch(t){e.Console.Console.instance().error(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message}))}return null}uiLocationToRawLocationRanges(t,o,s=-1){const i=[];return this.scriptsForUISourceCode(t).forEach((e=>{const n=j(e),a=this.#D.get(n);if(!a)return;const{plugin:c}=a;i.push(async function(e,i,n){const a={rawModuleId:e,sourceFileURL:t.url(),lineNumber:o,columnNumber:s},c=await i.sourceLocationToRawLocation(a);if(!c)return[];return c.map((e=>({start:new r.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.startOffset)+(n.codeOffset()||0)),end:new r.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.endOffset)+(n.codeOffset()||0))})))}(n,c,e))})),0===i.length?Promise.resolve(null):Promise.all(i).then((e=>e.flat())).catch((t=>(e.Console.Console.instance().error(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message})),null)))}async uiLocationToRawLocations(e,t,r){const o=await this.uiLocationToRawLocationRanges(e,t,r);return o?o.map((({start:e})=>e)):null}scriptsForUISourceCode(e){for(const t of this.#E.values()){const r=t.uiSourceCodeToScripts.get(e);if(r)return r}return[]}setDebugInfoURL(e,t){this.hasPluginForScript(e)||(e.debugSymbols={type:"ExternalDWARF",externalURL:t},this.parsedScriptSource({data:e}),e.debuggerModel.setDebugInfoURL(e,t))}parsedScriptSource(t){const r=t.data;if(r.sourceURL)for(const t of this.#j){if(!t.handleScript(r))return;const o=j(r);let s=this.#D.get(o);if(s)s.scripts.push(r);else{const i=(async()=>{const i=e.Console.Console.instance(),n=r.sourceURL,a=r.debugSymbols&&r.debugSymbols.externalURL||"";a?i.log(U(T.loadingDebugSymbolsForVia,{PH1:t.name,PH2:n,PH3:a})):i.log(U(T.loadingDebugSymbolsFor,{PH1:t.name,PH2:n}));try{const e=!a&&n.startsWith("wasm://")?await r.getWasmBytecode():void 0,c=await t.addRawModule(o,a,{url:n,code:e});if(s!==this.#D.get(o))return[];if("missingSymbolFiles"in c)return{missingSymbolFiles:c.missingSymbolFiles};const u=c;return 0===u.length?i.warn(U(T.loadedDebugSymbolsForButDidnt,{PH1:t.name,PH2:n})):i.log(U(T.loadedDebugSymbolsForFound,{PH1:t.name,PH2:n,PH3:u.length})),u}catch(e){return i.error(U(T.failedToLoadDebugSymbolsFor,{PH1:t.name,PH2:n,PH3:e.message})),this.#D.delete(o),[]}})();s={rawModuleId:o,plugin:t,scripts:[r],addRawModulePromise:i},this.#D.set(o,s)}return void s.addRawModulePromise.then((e=>{if(!("missingSymbolFiles"in e)&&r.debuggerModel.scriptForId(r.scriptId)===r){const t=this.#E.get(r.debuggerModel);t&&(t.addSourceFiles(r,e),this.#o.updateLocations(r))}}))}}debuggerResumed(e){const t=Array.from(this.callFrameByStopId.values()).filter((t=>t.debuggerModel===e.data));for(const e of t){const t=this.stopIdByCallFrame.get(e);i(t),this.stopIdByCallFrame.delete(e),this.callFrameByStopId.delete(t)}}getSourcesForScript(e){const t=j(e),r=this.#D.get(t);return r?r.addRawModulePromise:Promise.resolve(void 0)}async resolveScopeChain(t){const r=t.script,{rawModuleId:o,plugin:s}=await this.rawModuleIdAndPluginForScript(r);if(!s)return null;const i={rawModuleId:o,codeOffset:t.location().columnNumber-(r.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex},n=this.stopIdForCallFrame(t);try{if(0===(await s.rawLocationToSourceLocation(i)).length)return null;const e=new Map,r=await s.listVariablesInScope(i);for(const o of r||[]){let r=e.get(o.scope);if(!r){const{type:i,typeName:a,icon:c}=await s.getScopeInfo(o.scope);r=new _(t,n,i,a,c,s),e.set(o.scope,r)}r.object().variables.push(o)}return Array.from(e.values())}catch(t){return e.Console.Console.instance().error(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message})),null}}async getFunctionInfo(t,r){const{rawModuleId:o,plugin:s}=await this.rawModuleIdAndPluginForScript(t);if(!s)return null;const i={rawModuleId:o,codeOffset:r.columnNumber-(t.codeOffset()||0),inlineFrameIndex:0};try{return await s.getFunctionInfo(i)}catch(t){return e.Console.Console.instance().warn(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message})),{frames:[]}}}async getInlinedFunctionRanges(t){const o=t.script();if(!o)return[];const{rawModuleId:s,plugin:i}=await this.rawModuleIdAndPluginForScript(o);if(!i)return[];const n={rawModuleId:s,codeOffset:t.columnNumber-(o.codeOffset()||0)};try{return(await i.getInlinedFunctionRanges(n)).map((e=>({start:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.startOffset)+(o.codeOffset()||0)),end:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.endOffset)+(o.codeOffset()||0))})))}catch(t){return e.Console.Console.instance().warn(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getInlinedCalleesRanges(t){const o=t.script();if(!o)return[];const{rawModuleId:s,plugin:i}=await this.rawModuleIdAndPluginForScript(o);if(!i)return[];const n={rawModuleId:s,codeOffset:t.columnNumber-(o.codeOffset()||0)};try{return(await i.getInlinedCalleesRanges(n)).map((e=>({start:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.startOffset)+(o.codeOffset()||0)),end:new r.DebuggerModel.Location(o.debuggerModel,o.scriptId,0,Number(e.endOffset)+(o.codeOffset()||0))})))}catch(t){return e.Console.Console.instance().warn(U(T.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getMappedLines(e){const t=await Promise.all(this.scriptsForUISourceCode(e).map((e=>this.rawModuleIdAndPluginForScript(e))));let r;for(const{rawModuleId:o,plugin:s}of t){if(!s)continue;const t=await s.getMappedLines(o,e.url());void 0!==t&&(void 0===r?r=new Set(t):t.forEach((e=>r.add(e))))}return r}}class G{project;uiSourceCodeToScripts;constructor(e,t){this.project=new d(t,"language_plugins::"+e.target().id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.project,e.target()),this.uiSourceCodeToScripts=new Map}addSourceFiles(t,o){const s=t.createPageResourceLoadInitiator();for(const i of o){let o=this.project.uiSourceCodeForURL(i);if(o){const e=this.uiSourceCodeToScripts.get(o);e.includes(t)||e.push(t)}else{o=this.project.createUISourceCode(i,e.ResourceType.resourceTypes.SourceMapScript),v.setInitialFrameAttribution(o,t.frameId),this.uiSourceCodeToScripts.set(o,[t]);const n=new r.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(i,e.ResourceType.resourceTypes.SourceMapScript,s),a=e.ResourceType.ResourceType.mimeFromURL(i)||"text/javascript";this.project.addUISourceCodeWithProvider(o,n,null,a)}}}removeScript(e){this.uiSourceCodeToScripts.forEach(((t,r)=>{0===(t=t.filter((t=>t!==e))).length?(this.uiSourceCodeToScripts.delete(r),this.project.removeUISourceCode(r.url())):this.uiSourceCodeToScripts.set(r,t)}))}dispose(){this.project.dispose()}getProject(){return this.project}}var K=Object.freeze({__proto__:null,ValueNode:D,SourceScope:_,ExtensionRemoteObject:z,DebuggerLanguagePluginManager:V});const q=new WeakMap,$=new WeakMap;class J{#n;#o;#b;#m;#N;constructor(e,t,s){this.#n=e,this.#o=s,this.#b=new d(t,"debugger:"+e.target().id(),o.Workspace.projectTypes.Debugger,"",!0),this.#m=[e.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.debuggerReset,this),e.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(r.DebuggerModel.Events.DiscardedAnonymousScriptSource,this.discardedScriptSource,this)],this.#N=new WeakMap}static createV8ScriptURL(t){const r=e.ParsedURL.ParsedURL.extractName(t.sourceURL);return"debugger:///VM"+t.scriptId+(r?" "+r:"")}static scriptForUISourceCode(e){const t=q.get(e);return t?t.values().next().value:null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=$.get(t);if(!r)return null;const{lineNumber:o,columnNumber:s=0}=e;return r.uiLocation(o,s)}uiLocationToRawLocations(e,t,r){const o=this.#N.get(e);return o?[this.#n.createRawLocation(o,t,r)]:[]}parsedScriptSource(t){const r=t.data,o=J.createV8ScriptURL(r),s=this.#b.createUISourceCode(o,e.ResourceType.resourceTypes.Script);this.#N.set(s,r);const i=q.get(s);i?i.add(r):q.set(s,new Set([r])),$.set(r,s),this.#b.addUISourceCodeWithProvider(s,r,null,"text/javascript"),this.#o.updateLocations(r)}discardedScriptSource(e){const t=e.data,r=$.get(t);if(!r)return;$.delete(t),this.#N.delete(r);const o=q.get(r);o&&(o.delete(t),o.size||q.delete(r)),this.#b.removeUISourceCode(r.url())}debuggerReset(){this.#b.reset()}dispose(){e.EventTarget.removeEventListeners(this.#m),this.debuggerReset(),this.#b.dispose()}}var Q=Object.freeze({__proto__:null,DefaultScriptMapping:J});class X{#B;#O;#A;constructor(e,t){this.#B=e,this.#O=t,this.#O.add(this),this.#A=null}async update(){this.#B&&(this.#A?await this.#A.then((()=>this.update())):(this.#A=this.#B(this),await this.#A,this.#A=null))}async uiLocation(){throw"Not implemented"}dispose(){this.#O.delete(this),this.#B=null}isDisposed(){return!this.#O.has(this)}async isIgnoreListed(){throw"Not implemented"}}class Y{#x;constructor(){this.#x=new Set}add(e){this.#x.add(e)}delete(e){this.#x.delete(e)}has(e){return this.#x.has(e)}disposeAll(){for(const e of this.#x)e.dispose()}}var Z=Object.freeze({__proto__:null,LiveLocationWithPool:X,LiveLocationPool:Y});class ee{#a;#b;#m;#W;constructor(e,t,s){this.#a=t,this.#b=new d(s,"cssSourceMaps:"+e.id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.#b,e),this.#W=new Map,this.#m=[this.#a.addEventListener(r.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#a.addEventListener(r.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)]}sourceMapAttachedForTest(e){}async sourceMapAttached(e){const t=e.data.client,r=e.data.sourceMap,o=this.#b,s=this.#W;for(const e of r.sourceURLs()){let i=s.get(e);i||(i=new re(o,e),s.set(e,i)),i.addSourceMap(r,t.frameId)}await pe.instance().updateLocations(t),this.sourceMapAttachedForTest(r)}async sourceMapDetached(e){const t=e.data.client,r=e.data.sourceMap,o=this.#W;for(const e of r.sourceURLs()){const s=o.get(e);s&&(s.removeSourceMap(r,t.frameId),s.getUiSourceCode()||o.delete(e))}await pe.instance().updateLocations(t)}rawLocationToUILocation(e){const t=e.header();if(!t)return null;const r=this.#a.sourceMapForClient(t);if(!r)return null;let{lineNumber:o,columnNumber:s}=e;r.mapsOrigin()&&t.isInline&&(o-=t.startLine,0===o&&(s-=t.startColumn));const i=r.findEntry(o,s);if(!i||!i.sourceURL)return null;const n=this.#b.uiSourceCodeForURL(i.sourceURL);return n?n.uiLocation(i.sourceLineNumber,i.sourceColumnNumber):null}uiLocationToRawLocations(e){const{uiSourceCode:t,lineNumber:o,columnNumber:s=0}=e,i=te.get(t);if(!i)return[];const n=[];for(const e of i.getReferringSourceMaps()){const i=e.findReverseEntries(t.url(),o,s);for(const t of this.#a.clientsForSourceMap(e))n.push(...i.map((e=>new r.CSSModel.CSSLocation(t,e.lineNumber,e.columnNumber))))}return n}dispose(){e.EventTarget.removeEventListeners(this.#m),this.#b.dispose()}}const te=new WeakMap;class re{#b;#f;referringSourceMaps;uiSourceCode;constructor(e,t){this.#b=e,this.#f=t,this.referringSourceMaps=[],this.uiSourceCode=null}recreateUISourceCodeIfNeeded(t){const r=this.referringSourceMaps[this.referringSourceMaps.length-1],s=r.sourceContentProvider(this.#f,e.ResourceType.resourceTypes.SourceMapStyleSheet),i=this.#b.createUISourceCode(this.#f,s.contentType());te.set(i,this);const n=e.ResourceType.ResourceType.mimeFromURL(this.#f)||s.contentType().canonicalMimeType(),a=r.embeddedContentByURL(this.#f),c="string"==typeof a?new o.UISourceCode.UISourceCodeMetadata(null,a.length):null;this.uiSourceCode?(v.cloneInitialFrameAttribution(this.uiSourceCode,i),this.#b.removeFile(this.uiSourceCode.url())):v.setInitialFrameAttribution(i,t),this.uiSourceCode=i,this.#b.addUISourceCodeWithProvider(this.uiSourceCode,s,c,n)}addSourceMap(e,t){this.uiSourceCode&&v.addFrameAttribution(this.uiSourceCode,t),this.referringSourceMaps.push(e),this.recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){const r=this.uiSourceCode;v.removeFrameAttribution(r,t);const o=this.referringSourceMaps.lastIndexOf(e);-1!==o&&this.referringSourceMaps.splice(o,1),this.referringSourceMaps.length?this.recreateUISourceCodeIfNeeded(t):(this.#b.removeFile(r.url()),this.uiSourceCode=null)}getReferringSourceMaps(){return this.referringSourceMaps}getUiSourceCode(){return this.uiSourceCode}}var oe=Object.freeze({__proto__:null,SASSSourceMapping:ee});function se(e){for(const t of r.TargetManager.TargetManager.instance().models(r.ResourceTreeModel.ResourceTreeModel)){const r=t.resourceForURL(e);if(r)return r}return null}function ie(e,t,o){const s=e.model(r.ResourceTreeModel.ResourceTreeModel);if(!s)return null;const i=s.frameForId(t);return i?ne(i.resourceForURL(o)):null}function ne(e){return!e||"number"!=typeof e.contentSize()&&!e.lastModified()?null:new o.UISourceCode.UISourceCodeMetadata(e.lastModified(),e.contentSize())}var ae=Object.freeze({__proto__:null,resourceForURL:se,displayNameForURL:function(t){if(!t)return"";const i=se(t);if(i)return i.displayName;const n=o.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(t);if(n)return n.displayName();const a=r.TargetManager.TargetManager.instance().mainTarget(),c=a&&a.inspectedURL();if(!c)return s.StringUtilities.trimURL(t,"");const u=e.ParsedURL.ParsedURL.fromString(c);if(!u)return t;const l=u.lastPathComponent,d=c.indexOf(l);if(-1!==d&&d+l.length===c.length){const e=c.substring(0,d);if(t.startsWith(e))return t.substring(d)}const h=s.StringUtilities.trimURL(t,u.host);return"/"===h?u.host+"/":h},metadataForURL:ie,resourceMetadata:ne});const ce=new WeakMap;class ue{#H;#b;#_;#m;constructor(e,t){this.#H=e;const s=this.#H.target();this.#b=new d(t,"css:"+s.id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.#b,s),this.#_=new Map,this.#m=[this.#H.addEventListener(r.CSSModel.Events.StyleSheetAdded,this.styleSheetAdded,this),this.#H.addEventListener(r.CSSModel.Events.StyleSheetRemoved,this.styleSheetRemoved,this),this.#H.addEventListener(r.CSSModel.Events.StyleSheetChanged,this.styleSheetChanged,this)]}rawLocationToUILocation(e){const t=e.header();if(!t||!this.acceptsHeader(t))return null;const r=this.#_.get(t.resourceURL());if(!r)return null;let o=e.lineNumber,s=e.columnNumber;if(t.isInline&&t.hasSourceURL){o-=t.lineNumberInSource(0);const e=t.columnNumberInSource(o,0);void 0===e?s=e:s-=e}return r.getUiSourceCode().uiLocation(o,s)}uiLocationToRawLocations(e){const t=ce.get(e.uiSourceCode);if(!t)return[];const o=[];for(const s of t.getHeaders()){let t=e.lineNumber,i=e.columnNumber;s.isInline&&s.hasSourceURL&&(i=s.columnNumberInSource(t,e.columnNumber||0),t=s.lineNumberInSource(t)),o.push(new r.CSSModel.CSSLocation(s,t,i))}return o}acceptsHeader(e){return!e.isConstructedByNew()&&(!(e.isInline&&!e.hasSourceURL&&"inspector"!==e.origin)&&!!e.resourceURL())}styleSheetAdded(e){const t=e.data;if(!this.acceptsHeader(t))return;const r=t.resourceURL();let o=this.#_.get(r);o?o.addHeader(t):(o=new le(this.#H,this.#b,t),this.#_.set(r,o))}styleSheetRemoved(e){const t=e.data;if(!this.acceptsHeader(t))return;const r=t.resourceURL(),o=this.#_.get(r);o&&(1===o.getHeaders().size?(o.dispose(),this.#_.delete(r)):o.removeHeader(t))}styleSheetChanged(e){const t=this.#H.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!this.acceptsHeader(t))return;const r=this.#_.get(t.resourceURL());r&&r.styleSheetChanged(t)}dispose(){for(const e of this.#_.values())e.dispose();this.#_.clear(),e.EventTarget.removeEventListeners(this.#m),this.#b.removeProject()}}class le{#H;#b;headers;uiSourceCode;#m;#z;#V;#G;#K;constructor(t,r,s){this.#H=t,this.#b=r,this.headers=new Set([s]);const i=t.target(),n=s.resourceURL(),a=ie(i,s.frameId,n);this.uiSourceCode=this.#b.createUISourceCode(n,s.contentType()),ce.set(this.uiSourceCode,this),v.setInitialFrameAttribution(this.uiSourceCode,s.frameId),this.#b.addUISourceCodeWithProvider(this.uiSourceCode,this,a,"text/css"),this.#m=[this.uiSourceCode.addEventListener(o.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.uiSourceCode.addEventListener(o.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)],this.#z=new e.Throttler.Throttler(le.updateTimeout),this.#V=!1}addHeader(e){this.headers.add(e),v.addFrameAttribution(this.uiSourceCode,e.frameId)}removeHeader(e){this.headers.delete(e),v.removeFrameAttribution(this.uiSourceCode,e.frameId)}styleSheetChanged(e){if(console.assert(this.headers.has(e)),this.#K||!this.headers.has(e))return;const t=this.mirrorContent.bind(this,e,!0);this.#z.schedule(t,!1)}workingCopyCommitted(){if(this.#G)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!0);this.#z.schedule(e,!0)}workingCopyChanged(){if(this.#G)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!1);this.#z.schedule(e,!1)}async mirrorContent(e,t){if(this.#V)return void this.styleFileSyncedForTest();let r=null;if(e===this.uiSourceCode)r=this.uiSourceCode.workingCopy();else{r=(await e.requestContent()).content}if(null===r||this.#V)return void this.styleFileSyncedForTest();e!==this.uiSourceCode&&(this.#G=!0,this.uiSourceCode.addRevision(r),this.#G=!1),this.#K=!0;const o=[];for(const s of this.headers)s!==e&&o.push(this.#H.setStyleSheetText(s.id,r,t));await Promise.all(o),this.#K=!1,this.styleFileSyncedForTest()}styleFileSyncedForTest(){}dispose(){this.#V||(this.#V=!0,this.#b.removeFile(this.uiSourceCode.url()),e.EventTarget.removeEventListeners(this.#m))}contentURL(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentURL()}contentType(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentType()}requestContent(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().requestContent()}searchInContent(e,t,r){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().searchInContent(e,t,r)}static updateTimeout=200;getHeaders(){return this.headers}getUiSourceCode(){return this.uiSourceCode}}var de=Object.freeze({__proto__:null,StylesSourceMapping:ue,StyleFile:le});let he;class pe{#c;#q;#$;#J;constructor(e,t){this.#c=t,this.#q=new Map,this.#$=[],e.observeModels(r.CSSModel.CSSModel,this),this.#J=new Set}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:r,workspace:o}=e;if(!he||t){if(!r||!o)throw new Error(`Unable to create CSSWorkspaceBinding: targetManager and workspace must be provided: ${(new Error).stack}`);he=new pe(r,o)}return he}static removeInstance(){he=void 0}get modelToInfo(){return this.#q}getCSSModelInfo(e){return this.#q.get(e)}modelAdded(e){this.#q.set(e,new ge(e,this.#c))}modelRemoved(e){this.getCSSModelInfo(e).dispose(),this.#q.delete(e)}async pendingLiveLocationChangesPromise(){await Promise.all(this.#J)}recordLiveLocationChange(e){e.then((()=>{this.#J.delete(e)})),this.#J.add(e)}async updateLocations(e){const t=this.getCSSModelInfo(e.cssModel()).updateLocations(e);this.recordLiveLocationChange(t),await t}createLiveLocation(e,t,r){const o=this.getCSSModelInfo(e.cssModel()).createLiveLocation(e,t,r);return this.recordLiveLocationChange(o),o}propertyRawLocation(e,t){const o=e.ownerStyle;if(!o||o.type!==r.CSSStyleDeclaration.Type.Regular||!o.styleSheetId)return null;const s=o.cssModel().styleSheetHeaderForId(o.styleSheetId);if(!s)return null;const i=t?e.nameRange():e.valueRange();if(!i)return null;const n=i.startLine,a=i.startColumn;return new r.CSSModel.CSSLocation(s,s.lineNumberInSource(n),s.columnNumberInSource(n,a))}propertyUILocation(e,t){const r=this.propertyRawLocation(e,t);return r?this.rawLocationToUILocation(r):null}rawLocationToUILocation(e){for(let t=this.#$.length-1;t>=0;--t){const r=this.#$[t].rawLocationToUILocation(e);if(r)return r}return this.getCSSModelInfo(e.cssModel()).rawLocationToUILocation(e)}uiLocationToRawLocations(e){for(let t=this.#$.length-1;t>=0;--t){const r=this.#$[t].uiLocationToRawLocations(e);if(r.length)return r}const t=[];for(const r of this.#q.values())t.push(...r.uiLocationToRawLocations(e));return t}addSourceMapping(e){this.#$.push(e)}removeSourceMapping(e){const t=this.#$.indexOf(e);-1!==t&&this.#$.splice(t,1)}}class ge{#m;#Q;#X;#x;#Y;constructor(e,t){this.#m=[e.addEventListener(r.CSSModel.Events.StyleSheetAdded,(e=>{this.styleSheetAdded(e)}),this),e.addEventListener(r.CSSModel.Events.StyleSheetRemoved,(e=>{this.styleSheetRemoved(e)}),this)],this.#Q=new ue(e,t);const o=e.sourceMapManager();this.#X=new ee(e.target(),o,t),this.#x=new s.MapUtilities.Multimap,this.#Y=new s.MapUtilities.Multimap}get locations(){return this.#x}async createLiveLocation(e,t,r){const o=new me(e,this,t,r),s=e.header();return s?(o.setHeader(s),this.#x.set(s,o),await o.update()):this.#Y.set(e.url,o),o}disposeLocation(e){const t=e.header();t?this.#x.delete(t,e):this.#Y.delete(e.url,e)}updateLocations(e){const t=[];for(const r of this.#x.get(e))t.push(r.update());return Promise.all(t)}async styleSheetAdded(e){const t=e.data;if(!t.sourceURL)return;const r=[];for(const e of this.#Y.get(t.sourceURL))e.setHeader(t),this.#x.set(t,e),r.push(e.update());await Promise.all(r),this.#Y.deleteAll(t.sourceURL)}async styleSheetRemoved(e){const t=e.data,r=[];for(const e of this.#x.get(t))e.setHeader(t),this.#Y.set(e.url,e),r.push(e.update());await Promise.all(r),this.#x.deleteAll(t)}rawLocationToUILocation(e){let t=null;return t=t||this.#X.rawLocationToUILocation(e),t=t||this.#Q.rawLocationToUILocation(e),t=t||Ce.instance().cssLocationToUILocation(e),t}uiLocationToRawLocations(e){let t=this.#X.uiLocationToRawLocations(e);return t.length?t:(t=this.#Q.uiLocationToRawLocations(e),t.length?t:Ce.instance().uiLocationToCSSLocations(e))}dispose(){e.EventTarget.removeEventListeners(this.#m),this.#Q.dispose(),this.#X.dispose()}}class me extends X{url;#Z;#ee;#te;headerInternal;constructor(e,t,r,o){super(r,o),this.url=e.url,this.#Z=e.lineNumber,this.#ee=e.columnNumber,this.#te=t,this.headerInternal=null}header(){return this.headerInternal}setHeader(e){this.headerInternal=e}async uiLocation(){if(!this.headerInternal)return null;const e=new r.CSSModel.CSSLocation(this.headerInternal,this.#Z,this.#ee);return pe.instance().rawLocationToUILocation(e)}dispose(){super.dispose(),this.#te.disposeLocation(this)}async isIgnoreListed(){return!1}}var be=Object.freeze({__proto__:null,CSSWorkspaceBinding:pe,ModelInfo:ge,LiveLocation:me});let fe;const Se=new WeakMap,Me=new WeakMap,Le=new WeakSet;class Ce{#c;#q;constructor(e,t){this.#c=t,this.#q=new Map,e.observeModels(r.ResourceTreeModel.ResourceTreeModel,this)}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:r,workspace:o}=e;if(!fe||t){if(!r||!o)throw new Error(`Unable to create ResourceMapping: targetManager and workspace must be provided: ${(new Error).stack}`);fe=new Ce(r,o)}return fe}static removeInstance(){fe=void 0}modelAdded(e){const t=new ve(this.#c,e);this.#q.set(e,t)}modelRemoved(e){const t=this.#q.get(e);t&&(t.dispose(),this.#q.delete(e))}infoForTarget(e){const t=e.model(r.ResourceTreeModel.ResourceTreeModel);return t&&this.#q.get(t)||null}cssLocationToUILocation(e){const t=e.header();if(!t)return null;const r=this.infoForTarget(e.cssModel().target());if(!r)return null;const o=r.getProject().uiSourceCodeForURL(e.url);if(!o)return null;const s=Se.get(t)||n.TextRange.TextRange.createFromLocation(t.startLine,t.startColumn),i=e.lineNumber+s.startLine-t.startLine;let a=e.columnNumber;return e.lineNumber===t.startLine&&(a+=s.startColumn-t.startColumn),o.uiLocation(i,a)}jsLocationToUILocation(e){const t=e.script();if(!t)return null;const r=this.infoForTarget(e.debuggerModel.target());if(!r)return null;const o=t.embedderName();if(!o)return null;const s=r.getProject().uiSourceCodeForURL(o);if(!s)return null;const i=Me.get(t)||n.TextRange.TextRange.createFromLocation(t.lineOffset,t.columnOffset);let a=e.lineNumber+i.startLine-t.lineOffset,c=e.columnNumber;return e.lineNumber===t.lineOffset&&(c+=i.startColumn-t.columnOffset),t.hasSourceURL&&(0===a&&(c+=t.columnOffset),a+=t.lineOffset),s.uiLocation(a,c)}uiLocationToJSLocations(e,t,o){if(!Le.has(e))return[];const s=v.targetForUISourceCode(e);if(!s)return[];const i=s.model(r.DebuggerModel.DebuggerModel);if(!i)return[];const a=[];for(const r of i.scripts()){if(r.embedderName()!==e.url())continue;const{startLine:s,startColumn:c}=Me.get(r)||n.TextRange.TextRange.createFromLocation(r.lineOffset,r.columnOffset);if(t<s||t===s&&o<c)continue;const u=s+(r.endLine-r.lineOffset),l=s===u?c+(r.endColumn-r.columnOffset):r.endColumn;if(t>u||t===u&&o>l)continue;let d=t,h=o;r.hasSourceURL&&(d-=s,0===d&&(h-=c)),a.push(i.createRawLocation(r,d,h))}return a}uiLocationToCSSLocations(e){if(!Le.has(e.uiSourceCode))return[];const t=v.targetForUISourceCode(e.uiSourceCode);if(!t)return[];const o=t.model(r.CSSModel.CSSModel);return o?o.createRawLocationsByURL(e.uiSourceCode.url(),e.lineNumber,e.columnNumber):[]}resetForTest(e){const t=e.model(r.ResourceTreeModel.ResourceTreeModel),o=t?this.#q.get(t):null;o&&o.resetForTest()}}class ve{project;#W;#H;#m;constructor(e,t){const s=t.target();this.project=new d(e,"resources:"+s.id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.project,s),this.#W=new Map;const i=s.model(r.CSSModel.CSSModel);console.assert(Boolean(i)),this.#H=i,this.#m=[t.addEventListener(r.ResourceTreeModel.Events.ResourceAdded,this.resourceAdded,this),t.addEventListener(r.ResourceTreeModel.Events.FrameWillNavigate,this.frameWillNavigate,this),t.addEventListener(r.ResourceTreeModel.Events.FrameDetached,this.frameDetached,this),this.#H.addEventListener(r.CSSModel.Events.StyleSheetChanged,(e=>{this.styleSheetChanged(e)}),this)]}async styleSheetChanged(e){const t=this.#H.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!t.isInline||t.isInline&&t.isMutable)return;const r=this.#W.get(t.resourceURL());r&&await r.styleSheetChanged(t,e.data.edit||null)}acceptsResource(t){const r=t.resourceType();return(r===e.ResourceType.resourceTypes.Image||r===e.ResourceType.resourceTypes.Font||r===e.ResourceType.resourceTypes.Document||r===e.ResourceType.resourceTypes.Manifest)&&(!(r===e.ResourceType.resourceTypes.Image&&t.mimeType&&!t.mimeType.startsWith("image"))&&(!(r===e.ResourceType.resourceTypes.Font&&t.mimeType&&!t.mimeType.includes("font"))&&(r!==e.ResourceType.resourceTypes.Image&&r!==e.ResourceType.resourceTypes.Font||!t.contentURL().startsWith("data:"))))}resourceAdded(e){const t=e.data;if(!this.acceptsResource(t))return;let r=this.#W.get(t.url);r?r.addResource(t):(r=new Ie(this.project,t),this.#W.set(t.url,r))}removeFrameResources(e){for(const t of e.resources()){if(!this.acceptsResource(t))continue;const e=this.#W.get(t.url);e&&(1===e.resources.size?(e.dispose(),this.#W.delete(t.url)):e.removeResource(t))}}frameWillNavigate(e){this.removeFrameResources(e.data)}frameDetached(e){this.removeFrameResources(e.data.frame)}resetForTest(){for(const e of this.#W.values())e.dispose();this.#W.clear()}dispose(){e.EventTarget.removeEventListeners(this.#m);for(const e of this.#W.values())e.dispose();this.#W.clear(),this.project.removeProject()}getProject(){return this.project}}class Ie{resources;#b;#re;#oe;constructor(e,t){this.resources=new Set([t]),this.#b=e,this.#re=this.#b.createUISourceCode(t.url,t.contentType()),Le.add(this.#re),t.frameId&&v.setInitialFrameAttribution(this.#re,t.frameId),this.#b.addUISourceCodeWithProvider(this.#re,this,ne(t),t.mimeType),this.#oe=[]}inlineStyles(){const e=v.targetForUISourceCode(this.#re),t=[];if(!e)return t;const o=e.model(r.CSSModel.CSSModel);if(o)for(const e of o.getStyleSheetIdsForURL(this.#re.url())){const r=o.styleSheetHeaderForId(e);r&&t.push(r)}return t}inlineScripts(){const e=v.targetForUISourceCode(this.#re);if(!e)return[];const t=e.model(r.DebuggerModel.DebuggerModel);return t?t.scripts().filter((e=>e.embedderName()===this.#re.url())):[]}async styleSheetChanged(e,t){if(this.#oe.push({stylesheet:e,edit:t}),this.#oe.length>1)return;const{content:r}=await this.#re.requestContent();null!==r&&await this.innerStyleSheetChanged(r),this.#oe=[]}async innerStyleSheetChanged(e){const t=this.inlineScripts(),r=this.inlineStyles();let o=new n.Text.Text(e);for(const e of this.#oe){const s=e.edit;if(!s)continue;const i=e.stylesheet,a=Se.get(i)||n.TextRange.TextRange.createFromLocation(i.startLine,i.startColumn),c=s.oldRange.relativeFrom(a.startLine,a.startColumn),u=s.newRange.relativeFrom(a.startLine,a.startColumn);o=new n.Text.Text(o.replaceRange(c,s.newText));const l=[];for(const e of t){const t=Me.get(e)||n.TextRange.TextRange.createFromLocation(e.lineOffset,e.columnOffset);t.follows(c)&&(Me.set(e,t.rebaseAfterTextEdit(c,u)),l.push(je.instance().updateLocations(e)))}for(const e of r){const t=Se.get(e)||n.TextRange.TextRange.createFromLocation(e.startLine,e.startColumn);t.follows(c)&&(Se.set(e,t.rebaseAfterTextEdit(c,u)),l.push(pe.instance().updateLocations(e)))}await Promise.all(l)}this.#re.addRevision(o.value())}addResource(e){this.resources.add(e),e.frameId&&v.addFrameAttribution(this.#re,e.frameId)}removeResource(e){this.resources.delete(e),e.frameId&&v.removeFrameAttribution(this.#re,e.frameId)}dispose(){this.#b.removeFile(this.#re.url())}firstResource(){return console.assert(this.resources.size>0),this.resources.values().next().value}contentURL(){return this.firstResource().contentURL()}contentType(){return this.firstResource().contentType()}requestContent(){return this.firstResource().requestContent()}searchInContent(e,t,r){return this.firstResource().searchInContent(e,t,r)}}var we=Object.freeze({__proto__:null,ResourceMapping:Ce});const ye={liveEditFailed:"`LiveEdit` failed: {PH1}",liveEditCompileFailed:"`LiveEdit` compile failed: {PH1}"},Re=a.i18n.registerUIStrings("models/bindings/ResourceScriptMapping.ts",ye),ke=a.i18n.getLocalizedString.bind(void 0,Re);class Te{debuggerModel;#c;debuggerWorkspaceBinding;#se;#ie;#ne;#m;constructor(e,t,o){this.debuggerModel=e,this.#c=t,this.debuggerWorkspaceBinding=o,this.#se=new Map,this.#ie=new Map,this.#ne=new Map;const s=e.runtimeModel();this.#m=[this.debuggerModel.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,(e=>this.addScript(e.data)),this),this.debuggerModel.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),s.addEventListener(r.RuntimeModel.Events.ExecutionContextDestroyed,this.executionContextDestroyed,this),s.target().targetManager().addEventListener(r.TargetManager.Events.InspectedURLChanged,this.inspectedURLChanged,this)]}static resolveRelativeSourceURL(t,o){let i=t.debuggerModel.target();for(;i&&i.type()!==r.Target.Type.Frame;)i=i.parentTarget();const n=i?.inspectedURL()??s.DevToolsPath.EmptyUrlString;return o=e.ParsedURL.ParsedURL.completeURL(n,o)??o}project(e){const t=(e.isContentScript()?"js:extensions:":"js::")+this.debuggerModel.target().id()+":"+e.frameId;let r=this.#ie.get(t);if(!r){const s=e.isContentScript()?o.Workspace.projectTypes.ContentScripts:o.Workspace.projectTypes.Network;r=new d(this.#c,t,s,"",!1),v.setTargetForProject(r,this.debuggerModel.target()),this.#ie.set(t,r)}return r}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=this.#ne.get(t);if(!r)return null;const o=this.#se.get(r);if(!o)return null;if(o.hasDivergedFromVM()&&!o.isMergingToVM()||o.isDivergingFromVM())return null;if(!o.hasScripts([t]))return null;const{lineNumber:s,columnNumber:i=0}=e;return r.uiLocation(s,i)}uiLocationToRawLocations(e,t,r){const o=this.#se.get(e);if(!o)return[];const{script:s}=o;return s?[this.debuggerModel.createRawLocation(s,t,r)]:[]}inspectedURLChanged(e){for(let t=this.debuggerModel.target();t!==e.data;t=t.parentTarget())if(null===t)return;for(const e of Array.from(this.#ne.keys()))this.removeScript(e),this.addScript(e)}addScript(t){if(t.isLiveEdit())return;let r=t.sourceURL;if(!r)return;if(t.hasSourceURL)r=Te.resolveRelativeSourceURL(t,r);else{if(t.isInlineScript())return;if(t.isContentScript()){if(!new e.ParsedURL.ParsedURL(r).isValid)return}}const o=this.project(t),s=o.uiSourceCodeForURL(r);if(s){const e=this.#se.get(s);e&&e.script&&this.removeScript(e.script)}const i=t.originalContentProvider(),n=o.createUISourceCode(r,i.contentType());v.setInitialFrameAttribution(n,t.frameId);const a=ie(this.debuggerModel.target(),t.frameId,r),c=new Fe(this,n,[t]);this.#se.set(n,c),this.#ne.set(t,n);const u=t.isWasm()?"application/wasm":"text/javascript";o.addUISourceCodeWithProvider(n,i,a,u),this.debuggerWorkspaceBinding.updateLocations(t)}scriptFile(e){return this.#se.get(e)||null}removeScript(e){const t=this.#ne.get(e);if(!t)return;const r=this.#se.get(t);r&&r.dispose(),this.#se.delete(t),this.#ne.delete(e);t.project().removeFile(t.url()),this.debuggerWorkspaceBinding.updateLocations(e)}executionContextDestroyed(e){const t=e.data;for(const e of this.debuggerModel.scriptsForExecutionContext(t))this.removeScript(e)}globalObjectCleared(){for(const e of this.#ne.keys())this.removeScript(e)}resetForTest(){this.globalObjectCleared()}dispose(){e.EventTarget.removeEventListeners(this.#m),this.globalObjectCleared();for(const e of this.#ie.values())e.removeProject();this.#ie.clear()}}class Fe extends e.ObjectWrapper.ObjectWrapper{#ae;#ce;scriptInternal;#ue;#le;#de;#he;constructor(e,t,r){super(),console.assert(r.length>0),this.#ae=e,this.#ce=t,this.#ce.contentType().isScript()&&(this.scriptInternal=r[r.length-1]),this.#ce.addEventListener(o.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.#ce.addEventListener(o.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}hasScripts(e){return Boolean(this.scriptInternal)&&this.scriptInternal===e[0]}isDiverged(){if(this.#ce.isDirty())return!0;if(!this.scriptInternal)return!1;if(void 0===this.#ue||null===this.#ue)return!1;const e=this.#ce.workingCopy();if(!e)return!1;if(!e.startsWith(this.#ue.trimEnd()))return!0;const t=this.#ce.workingCopy().substr(this.#ue.length);return Boolean(t.length)&&!t.match(r.Script.sourceURLRegex)}workingCopyChanged(){this.update()}workingCopyCommitted(){if(this.#ce.project().canSetFileContent())return;if(!this.scriptInternal)return;const e=Ae.instance().breakpointLocationsForUISourceCode(this.#ce).map((e=>e.breakpoint)),t=this.#ce.workingCopy();this.scriptInternal.editSource(t).then((({status:r,exceptionDetails:o})=>{this.scriptSourceWasSet(t,e,r,o)}))}async scriptSourceWasSet(t,r,s,i){if("Ok"===s&&(this.#ue=t),await this.update(),"Ok"===s)return void await Promise.all(r.map((e=>e.refreshInDebugger())));if(!i)return void e.Console.Console.instance().addMessage(ke(ye.liveEditFailed,{PH1:function(e){switch(e){case"BlockedByActiveFunction":return"Functions that are on the stack (currently being executed) can not be edited";case"BlockedByActiveGenerator":return"Async functions/generators that are active can not be edited";case"CompileError":case"Ok":throw new Error("Compile errors and Ok status must not be reported on the console")}}(s)}),e.Console.MessageLevel.Warning);const n=ke(ye.liveEditCompileFailed,{PH1:i.text});this.#ce.addLineMessage(o.UISourceCode.Message.Level.Error,n,i.lineNumber,i.columnNumber)}async update(){this.isDiverged()&&!this.#de?await this.divergeFromVM():!this.isDiverged()&&this.#de&&await this.mergeToVM()}async divergeFromVM(){this.scriptInternal&&(this.#le=!0,await this.#ae.debuggerWorkspaceBinding.updateLocations(this.scriptInternal),this.#le=void 0,this.#de=!0,this.dispatchEventToListeners("DidDivergeFromVM"))}async mergeToVM(){this.scriptInternal&&(this.#de=void 0,this.#he=!0,await this.#ae.debuggerWorkspaceBinding.updateLocations(this.scriptInternal),this.#he=void 0,this.dispatchEventToListeners("DidMergeToVM"))}hasDivergedFromVM(){return Boolean(this.#de)}isDivergingFromVM(){return Boolean(this.#le)}isMergingToVM(){return Boolean(this.#he)}checkMapping(){this.scriptInternal&&void 0===this.#ue?this.scriptInternal.requestContent().then((e=>{this.#ue=e.content,this.update().then((()=>this.mappingCheckedForTest()))})):this.mappingCheckedForTest()}mappingCheckedForTest(){}dispose(){this.#ce.removeEventListener(o.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.#ce.removeEventListener(o.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}addSourceMapURL(e){this.scriptInternal&&this.scriptInternal.debuggerModel.setSourceMapURL(this.scriptInternal,e)}addDebugInfoURL(e){if(!this.scriptInternal)return;const{pluginManager:t}=je.instance();t&&t.setDebugInfoURL(this.scriptInternal,e)}hasSourceMapURL(){return void 0!==this.scriptInternal&&Boolean(this.scriptInternal.sourceMapURL)}async missingSymbolFiles(){if(!this.scriptInternal)return null;const{pluginManager:e}=this.#ae.debuggerWorkspaceBinding;if(!e)return null;const t=await e.getSourcesForScript(this.scriptInternal);return t&&"missingSymbolFiles"in t?t.missingSymbolFiles:null}get script(){return this.scriptInternal||null}get uiSourceCode(){return this.#ce}}var Ue=Object.freeze({__proto__:null,ResourceScriptMapping:Te,ResourceScriptFile:Fe});let Pe;class je{workspace;#$;#E;#J;pluginManager;#pe;constructor(e,o){this.workspace=o,this.#$=[],this.#E=new Map,e.addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addModelListener(r.DebuggerModel.DebuggerModel,r.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),e.observeModels(r.DebuggerModel.DebuggerModel,this),this.#pe=e,this.#J=new Set,this.pluginManager=t.Runtime.experiments.isEnabled("wasmDWARFDebugging")?new V(e,o,this):null}initPluginManagerForTest(){return t.Runtime.experiments.isEnabled("wasmDWARFDebugging")?this.pluginManager||(this.pluginManager=new V(this.#pe,this.workspace,this)):this.pluginManager=null,this.pluginManager}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:r,workspace:o}=e;if(!Pe||t){if(!r||!o)throw new Error(`Unable to create DebuggerWorkspaceBinding: targetManager and workspace must be provided: ${(new Error).stack}`);Pe=new je(r,o)}return Pe}static removeInstance(){Pe=void 0}addSourceMapping(e){this.#$.push(e)}removeSourceMapping(e){const t=this.#$.indexOf(e);-1!==t&&this.#$.splice(t,1)}async computeAutoStepRanges(e,t){function o(e,t){const{start:r,end:o}=t;return r.scriptId===e.scriptId&&(!(e.lineNumber<r.lineNumber||e.lineNumber>o.lineNumber)&&(!(e.lineNumber===r.lineNumber&&e.columnNumber<r.columnNumber)&&!(e.lineNumber===o.lineNumber&&e.columnNumber>=o.columnNumber)))}const s=t.location();if(!s)return[];const i=this.pluginManager;let n=[];if(i){if(e===r.DebuggerModel.StepMode.StepOut)return await i.getInlinedFunctionRanges(s);const t=await i.rawLocationToUILocation(s);if(t)return n=await i.uiLocationToRawLocationRanges(t.uiSourceCode,t.lineNumber,t.columnNumber)||[],n=n.filter((e=>o(s,e))),e===r.DebuggerModel.StepMode.StepOver&&(n=n.concat(await i.getInlinedCalleesRanges(s))),n}const a=this.#E.get(s.debuggerModel)?.compilerMapping;return a?e===r.DebuggerModel.StepMode.StepOut?[]:(n=a.getLocationRangesForSameSourceLocation(s),n=n.filter((e=>o(s,e))),n):[]}modelAdded(e){this.#E.set(e,new Ee(e,this)),e.setComputeAutoStepRangesCallback(this.computeAutoStepRanges.bind(this))}modelRemoved(e){e.setComputeAutoStepRangesCallback(null);const t=this.#E.get(e);t&&(t.dispose(),this.#E.delete(e))}async pendingLiveLocationChangesPromise(){await Promise.all(this.#J)}recordLiveLocationChange(e){e.then((()=>{this.#J.delete(e)})),this.#J.add(e)}async updateLocations(e){const t=this.#E.get(e.debuggerModel);if(t){const r=t.updateLocations(e);this.recordLiveLocationChange(r),await r}}async createLiveLocation(e,t,r){const o=this.#E.get(e.debuggerModel);if(!o)return null;const s=o.createLiveLocation(e,t,r);return this.recordLiveLocationChange(s),s}async createStackTraceTopFrameLiveLocation(e,t,r){console.assert(e.length>0);const o=Ne.createStackTraceTopFrameLocation(e,this,t,r);return this.recordLiveLocationChange(o),o}async createCallFrameLiveLocation(e,t,r){if(!e.script())return null;const o=e.debuggerModel,s=this.createLiveLocation(e,t,r);this.recordLiveLocationChange(s);const i=await s;return i?(this.registerCallFrameLiveLocation(o,i),i):null}async rawLocationToUILocation(e){for(const t of this.#$){const r=t.rawLocationToUILocation(e);if(r)return r}if(this.pluginManager){const t=await this.pluginManager.rawLocationToUILocation(e);if(t)return t}const t=this.#E.get(e.debuggerModel);return t?t.rawLocationToUILocation(e):null}uiSourceCodeForSourceMapSourceURL(e,t,r){const o=this.#E.get(e);return o?o.compilerMapping.uiSourceCodeForURL(t,r):null}async uiLocationToRawLocations(e,t,r){for(const o of this.#$){const s=o.uiLocationToRawLocations(e,t,r);if(s.length)return s}const o=await(this.pluginManager?.uiLocationToRawLocations(e,t,r));if(o)return o;for(const o of this.#E.values()){const s=o.uiLocationToRawLocations(e,t,r);if(s.length)return s}return[]}uiLocationToRawLocationsForUnformattedJavaScript(e,t,r){console.assert(e.contentType().isScript());const o=[];for(const s of this.#E.values())o.push(...s.uiLocationToRawLocations(e,t,r));return o}async normalizeUILocation(e){const t=await this.uiLocationToRawLocations(e.uiSourceCode,e.lineNumber,e.columnNumber);for(const e of t){const t=await this.rawLocationToUILocation(e);if(t)return t}return e}scriptFile(e,t){const r=this.#E.get(t);return r?r.getResourceMapping().scriptFile(e):null}scriptsForUISourceCode(e){const t=new Set;this.pluginManager&&this.pluginManager.scriptsForUISourceCode(e).forEach((e=>t.add(e)));for(const r of this.#E.values()){const o=r.getResourceMapping().scriptFile(e);o&&o.script&&t.add(o.script),r.compilerMapping.scriptsForUISourceCode(e).forEach((e=>t.add(e)))}return[...t]}scriptsForResource(e){const t=new Set;for(const r of this.#E.values()){const o=r.getResourceMapping().scriptFile(e);o&&o.script&&t.add(o.script)}return[...t]}supportsConditionalBreakpoints(e){if(!this.pluginManager)return!0;return this.pluginManager.scriptsForUISourceCode(e).every((e=>e.isJavaScript()))}sourceMapForScript(e){const t=this.#E.get(e.debuggerModel);return t?t.compilerMapping.sourceMapForScript(e):null}globalObjectCleared(e){this.reset(e.data)}reset(e){const t=this.#E.get(e);if(t){for(const e of t.callFrameLocations.values())this.removeLiveLocation(e);t.callFrameLocations.clear()}}resetForTest(e){const t=e.model(r.DebuggerModel.DebuggerModel),o=this.#E.get(t);o&&o.getResourceMapping().resetForTest()}registerCallFrameLiveLocation(e,t){const r=this.#E.get(e);if(r){r.callFrameLocations.add(t)}}removeLiveLocation(e){const t=this.#E.get(e.rawLocation.debuggerModel);t&&t.disposeLocation(e)}debuggerResumed(e){this.reset(e.data)}}class Ee{#n;#o;callFrameLocations;#ge;resourceMapping;compilerMapping;#x;constructor(e,t){this.#n=e,this.#o=t,this.callFrameLocations=new Set;const r=t.workspace;this.#ge=new J(e,r,t),this.resourceMapping=new Te(e,r,t),this.compilerMapping=new w(e,r,t),this.#x=new s.MapUtilities.Multimap,e.setBeforePausedCallback(this.beforePaused.bind(this))}async createLiveLocation(e,t,r){console.assert(""!==e.scriptId);const o=e.scriptId,s=new De(o,e,this.#o,t,r);return this.#x.set(o,s),await s.update(),s}disposeLocation(e){this.#x.delete(e.scriptId,e)}async updateLocations(e){const t=[];for(const r of this.#x.get(e.scriptId))t.push(r.update());await Promise.all(t)}rawLocationToUILocation(e){let t=this.compilerMapping.rawLocationToUILocation(e);return t=t||this.resourceMapping.rawLocationToUILocation(e),t=t||Ce.instance().jsLocationToUILocation(e),t=t||this.#ge.rawLocationToUILocation(e),t}uiLocationToRawLocations(e,t,r=0){let o=this.compilerMapping.uiLocationToRawLocations(e,t,r);return o=o.length?o:this.resourceMapping.uiLocationToRawLocations(e,t,r),o=o.length?o:Ce.instance().uiLocationToJSLocations(e,t,r),o=o.length?o:this.#ge.uiLocationToRawLocations(e,t,r),o}beforePaused(e){return Boolean(e.callFrames[0])}dispose(){this.#n.setBeforePausedCallback(null),this.compilerMapping.dispose(),this.resourceMapping.dispose(),this.#ge.dispose()}getResourceMapping(){return this.resourceMapping}}class De extends X{scriptId;rawLocation;#me;constructor(e,t,r,o,s){super(o,s),this.scriptId=e,this.rawLocation=t,this.#me=r}async uiLocation(){const e=this.rawLocation;return this.#me.rawLocationToUILocation(e)}dispose(){super.dispose(),this.#me.removeLiveLocation(this)}async isIgnoreListed(){const e=await this.uiLocation();return!!e&&g.instance().isUserOrSourceMapIgnoreListedUISourceCode(e.uiSourceCode)}}class Ne extends X{#be;#fe;#x;constructor(e,t){super(e,t),this.#be=!0,this.#fe=null,this.#x=null}static async createStackTraceTopFrameLocation(e,t,r,o){const s=new Ne(r,o),i=e.map((e=>t.createLiveLocation(e,s.scheduleUpdate.bind(s),o)));return s.#x=(await Promise.all(i)).filter((e=>Boolean(e))),await s.updateLocation(),s}async uiLocation(){return this.#fe?this.#fe.uiLocation():null}async isIgnoreListed(){return!!this.#fe&&this.#fe.isIgnoreListed()}dispose(){if(super.dispose(),this.#x)for(const e of this.#x)e.dispose();this.#x=null,this.#fe=null}async scheduleUpdate(){this.#be||(this.#be=!0,queueMicrotask((()=>{this.updateLocation()})))}async updateLocation(){if(this.#be=!1,this.#x&&0!==this.#x.length){this.#fe=this.#x[0];for(const e of this.#x)if(!await e.isIgnoreListed()){this.#fe=e;break}this.update()}}}var Be=Object.freeze({__proto__:null,DebuggerWorkspaceBinding:je,Location:De});let Oe;class Ae extends e.ObjectWrapper.ObjectWrapper{storage;#c;targetManager;debuggerWorkspaceBinding;#Se;#Me;#Le;constructor(e,t,s){super(),this.storage=new _e,this.#c=t,this.targetManager=e,this.debuggerWorkspaceBinding=s,this.#Se=new Map,this.#Me=new Map,this.#c.addEventListener(o.Workspace.Events.UISourceCodeAdded,this.uiSourceCodeAdded,this),this.#c.addEventListener(o.Workspace.Events.UISourceCodeRemoved,this.uiSourceCodeRemoved,this),this.#c.addEventListener(o.Workspace.Events.ProjectRemoved,this.projectRemoved,this),this.targetManager.observeModels(r.DebuggerModel.DebuggerModel,this),this.#Le=[]}static instance(e={forceNew:null,targetManager:null,workspace:null,debuggerWorkspaceBinding:null}){const{forceNew:t,targetManager:r,workspace:o,debuggerWorkspaceBinding:s}=e;if(!Oe||t){if(!r||!o||!s)throw new Error(`Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);Oe=new Ae(r,o,s)}return Oe}static breakpointStorageId(e,t,r){return e?`${e}:${t}`+("number"==typeof r?`:${r}`:""):""}modelAdded(e){t.Runtime.experiments.isEnabled(t.Runtime.ExperimentName.INSTRUMENTATION_BREAKPOINTS)&&e.setSynchronizeBreakpointsCallback(this.restoreBreakpointsForScript.bind(this))}modelRemoved(e){e.setSynchronizeBreakpointsCallback(null)}addUpdateBindingsCallback(e){this.#Le.push(e)}async copyBreakpoints(e,t){const r=this.storage.breakpointItems(e);for(const e of r)await this.setBreakpoint(t,e.lineNumber,e.columnNumber,e.condition,e.enabled)}async restoreBreakpointsForScript(e){if(!t.Runtime.experiments.isEnabled(t.Runtime.ExperimentName.INSTRUMENTATION_BREAKPOINTS))return;if(!e.sourceURL)return;const r=e.debuggerModel,s=await this.getUISourceCodeWithUpdatedBreakpointInfo(e);this.#Ce(e.sourceURL)&&await this.#ve(s);const i=await r.sourceMapManager().sourceMapForClientPromise(e);if(i)for(const e of i.sourceURLs())if(this.#Ce(e)){const t=await o.Workspace.WorkspaceImpl.instance().uiSourceCodeForURLPromise(e);await this.#ve(t)}const{pluginManager:n}=this.debuggerWorkspaceBinding;if(n){const t=await n.getSourcesForScript(e);if(Array.isArray(t))for(const e of t)if(this.#Ce(e)){const t=await o.Workspace.WorkspaceImpl.instance().uiSourceCodeForURLPromise(e);await this.#ve(t)}}}async getUISourceCodeWithUpdatedBreakpointInfo(e){const t=e.sourceURL.startsWith("snippet://")?o.Workspace.projectTypes.Network:void 0,r=e.isInlineScript()&&!e.hasSourceURL,s=!e.isLiveEdit()&&e.sourceURL&&e.hasSourceURL;let i=e.sourceURL;r?i=J.createV8ScriptURL(e):s&&(i=Te.resolveRelativeSourceURL(e,e.sourceURL));const n=await o.Workspace.WorkspaceImpl.instance().uiSourceCodeForURLPromise(i,t);if(this.#Le.length>0){const e=[];for(const t of this.#Le)e.push(t(n));await Promise.all(e)}return n}async#ve(e){this.restoreBreakpoints(e);const t=this.#Me.values(),r=Array.from(t).filter((t=>t.uiSourceCodes.has(e)));await Promise.all(r.map((e=>e.updateBreakpoint())))}#Ce(e){return this.storage.breakpointItems(e).length>0}restoreBreakpoints(e){const t=e.url();if(!t)return;this.storage.mute();const r=this.storage.breakpointItems(t);for(const t of r)this.innerSetBreakpoint(e,t.lineNumber,t.columnNumber,t.condition,t.enabled);this.storage.unmute()}uiSourceCodeAdded(e){const t=e.data;this.restoreBreakpoints(t)}uiSourceCodeRemoved(e){const t=e.data;this.removeUISourceCode(t)}projectRemoved(e){const t=e.data;for(const e of t.uiSourceCodes())this.removeUISourceCode(e)}removeUISourceCode(e){this.breakpointLocationsForUISourceCode(e).forEach((t=>t.breakpoint.removeUISourceCode(e)))}async setBreakpoint(t,r,s,i,n){let a=new o.UISourceCode.UILocation(t,r,s);const c=await this.debuggerWorkspaceBinding.normalizeUILocation(a);return c.id()!==a.id()&&(e.Revealer.reveal(c),a=c),this.innerSetBreakpoint(a.uiSourceCode,a.lineNumber,a.columnNumber,i,n)}innerSetBreakpoint(e,t,r,o,s){const i=Ae.breakpointStorageId(e.url(),t,r);let n=this.#Me.get(i);return n?(n.updateState(o,s),n.addUISourceCode(e),n.updateBreakpoint(),n):(n=new We(this,e,e.url(),t,r,o,s),this.#Me.set(i,n),n)}findBreakpoint(e){const t=this.#Se.get(e.uiSourceCode);return t&&t.get(e.id())||null}async possibleBreakpoints(e,t){const{pluginManager:r}=this.debuggerWorkspaceBinding;if(r){const o=await r.uiLocationToRawLocations(e,t.startLine);if(o){const e=[];for(const t of o){const r=await this.debuggerWorkspaceBinding.rawLocationToUILocation(t);r&&e.push(r)}return e}}const s=je.instance().uiLocationToRawLocations(e,t.startLine,t.startColumn),i=je.instance().uiLocationToRawLocations(e,t.endLine,t.endColumn),[n,a]=await Promise.all([s,i]),c=new Map;for(const e of a)c.set(e.debuggerModel,e);let u=null,l=null;for(const e of n){const t=c.get(e.debuggerModel);if(t){u=e,l=t;break}}return u&&l?u.debuggerModel.getPossibleBreakpoints(u,l,!1).then(async function(t){const r=t.map((e=>this.debuggerWorkspaceBinding.rawLocationToUILocation(e))),s=(await Promise.all(r)).filter((t=>t&&t.uiSourceCode===e));if(!s.length)return[];s.sort(o.UISourceCode.UILocation.comparator);let i=s[0];const n=[i];for(const e of s)e.id()!==i.id()&&(n.push(e),i=e);return n}.bind(this)):[]}breakpointLocationsForUISourceCode(e){const t=this.#Se.get(e);return t?Array.from(t.values()):[]}allBreakpointLocations(){const e=[];for(const t of this.#Se.values())e.push(...t.values());return e}removeBreakpoint(e,t){t&&this.storage.removeBreakpoint(e),this.#Me.delete(e.breakpointStorageId())}uiLocationAdded(e,t){let r=this.#Se.get(t.uiSourceCode);r||(r=new Map,this.#Se.set(t.uiSourceCode,r));const o={breakpoint:e,uiLocation:t};r.set(t.id(),o),this.dispatchEventToListeners(xe.BreakpointAdded,o)}uiLocationRemoved(e,t){const r=this.#Se.get(t.uiSourceCode);if(!r)return;r.get(t.id())&&(r.delete(t.id()),0===r.size&&this.#Se.delete(t.uiSourceCode),this.dispatchEventToListeners(xe.BreakpointRemoved,{breakpoint:e,uiLocation:t}))}}var xe;!function(e){e.BreakpointAdded="breakpoint-added",e.BreakpointRemoved="breakpoint-removed"}(xe||(xe={}));class We{breakpointManager;urlInternal;#Ie;#we;#ye;uiSourceCodes;#Re;#ke;isRemoved=!1;currentState;#Te;constructor(e,t,o,s,i,n,a){this.breakpointManager=e,this.urlInternal=o,this.#Ie=s,this.#we=i,this.#ye=new Set,this.uiSourceCodes=new Set,this.currentState=null,this.#Te=new Map,this.updateState(n,a),this.addUISourceCode(t),this.breakpointManager.targetManager.observeModels(r.DebuggerModel.DebuggerModel,this)}async refreshInDebugger(){if(!this.isRemoved){const e=Array.from(this.#Te.values());await Promise.all(e.map((async e=>(await e.resetBreakpoint(),this.#Fe(e)))))}}modelAdded(e){const t=this.breakpointManager.debuggerWorkspaceBinding,o=new He(e,this,t);this.#Te.set(e,o),this.#Fe(o),e.addEventListener(r.DebuggerModel.Events.DebuggerWasEnabled,this.#Ue,this),e.addEventListener(r.DebuggerModel.Events.DebuggerWasDisabled,this.#Pe,this)}modelRemoved(e){this.#Te.get(e)?.cleanUpAfterDebuggerIsGone(),this.#Te.delete(e),this.#je(e)}#je(e){e.removeEventListener(r.DebuggerModel.Events.DebuggerWasEnabled,this.#Ue,this),e.removeEventListener(r.DebuggerModel.Events.DebuggerWasDisabled,this.#Pe,this)}#Ue(e){const t=e.data,r=this.#Te.get(t);r&&this.#Fe(r)}#Pe(e){const t=e.data;this.#Te.get(t)?.cleanUpAfterDebuggerIsGone()}modelBreakpoint(e){return this.#Te.get(e)}addUISourceCode(e){this.uiSourceCodes.has(e)||(this.uiSourceCodes.add(e),this.bound()||this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e)))}clearUISourceCodes(){this.bound()||this.removeAllUnboundLocations(),this.uiSourceCodes.clear()}removeUISourceCode(e){if(this.uiSourceCodes.has(e)&&(this.uiSourceCodes.delete(e),this.bound()||this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))),this.bound()){for(const t of this.#ye)t.uiSourceCode===e&&(this.#ye.delete(t),this.breakpointManager.uiLocationRemoved(this,t));this.bound()||this.isRemoved||this.addAllUnboundLocations()}}url(){return this.urlInternal}lineNumber(){return this.#Ie}columnNumber(){return this.#we}uiLocationAdded(e){this.isRemoved||(this.bound()||this.removeAllUnboundLocations(),this.#ye.add(e),this.breakpointManager.uiLocationAdded(this,e))}uiLocationRemoved(e){this.#ye.has(e)&&(this.#ye.delete(e),this.breakpointManager.uiLocationRemoved(this,e),this.bound()||this.isRemoved||this.addAllUnboundLocations())}enabled(){return this.#ke}bound(){return 0!==this.#ye.size}hasBoundScript(){for(const e of this.uiSourceCodes)if(e.project().type()===o.Workspace.projectTypes.Network)return!0;return!1}setEnabled(e){this.updateState(this.#Re,e)}condition(){return this.#Re}setCondition(e){this.updateState(e,this.#ke)}updateState(e,t){this.#ke===t&&this.#Re===e||(this.#ke=t,this.#Re=e,this.breakpointManager.storage.updateBreakpoint(this),this.updateBreakpoint())}async updateBreakpoint(){return this.bound()||(this.removeAllUnboundLocations(),this.isRemoved||this.addAllUnboundLocations()),this.#Ee()}async remove(e){if(this.getIsRemoved())return;this.isRemoved=!0;const t=!e;for(const e of this.#Te.keys())this.#je(e);await this.#Ee(),this.breakpointManager.removeBreakpoint(this,t),this.breakpointManager.targetManager.unobserveModels(r.DebuggerModel.DebuggerModel,this),this.clearUISourceCodes()}breakpointStorageId(){return Ae.breakpointStorageId(this.urlInternal,this.#Ie,this.#we)}defaultUILocation(e){return e.uiLocation(this.#Ie,this.#we)}removeAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))}addAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e))}getUiSourceCodes(){return this.uiSourceCodes}getIsRemoved(){return this.isRemoved}async#Ee(){await Promise.all(Array.from(this.#Te.values()).map((e=>this.#Fe(e))))}async#Fe(e){const t=await e.scheduleUpdateInDebugger();"ERROR_BACKEND"===t?await this.remove(!0):"ERROR_BREAKPOINT_CLASH"===t&&await this.remove(!1)}}class He{#n;#De;#o;#Ne;#ye;#Be=new e.Mutex.Mutex;#Oe;#Ae;#xe;constructor(e,t,r){this.#n=e,this.#De=t,this.#o=r,this.#Ne=new Y,this.#ye=new Map,this.#Oe=!1,this.#Ae=null,this.#xe=[]}get currentState(){return this.#Ae}resetLocations(){for(const e of this.#ye.values())this.#De.uiLocationRemoved(e);this.#ye.clear(),this.#Ne.disposeAll()}async scheduleUpdateInDebugger(){if(!this.#n.debuggerEnabled())return"OK";const e=await this.#Be.acquire();let t="PENDING";for(;"PENDING"===t;)t=await this.#We();return e(),t}scriptDiverged(){for(const e of this.#De.getUiSourceCodes()){const t=this.#o.scriptFile(e,this.#n);if(t&&t.hasDivergedFromVM())return!0}return!1}async#We(){if(this.#n.target().isDisposed())return this.cleanUpAfterDebuggerIsGone(),"OK";const e=this.#De.lineNumber(),r=this.#De.columnNumber(),o=this.#De.condition();let s=null;if(!this.#De.getIsRemoved()&&this.#De.enabled()&&!this.scriptDiverged()){let i=[];for(const t of this.#De.getUiSourceCodes()){if(i=(await je.instance().uiLocationToRawLocations(t,e,r)).filter((e=>e.debuggerModel===this.#n)),i.length)break}if(i.length&&i.every((e=>e.script()))){const e=i.map((e=>{const t=e.script();return{url:t.sourceURL,scriptId:t.scriptId,scriptHash:t.hash,lineNumber:e.lineNumber,columnNumber:e.columnNumber}}));s=new We.State(e,o)}else if(!t.Runtime.experiments.isEnabled(t.Runtime.ExperimentName.INSTRUMENTATION_BREAKPOINTS))if(this.#De.currentState)s=new We.State(this.#De.currentState.positions,o);else{const t={url:this.#De.url(),scriptId:"",scriptHash:"",lineNumber:e,columnNumber:r};s=new We.State([t],o)}}const i=this.#xe.length;if(i&&We.State.equals(s,this.#Ae))return"OK";if(this.#De.currentState=s,i)return await this.resetBreakpoint(),"PENDING";if(!s)return"OK";const{breakpointIds:n,locations:a,serverError:c}=await this.#He(s),u=c&&this.#n.debuggerEnabled()&&!this.#n.isReadyToPause();if(!n.length&&u)return"PENDING";if(this.#Ae=s,this.#Oe)return this.#Oe=!1,"OK";if(!n.length)return"ERROR_BACKEND";this.#xe=n,this.#xe.forEach((e=>this.#n.addBreakpointListener(e,this.breakpointResolved,this)));return(await Promise.all(a.map((e=>this.addResolvedLocation(e))))).includes("ERROR")?"ERROR_BREAKPOINT_CLASH":"OK"}async#He(e){const t=this.#De.condition(),r=await Promise.all(e.positions.map((e=>e.url?this.#n.setBreakpointByURL(e.url,e.lineNumber,e.columnNumber,t):this.#n.setBreakpointInAnonymousScript(e.scriptId,e.scriptHash,e.lineNumber,e.columnNumber,t)))),o=[];let s=[],i=!1;for(const e of r)e.breakpointId?(o.push(e.breakpointId),s=s.concat(e.locations)):i=!0;return{breakpointIds:o,locations:s,serverError:i}}async resetBreakpoint(){this.#xe.length&&(this.resetLocations(),await Promise.all(this.#xe.map((e=>this.#n.removeBreakpoint(e)))),this.didRemoveFromDebugger(),this.#Ae=null)}didRemoveFromDebugger(){this.#Oe?this.#Oe=!1:(this.resetLocations(),this.#xe.forEach((e=>this.#n.removeBreakpointListener(e,this.breakpointResolved,this))),this.#xe=[])}async breakpointResolved({data:e}){"ERROR"===await this.addResolvedLocation(e)&&await this.#De.remove(!1)}async locationUpdated(e){const t=this.#ye.get(e),r=await e.uiLocation();t&&this.#De.uiLocationRemoved(t),r?(this.#ye.set(e,r),this.#De.uiLocationAdded(r)):this.#ye.delete(e)}async addResolvedLocation(e){const t=await this.#o.rawLocationToUILocation(e);if(!t)return"OK";const r=this.#De.breakpointManager.findBreakpoint(t);return r&&r.breakpoint!==this.#De?"ERROR":(await this.#o.createLiveLocation(e,this.locationUpdated.bind(this),this.#Ne),"OK")}cleanUpAfterDebuggerIsGone(){this.#Oe=!0,this.resetLocations(),this.#Ae=null,this.#xe.length&&this.didRemoveFromDebugger()}}!function(e){e.State=class{positions;condition;constructor(e,t){this.positions=e,this.condition=t}static equals(e,t){if(!e||!t)return!1;if(e.condition!==t.condition)return!1;if(e.positions.length!==t.positions.length)return!1;for(let r=0;r<e.positions.length;r++){const o=e.positions[r],s=t.positions[r];if(o.url!==s.url)return!1;if(o.scriptId!==s.scriptId)return!1;if(o.scriptHash!==s.scriptHash)return!1;if(o.lineNumber!==s.lineNumber)return!1;if(o.columnNumber!==s.columnNumber)return!1}return!0}}}(We||(We={}));class _e{#_e;#ze;#Ve;constructor(){this.#_e=e.Settings.Settings.instance().createLocalSetting("breakpoints",[]),this.#ze=new Map;const t=this.#_e.get();for(const e of t)this.#ze.set(Ae.breakpointStorageId(e.url,e.lineNumber,e.columnNumber),e)}get setting(){return this.#_e}mute(){this.#Ve=!0}unmute(){this.#Ve=void 0}breakpointItems(e){return Array.from(this.#ze.values()).filter((t=>t.url===e))}updateBreakpoint(e){!this.#Ve&&e.breakpointStorageId()&&(this.#ze.set(e.breakpointStorageId(),new _e.Item(e)),this.save())}removeBreakpoint(e){this.#Ve||(this.#ze.delete(e.breakpointStorageId()),this.save())}save(){this.#_e.set(Array.from(this.#ze.values()))}}!function(e){e.Item=class{url;lineNumber;columnNumber;condition;enabled;constructor(e){this.url=e.url(),this.lineNumber=e.lineNumber(),this.columnNumber=e.columnNumber(),this.condition=e.condition(),this.enabled=e.enabled()}}}(_e||(_e={}));var ze=Object.freeze({__proto__:null,BreakpointManager:Ae,get Events(){return xe},get Breakpoint(){return We},ModelBreakpoint:He});class Ve{#Ge;#Ke;#qe;#$e;#Je;#Qe;#Xe;#Ye;#Ze;#et;#tt;#rt;constructor(e,t,r){this.#Ge=e,this.#Ke=e.size,this.#qe=0,this.#Je=t,this.#Qe=r,this.#Xe=new TextDecoder,this.#Ye=!1,this.#Ze=null,this.#$e=null}async read(e){if(this.#Qe&&this.#Qe(this),this.#Ge?.type.endsWith("gzip")){const e=this.decompressStream(this.#Ge.stream());this.#$e=e.getReader()}else this.#rt=new FileReader,this.#rt.onload=this.onChunkLoaded.bind(this),this.#rt.onerror=this.onError.bind(this);return this.#tt=e,this.loadChunk(),new Promise((e=>{this.#et=e}))}cancel(){this.#Ye=!0}loadedSize(){return this.#qe}fileSize(){return this.#Ke}fileName(){return this.#Ge?this.#Ge.name:""}error(){return this.#Ze}decompressStream(e){const t=new DecompressionStream("gzip");return e.pipeThrough(t)}onChunkLoaded(e){if(this.#Ye)return;if(e.target.readyState!==FileReader.DONE)return;if(!this.#rt)return;const t=this.#rt.result;this.#qe+=t.byteLength;const r=this.#qe===this.#Ke;this.decodeChunkBuffer(t,r)}async decodeChunkBuffer(e,t){if(!this.#tt)return;const r=this.#Xe.decode(e,{stream:!t});await this.#tt.write(r),this.#Ye||(this.#Qe&&this.#Qe(this),t?this.finishRead():this.loadChunk())}finishRead(){this.#tt&&(this.#Ge=null,this.#rt=null,this.#tt.close(),this.#et(!this.#Ze))}async loadChunk(){if(this.#tt&&this.#Ge){if(this.#$e){const{value:e,done:t}=await this.#$e.read();if(t||!e)return this.finishRead();this.decodeChunkBuffer(e.buffer,!1)}if(this.#rt){const e=this.#qe,t=Math.min(this.#Ke,e+this.#Je),r=this.#Ge.slice(e,t);this.#rt.readAsArrayBuffer(r)}}}onError(e){const t=e.target;this.#Ze=t.error,this.#et(!1)}}var Ge=Object.freeze({__proto__:null,ChunkedFileReader:Ve,FileOutputStream:class{#ot;#st;#it;constructor(){this.#ot=[]}async open(e){this.#it=!1,this.#ot=[],this.#st=e;const t=await o.FileManager.FileManager.instance().save(this.#st,"",!0);return t&&o.FileManager.FileManager.instance().addEventListener(o.FileManager.Events.AppendedToURL,this.onAppendDone,this),Boolean(t)}write(e){return new Promise((t=>{this.#ot.push(t),o.FileManager.FileManager.instance().append(this.#st,e)}))}async close(){this.#it=!0,this.#ot.length||(o.FileManager.FileManager.instance().removeEventListener(o.FileManager.Events.AppendedToURL,this.onAppendDone,this),o.FileManager.FileManager.instance().close(this.#st))}onAppendDone(e){if(e.data!==this.#st)return;const t=this.#ot.shift();t&&t(),this.#ot.length||this.#it&&(o.FileManager.FileManager.instance().removeEventListener(o.FileManager.Events.AppendedToURL,this.onAppendDone,this),o.FileManager.FileManager.instance().close(this.#st))}}});const Ke=new WeakMap;class qe{#n;#nt;#at;#O;constructor(e){this.#n=e,this.#nt=new Map,this.#at=[],e.addEventListener(r.DebuggerModel.Events.ParsedScriptSource,(e=>{queueMicrotask((()=>{this.parsedScriptSource(e)}))})),e.addEventListener(r.DebuggerModel.Events.GlobalObjectCleared,this.debuggerReset,this),this.#O=new Y}consoleMessageAdded(e){const t=this.rawLocation(e);t?this.addConsoleMessageToScript(e,t):this.addPendingConsoleMessage(e)}rawLocation(e){if(e.scriptId)return this.#n.createRawLocationByScriptId(e.scriptId,e.line,e.column);const t=e.stackTrace&&e.stackTrace.callFrames?e.stackTrace.callFrames[0]:null;return t?this.#n.createRawLocationByScriptId(t.scriptId,t.lineNumber,t.columnNumber):e.url?this.#n.createRawLocationByURL(e.url,e.line,e.column):null}addConsoleMessageToScript(e,t){this.#at.push(new $e(e,t,this.#O))}addPendingConsoleMessage(e){if(!e.url)return;const t=this.#nt.get(e.url);t?t.push(e):this.#nt.set(e.url,[e])}parsedScriptSource(e){const t=e.data,r=this.#nt.get(t.sourceURL);if(!r)return;const o=[];for(const e of r){const r=this.rawLocation(e);r&&t.scriptId===r.scriptId?this.addConsoleMessageToScript(e,r):o.push(e)}o.length?this.#nt.set(t.sourceURL,o):this.#nt.delete(t.sourceURL)}consoleCleared(){this.#nt=new Map,this.debuggerReset()}debuggerReset(){for(const e of this.#at)e.dispose();this.#at=[],this.#O.disposeAll()}}class $e extends o.UISourceCode.Message{#re;constructor(e,t,r){super("error"===e.level?o.UISourceCode.Message.Level.Error:o.UISourceCode.Message.Level.Warning,e.messageText),je.instance().createLiveLocation(t,this.updateLocation.bind(this),r)}async updateLocation(e){this.#re&&this.#re.removeMessage(this);const t=await e.uiLocation();t&&(this.range=n.TextRange.TextRange.createFromLocation(t.lineNumber,t.columnNumber||0),this.#re=t.uiSourceCode,this.#re.addMessage(this))}dispose(){this.#re&&this.#re.removeMessage(this)}}var Je=Object.freeze({__proto__:null,PresentationConsoleMessageManager:class{constructor(){r.TargetManager.TargetManager.instance().observeModels(r.DebuggerModel.DebuggerModel,this),r.ConsoleModel.ConsoleModel.instance().addEventListener(r.ConsoleModel.Events.ConsoleCleared,this.consoleCleared,this),r.ConsoleModel.ConsoleModel.instance().addEventListener(r.ConsoleModel.Events.MessageAdded,(e=>this.consoleMessageAdded(e.data))),r.ConsoleModel.ConsoleModel.instance().messages().forEach(this.consoleMessageAdded,this)}modelAdded(e){Ke.set(e,new qe(e))}modelRemoved(e){const t=Ke.get(e);t&&t.consoleCleared()}consoleMessageAdded(e){const t=e.runtimeModel();if(!e.isErrorOrWarning()||!e.runtimeModel()||"violation"===e.source||!t)return;const r=Ke.get(t.debuggerModel());r&&r.consoleMessageAdded(e)}consoleCleared(){for(const e of r.TargetManager.TargetManager.instance().models(r.DebuggerModel.DebuggerModel)){const t=Ke.get(e);t&&t.consoleCleared()}}},PresentationConsoleMessageHelper:qe,PresentationConsoleMessage:$e});class Qe{#ct;constructor(){this.#ct=null}write(e){this.#ct&&e.unshift(this.#ct),this.#ct=new Blob(e,{type:"text/plain"})}read(){return this.readRange()}size(){return this.#ct?this.#ct.size:0}async readRange(t,r){if(!this.#ct)return e.Console.Console.instance().error("Attempt to read a temp file that was never written"),"";const o="number"==typeof t||"number"==typeof r?this.#ct.slice(t,r):this.#ct,s=new FileReader;try{await new Promise(((e,t)=>{s.onloadend=e,s.onerror=t,s.readAsText(o)}))}catch(t){e.Console.Console.instance().error("Failed to read from temp file: "+t.message)}return s.result}async copyToOutputStream(e,t){if(!this.#ct)return e.close(),null;const r=new Ve(this.#ct,1e7,t);return r.read(e).then((e=>e?null:r.error()))}remove(){this.#ct=null}}var Xe=Object.freeze({__proto__:null,TempFile:Qe,TempFileBackingStorage:class{#Ge;#ut;#lt;constructor(){this.#Ge=null,this.reset()}appendString(e){this.#ut.push(e),this.#lt+=e.length;this.#lt>10485760&&this.flush()}appendAccessibleString(e){if(this.flush(),!this.#Ge)return async()=>null;const t=this.#Ge.size();return this.#ut.push(e),this.flush(),this.#Ge.readRange.bind(this.#Ge,t,this.#Ge.size())}flush(){this.#ut.length&&(this.#Ge||(this.#Ge=new Qe),this.#lt=0,this.#Ge.write(this.#ut.splice(0)))}finishWriting(){this.flush()}reset(){this.#Ge&&this.#Ge.remove(),this.#Ge=null,this.#ut=[],this.#lt=0}writeToStream(e){return this.#Ge?this.#Ge.copyToOutputStream(e):Promise.resolve(null)}}});export{ze as BreakpointManager,be as CSSWorkspaceBinding,k as CompilerScriptMapping,h as ContentProviderBasedProject,K as DebuggerLanguagePlugins,Be as DebuggerWorkspaceBinding,Q as DefaultScriptMapping,Ge as FileUtils,b as IgnoreListManager,Z as LiveLocation,I as NetworkProject,Je as PresentationConsoleMessageHelper,we as ResourceMapping,Ue as ResourceScriptMapping,ae as ResourceUtils,oe as SASSSourceMapping,de as StylesSourceMapping,Xe as TempFile};
