import*as e from"../../core/common/common.js";import*as t from"../../core/i18n/i18n.js";import*as r from"../../core/platform/platform.js";import*as n from"../../core/root/root.js";import*as a from"../../core/sdk/sdk.js";const s={threadS:"Thread {PH1}"},i=t.i18n.registerUIStrings("models/timeline_model/TimelineJSProfile.ts",s),o=t.i18n.getLocalizedString.bind(void 0,i);class l{static generateTracingEventsFromCpuProfile(e,t){const r=e.idleNode,n=e.programNode||null,s=e.gcNode,i=e.samples||[],o=e.timestamps,l=[],d=new Map;d.set(n,[]);for(let n=0;n<i.length;++n){let c=e.nodeByIndex(n);if(!c){console.error(`Node with unknown id ${i[n]} at index ${n}`);continue}if(c===s||c===r)continue;let h=d.get(c);if(!h){h=new Array(c.depth+1),d.set(c,h);for(let e=0;c.parent;c=c.parent)h[e++]=c}const m=new a.TracingModel.Event(a.TracingModel.DevToolsTimelineEventCategory,g.JSSample,a.TracingModel.Phase.Instant,o[n],t);m.args.data={stackTrace:h},l.push(m)}return l}static generateJSFrameEvents(e,t){const r=[],n=[],s=[];let i=0,o=!1;const{showAllEvents:d,showRuntimeCallStats:c,showNativeFunctions:h}=t;function m(e,t){if(s.length){const r=s[s.length-1];e<r&&(console.error(`Child stack is shallower (${e}) than the parent stack (${r}) at ${t}`),e=r)}n.length<e&&(console.error(`Trying to truncate higher than the current stack size at ${t}`),e=n.length);for(let e=0;e<n.length;++e)n[e].setEndTime(t);n.length=e}function p(e){const t=e.name===g.JSSample?e.args.data.stackTrace.slice().reverse():n.map((e=>e.args.data));!function(e){if(d)return;let t=null,r=0;for(let a=0;a<e.length;++a){const s=e[a],i=s.url,o=i&&i.startsWith("native ");if(!h&&o)continue;const d=l.isNativeRuntimeFrame(s);if(d&&(n=s.functionName,!c||!Boolean(l.nativeGroup(n))))continue;const m=d?l.nativeGroup(s.functionName):null;t&&t===m||(t=m,e[r++]=s)}var n;e.length=r}(t);const i=e.endTime||e.startTime,o=Math.min(t.length,n.length);let u;for(u=s[s.length-1]||0;u<o;++u){const e=t[u],r=n[u].args.data;if(T=r,(p=e).scriptId!==T.scriptId||p.functionName!==T.functionName||p.lineNumber!==T.lineNumber)break;n[u].setEndTime(Math.max(n[u].endTime,i))}var p,T;for(m(u,e.startTime);u<t.length;++u){const s=t[u],o=new a.TracingModel.Event(a.TracingModel.DevToolsTimelineEventCategory,g.JSFrame,a.TracingModel.Phase.Complete,e.startTime,e.thread);o.ordinal=e.ordinal,o.addArgs({data:s}),o.setEndTime(i),n.push(o),r.push(o)}}const T=e.find(a.TracingModel.TracingModel.isTopLevelEvent),v=T?T.startTime:0;return u.forEachEvent(e,(function(e){o&&(m(s.pop(),e.startTime),o=!1),e.ordinal=++i,p(e),s.push(n.length)}),(function(e){m(s.pop(),e.endTime)}),(function(e,t){if(e.ordinal=++i,t&&function(e){switch(e.name){case g.RunMicrotasks:case g.FunctionCall:case g.EvaluateScript:case g.EvaluateModule:case g.EventDispatch:case g.V8Execute:return!0}return!1}(t)||o)p(e);else if(e.name===g.JSSample&&0===n.length){o=!0;const t=n.length;p(e),s.push(t)}}),v),r}static isNativeRuntimeFrame(e){return"native V8Runtime"===e.url}static nativeGroup(e){return e.startsWith("Parse")?l.NativeGroups.Parse:e.startsWith("Compile")||e.startsWith("Recompile")?l.NativeGroups.Compile:null}static buildTraceProfileFromCpuProfile(e,t,r,n){const i=[];if(r&&v("TracingStartedInPage",{data:{sessionId:"1"}},0,0,"M"),n||(n=o(s.threadS,{PH1:t})),v(a.TracingModel.MetadataEvent.ThreadName,{name:n},0,0,"M","__metadata"),!e)return i;const l=new Map,d=e.nodes;for(let e=0;e<d.length;++e)l.set(d[e].id,d[e]);let c=null,h=null,m=e.startTime,u=0;const g=e.samples,p=e.timeDeltas;for(let e=0;e<g.length;++e){u=m,m+=p[e];const t=l.get(g[e]).callFrame.functionName;"(idle)"!==t?(c||(c=v("MessageLoop::RunTask",{},u,0,"X","toplevel")),"(program)"===t?h&&(h.dur=u-h.ts,h=null):h||(h=v("FunctionCall",{data:{sessionId:"1"}},u))):T()}return T(),v("CpuProfile",{data:{cpuProfile:e}},e.endTime,0,"I"),i;function T(){c&&(c.dur=u-c.ts),h&&(h.dur=u-h.ts),c=null,h=null}function v(e,r,n,a,s,o){const l={cat:o||"disabled-by-default-devtools.timeline",name:e,ph:s||"X",pid:1,tid:t,ts:n,args:r};return a&&(l.dur=a),i.push(l),l}}}!function(e){let t;!function(e){e.Compile="Compile",e.Parse="Parse"}(t=e.NativeGroups||(e.NativeGroups={}))}(l||(l={}));var d=Object.freeze({__proto__:null,get TimelineJSProfileProcessor(){return l}});const c={threadS:"Thread {PH1}",userInteractions:"User Interactions",workerS:"`Worker` — {PH1}",dedicatedWorker:"Dedicated `Worker`",workerSS:"`Worker`: {PH1} — {PH2}",bidderWorkletS:"Bidder Worklet — {PH1}",sellerWorkletS:"Seller Worklet — {PH1}",unknownWorkletS:"Auction Worklet — {PH1}",bidderWorklet:"Bidder Worklet",sellerWorklet:"Seller Worklet",unknownWorklet:"Auction Worklet",workletService:"Auction Worklet Service",workletServiceS:"Auction Worklet Service — {PH1}"},h=t.i18n.registerUIStrings("models/timeline_model/TimelineModel.ts",c),m=t.i18n.getLocalizedString.bind(void 0,h);class u{isGenericTraceInternal;tracksInternal;namedTracks;inspectedTargetEventsInternal;timeMarkerEventsInternal;sessionId;mainFrameNodeId;pageFrames;auctionWorklets;cpuProfilesInternal;workerIdByThread;requestsFromBrowser;mainFrame;minimumRecordTimeInternal;maximumRecordTimeInternal;totalBlockingTimeInternal;estimatedTotalBlockingTime;asyncEventTracker;invalidationTracker;layoutInvalidate;lastScheduleStyleRecalculation;paintImageEventByPixelRefId;lastPaintForLayer;lastRecalculateStylesEvent;currentScriptEvent;eventStack;browserFrameTracking;persistentIds;legacyCurrentPage;currentTaskLayoutAndRecalcEvents;tracingModelInternal;mainFrameLayerTreeId;constructor(){this.minimumRecordTimeInternal=0,this.maximumRecordTimeInternal=0,this.totalBlockingTimeInternal=0,this.estimatedTotalBlockingTime=0,this.reset(),this.resetProcessingState(),this.currentTaskLayoutAndRecalcEvents=[],this.tracingModelInternal=null}static forEachEvent(e,t,r,n,s,i,o){s=s||0,i=i||1/0;const l=[];for(let d=u.topLevelEventEndingAfter(e,s);d<e.length;++d){const c=e[d];if((c.endTime||c.startTime)<s)continue;if(c.startTime>=i)break;if(a.TracingModel.TracingModel.isAsyncPhase(c.phase)||a.TracingModel.TracingModel.isFlowPhase(c.phase))continue;let h=l[l.length-1];for(;h&&void 0!==h.endTime&&h.endTime<=c.startTime;)l.pop(),r(h),h=l[l.length-1];o&&!o(c)||(c.duration?(t(c),l.push(c)):n&&n(c,l[l.length-1]||null))}for(;l.length;){const e=l.pop();e&&r(e)}}static topLevelEventEndingAfter(e,t){let n=r.ArrayUtilities.upperBound(e,t,((e,t)=>e-t.startTime))-1;for(;n>0&&!a.TracingModel.TracingModel.isTopLevelEvent(e[n]);)n--;return Math.max(n,0)}isMarkerEvent(e){switch(e.name){case g.TimeStamp:return!0;case g.MarkFirstPaint:case g.MarkFCP:return Boolean(this.mainFrame)&&e.args.frame===this.mainFrame.frameId&&Boolean(e.args.data);case g.MarkDOMContent:case g.MarkLoad:case g.MarkLCPCandidate:case g.MarkLCPInvalidate:return Boolean(e.args.data.isOutermostMainFrame??e.args.data.isMainFrame);default:return!1}}isInteractiveTimeEvent(e){return e.name===g.InteractiveTime}isLayoutShiftEvent(e){return e.name===g.LayoutShift}isUserTimingEvent(e){return e.categoriesString===u.Category.UserTiming}isEventTimingInteractionEvent(e){if(e.name!==g.EventTiming)return!1;const t=e.args.data,r=t.duration||0,n=t.interactionId||0;return r>0&&n>0}isParseHTMLEvent(e){return e.name===g.ParseHTML}isLCPCandidateEvent(e){return e.name===g.MarkLCPCandidate&&Boolean(e.args.data.isOutermostMainFrame??e.args.data.isMainFrame)}isLCPInvalidateEvent(e){return e.name===g.MarkLCPInvalidate&&Boolean(e.args.data.isOutermostMainFrame??e.args.data.isMainFrame)}isFCPEvent(e){return e.name===g.MarkFCP&&Boolean(this.mainFrame)&&e.args.frame===this.mainFrame.frameId}isLongRunningTask(e){return e.name===g.Task&&F.forEvent(e).warning===u.WarningType.LongTask}isNavigationStartEvent(e){return e.name===g.NavigationStart}isMainFrameNavigationStartEvent(e){return this.isNavigationStartEvent(e)&&(e.args.data.isOutermostMainFrame??e.args.data.isLoadingMainFrame)&&e.args.data.documentLoaderURL}static globalEventId(e,t){const r=e.args.data||e.args.beginData,n=r&&r[t];return n?`${e.thread.process().id()}.${n}`:""}static eventFrameId(e){const t=e.args.data||e.args.beginData;return t&&t.frame||null}cpuProfiles(){return this.cpuProfilesInternal}totalBlockingTime(){return-1===this.totalBlockingTimeInternal?{time:this.estimatedTotalBlockingTime,estimated:!0}:{time:this.totalBlockingTimeInternal,estimated:!1}}targetByEvent(e){const t=this.workerIdByThread.get(e.thread),r=a.TargetManager.TargetManager.instance().mainTarget();return t?a.TargetManager.TargetManager.instance().targetById(t):r}navStartTimes(){return this.tracingModelInternal?this.tracingModelInternal.navStartTimes():new Map}setEvents(e){this.reset(),this.resetProcessingState(),this.tracingModelInternal=e,this.minimumRecordTimeInternal=e.minimumRecordTime(),this.maximumRecordTimeInternal=e.maximumRecordTime();const t=[];for(const r of e.sortedProcesses())if("Renderer"===r.name())for(const e of r.sortedThreads()){const r=e.removeEventsByName(g.LayoutShift);t.push(...r)}if(this.processSyncBrowserEvents(e),this.browserFrameTracking)this.processThreadsForBrowserFrames(e);else{const t=this.processMetadataEvents(e);this.isGenericTraceInternal=!t,t?this.processMetadataAndThreads(e,t):this.processGenericTrace(e)}this.inspectedTargetEventsInternal.sort(a.TracingModel.Event.compareStartTime),this.processAsyncBrowserEvents(e),this.buildGPUEvents(e),this.buildLoadingEvents(e,t),this.collectInteractionEvents(e),this.resetProcessingState()}collectInteractionEvents(e){const t=[];for(const r of e.sortedProcesses()){if("Renderer"!==r.name())continue;const e=r.threadByName("CrRendererMain");if(e)for(const r of e.asyncEvents())this.isEventTimingInteractionEvent(r)&&t.push(r)}if(0===t.length)return;const r=this.ensureNamedTrack(p.UserInteractions);r.name=c.userInteractions,r.forMainFrame=!0,r.asyncEvents=t}processGenericTrace(e){let t=a.TracingModel.TracingModel.browserMainThread(e);!t&&e.sortedProcesses().length&&(t=e.sortedProcesses()[0].sortedThreads()[0]);for(const r of e.sortedProcesses())for(const n of r.sortedThreads())this.processThreadEvents(e,[{from:0,to:1/0}],n,n===t,!1,!0,0,null)}processMetadataAndThreads(e,t){let n=0;for(let a=0,s=t.page.length;a<s;a++){const i=t.page[a],o=i.thread.process(),l=a+1<s?t.page[a+1].startTime:1/0;if(n!==l){this.legacyCurrentPage=i.args.data&&i.args.data.page;for(const a of o.sortedThreads()){let s=null;if(a.name()===u.WorkerThreadName||a.name()===u.WorkerThreadNameLegacy){const e=t.workers.find((e=>{if(e.args.data.workerThreadId!==a.id())return!1;if(e.args.data.sessionId===this.sessionId)return!0;const t=u.eventFrameId(e);return!!t&&Boolean(this.pageFrames.get(t))}));if(!e)continue;const n=e.args.data.workerId;n&&this.workerIdByThread.set(a,n),s=e.args.data.url||r.DevToolsPath.EmptyUrlString}this.processThreadEvents(e,[{from:n,to:l}],a,a===i.thread,Boolean(s),!0,0,s)}n=l}}}processThreadsForBrowserFrames(e){const t=new Map;for(const e of this.pageFrames.values())for(let r=0;r<e.processes.length;r++){const n=e.processes[r].processId;let a=t.get(n);a||(a=[],t.set(n,a));const s=r===e.processes.length-1?e.deletedTime||1/0:e.processes[r+1].time;a.push({from:e.processes[r].time,to:s,main:!e.parent,url:e.processes[r].url,workletType:0})}for(const e of this.auctionWorklets.values()){const n=e.processId;let a=t.get(n);a||(a=[],t.set(n,a)),a.push({from:e.startTime,to:e.endTime,main:!1,workletType:e.workletType,url:e.host?"https://"+e.host:r.DevToolsPath.EmptyUrlString})}const n=e.devToolsMetadataEvents();for(const a of e.sortedProcesses()){const s=t.get(a.id());if(!s)continue;s.sort(((e,t)=>e.from-t.from||e.to-t.to));const i=[];let o=null,l=null,d=!1,c=!0,h=!1,m=0;for(const e of s){const t=i[i.length-1];!t||e.from>t.to?i.push({from:e.from,to:e.to}):t.to=e.to,e.main&&(d=!0),0===e.workletType?c=!1:(!1===h?h=e.url:h!==e.url&&(h=!0),0===m?m=e.workletType:m!==e.workletType&&(m=3)),e.url&&(e.main&&(l=e.url),o=e.url)}for(const t of a.sortedThreads())if(t.name()===u.RendererMainThreadName)this.processThreadEvents(e,i,t,!0,!1,d,0,d?l:o);else if(t.name()===u.WorkerThreadName||t.name()===u.WorkerThreadNameLegacy){const s=n.find((e=>{if(e.name!==u.DevToolsMetadataEvent.TracingSessionIdForWorker)return!1;if(e.thread.process()!==a)return!1;if(e.args.data.workerThreadId!==t.id())return!1;const r=u.eventFrameId(e);return!!r&&Boolean(this.pageFrames.get(r))}));if(!s)continue;this.workerIdByThread.set(t,s.args.data.workerId||""),this.processThreadEvents(e,i,t,!1,!0,!1,0,s.args.data.url||r.DevToolsPath.EmptyUrlString)}else{let r=null,n=0;if(t.name()===u.AuctionWorkletThreadName||t.name()===u.UtilityMainThreadName)"boolean"!=typeof h&&(r=h),n=m;else if(c)continue;this.processThreadEvents(e,i,t,!1,!1,!1,n,r)}}}processMetadataEvents(t){const r=t.devToolsMetadataEvents(),n=[],s=[];for(const e of r)if(e.name===u.DevToolsMetadataEvent.TracingStartedInPage){n.push(e),e.args.data&&e.args.data.persistentIds&&(this.persistentIds=!0);(e.args.data&&e.args.data.frames||[]).forEach((t=>this.addPageFrame(e,t))),this.mainFrame=this.rootFrames()[0]}else e.name===u.DevToolsMetadataEvent.TracingSessionIdForWorker?s.push(e):e.name===u.DevToolsMetadataEvent.TracingStartedInBrowser&&(console.assert(!this.mainFrameNodeId,"Multiple sessions in trace"),this.mainFrameNodeId=e.args.frameTreeNodeId);if(!n.length)return null;const i=n[0].args.sessionId||n[0].args.data.sessionId;this.sessionId=i;const o=new Set;const l={page:n.filter((function(e){let t=e.args;t.data&&(t=t.data);const r=t.sessionId;return r===i||(o.add(r),!1)})).sort(a.TracingModel.Event.compareStartTime),workers:s.sort(a.TracingModel.Event.compareStartTime)};return o.size&&e.Console.Console.instance().error("Timeline recording was started in more than one page simultaneously. Session id mismatch: "+this.sessionId+" and "+[...o]+"."),l}processSyncBrowserEvents(e){const t=a.TracingModel.TracingModel.browserMainThread(e);t&&t.events().forEach(this.processBrowserEvent,this)}processAsyncBrowserEvents(e){const t=a.TracingModel.TracingModel.browserMainThread(e);t&&this.processAsyncEvents(t,[{from:0,to:1/0}])}buildGPUEvents(e){const t=e.getThreadByName("GPU Process","CrGpuMain");if(!t)return;const r=g.GPUTask,n=this.ensureNamedTrack(p.GPU);n.thread=t,n.events=t.events().filter((e=>e.name===r))}buildLoadingEvents(e,t){const r=e.getThreadByName("Renderer","CrRendererMain");if(!r)return;const n=this.ensureNamedTrack(p.Experience);n.thread=r,n.events=t;for(const e of n.events)if(e.categoriesString="experience",e.name===g.LayoutShift){const t=e.args.data||e.args.beginData||{},r=F.forEvent(e);if(t.impacted_nodes)for(let e=0;e<t.impacted_nodes.length;++e)r.backendNodeIds.push(t.impacted_nodes[e].node_id)}}resetProcessingState(){this.asyncEventTracker=new S,this.invalidationTracker=new k,this.layoutInvalidate={},this.lastScheduleStyleRecalculation={},this.paintImageEventByPixelRefId={},this.lastPaintForLayer={},this.lastRecalculateStylesEvent=null,this.currentScriptEvent=null,this.eventStack=[],this.browserFrameTracking=!1,this.persistentIds=!1,this.legacyCurrentPage=null}extractCpuProfile(t,r){const n=r.events();let s,i=null,o=n[n.length-1];if(o&&o.name===g.CpuProfile){const e=o.args.data;s=e&&e.cpuProfile,i=this.targetByEvent(o)}if(!s){if(o=n.find((e=>e.name===g.Profile)),!o)return null;i=this.targetByEvent(o);const r=t.profileGroup(o);if(!r)return e.Console.Console.instance().error("Invalid CPU profile format."),null;s={startTime:1e3*o.startTime,endTime:0,nodes:[],samples:[],timeDeltas:[],lines:[]};for(const t of r.children){const r=t.args.data;"startTime"in r&&(s.startTime=1e3*t.startTime),"endTime"in r&&(s.endTime=1e3*t.startTime);const n=r.cpuProfile||{},a=n.samples||[],i=r.lines||Array(a.length).fill(0);if(s.nodes.push(...n.nodes||[]),s.lines.push(...i),s.samples&&s.samples.push(...a),s.timeDeltas&&s.timeDeltas.push(...r.timeDeltas||[]),s.samples&&s.timeDeltas&&s.samples.length!==s.timeDeltas.length)return e.Console.Console.instance().error("Failed to parse CPU profile."),null}if(!s.endTime&&s.timeDeltas){const e=s.timeDeltas;s.endTime=e.reduce(((e,t)=>e+t),s.startTime)}}try{const e=s,t=new a.CPUProfileDataModel.CPUProfileDataModel(e,i);return this.cpuProfilesInternal.push(t),t}catch(t){e.Console.Console.instance().error("Failed to parse CPU profile.")}return null}injectJSFrameEvents(t,s){const i=this.extractCpuProfile(t,s);let o=s.events();const d=i?l.generateTracingEventsFromCpuProfile(i,s):null;if(d&&d.length&&(o=r.ArrayUtilities.mergeOrdered(o,d,a.TracingModel.Event.orderedCompareStartTime)),d||o.some((e=>e.name===g.JSSample))){const t=l.generateJSFrameEvents(o,{showAllEvents:n.Runtime.experiments.isEnabled("timelineShowAllEvents"),showRuntimeCallStats:n.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats"),showNativeFunctions:e.Settings.Settings.instance().moduleSetting("showNativeFunctionsInJSProfile").get()});t&&t.length&&(o=r.ArrayUtilities.mergeOrdered(t,o,a.TracingModel.Event.orderedCompareStartTime))}return o}static nameAuctionWorklet(e,t){switch(e){case 1:return t?m(c.bidderWorkletS,{PH1:t}):m(c.bidderWorklet);case 2:return t?m(c.sellerWorkletS,{PH1:t}):m(c.sellerWorklet);default:return t?m(c.unknownWorkletS,{PH1:t}):m(c.unknownWorklet)}}processThreadEvents(e,t,n,s,i,o,l,d){const h=new T;h.name=n.name()||m(c.threadS,{PH1:n.id()}),h.type=p.Other,h.thread=n,s?(h.type=p.MainThread,h.url=d||r.DevToolsPath.EmptyUrlString,h.forMainFrame=o):i?(h.type=p.Worker,h.url=d||r.DevToolsPath.EmptyUrlString,h.name=h.url?m(c.workerS,{PH1:h.url}):m(c.dedicatedWorker)):n.name().startsWith("CompositorTileWorker")?h.type=p.Raster:n.name()===u.AuctionWorkletThreadName?(h.url=d||r.DevToolsPath.EmptyUrlString,h.name=u.nameAuctionWorklet(l,d)):0!==l&&n.name()===u.UtilityMainThreadName&&(h.url=d||r.DevToolsPath.EmptyUrlString,h.name=d?m(c.workletServiceS,{PH1:d}):m(c.workletService)),this.tracksInternal.push(h);const v=this.injectJSFrameEvents(e,n);this.eventStack=[];const f=this.eventStack;if(i){const e=v.find((e=>e.name===g.Profile));if(e){const t=this.targetByEvent(e);t&&(h.name=m(c.workerSS,{PH1:t.name(),PH2:h.url}))}}for(const e of t){let t=r.ArrayUtilities.lowerBound(v,e.from,((e,t)=>e-t.startTime));for(;t<v.length;t++){const r=v[t];if(r.startTime>=e.to)break;this.isInteractiveTimeEvent(r)&&-1===this.totalBlockingTimeInternal&&(this.totalBlockingTimeInternal=r.args.args.total_blocking_time_ms);const n=r.name===g.Task&&r.duration&&r.duration>50;s&&n&&r.duration&&(this.estimatedTotalBlockingTime+=r.duration-50);let i=f[f.length-1];for(;i&&void 0!==i.endTime&&i.endTime<=r.startTime;)f.pop(),i=f[f.length-1];if(this.processEvent(r)){if(!a.TracingModel.TracingModel.isAsyncPhase(r.phase)&&r.duration){if(f.length){const e=f[f.length-1];e&&(e.selfTime-=r.duration,e.selfTime<0&&this.fixNegativeDuration(e,r))}r.selfTime=r.duration,f.length||h.tasks.push(r),f.push(r)}this.isMarkerEvent(r)&&this.timeMarkerEventsInternal.push(r),h.events.push(r),this.inspectedTargetEventsInternal.push(r)}}}this.processAsyncEvents(n,t)}fixNegativeDuration(e,t){e.selfTime<-.001&&console.error(`Children are longer than parent at ${e.startTime} (${(t.startTime-this.minimumRecordTime()).toFixed(3)} by ${(-e.selfTime).toFixed(3)}`),e.selfTime=0}processAsyncEvents(e,t){const n=e.asyncEvents(),s=new Map;function i(e){return s.has(e)||s.set(e,[]),s.get(e)}for(const e of t){let t=r.ArrayUtilities.lowerBound(n,e.from,(function(e,t){return e-t.startTime}));for(;t<n.length;++t){const r=n[t];if(r.startTime>=e.to)break;r.hasCategory(u.Category.Console)?i(p.Console).push(r):r.hasCategory(u.Category.UserTiming)?i(p.Timings).push(r):r.name!==g.Animation||i(p.Animation).push(r)}}for(const[t,n]of s){const s=this.ensureNamedTrack(t);s.thread=e,s.asyncEvents=r.ArrayUtilities.mergeOrdered(s.asyncEvents,n,a.TracingModel.Event.compareStartTime)}}processEvent(e){const t=this.eventStack;if(!t.length){if(this.currentTaskLayoutAndRecalcEvents&&this.currentTaskLayoutAndRecalcEvents.length){const e=this.currentTaskLayoutAndRecalcEvents.reduce(((e,t)=>void 0===t.duration?e:e+t.duration),0);if(e>u.Thresholds.ForcedLayout)for(const e of this.currentTaskLayoutAndRecalcEvents){F.forEvent(e).warning=e.name===g.Layout?u.WarningType.ForcedLayout:u.WarningType.ForcedStyle}}this.currentTaskLayoutAndRecalcEvents=[]}this.currentScriptEvent&&void 0!==this.currentScriptEvent.endTime&&e.startTime>this.currentScriptEvent.endTime&&(this.currentScriptEvent=null);const r=e.args.data||e.args.beginData||{},n=F.forEvent(e);r.stackTrace&&(n.stackTrace=r.stackTrace.map((t=>{if(e.name!==g.JSSample){const e={...t};return--e.lineNumber,--e.columnNumber,e}return t})));let a=u.eventFrameId(e);const s=t[t.length-1];switch(!a&&s&&(a=F.forEvent(s).frameId),n.frameId=a||this.mainFrame&&this.mainFrame.frameId||"",this.asyncEventTracker.processEvent(e),this.isMarkerEvent(e)&&this.ensureNamedTrack(p.Timings),e.name){case g.ResourceSendRequest:case g.WebSocketCreate:n.setInitiator(t[t.length-1]||null),n.url=r.url;break;case g.ScheduleStyleRecalculation:this.lastScheduleStyleRecalculation[r.frame]=e;break;case g.UpdateLayoutTree:case g.RecalculateStyles:this.invalidationTracker.didRecalcStyle(e),e.args.beginData&&n.setInitiator(this.lastScheduleStyleRecalculation[e.args.beginData.frame]),this.lastRecalculateStylesEvent=e,this.currentScriptEvent&&this.currentTaskLayoutAndRecalcEvents.push(e);break;case g.ScheduleStyleInvalidationTracking:case g.StyleRecalcInvalidationTracking:case g.StyleInvalidatorInvalidationTracking:case g.LayoutInvalidationTracking:this.invalidationTracker.addInvalidation(new I(e,n));break;case g.InvalidateLayout:{let t=e;const n=r.frame;!this.layoutInvalidate[n]&&this.lastRecalculateStylesEvent&&void 0!==this.lastRecalculateStylesEvent.endTime&&this.lastRecalculateStylesEvent.endTime>e.startTime&&(t=F.forEvent(this.lastRecalculateStylesEvent).initiator()),this.layoutInvalidate[n]=t;break}case g.Layout:{this.invalidationTracker.didLayout(e);const t=e.args.beginData.frame;if(n.setInitiator(this.layoutInvalidate[t]),e.args.endData)if(e.args.endData.layoutRoots)for(let t=0;t<e.args.endData.layoutRoots.length;++t)n.backendNodeIds.push(e.args.endData.layoutRoots[t].nodeId);else n.backendNodeIds.push(e.args.endData.rootNode);this.layoutInvalidate[t]=null,this.currentScriptEvent&&this.currentTaskLayoutAndRecalcEvents.push(e);break}case g.Task:void 0!==e.duration&&e.duration>u.Thresholds.LongTask&&(n.warning=u.WarningType.LongTask);break;case g.EventDispatch:void 0!==e.duration&&e.duration>u.Thresholds.RecurringHandler&&(n.warning=u.WarningType.LongHandler);break;case g.TimerFire:case g.FireAnimationFrame:void 0!==e.duration&&e.duration>u.Thresholds.RecurringHandler&&(n.warning=u.WarningType.LongRecurringHandler);break;case g.FunctionCall:"string"==typeof r.scriptName&&(r.url=r.scriptName),"number"==typeof r.scriptLine&&(r.lineNumber=r.scriptLine);case g.EvaluateScript:case g.CompileScript:case g.CacheScript:"number"==typeof r.lineNumber&&--r.lineNumber,"number"==typeof r.columnNumber&&--r.columnNumber;case g.RunMicrotasks:this.currentScriptEvent||(this.currentScriptEvent=e);break;case g.SetLayerTreeId:{if(this.sessionId&&r.sessionId&&this.sessionId===r.sessionId){this.mainFrameLayerTreeId=r.layerTreeId;break}const t=u.eventFrameId(e),n=t?this.pageFrames.get(t):null;if(!n||n.parent)return!1;this.mainFrameLayerTreeId=r.layerTreeId;break}case g.Paint:{if(this.invalidationTracker.didPaint=!0,"nodeId"in r&&n.backendNodeIds.push(r.nodeId),!r.layerId)break;const t=r.layerId;this.lastPaintForLayer[t]=e;break}case g.DisplayItemListSnapshot:case g.PictureSnapshot:{const t=this.findAncestorEvent(g.UpdateLayer);if(!t||t.args.layerTreeId!==this.mainFrameLayerTreeId)break;const r=this.lastPaintForLayer[t.args.layerId];r&&(F.forEvent(r).picture=e);break}case g.ScrollLayer:n.backendNodeIds.push(r.nodeId);break;case g.PaintImage:n.backendNodeIds.push(r.nodeId),n.url=r.url;break;case g.DecodeImage:case g.ResizeImage:{let e=this.findAncestorEvent(g.PaintImage);if(!e){const t=this.findAncestorEvent(g.DecodeLazyPixelRef);e=t&&this.paintImageEventByPixelRefId[t.args.LazyPixelRef]}if(!e)break;const t=F.forEvent(e);n.backendNodeIds.push(t.backendNodeIds[0]),n.url=t.url;break}case g.DrawLazyPixelRef:{const t=this.findAncestorEvent(g.PaintImage);if(!t)break;this.paintImageEventByPixelRefId[e.args.LazyPixelRef]=t;const r=F.forEvent(t);n.backendNodeIds.push(r.backendNodeIds[0]),n.url=r.url;break}case g.FrameStartedLoading:if(n.frameId!==e.args.frame)return!1;break;case g.MarkLCPCandidate:n.backendNodeIds.push(r.nodeId);break;case g.MarkDOMContent:case g.MarkLoad:{const t=u.eventFrameId(e);if(!t||!this.pageFrames.has(t))return!1;break}case g.CommitLoad:{if(this.browserFrameTracking)break;const t=u.eventFrameId(e),n=Boolean(r.isOutermostMainFrame??r.isMainFrame),a=t?this.pageFrames.get(t):null;if(a)a.update(e.startTime,r);else if(this.persistentIds){if(n)return!1;if(!this.addPageFrame(e,r))return!1}else if(r.page&&r.page!==this.legacyCurrentPage)return!1;if(n&&t){const e=this.pageFrames.get(t);e&&(this.mainFrame=e)}break}case g.FireIdleCallback:void 0!==e.duration&&e.duration>r.allottedMilliseconds+u.Thresholds.IdleCallbackAddon&&(n.warning=u.WarningType.IdleDeadlineExceeded)}return!0}processBrowserEvent(e){if(e.name!==g.ResourceWillSendRequest){if(e.hasCategory(a.TracingModel.DevToolsMetadataEventCategory)&&e.args.data){const t=e.args.data;if(e.name===u.DevToolsMetadataEvent.TracingStartedInBrowser){if(!t.persistentIds)return;this.browserFrameTracking=!0,this.mainFrameNodeId=t.frameTreeNodeId;return void(t.frames||[]).forEach((e=>{const t=e.parent&&this.pageFrames.get(e.parent);if(e.parent&&!t)return;let r=this.pageFrames.get(e.frame);r||(r=new v(e),this.pageFrames.set(r.frameId,r),t?t.addChild(r):this.mainFrame=r),r.update(this.minimumRecordTimeInternal,e)}))}if(e.name===u.DevToolsMetadataEvent.FrameCommittedInBrowser&&this.browserFrameTracking){let r=this.pageFrames.get(t.frame);if(!r){const e=t.parent&&this.pageFrames.get(t.parent);if(!e)return;r=new v(t),this.pageFrames.set(r.frameId,r),e.addChild(r)}return void r.update(e.startTime,t)}if(e.name===u.DevToolsMetadataEvent.ProcessReadyInBrowser&&this.browserFrameTracking){const e=this.pageFrames.get(t.frame);return void(e&&e.processReady(t.processPseudoId,t.processId))}if(e.name===u.DevToolsMetadataEvent.FrameDeletedInBrowser&&this.browserFrameTracking){const r=this.pageFrames.get(t.frame);return void(r&&(r.deletedTime=e.startTime))}if(e.name===u.DevToolsMetadataEvent.AuctionWorkletRunningInProcess&&this.browserFrameTracking){const r=new f(e,t);this.auctionWorklets.set(t.target,r)}if(e.name===u.DevToolsMetadataEvent.AuctionWorkletDoneWithProcess&&this.browserFrameTracking){const r=this.auctionWorklets.get(t.target);r&&(r.endTime=e.startTime)}}}else{const t=e.args?.data?.requestId;"string"==typeof t&&this.requestsFromBrowser.set(t,e)}}ensureNamedTrack(e){let t=this.namedTracks.get(e);return t||(t=new T,t.type=e,this.tracksInternal.push(t),this.namedTracks.set(e,t),t)}findAncestorEvent(e){for(let t=this.eventStack.length-1;t>=0;--t){const r=this.eventStack[t];if(r.name===e)return r}return null}addPageFrame(e,t){const r=t.parent&&this.pageFrames.get(t.parent);if(t.parent&&!r)return!1;const n=new v(t);return this.pageFrames.set(n.frameId,n),n.update(e.startTime,t),r&&r.addChild(n),!0}reset(){this.isGenericTraceInternal=!1,this.tracksInternal=[],this.namedTracks=new Map,this.inspectedTargetEventsInternal=[],this.timeMarkerEventsInternal=[],this.sessionId=null,this.mainFrameNodeId=null,this.cpuProfilesInternal=[],this.workerIdByThread=new WeakMap,this.pageFrames=new Map,this.auctionWorklets=new Map,this.requestsFromBrowser=new Map,this.minimumRecordTimeInternal=0,this.maximumRecordTimeInternal=0,this.totalBlockingTimeInternal=-1,this.estimatedTotalBlockingTime=0}isGenericTrace(){return this.isGenericTraceInternal}tracingModel(){return this.tracingModelInternal}minimumRecordTime(){return this.minimumRecordTimeInternal}maximumRecordTime(){return this.maximumRecordTimeInternal}inspectedTargetEvents(){return this.inspectedTargetEventsInternal}tracks(){return this.tracksInternal}isEmpty(){return 0===this.minimumRecordTime()&&0===this.maximumRecordTime()}timeMarkerEvents(){return this.timeMarkerEventsInternal}rootFrames(){return Array.from(this.pageFrames.values()).filter((e=>!e.parent))}pageURL(){return this.mainFrame&&this.mainFrame.url||r.DevToolsPath.EmptyUrlString}pageFrameById(e){return e&&this.pageFrames.get(e)||null}networkRequests(){if(this.isGenericTrace())return[];const e=new Map,t=[],r=[],n=new Set([g.ResourceWillSendRequest,g.ResourceSendRequest,g.ResourceReceiveResponse,g.ResourceReceivedData,g.ResourceFinish,g.ResourceMarkAsCached]),a=this.inspectedTargetEvents();for(let e=0;e<a.length;++e){const t=a[e];if(!n.has(t.name))continue;const r=u.globalEventId(t,"requestId"),i=t.args?.data?.requestId;if(t.name===g.ResourceSendRequest&&i&&this.requestsFromBrowser.has(i)){const e=this.requestsFromBrowser.get(i);e&&s(e,r)}s(t,r)}function s(n,a){let s=e.get(a);s?s.addEvent(n):(s=new y(n),e.set(a,s),s.startTime?t.push(s):r.push(s))}return r.concat(t)}}var g,p;!function(e){e.Task="RunTask",e.Program="Program",e.EventDispatch="EventDispatch",e.GPUTask="GPUTask",e.Animation="Animation",e.RequestMainThreadFrame="RequestMainThreadFrame",e.BeginFrame="BeginFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.BeginMainThreadFrame="BeginMainThreadFrame",e.ActivateLayerTree="ActivateLayerTree",e.DrawFrame="DrawFrame",e.DroppedFrame="DroppedFrame",e.HitTest="HitTest",e.ScheduleStyleRecalculation="ScheduleStyleRecalculation",e.RecalculateStyles="RecalculateStyles",e.UpdateLayoutTree="UpdateLayoutTree",e.InvalidateLayout="InvalidateLayout",e.Layout="Layout",e.LayoutShift="LayoutShift",e.UpdateLayer="UpdateLayer",e.UpdateLayerTree="UpdateLayerTree",e.PaintSetup="PaintSetup",e.Paint="Paint",e.PaintImage="PaintImage",e.PrePaint="PrePaint",e.Rasterize="Rasterize",e.RasterTask="RasterTask",e.ScrollLayer="ScrollLayer",e.CompositeLayers="CompositeLayers",e.ComputeIntersections="IntersectionObserverController::computeIntersections",e.InteractiveTime="InteractiveTime",e.ScheduleStyleInvalidationTracking="ScheduleStyleInvalidationTracking",e.StyleRecalcInvalidationTracking="StyleRecalcInvalidationTracking",e.StyleInvalidatorInvalidationTracking="StyleInvalidatorInvalidationTracking",e.LayoutInvalidationTracking="LayoutInvalidationTracking",e.ParseHTML="ParseHTML",e.ParseAuthorStyleSheet="ParseAuthorStyleSheet",e.TimerInstall="TimerInstall",e.TimerRemove="TimerRemove",e.TimerFire="TimerFire",e.XHRReadyStateChange="XHRReadyStateChange",e.XHRLoad="XHRLoad",e.CompileScript="v8.compile",e.CompileCode="V8.CompileCode",e.OptimizeCode="V8.OptimizeCode",e.EvaluateScript="EvaluateScript",e.CacheScript="v8.produceCache",e.CompileModule="v8.compileModule",e.EvaluateModule="v8.evaluateModule",e.CacheModule="v8.produceModuleCache",e.WasmStreamFromResponseCallback="v8.wasm.streamFromResponseCallback",e.WasmCompiledModule="v8.wasm.compiledModule",e.WasmCachedModule="v8.wasm.cachedModule",e.WasmModuleCacheHit="v8.wasm.moduleCacheHit",e.WasmModuleCacheInvalid="v8.wasm.moduleCacheInvalid",e.FrameStartedLoading="FrameStartedLoading",e.CommitLoad="CommitLoad",e.MarkLoad="MarkLoad",e.MarkDOMContent="MarkDOMContent",e.MarkFirstPaint="firstPaint",e.MarkFCP="firstContentfulPaint",e.MarkLCPCandidate="largestContentfulPaint::Candidate",e.MarkLCPInvalidate="largestContentfulPaint::Invalidate",e.NavigationStart="navigationStart",e.TimeStamp="TimeStamp",e.ConsoleTime="ConsoleTime",e.UserTiming="UserTiming",e.EventTiming="EventTiming",e.ResourceWillSendRequest="ResourceWillSendRequest",e.ResourceSendRequest="ResourceSendRequest",e.ResourceReceiveResponse="ResourceReceiveResponse",e.ResourceReceivedData="ResourceReceivedData",e.ResourceFinish="ResourceFinish",e.ResourceMarkAsCached="ResourceMarkAsCached",e.RunMicrotasks="RunMicrotasks",e.FunctionCall="FunctionCall",e.GCEvent="GCEvent",e.MajorGC="MajorGC",e.MinorGC="MinorGC",e.JSFrame="JSFrame",e.JSSample="JSSample",e.V8Sample="V8Sample",e.JitCodeAdded="JitCodeAdded",e.JitCodeMoved="JitCodeMoved",e.StreamingCompileScript="v8.parseOnBackground",e.StreamingCompileScriptWaiting="v8.parseOnBackgroundWaiting",e.StreamingCompileScriptParsing="v8.parseOnBackgroundParsing",e.V8Execute="V8.Execute",e.UpdateCounters="UpdateCounters",e.RequestAnimationFrame="RequestAnimationFrame",e.CancelAnimationFrame="CancelAnimationFrame",e.FireAnimationFrame="FireAnimationFrame",e.RequestIdleCallback="RequestIdleCallback",e.CancelIdleCallback="CancelIdleCallback",e.FireIdleCallback="FireIdleCallback",e.WebSocketCreate="WebSocketCreate",e.WebSocketSendHandshakeRequest="WebSocketSendHandshakeRequest",e.WebSocketReceiveHandshakeResponse="WebSocketReceiveHandshakeResponse",e.WebSocketDestroy="WebSocketDestroy",e.EmbedderCallback="EmbedderCallback",e.SetLayerTreeId="SetLayerTreeId",e.TracingStartedInPage="TracingStartedInPage",e.TracingSessionIdForWorker="TracingSessionIdForWorker",e.DecodeImage="Decode Image",e.ResizeImage="Resize Image",e.DrawLazyPixelRef="Draw LazyPixelRef",e.DecodeLazyPixelRef="Decode LazyPixelRef",e.LazyPixelRef="LazyPixelRef",e.LayerTreeHostImplSnapshot="cc::LayerTreeHostImpl",e.PictureSnapshot="cc::Picture",e.DisplayItemListSnapshot="cc::DisplayItemList",e.LatencyInfo="LatencyInfo",e.LatencyInfoFlow="LatencyInfo.Flow",e.InputLatencyMouseMove="InputLatency::MouseMove",e.InputLatencyMouseWheel="InputLatency::MouseWheel",e.ImplSideFling="InputHandlerProxy::HandleGestureFling::started",e.GCCollectGarbage="BlinkGC.AtomicPhase",e.CryptoDoEncrypt="DoEncrypt",e.CryptoDoEncryptReply="DoEncryptReply",e.CryptoDoDecrypt="DoDecrypt",e.CryptoDoDecryptReply="DoDecryptReply",e.CryptoDoDigest="DoDigest",e.CryptoDoDigestReply="DoDigestReply",e.CryptoDoSign="DoSign",e.CryptoDoSignReply="DoSignReply",e.CryptoDoVerify="DoVerify",e.CryptoDoVerifyReply="DoVerifyReply",e.CpuProfile="CpuProfile",e.Profile="Profile",e.AsyncTask="AsyncTask"}(g||(g={})),function(e){let t;e.Category={Console:"blink.console",UserTiming:"blink.user_timing",LatencyInfo:"latencyInfo",Loading:"loading"},function(e){e.LongTask="LongTask",e.ForcedStyle="ForcedStyle",e.ForcedLayout="ForcedLayout",e.IdleDeadlineExceeded="IdleDeadlineExceeded",e.LongHandler="LongHandler",e.LongRecurringHandler="LongRecurringHandler",e.V8Deopt="V8Deopt"}(t=e.WarningType||(e.WarningType={})),e.WorkerThreadName="DedicatedWorker thread",e.WorkerThreadNameLegacy="DedicatedWorker Thread",e.RendererMainThreadName="CrRendererMain",e.BrowserMainThreadName="CrBrowserMain",e.UtilityMainThreadName="CrUtilityMain",e.AuctionWorkletThreadName="AuctionV8HelperThread",e.DevToolsMetadataEvent={TracingStartedInBrowser:"TracingStartedInBrowser",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",FrameCommittedInBrowser:"FrameCommittedInBrowser",ProcessReadyInBrowser:"ProcessReadyInBrowser",FrameDeletedInBrowser:"FrameDeletedInBrowser",AuctionWorkletRunningInProcess:"AuctionWorkletRunningInProcess",AuctionWorkletDoneWithProcess:"AuctionWorkletDoneWithProcess"},e.Thresholds={LongTask:50,Handler:150,RecurringHandler:50,ForcedLayout:30,IdleCallbackAddon:5}}(u||(u={}));class T{name;type;forMainFrame;url;events;asyncEvents;tasks;syncEventsInternal;thread;constructor(){this.name="",this.type=p.Other,this.forMainFrame=!1,this.url=r.DevToolsPath.EmptyUrlString,this.events=[],this.asyncEvents=[],this.tasks=[],this.syncEventsInternal=null,this.thread=null}syncEvents(){if(this.events.length)return this.events;if(this.syncEventsInternal)return this.syncEventsInternal;const e=[];function t(){const t=e[e.length-1];if(void 0!==t){const e=t.endTime;if(void 0!==e)return e}throw new Error("End time does not exist on event.")}this.syncEventsInternal=[];for(const r of this.asyncEvents){const n=r.startTime;let s=r.endTime;for(void 0===s&&(s=n);e.length&&n>=t();)e.pop();if(e.length&&s>t()){this.syncEventsInternal=[];break}const i=new a.TracingModel.Event(r.categoriesString,r.name,a.TracingModel.Phase.Complete,n,r.thread);i.setEndTime(s),i.addArgs(r.args),this.syncEventsInternal.push(i),e.push(i)}return this.syncEventsInternal}}!function(e){e.MainThread="MainThread",e.Worker="Worker",e.Animation="Animation",e.Timings="Timings",e.Console="Console",e.Raster="Raster",e.GPU="GPU",e.Experience="Experience",e.Other="Other",e.UserInteractions="UserInteractions"}(p||(p={}));class v{frameId;url;name;children;parent;processes;deletedTime;ownerNode;constructor(e){this.frameId=e.frame,this.url=e.url||r.DevToolsPath.EmptyUrlString,this.name=e.name,this.children=[],this.parent=null,this.processes=[],this.deletedTime=null,this.ownerNode=null}update(e,t){this.url=t.url||"",this.name=t.name,t.processId?this.processes.push({time:e,processId:t.processId,processPseudoId:"",url:t.url||""}):this.processes.push({time:e,processId:-1,processPseudoId:t.processPseudoId,url:t.url||""})}processReady(e,t){for(const r of this.processes)r.processPseudoId===e&&(r.processPseudoId="",r.processId=t)}addChild(e){this.children.push(e),e.parent=this}}class f{targetId;processId;host;startTime;endTime;workletType;constructor(e,t){this.targetId="string"==typeof t.target?t.target:"",this.processId="number"==typeof t.pid?t.pid:0,this.host="string"==typeof t.host?t.host:void 0,this.startTime=e.startTime,this.endTime=1/0,"bidder"===t.type?this.workletType=1:"seller"===t.type?this.workletType=2:this.workletType=3}}class y{startTime;endTime;encodedDataLength;decodedBodyLength;children;timing;mimeType;url;requestMethod;transferSize;maybeDiskCached;memoryCachedInternal;priority;finishTime;responseTime;fromServiceWorker;hasCachedResource;constructor(e){const t=e.name===g.ResourceSendRequest||e.name===g.ResourceWillSendRequest;this.startTime=t?e.startTime:0,this.endTime=1/0,this.encodedDataLength=0,this.decodedBodyLength=0,this.children=[],this.transferSize=0,this.maybeDiskCached=!1,this.memoryCachedInternal=!1,this.addEvent(e)}addEvent(e){this.children.push(e),this.startTime=Math.min(this.startTime,e.startTime);const t=e.args.data;t.mimeType&&(this.mimeType=t.mimeType),"priority"in t&&(this.priority=t.priority),e.name===g.ResourceFinish&&(this.endTime=e.startTime),t.finishTime&&(this.finishTime=1e3*t.finishTime),this.responseTime||e.name!==g.ResourceReceiveResponse&&e.name!==g.ResourceReceivedData||(this.responseTime=e.startTime);const r=t.encodedDataLength||0;e.name===g.ResourceMarkAsCached&&(this.memoryCachedInternal=!0),e.name===g.ResourceReceiveResponse&&(t.fromCache&&(this.maybeDiskCached=!0),t.fromServiceWorker&&(this.fromServiceWorker=!0),t.hasCachedResource&&(this.hasCachedResource=!0),this.encodedDataLength=r),e.name===g.ResourceReceivedData&&(this.encodedDataLength+=r),e.name===g.ResourceFinish&&r&&(this.encodedDataLength=r,this.transferSize=r);const n=t.decodedBodyLength;e.name===g.ResourceFinish&&n&&(this.decodedBodyLength=n),this.url||(this.url=t.url),this.requestMethod||(this.requestMethod=t.requestMethod),this.timing||(this.timing=t.timing),t.fromServiceWorker&&(this.fromServiceWorker=!0)}cached(){return Boolean(this.memoryCachedInternal)||Boolean(this.maybeDiskCached)&&!this.transferSize&&!this.fromServiceWorker}memoryCached(){return this.memoryCachedInternal}getSendReceiveTiming(){if(this.cached()||!this.timing)return{sendStartTime:this.startTime,headersEndTime:this.startTime};const e=1e3*this.timing.requestTime;return{sendStartTime:e+this.timing.sendStart,headersEndTime:e+this.timing.receiveHeadersEnd}}getStartTime(){return Math.min(this.startTime,!this.cached()&&this.timing&&1e3*this.timing.requestTime||1/0)}beginTime(){return Math.min(this.getStartTime(),!this.cached()&&this.timing&&1e3*this.timing.pushStart||1/0)}}class I{type;startTime;tracingEvent;frame;nodeId;nodeName;invalidationSet;invalidatedSelectorId;changedId;changedClass;changedAttribute;changedPseudo;selectorPart;extraData;invalidationList;cause;linkedRecalcStyleEvent;linkedLayoutEvent;constructor(e,t){this.type=e.name,this.startTime=e.startTime,this.tracingEvent=e;const r=e.args.data;this.frame=r.frame,this.nodeId=r.nodeId,this.nodeName=r.nodeName,this.invalidationSet=r.invalidationSet,this.invalidatedSelectorId=r.invalidatedSelectorId,this.changedId=r.changedId,this.changedClass=r.changedClass,this.changedAttribute=r.changedAttribute,this.changedPseudo=r.changedPseudo,this.selectorPart=r.selectorPart,this.extraData=r.extraData,this.invalidationList=r.invalidationList,this.cause={reason:r.reason,stackTrace:t.stackTrace},this.linkedRecalcStyleEvent=!1,this.linkedLayoutEvent=!1,!this.cause.reason&&this.cause.stackTrace&&this.type===g.LayoutInvalidationTracking&&(this.cause.reason="Layout forced")}}class k{lastRecalcStyle;lastPaintWithLayer;didPaint;invalidations;invalidationsByNodeId;constructor(){this.lastRecalcStyle=null,this.lastPaintWithLayer=null,this.didPaint=!1,this.initializePerFrameState(),this.invalidations={},this.invalidationsByNodeId={}}static invalidationEventsFor(e){return E.get(e)||null}addInvalidation(e){if(this.startNewFrameIfNeeded(),!e.nodeId)return console.error("Invalidation lacks node information."),void console.error(e);if(e.type===g.StyleRecalcInvalidationTracking&&"StyleInvalidator"===e.cause.reason)return;if(e.type===g.ScheduleStyleInvalidationTracking||e.type===g.StyleInvalidatorInvalidationTracking||e.type===g.StyleRecalcInvalidationTracking){e.startTime&&this.lastRecalcStyle&&void 0!==this.lastRecalcStyle.endTime&&e.startTime>=this.lastRecalcStyle.startTime&&e.startTime<=this.lastRecalcStyle.endTime&&this.associateWithLastRecalcStyleEvent(e)}this.invalidations[e.type]?this.invalidations[e.type].push(e):this.invalidations[e.type]=[e],e.nodeId&&(this.invalidationsByNodeId[e.nodeId]?this.invalidationsByNodeId[e.nodeId].push(e):this.invalidationsByNodeId[e.nodeId]=[e])}didRecalcStyle(e){this.lastRecalcStyle=e;const t=[g.ScheduleStyleInvalidationTracking,g.StyleInvalidatorInvalidationTracking,g.StyleRecalcInvalidationTracking];for(const e of this.invalidationsOfTypes(t))this.associateWithLastRecalcStyleEvent(e)}associateWithLastRecalcStyleEvent(e){if(e.linkedRecalcStyleEvent)return;if(!this.lastRecalcStyle)throw new Error("Last recalculate style event not set.");const t=this.lastRecalcStyle.args.beginData.frame;e.type===g.StyleInvalidatorInvalidationTracking?this.addSyntheticStyleRecalcInvalidations(this.lastRecalcStyle,t,e):e.type===g.ScheduleStyleInvalidationTracking||this.addInvalidationToEvent(this.lastRecalcStyle,t,e),e.linkedRecalcStyleEvent=!0}addSyntheticStyleRecalcInvalidations(e,t,r){if(r.invalidationList){if(!r.nodeId)return console.error("Invalidation lacks node information."),void console.error(r);for(let e=0;e<r.invalidationList.length;e++){const n=r.invalidationList[e].id;let a;const s=this.invalidationsByNodeId[r.nodeId]||[];for(let e=0;e<s.length;e++){const r=s[e];r.frame===t&&r.invalidationSet===n&&r.type===g.ScheduleStyleInvalidationTracking&&(a=r)}a&&this.addSyntheticStyleRecalcInvalidation(a.tracingEvent,r)}}else this.addSyntheticStyleRecalcInvalidation(r.tracingEvent,r)}addSyntheticStyleRecalcInvalidation(e,t){const r=F.forEvent(e),n=new I(e,r);n.type=g.StyleRecalcInvalidationTracking,t.cause.reason&&(n.cause.reason=t.cause.reason),t.selectorPart&&(n.selectorPart=t.selectorPart),n.linkedRecalcStyleEvent||this.associateWithLastRecalcStyleEvent(n)}didLayout(e){const t=e.args.beginData.frame;for(const r of this.invalidationsOfTypes([g.LayoutInvalidationTracking]))r.linkedLayoutEvent||(this.addInvalidationToEvent(e,t,r),r.linkedLayoutEvent=!0)}addInvalidationToEvent(e,t,r){if(t!==r.frame)return;const n=E.get(e);n?n.push(r):E.set(e,[r])}invalidationsOfTypes(e){const t=this.invalidations;return e||(e=Object.keys(t)),function*(){if(e)for(let r=0;r<e.length;++r){const n=t[e[r]]||[];for(let e=0;e<n.length;++e)yield n[e]}}()}startNewFrameIfNeeded(){this.didPaint&&this.initializePerFrameState()}initializePerFrameState(){this.invalidations={},this.invalidationsByNodeId={},this.lastRecalcStyle=null,this.lastPaintWithLayer=null,this.didPaint=!1}}class S{initiatorByType;constructor(){if(S.initialize(),this.initiatorByType=new Map,S.asyncEvents)for(const e of S.asyncEvents.keys())this.initiatorByType.set(e,new Map)}static initialize(){if(S.asyncEvents)return;const e=new Map;e.set(g.TimerInstall,{causes:[g.TimerFire],joinBy:"timerId"}),e.set(g.ResourceSendRequest,{causes:[g.ResourceMarkAsCached,g.ResourceReceiveResponse,g.ResourceReceivedData,g.ResourceFinish],joinBy:"requestId"}),e.set(g.RequestAnimationFrame,{causes:[g.FireAnimationFrame],joinBy:"id"}),e.set(g.RequestIdleCallback,{causes:[g.FireIdleCallback],joinBy:"id"}),e.set(g.WebSocketCreate,{causes:[g.WebSocketSendHandshakeRequest,g.WebSocketReceiveHandshakeResponse,g.WebSocketDestroy],joinBy:"identifier"}),S.asyncEvents=e,S.typeToInitiator=new Map;for(const t of e){const e=t[1].causes;for(const r of e)S.typeToInitiator.set(r,t[0])}}processEvent(e){if(!S.typeToInitiator||!S.asyncEvents)return;let t=S.typeToInitiator.get(e.name);const r=!t;t||(t=e.name);const n=S.asyncEvents.get(t);if(!n)return;const a=u.globalEventId(e,n.joinBy);if(!a)return;const s=this.initiatorByType.get(t);if(s){if(r)return void s.set(a,e);const t=s.get(a),n=F.forEvent(e);n.setInitiator(t||null),!n.frameId&&t&&(n.frameId=u.eventFrameId(t))}}static asyncEvents=null;static typeToInitiator=null}class F{warning;previewElement;url;backendNodeIds;stackTrace;picture;initiatorInternal;frameId;timeWaitingForMainThread;constructor(){this.warning=null,this.previewElement=null,this.url=null,this.backendNodeIds=[],this.stackTrace=null,this.picture=null,this.initiatorInternal=null,this.frameId=null}setInitiator(e){if(this.initiatorInternal=e,!e||this.url)return;const t=F.forEvent(e).url;t&&(this.url=t)}initiator(){return this.initiatorInternal}topFrame(){const e=this.stackTraceForSelfOrInitiator();return e&&e[0]||null}stackTraceForSelfOrInitiator(){return this.stackTrace||this.initiatorInternal&&F.forEvent(this.initiatorInternal).stackTrace}static forEvent(e){let t=R.get(e);return t||(t=new F,R.set(e,t)),t}}const R=new WeakMap,E=new WeakMap;var C=Object.freeze({__proto__:null,get TimelineModelImpl(){return u},get RecordType(){return g},Track:T,get TrackType(){return p},PageFrame:v,AuctionWorklet:f,NetworkRequest:y,InvalidationTrackingEvent:I,InvalidationTracker:k,TimelineAsyncEventTracker:S,TimelineData:F});class P{accept(e){return!0}}class M extends P{visibleTypes;constructor(e){super(),this.visibleTypes=new Set(e)}accept(e){return this.visibleTypes.has(M.eventType(e))}static eventType(e){return e.hasCategory(u.Category.Console)?g.ConsoleTime:e.hasCategory(u.Category.UserTiming)?g.UserTiming:e.hasCategory(u.Category.LatencyInfo)?g.LatencyInfo:e.name}}var w=Object.freeze({__proto__:null,TimelineModelFilter:P,TimelineVisibleEventsFilter:M,TimelineInvisibleEventsFilter:class extends P{invisibleTypes;constructor(e){super(),this.invisibleTypes=new Set(e)}accept(e){return!this.invisibleTypes.has(M.eventType(e))}},ExclusiveNameFilter:class extends P{excludeNames;constructor(e){super(),this.excludeNames=new Set(e)}accept(e){return!this.excludeNames.has(e.name)}}});class b extends a.LayerTreeBase.LayerTreeBase{tileById;paintProfilerModel;constructor(e){super(e),this.tileById=new Map,this.paintProfilerModel=e&&e.model(a.PaintProfiler.PaintProfilerModel)}async setLayers(e,t,r){const n=new Set;if(e)this.extractNodeIdsToResolve(n,{},e);else if(t)for(let e=0;e<t.length;++e)this.extractNodeIdsToResolve(n,{},t[e]);await this.resolveBackendNodeIds(n);const a=this.layersById;if(this.layersById=new Map,this.setContentRoot(null),e){const t=this.innerSetLayers(a,e);this.setRoot(t)}else if(t){const e=t.map(this.innerSetLayers.bind(this,a)),r=this.contentRoot();if(!r)throw new Error("Content root is not set.");this.setRoot(r);for(let t=0;t<e.length;++t)e[t].id()!==r.id()&&r.addChild(e[t])}this.setPaints(r)}setTiles(e){this.tileById=new Map;for(const t of e)this.tileById.set(t.id,t)}pictureForRasterTile(t){const r=this.tileById.get("cc::Tile/"+t);if(!r)return e.Console.Console.instance().error(`Tile ${t} is missing`),Promise.resolve(null);const n=this.layerById(r.layer_id);return n?n.pictureForRect(r.content_rect):(e.Console.Console.instance().error(`Layer ${r.layer_id} for tile ${t} is not found`),Promise.resolve(null))}setPaints(e){for(let t=0;t<e.length;++t){const r=this.layersById.get(e[t].layerId());r&&r.addPaintEvent(e[t])}}innerSetLayers(e,t){let r=e.get(t.layer_id);r?r.reset(t):r=new L(this.paintProfilerModel,t),this.layersById.set(t.layer_id,r),t.owner_node&&r.setNode(this.backendNodeIdToNode().get(t.owner_node)||null),!this.contentRoot()&&r.drawsContent()&&this.setContentRoot(r);for(let n=0;t.children&&n<t.children.length;++n)r.addChild(this.innerSetLayers(e,t.children[n]));return r}extractNodeIdsToResolve(e,t,r){const n=r.owner_node;n&&!this.backendNodeIdToNode().has(n)&&e.add(n);for(let n=0;r.children&&n<r.children.length;++n)this.extractNodeIdsToResolve(e,t,r.children[n])}}class L{parentLayerId;parentInternal;layerId;nodeInternal;offsetXInternal;offsetYInternal;widthInternal;heightInternal;childrenInternal;quadInternal;scrollRectsInternal;gpuMemoryUsageInternal;paints;compositingReasonIds;drawsContentInternal;paintProfilerModel;constructor(e,t){this.parentLayerId=null,this.parentInternal=null,this.layerId="",this.nodeInternal=null,this.offsetXInternal=-1,this.offsetYInternal=-1,this.widthInternal=-1,this.heightInternal=-1,this.childrenInternal=[],this.quadInternal=[],this.scrollRectsInternal=[],this.gpuMemoryUsageInternal=-1,this.paints=[],this.compositingReasonIds=[],this.drawsContentInternal=!1,this.paintProfilerModel=e,this.reset(t)}reset(e){this.nodeInternal=null,this.layerId=String(e.layer_id),this.offsetXInternal=e.position[0],this.offsetYInternal=e.position[1],this.widthInternal=e.bounds.width,this.heightInternal=e.bounds.height,this.childrenInternal=[],this.parentLayerId=null,this.parentInternal=null,this.quadInternal=e.layer_quad||[],this.createScrollRects(e),this.compositingReasonIds=e.compositing_reason_ids||e.debug_info&&e.debug_info.compositing_reason_ids||[],this.drawsContentInternal=Boolean(e.draws_content),this.gpuMemoryUsageInternal=e.gpu_memory_usage,this.paints=[]}id(){return this.layerId}parentId(){return this.parentLayerId}parent(){return this.parentInternal}isRoot(){return!this.parentId()}children(){return this.childrenInternal}addChild(e){const t=e;t.parentInternal&&console.assert(!1,"Child already has a parent"),this.childrenInternal.push(t),t.parentInternal=this,t.parentLayerId=this.layerId}setNode(e){this.nodeInternal=e}node(){return this.nodeInternal}nodeForSelfOrAncestor(){let e=this;for(;e;e=e.parent())if(e.node())return e.node();return null}offsetX(){return this.offsetXInternal}offsetY(){return this.offsetYInternal}width(){return this.widthInternal}height(){return this.heightInternal}transform(){return null}quad(){return this.quadInternal}anchorPoint(){return[.5,.5,0]}invisible(){return!1}paintCount(){return 0}lastPaintRect(){return null}scrollRects(){return this.scrollRectsInternal}stickyPositionConstraint(){return null}gpuMemoryUsage(){return this.gpuMemoryUsageInternal}snapshots(){return this.paints.map((e=>e.snapshotPromise().then((e=>{if(!e)return null;return{rect:{x:e.rect[0],y:e.rect[1],width:e.rect[2],height:e.rect[3]},snapshot:e.snapshot}}))))}pictureForRect(e){return Promise.all(this.paints.map((e=>e.picturePromise()))).then((r=>{const n=r.filter((r=>{return r&&(n=r.rect,a=e,t(n[0],n[0]+n[2],a[0],a[0]+a[2])&&t(n[1],n[1]+n[3],a[1],a[1]+a[3]));var n,a})).map((e=>({x:e.rect[0],y:e.rect[1],picture:e.serializedPicture})));if(!n.length||!this.paintProfilerModel)return null;const a=n.reduce(((e,t)=>Math.min(e,t.x)),1/0),s=n.reduce(((e,t)=>Math.min(e,t.y)),1/0),i={x:e[0]-a,y:e[1]-s,width:e[2],height:e[3]};return this.paintProfilerModel.loadSnapshotFromFragments(n).then((e=>e?{rect:i,snapshot:e}:null))}));function t(e,t,r,n){return console.assert(e<=t&&r<=n,"segments should be specified as ordered pairs"),t>r&&e<n}}scrollRectsFromParams(e,t){return{rect:{x:e[0],y:e[1],width:e[2],height:e[3]},type:t}}createScrollRects(e){const t=[];e.non_fast_scrollable_region&&t.push(this.scrollRectsFromParams(e.non_fast_scrollable_region,"NonFastScrollable")),e.touch_event_handler_region&&t.push(this.scrollRectsFromParams(e.touch_event_handler_region,"TouchEventHandler")),e.wheel_event_handler_region&&t.push(this.scrollRectsFromParams(e.wheel_event_handler_region,"WheelEventHandler")),e.scroll_event_handler_region&&t.push(this.scrollRectsFromParams(e.scroll_event_handler_region,"RepaintsOnScroll")),this.scrollRectsInternal=t}addPaintEvent(e){this.paints.push(e)}requestCompositingReasonIds(){return Promise.resolve(this.compositingReasonIds)}drawsContent(){return this.drawsContentInternal}}var B=Object.freeze({__proto__:null,TracingLayerTree:b,TracingLayer:L});const D={twoFlingsAtTheSameTimeSVsS:"Two flings at the same time? {PH1} vs {PH2}",twoTouchesAtTheSameTimeSVsS:"Two touches at the same time? {PH1} vs {PH2}"},N=t.i18n.registerUIStrings("models/timeline_model/TimelineIRModel.ts",D),A=t.i18n.getLocalizedString.bind(void 0,N),W=new WeakMap;class _{segments;drags;cssAnimations;responses;scrolls;constructor(){this.reset()}static phaseForEvent(e){return W.get(e)}populate(t,r){if(this.reset(),!t)return;this.processInputLatencies(t),r&&this.processAnimations(r);const n=new e.SegmentedRange.SegmentedRange;n.appendRange(this.drags),n.appendRange(this.cssAnimations),n.appendRange(this.scrolls),n.appendRange(this.responses),this.segments=n.segments()}processInputLatencies(t){const r=x,n=U,a=_._mergeThresholdsMs;let s,i,o,l,d,c,h;for(let u=0;u<t.length;++u){const g=t[u];u>0&&t[u].startTime<t[u-1].startTime&&console.assert(!1,"Unordered input events");switch(this.inputEventType(g.name)){case r.ScrollBegin:this.scrolls.append(this.segmentForEvent(g,n.Scroll)),s=g;break;case r.ScrollEnd:s?this.scrolls.append(this.segmentForEventRange(s,g,n.Scroll)):this.scrolls.append(this.segmentForEvent(g,n.Scroll)),s=null;break;case r.ScrollUpdate:o=null,this.scrolls.append(this.segmentForEvent(g,n.Scroll));break;case r.FlingStart:if(i){e.Console.Console.instance().error(A(D.twoFlingsAtTheSameTimeSVsS,{PH1:i.startTime,PH2:g.startTime}));break}i=g;break;case r.FlingCancel:if(!i)break;this.scrolls.append(this.segmentForEventRange(i,g,n.Fling)),i=null;break;case r.ImplSideFling:this.scrolls.append(this.segmentForEvent(g,n.Fling));break;case r.ShowPress:case r.Tap:case r.KeyDown:case r.KeyDownRaw:case r.KeyUp:case r.Char:case r.Click:case r.ContextMenu:this.responses.append(this.segmentForEvent(g,n.Response));break;case r.TouchStart:if(o){e.Console.Console.instance().error(A(D.twoTouchesAtTheSameTimeSVsS,{PH1:o.startTime,PH2:g.startTime}));break}o=g,this.setPhaseForEvent(g,n.Response),l=null;break;case r.TouchCancel:o=null;break;case r.TouchMove:l?this.drags.append(this.segmentForEvent(g,n.Drag)):o&&(l=g,this.responses.append(this.segmentForEventRange(o,g,n.Response)));break;case r.TouchEnd:o=null;break;case r.MouseDown:c=g,h=null;break;case r.MouseMove:c&&!h&&c.startTime+a.mouse>g.startTime?(this.responses.append(this.segmentForEvent(c,n.Response)),this.responses.append(this.segmentForEvent(g,n.Response))):c&&this.drags.append(this.segmentForEvent(g,n.Drag)),h=g;break;case r.MouseUp:this.responses.append(this.segmentForEvent(g,n.Response)),c=null;break;case r.MouseWheel:d&&m(a.mouse,d,g)?this.scrolls.append(this.segmentForEventRange(d,g,n.Scroll)):this.scrolls.append(this.segmentForEvent(g,n.Scroll)),d=g}}function m(e,t,r){return void 0!==t.endTime&&(t.endTime<r.startTime&&r.startTime<t.endTime+e)}}processAnimations(e){for(let t=0;t<e.length;++t)this.cssAnimations.append(this.segmentForEvent(e[t],U.Animation))}segmentForEvent(t,r){return this.setPhaseForEvent(t,r),new e.SegmentedRange.Segment(t.startTime,void 0!==t.endTime?t.endTime:Number.MAX_SAFE_INTEGER,r)}segmentForEventRange(t,r,n){return this.setPhaseForEvent(t,n),this.setPhaseForEvent(r,n),new e.SegmentedRange.Segment(t.startTime,void 0!==t.endTime?t.endTime:Number.MAX_SAFE_INTEGER,n)}setPhaseForEvent(e,t){W.set(e.steps[0],t)}interactionRecords(){return this.segments}reset(){const t=_._mergeThresholdsMs;function r(e,t,r){return t.end+e>=r.begin&&t.data===r.data?t:null}this.segments=[],this.drags=new e.SegmentedRange.SegmentedRange(r.bind(null,t.mouse)),this.cssAnimations=new e.SegmentedRange.SegmentedRange(r.bind(null,t.animation)),this.responses=new e.SegmentedRange.SegmentedRange(r.bind(null,0)),this.scrolls=new e.SegmentedRange.SegmentedRange(r.bind(null,t.animation))}inputEventType(e){const t="InputLatency::";if(!e.startsWith(t)){const t=e;return t===x.ImplSideFling?t:(console.error("Unrecognized input latency event: "+e),null)}return e.substr(t.length)}}var U,x;!function(e){e.Idle="Idle",e.Response="Response",e.Scroll="Scroll",e.Fling="Fling",e.Drag="Drag",e.Animation="Animation",e.Uncategorized="Uncategorized"}(U||(U={})),function(e){e.Char="Char",e.Click="GestureClick",e.ContextMenu="ContextMenu",e.FlingCancel="GestureFlingCancel",e.FlingStart="GestureFlingStart",e.ImplSideFling="InputHandlerProxy::HandleGestureFling::started",e.KeyDown="KeyDown",e.KeyDownRaw="RawKeyDown",e.KeyUp="KeyUp",e.LatencyScrollUpdate="ScrollUpdate",e.MouseDown="MouseDown",e.MouseMove="MouseMove",e.MouseUp="MouseUp",e.MouseWheel="MouseWheel",e.PinchBegin="GesturePinchBegin",e.PinchEnd="GesturePinchEnd",e.PinchUpdate="GesturePinchUpdate",e.ScrollBegin="GestureScrollBegin",e.ScrollEnd="GestureScrollEnd",e.ScrollUpdate="GestureScrollUpdate",e.ScrollUpdateRenderer="ScrollUpdate",e.ShowPress="GestureShowPress",e.Tap="GestureTap",e.TapCancel="GestureTapCancel",e.TapDown="GestureTapDown",e.TouchCancel="TouchCancel",e.TouchEnd="TouchEnd",e.TouchMove="TouchMove",e.TouchStart="TouchStart"}(x||(x={})),function(e){e._mergeThresholdsMs={animation:1,mouse:40},e._eventIRPhase=Symbol("eventIRPhase")}(_||(_={}));var G=Object.freeze({__proto__:null,get TimelineIRModel(){return _},get Phases(){return U},get InputEvents(){return x}});class H{categoryMapper;frames;frameById;beginFrameQueue;minimumRecordTime;lastFrame;mainFrameCommitted;mainFrameRequested;lastLayerTree;framePendingActivation;currentTaskTimeByCategory;target;framePendingCommit;lastBeginFrame;lastDroppedFrame;lastNeedsBeginFrame;lastTaskBeginTime;layerTreeId;currentProcessMainThread;constructor(e){this.categoryMapper=e,this.reset()}getFrames(){return this.frames}getFramesWithinWindow(e,t){const n=r.ArrayUtilities.lowerBound(this.frames,e||0,((e,t)=>e-t.endTime)),a=r.ArrayUtilities.lowerBound(this.frames,t||1/0,((e,t)=>e-t.startTime));return this.frames.slice(n,a)}hasRasterTile(e){const t=e.args.tileData;if(!t)return!1;const r=t.sourceFrameNumber,n=r&&this.frameById[r];return!(!n||!n.layerTree)}rasterTilePromise(e){if(!this.target)return Promise.resolve(null);const t=e.args.tileData,r=t.sourceFrameNumber,n=t.tileId&&t.tileId.id_ref,a=r&&this.frameById[r];return a&&a.layerTree&&n?a.layerTree.layerTreePromise().then((e=>e&&e.pictureForRasterTile(n))):Promise.resolve(null)}reset(){this.minimumRecordTime=1/0,this.frames=[],this.frameById={},this.beginFrameQueue=new J,this.lastFrame=null,this.lastLayerTree=null,this.mainFrameCommitted=!1,this.mainFrameRequested=!1,this.framePendingCommit=null,this.lastBeginFrame=null,this.lastDroppedFrame=null,this.lastNeedsBeginFrame=null,this.framePendingActivation=null,this.lastTaskBeginTime=null,this.target=null,this.layerTreeId=null,this.currentTaskTimeByCategory={}}handleBeginFrame(e,t){this.lastFrame||this.startFrame(e),this.lastBeginFrame=e,this.beginFrameQueue.addFrameIfNotExists(t,e,!1,!1)}handleDroppedFrame(e,t,r){this.lastFrame||this.startFrame(e),this.beginFrameQueue.addFrameIfNotExists(t,e,!0,r),this.beginFrameQueue.setDropped(t,!0),this.beginFrameQueue.setPartial(t,r)}handleDrawFrame(e,t){if(this.lastFrame){if(this.mainFrameCommitted||!this.mainFrameRequested){if(this.lastNeedsBeginFrame){(this.framePendingActivation?this.framePendingActivation.triggerTime:this.lastBeginFrame||this.lastNeedsBeginFrame)>this.lastFrame.startTime&&(this.lastFrame.idle=!0,this.lastBeginFrame=null),this.lastNeedsBeginFrame=null}const e=this.beginFrameQueue.processPendingBeginFramesOnDrawFrame(t);for(const t of e){const e=this.lastFrame.idle;this.startFrame(t.startTime),e&&this.framePendingActivation&&this.commitPendingFrame(),t.isDropped&&(this.lastFrame.dropped=!0),t.isPartial&&(this.lastFrame.isPartial=!0)}}this.mainFrameCommitted=!1}else this.startFrame(e)}handleActivateLayerTree(){this.lastFrame&&this.framePendingActivation&&!this.lastNeedsBeginFrame&&this.commitPendingFrame()}handleRequestMainThreadFrame(){this.lastFrame&&(this.mainFrameRequested=!0)}handleCompositeLayers(){this.framePendingCommit&&(this.framePendingActivation=this.framePendingCommit,this.framePendingCommit=null,this.mainFrameRequested=!1,this.mainFrameCommitted=!0)}handleLayerTreeSnapshot(e){this.lastLayerTree=e}handleNeedFrameChanged(e,t){t&&(this.lastNeedsBeginFrame=e)}startFrame(e){this.lastFrame&&this.flushFrame(this.lastFrame,e),this.lastFrame=new z(e,e-this.minimumRecordTime)}flushFrame(e,t){e.setLayerTree(this.lastLayerTree),e.setEndTime(t),this.lastLayerTree&&this.lastLayerTree.setPaints(e.paints);const r=this.frames[this.frames.length-1];this.frames.length&&r&&(e.startTime!==r.endTime||e.startTime>e.endTime)&&console.assert(!1,`Inconsistent frame time for frame ${this.frames.length} (${e.startTime} - ${e.endTime})`),this.frames.push(e),"number"==typeof e.mainFrameId&&(this.frameById[e.mainFrameId]=e)}commitPendingFrame(){this.framePendingActivation&&this.lastFrame&&(this.lastFrame.addTimeForCategories(this.framePendingActivation.timeByCategory),this.lastFrame.paints=this.framePendingActivation.paints,this.lastFrame.mainFrameId=this.framePendingActivation.mainFrameId,this.framePendingActivation=null)}addTraceEvents(e,t,r){this.target=e;let n=0;this.currentProcessMainThread=r.length&&r[0].thread||null;for(let e=0;e<t.length;++e){for(;n+1<r.length&&r[n+1].time<=t[e].startTime;)this.currentProcessMainThread=r[++n].thread;this.addTraceEvent(t[e])}this.currentProcessMainThread=null}addTraceEvent(e){if(e.startTime&&e.startTime<this.minimumRecordTime&&(this.minimumRecordTime=e.startTime),e.name===g.SetLayerTreeId)this.layerTreeId=e.args.layerTreeId||e.args.data.layerTreeId;else if(e.id&&e.phase===a.TracingModel.Phase.SnapshotObject&&e.name===g.LayerTreeHostImplSnapshot&&Number(e.id)===this.layerTreeId&&this.target){const t=e;this.handleLayerTreeSnapshot(new q(this.target,t))}else this.processCompositorEvents(e),e.thread===this.currentProcessMainThread?this.addMainThreadTraceEvent(e):this.lastFrame&&e.selfTime&&!a.TracingModel.TracingModel.isTopLevelEvent(e)&&this.lastFrame.addTimeForCategory(this.categoryMapper(e),e.selfTime)}processCompositorEvents(e){if(e.args.layerTreeId!==this.layerTreeId)return;const t=e.startTime;e.name===g.BeginFrame?this.handleBeginFrame(t,e.args.frameSeqId):e.name===g.DrawFrame?this.handleDrawFrame(t,e.args.frameSeqId):e.name===g.ActivateLayerTree?this.handleActivateLayerTree():e.name===g.RequestMainThreadFrame?this.handleRequestMainThreadFrame():e.name===g.NeedsBeginFrameChanged?this.handleNeedFrameChanged(t,e.args.data&&e.args.data.needsBeginFrame):e.name===g.DroppedFrame&&this.handleDroppedFrame(t,e.args.frameSeqId,e.args.hasPartialUpdate)}addMainThreadTraceEvent(e){a.TracingModel.TracingModel.isTopLevelEvent(e)&&(this.currentTaskTimeByCategory={},this.lastTaskBeginTime=e.startTime),!this.framePendingCommit&&H.mainFrameMarkers.indexOf(e.name)>=0&&(this.framePendingCommit=new j(this.lastTaskBeginTime||e.startTime,this.currentTaskTimeByCategory)),this.framePendingCommit?(this.addTimeForCategory(this.framePendingCommit.timeByCategory,e),e.name===g.BeginMainThreadFrame&&e.args.data&&e.args.data.frameId&&(this.framePendingCommit.mainFrameId=e.args.data.frameId),e.name===g.Paint&&e.args.data.layerId&&F.forEvent(e).picture&&this.target&&this.framePendingCommit.paints.push(new O(e,this.target)),e.name===g.CompositeLayers&&e.args.layerTreeId===this.layerTreeId&&this.handleCompositeLayers()):this.addTimeForCategory(this.currentTaskTimeByCategory,e)}addTimeForCategory(e,t){if(!t.selfTime)return;const r=this.categoryMapper(t);e[r]=(e[r]||0)+t.selfTime}static mainFrameMarkers=[g.ScheduleStyleRecalculation,g.InvalidateLayout,g.BeginMainThreadFrame,g.ScrollLayer]}class q{target;snapshot;paintsInternal;constructor(e,t){this.target=e,this.snapshot=t}async layerTreePromise(){const e=await this.snapshot.objectPromise();if(!e)return null;const t=e.device_viewport_size,r=e.active_tiles,n=e.active_tree.root_layer,a=e.active_tree.layers,s=new b(this.target);return s.setViewportSize(t),s.setTiles(r),await s.setLayers(n,a,this.paintsInternal||[]),s}paints(){return this.paintsInternal||[]}setPaints(e){this.paintsInternal=e}}class z{startTime;startTimeOffset;endTime;duration;timeByCategory;cpuTime;idle;dropped;isPartial;layerTree;paints;mainFrameId;constructor(e,t){this.startTime=e,this.startTimeOffset=t,this.endTime=this.startTime,this.duration=0,this.timeByCategory={},this.cpuTime=0,this.idle=!1,this.dropped=!1,this.isPartial=!1,this.layerTree=null,this.paints=[],this.mainFrameId=void 0}hasWarnings(){return!1}setEndTime(e){this.endTime=e,this.duration=this.endTime-this.startTime}setLayerTree(e){this.layerTree=e}addTimeForCategories(e){for(const t in e)this.addTimeForCategory(t,e[t])}addTimeForCategory(e,t){this.timeByCategory[e]=(this.timeByCategory[e]||0)+t,this.cpuTime+=t}}class O{eventInternal;target;constructor(e,t){this.eventInternal=e,this.target=t}layerId(){return this.eventInternal.args.data.layerId}event(){return this.eventInternal}picturePromise(){const e=F.forEvent(this.eventInternal).picture;return e?e.objectPromise().then((e=>{if(!e)return null;const t=e.params&&e.params.layer_rect,r=e.skp64;return t&&r?{rect:t,serializedPicture:r}:null})):Promise.resolve(null)}async snapshotPromise(){const e=this.target&&this.target.model(a.PaintProfiler.PaintProfilerModel),t=await this.picturePromise();if(!t||!e)return null;const r=await e.loadSnapshot(t.serializedPicture);return r?{rect:t.rect,snapshot:r}:null}}class j{timeByCategory;paints;mainFrameId;triggerTime;constructor(e,t){this.timeByCategory=t,this.paints=[],this.mainFrameId=void 0,this.triggerTime=e}}class ${seqId;startTime;isDropped;isPartial;constructor(e,t,r,n){this.seqId=e,this.startTime=t,this.isDropped=r,this.isPartial=n}}class J{queueFrames;mapFrames;constructor(){this.queueFrames=[],this.mapFrames={}}addFrameIfNotExists(e,t,r,n){e in this.mapFrames||(this.mapFrames[e]=new $(e,t,r,n),this.queueFrames.push(e))}setDropped(e,t){e in this.mapFrames&&(this.mapFrames[e].isDropped=t)}setPartial(e,t){e in this.mapFrames&&(this.mapFrames[e].isPartial=t)}processPendingBeginFramesOnDrawFrame(e){const t=[];if(e in this.mapFrames){for(;this.queueFrames[0]!==e;){const e=this.queueFrames[0];this.mapFrames[e].isDropped&&t.push(this.mapFrames[e]),delete this.mapFrames[e],this.queueFrames.shift()}t.push(this.mapFrames[e]),delete this.mapFrames[e],this.queueFrames.shift()}return t}}var V=Object.freeze({__proto__:null,TimelineFrameModel:H,TracingFrameLayerTree:q,TimelineFrame:z,LayerPaintEvent:O,PendingFrame:j,TimelineFrameBeginFrameQueue:J});class X{totalTime;selfTime;id;event;parent;groupId;isGroupNodeInternal;depth;constructor(e,t){this.totalTime=0,this.selfTime=0,this.id=e,this.event=t,this.groupId="",this.isGroupNodeInternal=!1,this.depth=0}isGroupNode(){return this.isGroupNodeInternal}hasChildren(){throw"Not implemented"}setHasChildren(e){throw"Not implemented"}children(){throw"Not implemented"}searchTree(e,t){t=t||[],this.event&&e(this.event)&&t.push(this);for(const r of this.children().values())r.searchTree(e,t);return t}}class K extends X{root;hasChildrenInternal;childrenInternal;parent;constructor(e,t,r){super(e,t),this.root=r&&r.root,this.hasChildrenInternal=!1,this.childrenInternal=null,this.parent=r}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){return this.childrenInternal||this.buildChildren()}buildChildren(){const e=[];for(let t=this;t.parent&&!t.isGroupNode();t=t.parent)e.push(t);e.reverse();const t=new Map,r=this,n=this.root;if(!n)return this.childrenInternal=t,this.childrenInternal;const a=n.startTime,s=n.endTime,i=n.doNotAggregate?function(t){++d,c===e.length&&d<=e.length+2&&m(t,0);--d}:void 0,o=n.doNotAggregate?void 0:ee,l=n.getEventGroupIdCallback();let d=0,c=0,h=null;function m(n,a){if(d===e.length+2){if(!h)return;return h.setHasChildren(!0),void(h.selfTime-=a)}let s,i="";o?(s=o(n),i=l?l(n):"",i&&(s+="/"+i)):s=Symbol("uniqueId");let c=t.get(s);c||(c=new K(s,n,r),c.groupId=i,t.set(s,c)),c.selfTime+=a,c.totalTime+=a,h=c}return u.forEachEvent(n.events,(function(t){if(++d,d>e.length+2)return;if(!function(t){if(c===e.length)return!0;if(c!==d-1)return!1;if(!t.endTime)return!1;if(!o)return t===e[c].event&&++c,!1;let r=o(t);const n=l?l(t):"";n&&(r+="/"+n);r===e[c].id&&++c;return!1}(t))return;const r=(void 0!==t.endTime?Math.min(t.endTime,s):s)-Math.max(a,t.startTime);r<0&&console.error("Negative event duration");m(t,r)}),(function(e){--d,c>d&&(c=d)}),i,a,s,n.filter),this.childrenInternal=t,t}getRoot(){return this.root}}class Q extends X{childrenInternal;isGroupNodeInternal;constructor(e,t,r){super(e,r),this.childrenInternal=new Map,this.parent=t,this.isGroupNodeInternal=!0}addChild(e,t,r){this.childrenInternal.set(e.id,e),this.selfTime+=t,this.totalTime+=r,e.parent=this}hasChildren(){return!0}children(){return this.childrenInternal}}class Y extends X{parent;root;depth;cachedChildren;hasChildrenInternal;constructor(e,t,r,n,a){super(t,r),this.parent=a,this.root=e,this.depth=(a.depth||0)+1,this.cachedChildren=null,this.hasChildrenInternal=n}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){if(this.cachedChildren)return this.cachedChildren;const e=[0],t=[],r=[],n=new Map,a=this.root.startTime,s=this.root.endTime;let i=a;const o=this;return u.forEachEvent(this.root.events,(function(n){const i=(void 0!==n.endTime?Math.min(n.endTime,s):s)-Math.max(n.startTime,a);i<0&&console.assert(!1,"Negative duration of an event");e[e.length-1]-=i,e.push(i);const o=ee(n);t.push(o),r.push(n)}),(function(a){const l=e.pop(),d=t.pop();let c;for(r.pop(),c=o;c.depth>1;c=c.parent)if(c.id!==t[t.length+1-c.depth])return;if(c.id!==d||t.length<o.depth)return;const h=t[t.length-o.depth];if(c=n.get(h),!c){const e=r[r.length-o.depth],t=r.length>o.depth;c=new Y(o.root,h,e,t,o),n.set(h,c)}const m=void 0!==a.endTime?Math.min(a.endTime,s):s,u=m-Math.max(a.startTime,i);c.selfTime+=l||0,c.totalTime+=u,i=m}),void 0,a,s,this.root.filter),this.cachedChildren=this.root.filterChildren(n),this.cachedChildren}searchTree(e,t){return t=t||[],this.event&&e(this.event)&&t.push(this),t}}function Z(e){return e.name===g.JSFrame?e.args.data||null:F.forEvent(e).topFrame()}function ee(e){if(e.name===g.TimeStamp)return`${e.name}:${e.args.data.message}`;if(e.name!==g.JSFrame)return e.name;const t=e.args.data,r=t.scriptId||t.url||"",n=t.functionName;return`f:${l.isNativeRuntimeFrame(t)?l.nativeGroup(n)||n:`${n}:${t.lineNumber}:${t.columnNumber}`}@${r}`}var te=Object.freeze({__proto__:null,Node:X,TopDownNode:K,TopDownRootNode:class extends K{events;filter;startTime;endTime;eventGroupIdCallback;doNotAggregate;totalTime;selfTime;constructor(e,t,r,n,a,s){super("",null,null),this.root=this,this.events=e,this.filter=e=>t.every((t=>t.accept(e))),this.startTime=r,this.endTime=n,this.eventGroupIdCallback=s,this.doNotAggregate=a,this.totalTime=n-r,this.selfTime=this.totalTime}children(){return this.childrenInternal||this.grouppedTopNodes()}grouppedTopNodes(){const e=super.children();for(const t of e.values())this.selfTime-=t.totalTime;if(!this.eventGroupIdCallback)return e;const t=new Map;for(const r of e.values()){const e=this.eventGroupIdCallback(r.event);let n=t.get(e);n||(n=new Q(e,this,r.event),t.set(e,n)),n.addChild(r,r.selfTime,r.totalTime)}return this.childrenInternal=t,t}getEventGroupIdCallback(){return this.eventGroupIdCallback}},BottomUpRootNode:class extends X{childrenInternal;events;textFilter;filter;startTime;endTime;eventGroupIdCallback;totalTime;constructor(e,t,r,n,a,s){super("",null),this.childrenInternal=null,this.events=e,this.textFilter=t,this.filter=e=>r.every((t=>t.accept(e))),this.startTime=n,this.endTime=a,this.eventGroupIdCallback=s,this.totalTime=a-n}hasChildren(){return!0}filterChildren(e){for(const[t,r]of e)r.event&&!this.textFilter.accept(r.event)&&e.delete(t);return e}children(){return this.childrenInternal||(this.childrenInternal=this.filterChildren(this.grouppedTopNodes())),this.childrenInternal}ungrouppedTopNodes(){const e=this,t=this.startTime,r=this.endTime,n=new Map,a=[r-t],s=[],i=new Map;u.forEachEvent(this.events,(function(e){const n=(void 0!==e.endTime?Math.min(e.endTime,r):r)-Math.max(e.startTime,t);a[a.length-1]-=n,a.push(n);const o=ee(e),l=!i.has(o);l&&i.set(o,n);s.push(l)}),(function(t){const r=ee(t);let o=n.get(r);o||(o=new Y(e,r,t,!1,e),n.set(r,o));o.selfTime+=a.pop()||0,s.pop()&&(o.totalTime+=i.get(r)||0,i.delete(r));s.length&&o.setHasChildren(!0)}),void 0,t,r,this.filter),this.selfTime=a.pop()||0;for(const e of n)e[1].selfTime<=0&&n.delete(e[0]);return n}grouppedTopNodes(){const e=this.ungrouppedTopNodes();if(!this.eventGroupIdCallback)return e;const t=new Map;for(const r of e.values()){const e=this.eventGroupIdCallback(r.event);let n=t.get(e);n||(n=new Q(e,this,r.event),t.set(e,n)),n.addChild(r,r.selfTime,r.selfTime)}return t}},GroupNode:Q,BottomUpNode:Y,eventURL:function(e){const t=e.args.data||e.args.beginData;if(t&&t.url)return t.url;let r=Z(e);for(;r;){const e=r.url;if(e)return e;r=r.parent}return null},eventStackFrame:Z,_eventId:ee});export{V as TimelineFrameModel,G as TimelineIRModel,d as TimelineJSProfile,C as TimelineModel,w as TimelineModelFilter,te as TimelineProfileTree,B as TracingLayerTree};
