import*as e from"../../../core/common/common.js";import*as t from"../../../core/i18n/i18n.js";import*as o from"../../../services/window_bounds/window_bounds.js";import*as n from"../../../third_party/codemirror.next/codemirror.next.js";import*as i from"../code_highlighter/code_highlighter.js";import*as r from"../icon_button/icon_button.js";import*as s from"../../../core/sdk/sdk.js";import*as a from"../../../models/formatter/formatter.js";import*as c from"../../../models/javascript_metadata/javascript_metadata.js";import*as l from"../../legacy/legacy.js";import*as d from"../../legacy/theme_support/theme_support.js";import*as u from"../../lit-html/lit-html.js";import*as m from"../helpers/helpers.js";const p=n.EditorView.theme({"&.cm-editor":{color:"color: var(--color-text-primary)",cursor:"auto","&.cm-focused":{outline:"none"}},".cm-scroller":{lineHeight:"1.2em",fontFamily:"var(--source-code-font-family)",fontSize:"var(--source-code-font-size)"},".cm-panels":{backgroundColor:"var(--color-background-elevation-1)"},".cm-selectionMatch":{backgroundColor:"var(--color-selection-highlight)"},".cm-cursor":{borderLeft:"1px solid var(--color-background-inverted)"},"&.cm-readonly .cm-cursor":{display:"none"},".cm-cursor-secondary":{borderLeft:"1px solid var(--color-secondary-cursor)"},".cm-selectionBackground":{background:"var(--color-editor-selection-selection)"},"&.cm-focused .cm-selectionBackground":{background:"var(--color-editor-selection)"},".cm-gutters":{borderRight:"1px solid var(--color-details-hairline)",whiteSpace:"nowrap",backgroundColor:"var(--color-background)"},".cm-lineNumbers":{overflow:"visible",minWidth:"40px"},".cm-lineNumbers .cm-gutterElement":{color:"var(--color-line-number)",padding:"0 3px 0 9px"},".cm-matchingBracket, .cm-nonmatchingBracket":{background:"transparent",borderBottom:"none"},"&:focus-within .cm-matchingBracket":{color:"inherit",backgroundColor:"var(--color-matching-bracket-background)",borderBottom:"1px solid var(--color-matching-bracket-underline)"},"&:focus-within .cm-nonmatchingBracket":{backgroundColor:"var(--color-nonmatching-bracket-background)",borderBottom:"1px solid var(--color-nonmatching-bracket-underline)"},".cm-trailingWhitespace":{backgroundColor:"var(--color-trailing-whitespace)"},".cm-highlightedTab":{display:"inline-block",position:"relative","&:before":{content:'""',borderBottom:"1px solid var(--color-text-secondary)",position:"absolute",left:"5%",bottom:"50%",width:"90%",pointerEvents:"none"}},".cm-highlightedSpaces:before":{color:"var(--color-text-secondary)",content:"attr(data-display)",position:"absolute",pointerEvents:"none"},".cm-placeholder":{color:"var(--color-text-secondary)"},".cm-completionHint":{color:"var(--color-text-secondary)"},".cm-tooltip":{boxShadow:"var(--drop-shadow)",backgroundColor:"var(--color-background-elevation-1)"},".cm-argumentHints":{pointerEvents:"none",padding:"0 4px",whiteSpace:"nowrap",lineHeight:"20px",marginBottom:"4px",width:"fit-content"},".cm-tooltip.cm-tooltip-autocomplete > ul":{backgroundColor:"var(--color-background)",maxHeight:"25em",minWidth:"16em","& > li.cm-secondaryCompletion":{display:"flex",backgroundColor:"var(--color-background-elevation-1)",justifyContent:"space-between","&::before":{content:'">"',fontWeight:"bold",color:"var(--color-primary-variant)",marginRight:"5px"}},"& > li:hover":{backgroundColor:"var(--item-hover-color)"},"& > li[aria-selected]":{backgroundColor:"var(--color-selected-option-background)","&, &.cm-secondaryCompletion::before":{color:"var(--color-selected-option)"}}},".cm-completionMatchedText":{textDecoration:"none",fontWeight:"bold"},".cm-highlightedLine":{animation:"cm-fading-highlight 2s 0s"},"@keyframes cm-fading-highlight":{from:{backgroundColor:"var(--color-highlighted-line)"},to:{backgroundColor:"transparent"}}}),f={codeEditor:"Code editor"},h=t.i18n.registerUIStrings("ui/components/text_editor/config.ts",f),g=t.i18n.getLocalizedString.bind(void 0,h),b=[],v=n.Facet.define();class y{settingName;getExtension;compartment=new n.Compartment;constructor(e,t){this.settingName=e,this.getExtension=t}settingValue(){return e.Settings.Settings.instance().moduleSetting(this.settingName).get()}instance(){return[this.compartment.of(this.getExtension(this.settingValue())),v.of(this)]}sync(e,t){const o=this.compartment.get(e),n=this.getExtension(t);return o===n?null:this.compartment.reconfigure(n)}static bool(e,t,o=b){return new y(e,(e=>e?t:o))}static none=[]}const w=y.bool("textEditorTabMovesFocus",[],n.keymap.of([{key:"Tab",run:e=>!!e.state.doc.length&&n.indentMore(e),shift:e=>!!e.state.doc.length&&n.indentLess(e)}])),x=[n.autocompletion({icons:!1,optionClass:e=>"secondary"===e.type?"cm-secondaryCompletion":""}),n.Prec.highest(n.keymap.of([{key:"ArrowRight",run:n.acceptCompletion}]))],S=y.bool("textEditorAutocompletion",x),E=y.bool("textEditorBracketMatching",n.bracketMatching()),C=y.bool("textEditorCodeFolding",[n.foldGutter({markerDOM(e){const t=e?"triangle-expanded":"triangle-collapsed",o=new r.Icon.Icon;return o.data={iconName:t,color:"var(--color-text-secondary)",width:"12px",height:"12px"},o}}),n.keymap.of(n.foldKeymap)]);function k(t){const o=Object.create(null);let n=0;for(let e=t.iterLines(1,Math.min(t.lines+1,1e3));!e.next().done;){let t=/^\s*/.exec(e.value)[0];if(t.length!==e.value.length&&t.length&&"*"!==e.value[t.length]){if("\t"===t[0])t="\t";else if(/[^ ]/.test(t))continue;n++,o[t]=(o[t]||0)+1}}const i=.05*n;return Object.entries(o).reduce(((e,[t,o])=>o<i||e&&e.length<t.length?e:t),null)??e.Settings.Settings.instance().moduleSetting("textEditorIndent").get()}const M=n.Prec.highest(n.indentUnit.compute([],(e=>k(e.doc)))),D=y.bool("textEditorAutoDetectIndent",M);function T(e){return n.ViewPlugin.define((t=>({decorations:e.createDeco(t),update(t){this.decorations=e.updateDeco(t,this.decorations)}})),{decorations:e=>e.decorations})}const j=new Map;const L=T(new n.MatchDecorator({regexp:/\t| +/g,decoration:e=>function(e){const t=j.get(e);if(t)return t;const o=n.Decoration.mark({attributes:"\t"===e?{class:"cm-highlightedTab"}:{class:"cm-highlightedSpaces","data-display":"·".repeat(e.length)}});return j.set(e,o),o}(e[0]),boundary:/\S/})),N=T(new n.MatchDecorator({regexp:/\s+$/g,decoration:n.Decoration.mark({class:"cm-trailingWhitespace"}),boundary:/\S/})),O=new y("showWhitespacesInEditor",(e=>"all"===e?L:"trailing"===e?N:b)),P=y.bool("allowScrollPastEof",n.scrollPastEnd()),B=Object.create(null);const _=new y("textEditorIndent",(function(e){let t=B[e];return t||(t=B[e]=n.indentUnit.of(e)),t})),I=y.bool("domWordWrap",n.EditorView.lineWrapping);function A(e){return/\r\n/.test(e)&&!/(^|[^\r])\n/.test(e)?n.EditorState.lineSeparator.of("\r\n"):[]}const W=n.keymap.of([{key:"Tab",run:n.acceptCompletion},{key:"End",run:n.acceptCompletion},{key:"Ctrl-m",run:n.cursorMatchingBracket,shift:n.selectMatchingBracket},{key:"Mod-/",run:n.toggleComment},{key:"Mod-d",run:n.selectNextOccurrence},{key:"Alt-ArrowLeft",mac:"Ctrl-ArrowLeft",run:n.cursorSubwordBackward,shift:n.selectSubwordBackward},{key:"Alt-ArrowRight",mac:"Ctrl-ArrowRight",run:n.cursorSubwordForward,shift:n.selectSubwordForward},...n.standardKeymap,...n.historyKeymap]);function z(){const t=e.Settings.Settings.instance().moduleSetting("uiTheme").get();return"systemPreferred"===t?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"===t}const R=n.EditorView.theme({},{dark:!0}),F=new n.Compartment;function H(){return[p,z()?F.of(R):F.of([])]}let $=null;function V(){return $||($=o.WindowBoundsService.WindowBoundsServiceImpl.instance().getDevToolsBoundingElement()),$.getBoundingClientRect()}function U(e){return[H(),n.highlightSpecialChars(),n.highlightSelectionMatches(),n.history(),n.drawSelection(),n.EditorState.allowMultipleSelections.of(!0),n.indentOnInput(),n.syntaxHighlighting(i.CodeHighlighter.highlightStyle),W,n.EditorView.clickAddsSelectionRange.of((e=>e.altKey||e.ctrlKey)),w.instance(),E.instance(),_.instance(),n.Prec.lowest(n.EditorView.contentAttributes.of({"aria-label":g(f.codeEditor)})),e instanceof n.Text?[]:A(e),n.tooltips({tooltipSpace:V})]}const K=[n.closeBrackets(),n.keymap.of(n.closeBracketsKeymap)];class G extends n.WidgetType{text;constructor(e){super(),this.text=e}eq(e){return this.text===e.text}toDOM(){const e=document.createElement("span");return e.className="cm-completionHint",e.textContent=this.text,e}}const J=n.ViewPlugin.fromClass(class{decorations=n.Decoration.none;currentHint=null;update(e){const t=this.currentHint=this.topCompletion(e.state);this.decorations=t?n.Decoration.set([n.Decoration.widget({widget:new G(t),side:1}).range(e.state.selection.main.head)]):n.Decoration.none}topCompletion(e){const t=n.selectedCompletion(e);if(!t)return null;let{label:o,apply:i}=t;if("string"==typeof i&&(o=i,i=void 0),i||o.length>100||o.indexOf("\n")>-1||"secondary"===t.type)return null;const r=e.selection.main.head,s=e.doc.lineAt(r);if(r!==s.to)return null;const a=("'"===o[0]?/'(\\.|[^'\\])*$/:'"'===o[0]?/"(\\.|[^"\\])*$/:/#?[\w$]+$/).exec(s.text);return a&&!o.startsWith(a[0])?null:o.slice(a?a[0].length:0)}},{decorations:e=>e.decorations});var q=Object.freeze({__proto__:null,dynamicSetting:v,DynamicSetting:y,tabMovesFocus:w,autocompletion:x,sourcesAutocompletion:S,bracketMatching:E,codeFolding:C,guessIndent:k,autoDetectIndent:D,showWhitespace:O,allowScrollPastEof:P,indentUnit:_,domWordWrap:I,dummyDarkTheme:R,themeSelection:F,theme:H,baseConfiguration:U,closeBrackets:K,showCompletionHint:J,contentIncludingHint:function(e){const t=e.plugin(J);let o=e.state.doc.toString();if(t&&t.currentHint){const{head:n}=e.state.selection.main;o=o.slice(0,n)+t.currentHint+o.slice(n)}return o}});const Q=n.StateEffect.define();class X{completions;seen;constructor(e=[],t=new Set){this.completions=e,this.seen=t}add(e){this.seen.has(e.label)||(this.seen.add(e.label),this.completions.push(e))}copy(){return new X(this.completions.slice(),new Set(this.seen))}}const Y=["async","await","break","case","catch","class","const","continue","debugger","default","delete","do","else","export","extends","false","finally","for","function","if","import","in","instanceof","let","new","null","of","return","static","super","switch","this","throw","true","try","typeof","var","void","while","with","yield"],Z=["clear","copy","debug","dir","dirxml","getEventListeners","inspect","keys","monitor","monitorEvents","profile","profileEnd","queryObjects","table","undebug","unmonitor","unmonitorEvents","values"],ee=["$","$$","$x","$0","$_"],te=new X;for(const e of Y)te.add({label:e,type:"keyword"});for(const e of Z)te.add({label:e,type:"function"});for(const e of ee)te.add({label:e,type:"variable"});const oe=new Set(["TemplateString","LineComment","BlockComment","TypeDefinition","VariableDefinition","PropertyDefinition","TypeName"]);function ne(e,t,o){let n=e.resolveInner(t,-1);const i=n.parent;if(oe.has(n.name))return null;if("PropertyName"===n.name||"PrivatePropertyName"===n.name)return"MemberExpression"!==i?.name?null:{type:1,from:n.from,relatedNode:i};if("VariableName"===n.name||!n.firstChild&&n.to-n.from<20&&!/[^a-z]/.test(o.sliceString(n.from,n.to)))return{type:0,from:n.from};if("String"===n.name){const e=n.parent;return"MemberExpression"===e?.name&&"["===e.childBefore(n.from)?.name?{type:2,from:n.from,relatedNode:e}:null}if(n=n.enterUnfinishedNodesBefore(t),n.to===t&&"MemberExpression"===n.parent?.name&&(n=n.parent),"MemberExpression"===n.name){const e=n.childBefore(Math.min(t,n.to));if("["===e?.name)return{type:2,relatedNode:n};if("."===e?.name||"?."===e?.name)return{type:1,relatedNode:n}}if("("===n.name&&"ArgList"===i?.name&&"CallExpression"===i?.parent?.name){const e=i?.parent?.firstChild;if("MemberExpression"===e?.name){const t=e?.lastChild;if(t&&"get"===o.sliceString(t.from,t.to)){const t=e?.firstChild;return{type:3,relatedNode:t||void 0}}}}return{type:0}}async function ie(e){const t=ne(n.syntaxTree(e.state),e.pos,e.state.doc);if(!t||void 0===t.from&&!e.explicit&&0===t.type)return null;let o,i;if(0===t.type){const[e,t]=await Promise.all([fe(),he()]);if(e.completions.length){o=e;for(const e of t.completions)o.add(e)}else o=t}else if(1===t.type||2===t.type){const n=t.relatedNode.getChild("Expression");if(2===t.type&&(i=void 0===t.from?"'":e.state.sliceDoc(t.from,t.from+1)),!n)return null;o=await async function(e,t,o=!1){const n=me.instance();if(!t){const t=n.get(e);if(t)return t}const i=ce();if(!i)return new X;const r=pe(e,i,t,o);t||n.set(e,r);return r}(e.state.sliceDoc(n.from,n.to),i,"]"===e.state.sliceDoc(e.pos,e.pos+1))}else{if(3!==t.type)return null;{const n=t.relatedNode;if(!n)return null;o=await async function(e){const t=new X,o=ce();if(!o)return t;const n=await le(o,`[...Map.prototype.keys.call(${e})]`,"completion");if(!n)return t;const i=s.RemoteObject.RemoteArray.objectAsArray(n),r=i.length();for(let e=0;e<r;e++)t.add({label:`"${(await i.at(e)).value}")`,type:"constant",boost:-1*e});return t}(e.state.sliceDoc(n.from,n.to))}}return{from:t.from??e.pos,options:o.completions,validFor:i?"'"===i?se:ae:re}}const re=/^#?(?:[$_\p{ID_Start}])(?:[$_\u200C\u200D\p{ID_Continue}])*$/u,se=/^\'(\\.|[^\\'\n])*'?$/,ae=/^"(\\.|[^\\"\n])*"?$/;function ce(){return l.Context.Context.instance().flavor(s.RuntimeModel.ExecutionContext)}async function le(e,t,o){const n=await e.evaluate({expression:t,objectGroup:o,includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);return"error"in n||n.exceptionDetails||!n.object?null:n.object}const de=new Map([["string","String"],["symbol","Symbol"],["number","Number"],["boolean","Boolean"],["bigint","BigInt"]]);let ue=null;class me{#e=new Map;constructor(){const e=()=>this.#e.clear();s.ConsoleModel.ConsoleModel.instance().addEventListener(s.ConsoleModel.Events.CommandEvaluated,e),l.Context.Context.instance().addFlavorChangeListener(s.RuntimeModel.ExecutionContext,e),s.TargetManager.TargetManager.instance().addModelListener(s.DebuggerModel.DebuggerModel,s.DebuggerModel.Events.DebuggerResumed,e),s.TargetManager.TargetManager.instance().addModelListener(s.DebuggerModel.DebuggerModel,s.DebuggerModel.Events.DebuggerPaused,e)}get(e){return this.#e.get(e)}set(e,t){this.#e.set(e,t),window.setTimeout((()=>{this.#e.get(e)===t&&this.#e.delete(e)}),3e4)}static instance(){return ue||(ue=new me),ue}}async function pe(e,t,o,n=!1){const i=new X;if(!t)return i;let r=await le(t,e,"completion");if(!r)return i;for(;"object"===r.type&&"proxy"===r.subtype;){const e=(await r.getOwnProperties(!1)).internalProperties?.find((e=>"[[Target]]"===e.name))?.value;if(!e)break;r=e}const s=de.get(r.type);s&&(r=await le(t,s+".prototype","completion"));const a="globalThis"===e?"function":"method",c="globalThis"===e?"variable":"property";if(r&&("object"===r.type||"function"===r.type)){const t=await r.getAllProperties(!1,!1,!0),s="function"===r.type;for(const r of t.properties||[])if(!r.symbol&&(!s||"arguments"!==r.name&&"caller"!==r.name)&&(!r.private||"this"===e)&&(o||re.test(r.name))){const e=o?o+r.name.replaceAll("\\","\\\\").replaceAll(o,"\\"+o)+o:r.name,t=o&&!n?`${e}]`:void 0,s=2*Number(r.isOwn)+1*Number(r.enumerable),l="function"===r.value?.type?a:c;i.add({apply:t,label:e,type:l,boost:s})}}return t.runtimeModel.releaseObjectGroup("completion"),i}async function fe(){const e=new X,t=ce()?.debuggerModel.selectedCallFrame();if(!t)return e;const o=await Promise.all(t.scopeChain().map((e=>e.object().getAllProperties(!1,!1))));for(const t of o)for(const o of t.properties||[])e.add({label:o.name,type:"function"===o.value?.type?"function":"variable"});return e}async function he(){const e=me.instance(),t=e.get("");if(t)return t;const o=ce();if(!o)return te;const n=te.copy(),i=pe("globalThis",o).then((e=>o.globalLexicalScopeNames().then((t=>{for(const t of e.completions)n.add(t);for(const e of t||[])n.add({label:e,type:"variable"});return n}))));return e.set("",i),i}async function ge(e,t){const o=n.syntaxTree(e).resolveInner(t).enterUnfinishedNodesBefore(t);if("ArgList"!==o.name)return null;const i=o.parent?.getChild("Expression");if(!i)return null;const r=await async function(e,t){const o=ce();if(!o)return null;const n=t.sliceString(e.from,e.to),i=await le(o,n,"argumentsHint");if(!i||"function"!==i.type)return null;return be(i,(async()=>{const n=e.firstChild;return n&&"MemberExpression"===e.name?le(o,t.sliceString(n.from,n.to),"argumentsHint"):null}),n).finally((()=>o.runtimeModel.releaseObjectGroup("argumentsHint")))}(i,e.doc);if(!r)return null;let s=0;for(let e=t;;){const t=o.childBefore(e);if(!t)break;t.type.is("Expression")&&s++,e=t.from}return()=>function(e,t){const o=document.createElement("div");o.className="cm-argumentHints";for(const n of e){const e=document.createElement("span");for(let o=0;o<n.length;o++){if(o===t||o<t&&n[o].startsWith("...")){e.appendChild(document.createElement("b")).appendChild(document.createTextNode(n[o]))}else e.appendChild(document.createTextNode(n[o]));o<n.length-1&&e.appendChild(document.createTextNode(", "))}const i=o.appendChild(document.createElement("div"));i.className="source-code",i.appendChild(document.createTextNode("ƒ(")),i.appendChild(e),i.appendChild(document.createTextNode(")"))}return{dom:o}}(r,s)}async function be(e,t,o){const n=e.description;if(!n)return null;if(!n.endsWith("{ [native code] }"))return[await a.FormatterWorkerPool.formatterWorkerPool().argumentsList(n)];if("function () { [native code] }"===n){const t=await async function(e){const{internalProperties:t}=await e.getOwnProperties(!1);if(!t)return null;const o=t.find((e=>"[[TargetFunction]]"===e.name))?.value,n=t.find((e=>"[[BoundArgs]]"===e.name))?.value,i=t.find((e=>"[[BoundThis]]"===e.name))?.value;if(!i||!o||!n)return null;const r=await be(o,(()=>Promise.resolve(i))),a=s.RemoteObject.RemoteObject.arrayLength(n);if(!r)return null;return r.map((e=>{const t=e.findIndex((e=>e.startsWith("...")));return t>-1&&t<a?e.slice(t):e.slice(a)}))}(e);if(t)return t}const i=c.JavaScriptMetadata.JavaScriptMetadataImpl.instance(),r=/^function ([^(]*)\(/.exec(n),l=r&&r[1]||o;if(!l)return null;const d=i.signaturesForNativeFunction(l);if(d)return d;const u=await t();if(!u)return null;const m=u.className;if(m){const e=i.signaturesForInstanceMethod(l,m);if(e)return e}if(u.description&&"function"===u.type&&u.description.endsWith("{ [native code] }")){const e=/^function ([^(]*)\(/.exec(u.description);if(e){const t=e[1],o=i.signaturesForStaticMethod(l,t);if(o)return o}}for(const e of await async function(e){if("number"===e.type)return["Number","Object"];if("string"===e.type)return["String","Object"];if("symbol"===e.type)return["Symbol","Object"];if("bigint"===e.type)return["BigInt","Object"];if("boolean"===e.type)return["Boolean","Object"];if("undefined"===e.type||"null"===e.subtype)return[];return await e.callFunctionJSON((function(){const e=[];for(let t=this;t;t=Object.getPrototypeOf(t))"object"==typeof t&&t.constructor&&t.constructor.name&&(e[e.length]=t.constructor.name);return e}),[])}(u)){const t=i.signaturesForInstanceMethod(l,e);if(t)return t}return null}var ve=Object.freeze({__proto__:null,completion:function(){return n.javascript.javascriptLanguage.data.of({autocomplete:ie})},completeInContext:async function(e,t,o=!1){const i=n.EditorState.create({doc:e+t,selection:{anchor:e.length},extensions:n.javascript.javascriptLanguage}),r=await ie(new n.CompletionContext(i,i.doc.length,o));return r?r.options.filter((e=>e.label.startsWith(t))).map((e=>({text:e.label,priority:100+(e.boost||0),isSecondary:"secondary"===e.type}))):[]},getQueryType:ne,javascriptCompletionSource:ie,isExpressionComplete:async function(e){const t=l.Context.Context.instance().flavor(s.RuntimeModel.ExecutionContext);if(!t)return!0;const o=await t.runtimeModel.compileScript(e,"",!1,t.id);if(!o||!o.exceptionDetails||!o.exceptionDetails.exception)return!0;const n=o.exceptionDetails.exception.description;return!!n&&(!n.startsWith("SyntaxError: Unexpected end of input")&&!n.startsWith("SyntaxError: Unterminated template literal"))},argumentHints:function(){return function(e){const t=n.StateEffect.define();return[n.StateField.define({create:()=>null,update(e,o){if(o.selection&&(e=null),e&&!o.changes.empty){const t=o.changes.mapPos(e.pos,-1,n.MapMode.TrackDel);e=null===t?null:{pos:t,create:e.create,above:!0}}for(const n of o.effects)n.is(t)?e={pos:o.state.selection.main.from,create:n.value,above:!0}:n.is(Q)&&(e=null);return e},provide:e=>n.showTooltip.from(e)}),n.ViewPlugin.fromClass(class{pending=-1;updateID=0;update(e){this.updateID++,e.transactions.some((e=>e.selection))&&e.state.selection.main.empty&&this.#t(e.view)}#t(e){this.pending>-1&&clearTimeout(this.pending),this.pending=window.setTimeout((()=>this.#o(e)),50)}#o(o){this.pending=-1;const{main:n}=o.state.selection;if(n.empty){const{updateID:i}=this;e(o.state,n.from).then((e=>{this.updateID!==i?this.pending<0&&this.#t(o):e?o.dispatch({effects:t.of(e)}):o.dispatch({effects:Q.of(null)})}))}}})]}(ge)},closeArgumentsHintsTooltip:function(e,t){return null!==e.state.field(t)&&(e.dispatch({effects:Q.of(null)}),!0)}});function ye(e,{lineNumber:t,columnNumber:o}){const n=e.line(Math.max(1,Math.min(e.lines,t+1)));return Math.max(n.from,Math.min(n.to,n.from+o))}function we(e,t){t=Math.max(0,Math.min(t,e.length));const o=e.lineAt(t);return{lineNumber:o.number-1,columnNumber:t-o.from}}var xe=Object.freeze({__proto__:null,toOffset:ye,toLineColumn:we});class Se extends HTMLElement{static litTagName=u.literal`devtools-text-editor`;#n=this.attachShadow({mode:"open"});#i=void 0;#r=y.none;#s=[];#a;#c={left:0,top:0};#l=-1;#d=()=>{this.#l<0&&(this.#l=window.setTimeout((()=>{this.#l=-1,this.#i&&n.repositionTooltips(this.#i)}),50))};#u=new ResizeObserver(this.#d);constructor(e){super(),this.#a=e,this.#n.adoptedStyleSheets=[i.Style.default]}#m(){return this.#i=new n.EditorView({state:this.state,parent:this.#n,root:this.#n,dispatch:e=>{this.editor.update([e]),e.reconfigured&&this.#p()}}),this.#i.scrollDOM.scrollTop=this.#c.top,this.#i.scrollDOM.scrollLeft=this.#c.left,this.#i.scrollDOM.addEventListener("scroll",(e=>{this.#c.left=e.target.scrollLeft,this.#c.top=e.target.scrollTop})),this.#p(),this.#f(),d.ThemeSupport.instance().addEventListener(d.ThemeChangeEvent.eventName,(()=>{const e="dark"===d.ThemeSupport.instance().themeName()?R:[];this.editor.dispatch({effects:F.reconfigure(e)})})),this.#i}get editor(){return this.#i||this.#m()}dispatch(e){return this.editor.dispatch(e)}get state(){return this.#i?this.#i.state:(this.#a||(this.#a=n.EditorState.create({extensions:U("")})),this.#a)}set state(e){this.#i?this.#i.setState(e):this.#a=e}connectedCallback(){this.#i?(this.#i.scrollDOM.scrollTop=this.#c.top,this.#i.scrollDOM.scrollLeft=this.#c.left):this.#m()}disconnectedCallback(){this.#i&&(this.#a=this.#i.state,this.#u.disconnect(),window.removeEventListener("resize",this.#d),this.#i.destroy(),this.#i=void 0,this.#p())}focus(){this.#i&&this.#i.focus()}#p(){const t=this.#i?this.#i.state.facet(v):y.none;if(t===this.#r)return;this.#r=t;for(const[e,t]of this.#s)e.removeChangeListener(t);this.#s=[];const o=e.Settings.Settings.instance();for(const e of t){const t=({data:t})=>{const o=e.sync(this.state,t);o&&this.#i&&this.#i.dispatch({effects:o})},n=o.moduleSetting(e.settingName);n.addChangeListener(t),this.#s.push([n,t])}}#f(){const e=o.WindowBoundsService.WindowBoundsServiceImpl.instance().getDevToolsBoundingElement();e&&this.#u.observe(e),window.addEventListener("resize",this.#d)}revealPosition(e,t=!0){const o=this.#i;if(!o)return;const i=o.state.doc.lineAt(e.main.head),r=[];t&&r.push(o.state.field(ke,!1)?Ee.of(i.from):n.StateEffect.appendConfig.of(ke.init((()=>Ce(i.from)))));const s=o.scrollDOM.getBoundingClientRect(),a=o.coordsAtPos(e.main.head);if((!a||a.top<s.top||a.bottom>s.bottom)&&r.push(n.EditorView.scrollIntoView(e.main,{y:"center"})),o.dispatch({selection:e,effects:r,userEvent:"select.reveal"}),t){const{id:e}=o.state.field(ke);window.setTimeout((()=>{o.state.field(ke).id===e&&o.dispatch({effects:Ee.of(null)})}),2e3)}}createSelection(e,t){const{doc:o}=this.state,i=ye(o,e);return n.EditorSelection.single(t?ye(o,t):i,i)}toLineColumn(e){return we(this.state.doc,e)}toOffset(e){return ye(this.state.doc,e)}}m.CustomElements.defineComponent("devtools-text-editor",Se);const Ee=n.StateEffect.define({map:(e,t)=>null===e?null:t.mapPos(e)});function Ce(e){return{deco:n.Decoration.set([n.Decoration.line({attributes:{class:"cm-highlightedLine"}}).range(e)]),id:Math.floor(1048575*Math.random())}}const ke=n.StateField.define({create:()=>({deco:n.Decoration.none,id:0}),update(e,t){!t.changes.empty&&e.deco.size&&(e={deco:e.deco.map(t.changes),id:e.id});for(const o of t.effects)o.is(Ee)&&(e=null===o.value?{deco:n.Decoration.none,id:0}:Ce(o.value));return e},provide:e=>n.EditorView.decorations.from(e,(e=>e.deco))});var Me=Object.freeze({__proto__:null,TextEditor:Se});export{q as Config,ve as JavaScript,xe as Position,Me as TextEditor};
