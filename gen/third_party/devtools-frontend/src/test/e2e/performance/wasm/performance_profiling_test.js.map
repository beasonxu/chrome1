{"version":3,"file":"performance_profiling_test.js","sourceRoot":"","sources":["../../../../../../../../../../third_party/devtools-frontend/src/test/e2e/performance/wasm/performance_profiling_test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {assert} from 'chai';\nimport type * as puppeteer from 'puppeteer';\n\nimport {\n  $,\n  getBrowserAndPages,\n  step,\n  waitFor,\n  waitForElementWithTextContent,\n  waitForFunction,\n} from '../../../shared/helper.js';\nimport {describe, it} from '../../../shared/mocha-extensions.js';\nimport {\n  BOTTOM_UP_SELECTOR,\n  CALL_TREE_SELECTOR,\n  getTotalTimeFromSummary,\n  navigateToBottomUpTab,\n  navigateToCallTreeTab,\n  navigateToPerformanceTab,\n  searchForComponent,\n  startRecording,\n  stopRecording,\n  SUMMARY_TAB_SELECTOR,\n} from '../../helpers/performance-helpers.js';\n\nasync function expandAndCheckActivityTree(frontend: puppeteer.Page, expectedActivities: string[]) {\n  let index = 0;\n  let parentItem: puppeteer.ElementHandle<Element>|undefined = undefined;\n  do {\n    await waitForFunction(async () => {\n      if (parentItem) {\n        parentItem.evaluate(e => e.scrollIntoView());\n      }\n      const treeItem = await $('.data-grid-data-grid-node.selected.revealed .activity-name');\n      if (!treeItem) {\n        return false;\n      }\n      const treeItemText = await frontend.evaluate(el => el.innerText, treeItem);\n      if (expectedActivities[index] === treeItemText) {\n        parentItem = treeItem;\n        return true;\n      }\n      return false;\n    });\n    index++;\n    await frontend.keyboard.press('ArrowRight');\n    await frontend.keyboard.press('ArrowRight');\n  } while (index < expectedActivities.length);\n}\n\ndescribe('The Performance panel', async function() {\n  it('is able to record performance', async () => {\n    const {target, frontend} = getBrowserAndPages();\n\n    await step('navigate to the Performance tab', async () => {\n      await navigateToPerformanceTab('wasm/profiling');\n    });\n\n    await step('open up the console', async () => {\n      await frontend.keyboard.press('Escape');\n      await waitFor('.console-searchable-view');\n    });\n\n    await step('click the record button', async () => {\n      await startRecording();\n    });\n\n    await step('reload the page', async () => {\n      await target.reload();\n    });\n\n    await step('navigate to console-filter.html and get console messages', async () => {\n      await waitFor('.console-message-text .source-code');\n    });\n\n    await step('stop the recording', async () => {\n      await stopRecording();\n    });\n\n    await step('check that the recording finished successfully', async () => {\n      await waitFor(SUMMARY_TAB_SELECTOR);\n      await waitFor(BOTTOM_UP_SELECTOR);\n      await waitFor(CALL_TREE_SELECTOR);\n    });\n  });\n});\n\nasync function searchForWasmCall() {\n  const {frontend} = getBrowserAndPages();\n  await waitForFunction(async () => {\n    await searchForComponent(frontend, 'mainWasm');\n    const title = await $('.timeline-details-chip-title');\n    if (!title) {\n      return false;\n    }\n    const titleText = await title.evaluate(x => x.textContent);\n    return titleText === 'mainWasm';\n  });\n}\n\ndescribe('The Performance panel', async function() {\n  // These tests have lots of waiting which might take more time to execute\n  if (this.timeout() !== 0) {\n    this.timeout(20000);\n  }\n\n  beforeEach(async () => {\n    await step('navigate to the Performance tab and uplaod performance profile', async () => {\n      await navigateToPerformanceTab('wasm/profiling');\n\n      const uploadProfileHandle = await waitFor('input[type=file]');\n      assert.isNotNull(uploadProfileHandle, 'unable to upload the performance profile');\n      await uploadProfileHandle.uploadFile('test/e2e/resources/performance/wasm/mainWasm_profile.json');\n    });\n\n    await step('search for \"mainWasm\"', async () => {\n      await searchForWasmCall();\n    });\n  });\n\n  it('is able to display the execution time for a wasm function', async () => {\n    await step('check that the Summary tab shows more than zero total time for \"mainWasm\"', async () => {\n      const totalTime = await getTotalTimeFromSummary();\n      assert.isAbove(totalTime, 0, 'mainWasm function execution time is displayed incorrectly');\n    });\n  });\n\n  it('is able to inspect the call stack for a wasm function from the bottom up', async () => {\n    const {frontend} = getBrowserAndPages();\n    const expectedActivities = ['mainWasm', 'js-to-wasm::i', '(anonymous)', 'Run Microtasks'];\n\n    await step('navigate to the Bottom Up tab', async () => {\n      await navigateToBottomUpTab();\n    });\n\n    await step(\n        'expand the tree for the \"mainWasm\" activity and check that it displays the correct values', async () => {\n          const timelineTree = await $('.timeline-tree-view') as puppeteer.ElementHandle<HTMLSelectElement>;\n          const rootActivity = await waitForElementWithTextContent(expectedActivities[0], timelineTree);\n          if (!rootActivity) {\n            assert.fail(`Could not find ${expectedActivities[0]} in frontend.`);\n          }\n          await rootActivity.click();\n          await expandAndCheckActivityTree(frontend, expectedActivities);\n        });\n  });\n\n  it('is able to inspect the call stack for a wasm function from the call tree', async () => {\n    const {frontend} = getBrowserAndPages();\n    const expectedActivities = [\n      'Run Microtasks',\n      '(anonymous)',\n      'js-to-wasm::i',\n      'mainWasm',\n      'wasm-to-js::l-imports.getTime',\n      'getTime',\n    ];\n\n    await step('navigate to the Call Tree tab', async () => {\n      await navigateToCallTreeTab();\n    });\n\n    await step(\n        'expand the tree for the \"Run Microtasks\" activity and check that it displays the correct values', async () => {\n          const timelineTree = await $('.timeline-tree-view') as puppeteer.ElementHandle<HTMLSelectElement>;\n          const rootActivity = await waitForElementWithTextContent(expectedActivities[0], timelineTree);\n          if (!rootActivity) {\n            assert.fail(`Could not find ${expectedActivities[0]} in frontend.`);\n          }\n          await rootActivity.click();\n          await expandAndCheckActivityTree(frontend, expectedActivities);\n        });\n  });\n});\n"]}