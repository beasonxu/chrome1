{"version":3,"file":"navigation_test.js","sourceRoot":"","sources":["../../../../../../../../../third_party/devtools-frontend/src/test/e2e/lighthouse/navigation_test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {assert} from 'chai';\n\nimport {expectError} from '../../conductor/events.js';\nimport {describe, it} from '../../shared/mocha-extensions.js';\nimport {\n  clickStartButton,\n  getAuditsBreakdown,\n  navigateToLighthouseTab,\n  selectCategories,\n  selectMode,\n  setClearStorage,\n  setLegacyNavigation,\n  setThrottlingMethod,\n  waitForResult,\n} from '../helpers/lighthouse-helpers.js';\n\n// This test will fail (by default) in headful mode, as the target page never gets painted.\n// To resolve this when debugging, just make sure the target page is visible during the lighthouse run.\n\ndescribe('Navigation', async function() {\n  // The tests in this suite are particularly slow\n  this.timeout(60_000);\n\n  const modes = ['legacy', 'FR'];\n\n  for (const mode of modes) {\n    describe(`in ${mode} mode`, () => {\n      beforeEach(() => {\n        if (mode === 'FR') {\n          // TODO: Figure out why these are emitted in FR.\n          expectError(/Protocol Error: the message with wrong session id/);\n          expectError(/Protocol Error: the message with wrong session id/);\n        }\n      });\n\n      it('successfully returns a Lighthouse report', async () => {\n        await navigateToLighthouseTab('lighthouse/hello.html');\n\n        await setLegacyNavigation(mode === 'legacy');\n\n        await clickStartButton();\n\n        const {lhr, artifacts, reportEl} = await waitForResult();\n\n        assert.strictEqual(lhr.lighthouseVersion, '9.6.2');\n        assert.match(lhr.finalUrl, /^https:\\/\\/localhost:[0-9]+\\/test\\/e2e\\/resources\\/lighthouse\\/hello.html/);\n        assert.strictEqual(lhr.configSettings.throttlingMethod, 'simulate');\n        assert.strictEqual(lhr.configSettings.disableStorageReset, false);\n        assert.strictEqual(lhr.configSettings.formFactor, 'mobile');\n\n        const {innerWidth, innerHeight, outerWidth, outerHeight, devicePixelRatio} = artifacts.ViewportDimensions;\n        // This value can vary slightly, depending on the display.\n        // https://bugs.chromium.org/p/chromium/issues/detail?id=1346355\n        assert.approximately(innerHeight, 1742, 1);\n        assert.strictEqual(innerWidth, 980);\n        assert.strictEqual(outerWidth, 360);\n        assert.strictEqual(outerHeight, 640);\n        assert.strictEqual(devicePixelRatio, 3);\n\n        const {auditResults, erroredAudits, failedAudits} = getAuditsBreakdown(lhr);\n        assert.strictEqual(auditResults.length, 152);\n        assert.strictEqual(erroredAudits.length, 0);\n        assert.deepStrictEqual(failedAudits.map(audit => audit.id), [\n          'service-worker',\n          'viewport',\n          'installable-manifest',\n          'apple-touch-icon',\n          'splash-screen',\n          'themed-omnibox',\n          'maskable-icon',\n          'content-width',\n          'document-title',\n          'html-has-lang',\n          'meta-description',\n          'font-size',\n          'tap-targets',\n        ]);\n\n        const viewTraceText = await reportEl.$eval('.lh-button--trace', viewTraceEl => {\n          return viewTraceEl.textContent;\n        });\n        assert.strictEqual(viewTraceText, 'View Original Trace');\n      });\n\n      it('successfully returns a Lighthouse report with DevTools throttling', async () => {\n        await navigateToLighthouseTab('lighthouse/hello.html');\n\n        await setThrottlingMethod('devtools');\n        await setLegacyNavigation(mode === 'legacy');\n\n        await clickStartButton();\n\n        const {lhr, reportEl} = await waitForResult();\n\n        assert.strictEqual(lhr.configSettings.throttlingMethod, 'devtools');\n\n        // [crbug.com/1347220] DevTools throttling can force resources to load slow enough for these audits to fail sometimes.\n        const flakyAudits = [\n          'server-response-time',\n          'render-blocking-resources',\n        ];\n\n        const {auditResults, erroredAudits, failedAudits} = getAuditsBreakdown(lhr, flakyAudits);\n        assert.strictEqual(auditResults.length, 152);\n        assert.strictEqual(erroredAudits.length, 0);\n        assert.deepStrictEqual(failedAudits.map(audit => audit.id), [\n          'service-worker',\n          'viewport',\n          'installable-manifest',\n          'apple-touch-icon',\n          'splash-screen',\n          'themed-omnibox',\n          'maskable-icon',\n          'content-width',\n          'document-title',\n          'html-has-lang',\n          'meta-description',\n          'font-size',\n          'tap-targets',\n        ]);\n\n        const viewTraceText = await reportEl.$eval('.lh-button--trace', viewTraceEl => {\n          return viewTraceEl.textContent;\n        });\n        assert.strictEqual(viewTraceText, 'View Trace');\n      });\n\n      it('successfully returns a Lighthouse report when settings changed', async () => {\n        await navigateToLighthouseTab('lighthouse/hello.html');\n\n        await setLegacyNavigation(mode === 'legacy');\n        await setClearStorage(false);\n        await selectCategories(['performance', 'best-practices']);\n        await selectMode('desktop');\n\n        await clickStartButton();\n\n        const {lhr, artifacts} = await waitForResult();\n\n        const {innerWidth, innerHeight, devicePixelRatio} = artifacts.ViewportDimensions;\n        // TODO: Figure out why outerHeight can be different depending on OS\n        assert.strictEqual(innerHeight, 720);\n        assert.strictEqual(innerWidth, 1280);\n        assert.strictEqual(devicePixelRatio, 1);\n\n        const {erroredAudits} = getAuditsBreakdown(lhr);\n        assert.strictEqual(erroredAudits.length, 0);\n\n        assert.deepStrictEqual(Object.keys(lhr.categories), ['performance', 'best-practices']);\n        assert.strictEqual(lhr.configSettings.disableStorageReset, true);\n        assert.strictEqual(lhr.configSettings.formFactor, 'desktop');\n      });\n    });\n  }\n});\n"]}